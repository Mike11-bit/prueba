<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de M√©tricas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --secondary: #9b59b6;
            --info: #17a2b8;
            --dark: #2c3e50;
            --light: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 30px;
            margin: -20px -20px 20px -20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .user-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .user-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .user-info-item {
            display: flex;
            flex-direction: column;
        }

        .user-info-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .user-info-value {
            color: #2c3e50;
            font-size: 1rem;
            font-weight: 500;
        }

        .tab-buttons {
            display: flex;
            background: #f1f3f5;
            padding: 10px 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-btn {
            padding: 15px 30px;
            border: none;
            background: transparent;
            font-size: 1rem;
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: white;
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .form-section h3 {
            color: var(--dark);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .kpi-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .kpi-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #dee2e6;
        }

        .kpi-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .kpi-table input,
        .kpi-table select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
        }

        .toast.success {
            border-left: 5px solid var(--success);
        }

        .toast.danger {
            border-left: 5px solid var(--danger);
        }

        .toast.warning {
            border-left: 5px solid var(--warning);
        }

        .toast.info {
            border-left: 5px solid var(--info);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            width: 90%;
            max-width: 1000px;
            border-radius: 15px;
            position: relative;
            animation: slideDown 0.4s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: var(--danger);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin-top: 10px;
            height: 20px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 12px;
            transition: width 0.5s ease;
        }

        .progress-bar.warning {
            background: linear-gradient(90deg, #f1c40f, #f39c12);
        }

        .progress-bar.danger {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }
    </style>
</head>

<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <h3 id="loadingText" style="color: var(--dark);">Procesando...</h3>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <span id="toastIcon"></span>
        <span id="toastMessage"></span>
    </div>

    <div class="navbar">
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="#" style="font-size: 1.3rem;">üìä Sistema de Gesti√≥n de M√©tricas</a>
            <span
                style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">v2.5.0
                (PVE Support)</span>
        </div>

        <div style="display:flex;align-items:center;gap:8px;">
            <select id="tipoAccesoSelect" class="tipo-acceso-select"
                style="padding:6px 10px;border:1px solid #ddd;border-radius:4px;font-size:0.9rem;cursor:pointer;">
                <option value="Registro">üìù Registro</option>
                <option value="Audit">üîç Audit</option>
                <option value="OM">‚öôÔ∏è OM</option>
            </select>
            <button onclick="cambiarTipoAccesoUsuario()" class="btn-cambiar-acceso"
                style="padding:6px 16px;background:#3498db;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.9rem;font-weight:600;transition:all 0.3s ease;">
                üîÑ Cambiar
            </button>
        </div>
    </div>

    <div class="container">
        <!-- User Info Card -->
        <div class="user-card">
            <div class="user-info-grid">
                <div class="user-info-item">
                    <span class="user-info-label">Usuario</span>
                    <span class="user-info-value" id="nombreUsuario">Cargando...</span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">Correo</span>
                    <span class="user-info-value" id="correoUsuario">...</span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">Rol</span>
                    <span class="user-info-value" id="rolUsuario">...</span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">Fecha</span>
                    <span class="user-info-value" id="fechaActual"></span>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="cambiarTab('registro')">üìù Registro de Metas</button>
            <button class="tab-btn" onclick="cambiarTab('simulacion')">üí∞ Simulador de Bonos</button>
        </div>

        <!-- TAB 1: REGISTRO -->
        <div id="tab-registro" class="tab-content active">
            <div id="mensajeCarga" style="text-align: center; padding: 50px;">
                <div class="spinner" style="margin: 0 auto;"></div>
                <p style="margin-top: 20px; color: #666;">Cargando datos del usuario...</p>
            </div>

            <div id="formRegistroContainer" style="display: none;">
                <form id="formRegistro">
                    <!-- Configuraci√≥n General -->
                    <div class="form-section">
                        <h3>‚öôÔ∏è Configuraci√≥n General</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>LOB <span style="color: red">*</span></label>
                                <select id="selectLob" class="form-control" required>
                                    <option value="">Cargando LOBs...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Mes de Registro</label>
                                <input type="text" id="mes" class="form-control" readonly style="background: #e9ecef;">
                            </div>
                            <div class="form-group">
                                <label>Tipo de Hoja <span style="color: red">*</span></label>
                                <select id="tipoHoja" class="form-control" required onchange="actualizarLimites()">
                                    <option value="">-- Seleccione --</option>
                                    <option value="Registro">Registro (Est√°ndar)</option>
                                    <option value="Registro_pisos">Registro Pisos (Complejo)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Info Din√°mica -->
                        <div id="mesInfo"
                            style="display: none; margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                            <strong>üìÖ Mes Seleccionado:</strong> <span id="mesTexto"></span>
                            <div id="contadorAgentes" style="margin-top: 5px; font-size: 0.9em; color: #555;">
                                üë• Total Agentes (HC): <strong id="totalAgentes">0</strong>
                            </div>
                        </div>

                        <!-- Alerta Configuraci√≥n Previa -->
                        <div id="alertaSalarioPorcentaje"
                            style="display: none; margin-top: 15px; padding: 15px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
                            <strong>‚úÖ Configuraci√≥n Cargada:</strong>
                            Se encontr√≥ un salario base de <strong id="salarioTextoAlerta"></strong>
                            y un bono del <strong id="porcentajeTextoAlerta"></strong>
                            registrado en <span id="mesOrigenAlerta"></span>.
                        </div>
                    </div>

                    <!-- Responsables -->
                    <div class="form-section">
                        <h3>üë• Responsables</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>ACCM</label>
                                <input type="text" id="accm" class="form-control" placeholder="Nombre del ACCM">
                            </div>
                            <div class="form-group">
                                <label>OM / Director</label>
                                <input type="text" id="om" class="form-control" placeholder="Nombre del OM">
                            </div>
                        </div>
                    </div>

                    <!-- Configuraci√≥n Salarial -->
                    <div class="form-section">
                        <h3>üí∞ Configuraci√≥n Salarial</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Salario Base <span style="color: red">*</span></label>
                                <input type="number" id="salario" class="form-control" required min="0" step="1000"
                                    onchange="calcularBonoMaximo()">
                            </div>
                            <div class="form-group">
                                <label>% Bono (Max 30%) <span style="color: red">*</span></label>
                                <input type="number" id="porcentajeBono" class="form-control" required min="0" max="30"
                                    step="0.01" onchange="calcularBonoMaximo()">
                            </div>

                            <!-- NUEVO: PVE -->
                            <div class="form-group">
                                <label>PVE Presupuesto (Opcional)</label>
                                <input type="number" id="pvePresupuesto" class="form-control" min="0" step="1000"
                                    placeholder="Presupuesto PVE asignado">
                                <small style="color: #666;">Si se deja vac√≠o, se usar√° el global en
                                    simulaciones.</small>
                            </div>
                        </div>

                        <!-- Indicador de Bono -->
                        <div id="bonoIndicator"
                            style="display: none; margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 10px; border: 1px solid #ffeeba;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="font-weight: bold; color: #856404;">üí∞ Bono M√°ximo por Agente:</span>
                                <span id="bonoMaximoTexto"
                                    style="font-size: 1.2em; font-weight: bold; color: #28a745;">$0.00</span>
                            </div>

                            <div style="margin-top: 15px;">
                                <div
                                    style="display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 5px;">
                                    <span>Asignado en Bonus Structure: <strong
                                            id="porcentajeAsignadoTexto">0%</strong></span>
                                    <span>Disponible: <strong id="porcentajeDisponibleTexto">100%</strong></span>
                                </div>
                                <div class="progress-container">
                                    <div id="progressBar" class="progress-bar" style="width: 0%">0%</div>
                                </div>
                                <div style="margin-top: 5px; text-align: right; font-size: 0.85em; color: #666;">
                                    Monto Asignado: <strong id="montoAsignadoTexto">$0.00</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECCIONES DE KPIs (Ocultas inicialmente) -->
                    <div id="sectionKeys" class="form-section" style="display: none;">
                        <h3>üîë Key KPIs <button type="button" class="btn btn-primary"
                                style="font-size: 0.8em; margin-left: auto;" onclick="agregarFilaKPI('keys')">+ Agregar
                                KPI</button></h3>
                        <table class="kpi-table">
                            <thead>
                                <tr>
                                    <th>KPI</th>
                                    <th>Comparaci√≥n</th>
                                    <th>Meta/Score</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyKeys"></tbody>
                        </table>
                    </div>

                    <div id="sectionBonus" class="form-section" style="display: none;">
                        <h3>üü¢ Bonus Structure <button type="button" class="btn btn-primary"
                                style="font-size: 0.8em; margin-left: auto;" onclick="agregarFilaKPI('bonus')">+ Agregar
                                KPI</button></h3>
                        <table class="kpi-table">
                            <thead>
                                <tr>
                                    <th>KPI</th>
                                    <th>Comparaci√≥n</th>
                                    <th>Meta/Score</th>
                                    <th>% Asignado</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyBonus"></tbody>
                        </table>
                    </div>

                    <div id="sectionAdditional" class="form-section" style="display: none;">
                        <h3>üü† Additional Incentive <button type="button" class="btn btn-primary"
                                style="font-size: 0.8em; margin-left: auto;" onclick="agregarFilaKPI('additional')">+
                                Agregar KPI</button></h3>
                        <table class="kpi-table">
                            <thead>
                                <tr>
                                    <th>KPI</th>
                                    <th>Comparaci√≥n</th>
                                    <th>Meta/Score</th>
                                    <th>% Asignado</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyAdditional"></tbody>
                        </table>
                    </div>

                    <div id="sectionDecreased" class="form-section" style="display: none;">
                        <h3>üî¥ Decreased (Penalizaciones) <button type="button" class="btn btn-primary"
                                style="font-size: 0.8em; margin-left: auto;" onclick="agregarFilaKPI('decreased')">+
                                Agregar KPI</button></h3>
                        <table class="kpi-table">
                            <thead>
                                <tr>
                                    <th>KPI</th>
                                    <th>Comparaci√≥n</th>
                                    <th>Meta/Score</th>
                                    <th>% Penalizaci√≥n</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyDecreased"></tbody>
                        </table>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" id="btnGuardar" class="btn btn-success"
                            style="font-size: 1.2rem; padding: 15px 40px;">
                            üíæ GUARDAR REGISTRO
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- TAB 2: SIMULACI√ìN -->
        <div id="tab-simulacion" class="tab-content">
            <div class="form-section">
                <h3>üîç Consultar / Simular Estructura</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>LOB</label>
                        <select id="simSelectLob" class="form-control">
                            <option value="">Cargando...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Mes Registrado</label>
                        <select id="simSelectMes" class="form-control">
                            <option value="">-- Seleccione LOB primero --</option>
                        </select>
                    </div>
                </div>

                <div class="form-grid" style="margin-top: 15px;">
                    <div class="form-group">
                        <label>Salario Base (Simulaci√≥n)</label>
                        <input type="number" id="simInputSalario" class="form-control"
                            placeholder="Opcional (usa registrado)">
                    </div>
                    <div class="form-group">
                        <label>% Bono (Simulaci√≥n)</label>
                        <input type="number" id="simInputPorcentaje" class="form-control"
                            placeholder="Opcional (usa registrado)">
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px; display: flex; gap: 15px; justify-content: center;">
                    <button onclick="consultarEstructuraRegistrada()" class="btn btn-primary">
                        üëÅÔ∏è VER ESTRUCTURA
                    </button>
                    <button onclick="abrirModalSimulacion()" class="btn btn-success">
                        üí∞ SIMULAR BONO
                    </button>
                </div>
            </div>

            <!-- NUEVO: SIMULACI√ìN MASIVA -->
            <div class="form-section" style="border-left: 5px solid #9b59b6;">
                <h3 id="tituloSimMasiva">üöÄ Simulaci√≥n Masiva</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    Calcula el costo total de todas las LOBs para el pr√≥ximo mes.
                </p>

                <!-- üî• SELECTOR DE REGI√ìN (solo Reporting Analyst) -->
                <div id="regionSelectorContainer" style="display: none; margin-bottom: 20px;">
                    <div class="form-group">
                        <label style="font-weight: bold; color: #8e44ad;">üåé Seleccionar Regi√≥n</label>
                        <select id="simSelectRegion" class="form-control" onchange="filtrarLOBsPorRegion()">
                            <option value="">-- Seleccione Regi√≥n --</option>
                            <option value="Rebel US&C">Rebel US&C</option>
                            <option value="Rebel LATAM">Rebel LATAM</option>
                        </select>
                    </div>
                </div>

                <!-- Configuraci√≥n PVE -->
                <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #8e44ad; margin-bottom: 10px;">üí∞ Configuraci√≥n PVE (Plan vs Estimate)</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>PVE Total Global ($)</label>
                            <input type="number" id="simPVETotal" class="form-control" placeholder="Ej: 500000000"
                                onchange="calcularPresupuestoPVE()" oninput="actualizarTextoAyudaPVE(this)">
                            <small id="simPVETotalHelp"
                                style="color: #27ae60; font-weight: bold; display: block; margin-top: 5px;"></small>
                        </div>
                        <div class="form-group">
                            <label>% PVE Asignado</label>
                            <input type="number" id="simPorcPVE" class="form-control" placeholder="Ej: 4.5" step="0.1"
                                onchange="calcularPresupuestoPVE()">
                        </div>
                        <div class="form-group">
                            <label>Presupuesto Disponible</label>
                            <input type="text" id="simPresupuestoDisponible" class="form-control" readonly
                                style="background: #e9ecef; font-weight: bold; color: #27ae60;">
                        </div>
                    </div>
                    <div id="alertaPVE" style="display: none; margin-top: 10px; font-size: 0.9em; color: #8e44ad;">
                        ‚úÖ Se calcular√° el cumplimiento del presupuesto PVE para cada LOB.
                    </div>
                </div>

                <div style="text-align: center;">
                    <button id="btnSimularTodasLOBs" onclick="simularTodasLOBsUnificado()" class="btn"
                        style="background: #8e44ad; color: white;">
                        üìä SIMULAR TODAS MIS LOBs
                    </button>
                </div>

                <!-- Filtros (Ocultos inicialmente) -->
                <div id="filtrosSimulacionMasiva"
                    style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <h4>üå™Ô∏è Filtros de Resultados</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Eficiencia</label>
                            <select id="filtroEficiencia" class="form-control" onchange="aplicarFiltrosSimulacion()">
                                <option value="todas">Todas</option>
                                <option value="alta">Alta (>90%)</option>
                                <option value="media">Media (70-90%)</option>
                                <option value="baja">Baja (<70%)< /option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Costo</label>
                            <select id="filtroCosto" class="form-control" onchange="aplicarFiltrosSimulacion()">
                                <option value="todas">Todos</option>
                                <option value="alto">Alto (>$50k)</option>
                                <option value="medio">Medio ($10k-$50k)</option>
                                <option value="bajo">Bajo (<$10k)< /option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>HC</label>
                            <select id="filtroHC" class="form-control" onchange="aplicarFiltrosSimulacion()">
                                <option value="todas">Todos</option>
                                <option value="grande">Grande (>50)</option>
                                <option value="mediano">Mediano (10-50)</option>
                                <option value="pequeno">Peque√±o (<10)< /option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ordenar por</label>
                            <select id="ordenarPor" class="form-control" onchange="aplicarFiltrosSimulacion()">
                                <option value="costo_desc">Mayor Costo</option>
                                <option value="costo_asc">Menor Costo</option>
                                <option value="eficiencia_desc">Mayor Eficiencia</option>
                                <option value="hc_desc">Mayor HC</option>
                                <option value="nombre_asc">Nombre A-Z</option>
                            </select>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <button onclick="limpiarFiltros()" class="btn btn-secondary" style="font-size: 0.8em;">üóëÔ∏è
                            Limpiar Filtros</button>
                    </div>
                </div>
            </div>

            <!-- Contenedor de Resultados -->
            <div id="estructuraRegistrada" style="display: none; margin-top: 30px;"></div>
        </div>
    </div>

    <!-- MODAL DE SIMULACI√ìN -->
    <div id="simulacionModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="cerrarModalSimulacion()">&times;</span>
            <div id="contenidoSimulacion"></div>
        </div>
    </div>

    <script>
        // ============================================================
        // üìä SCRIPT PRINCIPAL
        // ============================================================

        // Variables Globales
        var datosUsuario = null;
        var lobsDisponibles = [];
        var kpisDisponibles = null;
        var estructuraCargada = null;
        var limites = {
            'Registro': { keys: 2, bonus: 4, additional: 3, decreased: 2 },
            'Registro_pisos': { keys: 6, bonus: 25, additional: 3, decreased: 4 }
        };

        // Inicializaci√≥n
        window.addEventListener('DOMContentLoaded', function () {
            document.getElementById('fechaActual').textContent = new Date().toLocaleDateString();
            cargarDatosIniciales();
            inicializarEventos();
        });

        // Tabs
        function cambiarTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Buscar bot√≥n espec√≠fico
            const buttons = document.querySelectorAll('.tab-btn');
            if (tab === 'registro') buttons[0].classList.add('active');
            else buttons[1].classList.add('active');

            document.getElementById('tab-' + tab).classList.add('active');
        }

        // Carga de Datos
        function cargarDatosIniciales() {
            google.script.run
                .withSuccessHandler(function (response) {
                    if (response.success) {
                        datosUsuario = response.usuario;
                        lobsDisponibles = response.lobs;

                        document.getElementById('nombreUsuario').textContent = datosUsuario.nombre;
                        document.getElementById('correoUsuario').textContent = datosUsuario.correo;
                        document.getElementById('rolUsuario').textContent = datosUsuario.rol;

                        // Cargar LOBs en Registro
                        const selectLob = document.getElementById('selectLob');
                        selectLob.innerHTML = '<option value="">-- Seleccione LOB --</option>';
                        lobsDisponibles.forEach(lob => selectLob.appendChild(new Option(lob, lob)));

                        // Cargar LOBs en Simulaci√≥n (solo registradas)
                        cargarLobsRegistradasEnSimulacion();

                        // Cargar KPIs
                        cargarKPIsDisponibles();

                        document.getElementById('mensajeCarga').style.display = 'none';
                        document.getElementById('formRegistroContainer').style.display = 'block';
                    } else {
                        mostrarToast('‚ùå ' + response.error, 'danger');
                    }
                })
                .obtenerDatosParaFormularioRegistro();
        }

        function cargarLobsRegistradasEnSimulacion() {
            google.script.run
                .withSuccessHandler(function (lobs) {
                    const select = document.getElementById('simSelectLob');
                    select.innerHTML = '<option value="">-- Seleccione LOB --</option>';
                    if (lobs && lobs.length > 0) {
                        lobs.forEach(lob => select.appendChild(new Option(lob, lob)));
                    } else {
                        select.innerHTML = '<option value="">-- Sin registros --</option>';
                    }
                })
                .obtenerLobsRegistradas();
        }

        function cargarKPIsDisponibles() {
            google.script.run
                .withSuccessHandler(function (kpis) {
                    kpisDisponibles = kpis;
                })
                .obtenerTodosLosKPIsDisponibles();
        }

        // Eventos
        function inicializarEventos() {
            // Cambio de LOB en Registro
            document.getElementById('selectLob').addEventListener('change', function () {
                const lob = this.value;
                if (!lob) return;

                // Set Mes (Next Month)
                const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const mes = meses[(new Date().getMonth() + 1) % 12];
                document.getElementById('mes').value = mes;
                document.getElementById('mesTexto').textContent = mes;
                document.getElementById('mesInfo').style.display = 'block';

                // Cargar Config Previa
                google.script.run.withSuccessHandler(function (config) {
                    if (config.encontrado) {
                        document.getElementById('salario').value = config.salario;
                        document.getElementById('porcentajeBono').value = config.porcentaje;
                        document.getElementById('pvePresupuesto').value = config.pve || '';

                        document.getElementById('salarioTextoAlerta').textContent = formatearMoneda(config.salario);
                        document.getElementById('porcentajeTextoAlerta').textContent = config.porcentaje + '%';
                        document.getElementById('mesOrigenAlerta').textContent = config.mes;
                        document.getElementById('alertaSalarioPorcentaje').style.display = 'block';
                        calcularBonoMaximo();
                    } else {
                        document.getElementById('alertaSalarioPorcentaje').style.display = 'none';
                        document.getElementById('salario').value = '';
                        document.getElementById('porcentajeBono').value = '';
                        document.getElementById('pvePresupuesto').value = '';
                    }
                }).obtenerSalarioPorLob(lob);

                // Cargar Responsables y HC
                google.script.run.withSuccessHandler(function (resp) {
                    document.getElementById('accm').value = resp.accm || '';
                    document.getElementById('om').value = (datosUsuario.rol === 'OM') ? datosUsuario.nombre : (resp.om || '');
                }).obtenerResponsablesPorLob(lob);

                google.script.run.withSuccessHandler(function (count) {
                    document.getElementById('totalAgentes').textContent = count;
                }).contarAgentesPorLob(lob);

                mostrarSeccionesConBotones();
            });

            // Cambio de LOB en Simulaci√≥n
            document.getElementById('simSelectLob').addEventListener('change', function () {
                const lob = this.value;
                if (!lob) return;
                google.script.run.withSuccessHandler(function (meses) {
                    const select = document.getElementById('simSelectMes');
                    select.innerHTML = '<option value="">-- Seleccione Mes --</option>';
                    meses.forEach(m => select.appendChild(new Option(m, m)));
                }).obtenerMesesRegistrados(lob, datosUsuario);
            });

            // Submit Registro
            document.getElementById('formRegistro').addEventListener('submit', manejarSubmitRegistro);
        }

        // Funciones de Formulario
        function mostrarSeccionesConBotones() {
            ['Keys', 'Bonus', 'Additional', 'Decreased'].forEach(id => {
                document.getElementById('section' + id).style.display = 'block';
            });
        }

        function agregarFilaKPI(tipo) {
            const tipoHoja = document.getElementById('tipoHoja').value;
            if (!tipoHoja) { alert('Seleccione Tipo de Hoja'); return; }

            const tbody = document.getElementById('tbody' + capitalize(tipo));
            if (tbody.rows.length >= limites[tipoHoja][tipo]) {
                alert('L√≠mite de KPIs alcanzado para esta secci√≥n');
                return;
            }

            const row = tbody.insertRow();
            let kpis = kpisDisponibles ? (kpisDisponibles[tipo === 'bonus' ? 'bonusStructure' : tipo === 'additional' ? 'additionalIncentives' : tipo === 'decreased' ? 'decreasedKPIs' : 'keys'] || []) : [];
            let opts = '<option value="">-- Seleccionar --</option>' + kpis.map(k => `<option value="${k}">${k}</option>`).join('');

            let html = `<td><select class="kpi-nombre">${opts}</select></td>
                        <td><select class="kpi-comparacion"><option value="<"><</option><option value="<="><=</option><option value=">">></option><option value=">=">>=</option><option value="=">=</option></select></td>
                        <td><input type="number" class="kpi-score" step="0.01"></td>`;

            if (tipo !== 'keys') {
                html += `<td><input type="number" class="kpi-porcentaje" step="0.01" oninput="actualizarIndicadorBono()"></td>`;
            }
            html += `<td><button type="button" class="btn-delete" onclick="eliminarFila(this)" style="background:none;border:none;cursor:pointer;">üóëÔ∏è</button></td>`;
            row.innerHTML = html;
        }

        function eliminarFila(btn) {
            btn.closest('tr').remove();
            actualizarIndicadorBono();
        }

        function manejarSubmitRegistro(e) {
            e.preventDefault();
            const lob = document.getElementById('selectLob').value;
            const mes = document.getElementById('mes').value;

            // Validar Bonus <= 100
            let totalBonus = 0;
            document.querySelectorAll('#tbodyBonus .kpi-porcentaje').forEach(i => totalBonus += parseFloat(i.value) || 0);
            if (totalBonus > 100) { alert('Total Bonus excede 100%'); return; }

            const datos = {
                mes, lob,
                tipoHoja: document.getElementById('tipoHoja').value,
                accm: document.getElementById('accm').value,
                om: document.getElementById('om').value,
                salario: parseFloat(document.getElementById('salario').value) || 0,
                porcentaje: parseFloat(document.getElementById('porcentajeBono').value) || 0,
                keys: extraerKPIsDeTabla('keys'),
                bonus: extraerKPIsDeTabla('bonus'),
                additional: extraerKPIsDeTabla('additional'),
                decreased: extraerKPIsDeTabla('decreased')
            };

            mostrarLoading('Guardando registro...');
            google.script.run
                .withSuccessHandler(function (r) {
                    ocultarLoading();
                    if (r.success) {
                        mostrarToast('‚úÖ Registro guardado', 'success');
                    } else {
                        mostrarToast('‚ùå ' + r.error, 'danger');
                    }
                })
                .withFailureHandler(function (err) {
                    ocultarLoading();
                    mostrarToast('‚ùå Error: ' + err, 'danger');
                })
                .guardarRegistroMetricas(datos);
        }

        function extraerKPIsDeTabla(tipo) {
            const tbody = document.getElementById('tbody' + capitalize(tipo));
            if (!tbody) return [];
            const kpis = [];
            for (let row of tbody.rows) {
                const nombre = row.querySelector('.kpi-nombre')?.value || '';
                const comparacion = row.querySelector('.kpi-comparacion')?.value || '';
                const score = row.querySelector('.kpi-score')?.value || '';
                const porcentaje = row.querySelector('.kpi-porcentaje')?.value || '';
                if (nombre) {
                    let obj = { nombre, comparacion, score };
                    if (tipo !== 'keys') obj.porcentaje = porcentaje;
                    kpis.push(obj);
                }
            }
            return kpis;
        }

        // Tabs
        function cambiarTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            const buttons = document.querySelectorAll('.tab-btn');
            if (tab === 'registro') buttons[0].classList.add('active');
            else buttons[1].classList.add('active');

            document.getElementById('tab-' + tab).classList.add('active');
        }

        // Carga de Datos
        function cargarDatosIniciales() {
            google.script.run
                .withSuccessHandler(function (response) {
                    if (response.success) {
                        datosUsuario = response.usuario;
                        lobsDisponibles = response.lobs;

                        document.getElementById('nombreUsuario').textContent = datosUsuario.nombre;
                        document.getElementById('correoUsuario').textContent = datosUsuario.correo;
                        document.getElementById('rolUsuario').textContent = datosUsuario.rol;

                        // Cargar LOBs en Registro
                        const selectLob = document.getElementById('selectLob');
                        selectLob.innerHTML = '<option value="">-- Seleccione LOB --</option>';
                        lobsDisponibles.forEach(lob => selectLob.appendChild(new Option(lob, lob)));

                        // Cargar LOBs en Simulaci√≥n (solo registradas)
                        cargarLobsRegistradasEnSimulacion();

                        // Cargar KPIs
                        cargarKPIsDisponibles();

                        document.getElementById('mensajeCarga').style.display = 'none';
                        document.getElementById('formRegistroContainer').style.display = 'block';
                    } else {
                        mostrarToast('‚ùå ' + response.error, 'danger');
                    }
                })
                .obtenerDatosParaFormularioRegistro();
        }

        function cargarLobsRegistradasEnSimulacion() {
            google.script.run
                .withSuccessHandler(function (lobs) {
                    const select = document.getElementById('simSelectLob');
                    select.innerHTML = '<option value="">-- Seleccione LOB --</option>';
                    if (lobs && lobs.length > 0) {
                        lobs.forEach(lob => select.appendChild(new Option(lob, lob)));
                    } else {
                        select.innerHTML = '<option value="">-- Sin registros --</option>';
                    }
                })
                .obtenerLobsRegistradas();
        }

        function cargarKPIsDisponibles() {
            google.script.run
                .withSuccessHandler(function (kpis) {
                    kpisDisponibles = kpis;
                })
                .obtenerTodosLosKPIsDisponibles();
        }

        // Eventos
        function inicializarEventos() {
            // Cambio de LOB en Registro
            document.getElementById('selectLob').addEventListener('change', function () {
                const lob = this.value;
                if (!lob) return;

                // Set Mes (Next Month)
                const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const mes = meses[(new Date().getMonth() + 1) % 12];
                document.getElementById('mes').value = mes;
                document.getElementById('mesTexto').textContent = mes;
                document.getElementById('mesInfo').style.display = 'block';

                // Cargar Config Previa
                google.script.run.withSuccessHandler(function (config) {
                    if (config.encontrado) {
                        document.getElementById('salario').value = config.salario;
                        document.getElementById('porcentajeBono').value = config.porcentaje;
                        document.getElementById('pvePresupuesto').value = config.pve || '';

                        document.getElementById('salarioTextoAlerta').textContent = formatearMoneda(config.salario);
                        document.getElementById('porcentajeTextoAlerta').textContent = config.porcentaje + '%';
                        document.getElementById('mesOrigenAlerta').textContent = config.mes;
                        document.getElementById('alertaSalarioPorcentaje').style.display = 'block';
                        calcularBonoMaximo();
                    } else {
                        document.getElementById('alertaSalarioPorcentaje').style.display = 'none';
                        document.getElementById('salario').value = '';
                        document.getElementById('porcentajeBono').value = '';
                        document.getElementById('pvePresupuesto').value = '';
                    }
                }).obtenerSalarioPorLob(lob);

                // Cargar Responsables y HC
                google.script.run.withSuccessHandler(function (resp) {
                    document.getElementById('accm').value = resp.accm || '';
                    document.getElementById('om').value = (datosUsuario.rol === 'OM') ? datosUsuario.nombre : (resp.om || '');
                }).obtenerResponsablesPorLob(lob);

                google.script.run.withSuccessHandler(function (count) {
                    document.getElementById('totalAgentes').textContent = count;
                }).contarAgentesPorLob(lob);

                mostrarSeccionesConBotones();
            });

            // Cambio de LOB en Simulaci√≥n
            document.getElementById('simSelectLob').addEventListener('change', function () {
                const lob = this.value;
                if (!lob) return;
                google.script.run.withSuccessHandler(function (meses) {
                    const select = document.getElementById('simSelectMes');
                    select.innerHTML = '<option value="">-- Seleccione Mes --</option>';
                    meses.forEach(m => select.appendChild(new Option(m, m)));
                }).obtenerMesesRegistrados(lob, datosUsuario);
            });

            // Submit Registro
            document.getElementById('formRegistro').addEventListener('submit', manejarSubmitRegistro);
        }

        // Funciones de Formulario
        function mostrarSeccionesConBotones() {
            ['Keys', 'Bonus', 'Additional', 'Decreased'].forEach(id => {
                document.getElementById('section' + id).style.display = 'block';
            });
        }

        function agregarFilaKPI(tipo) {
            const tipoHoja = document.getElementById('tipoHoja').value;
            if (!tipoHoja) { alert('Seleccione Tipo de Hoja'); return; }

            const tbody = document.getElementById('tbody' + capitalize(tipo));
            if (tbody.rows.length >= limites[tipoHoja][tipo]) {
                alert('L√≠mite de KPIs alcanzado para esta secci√≥n');
                return;
            }

            const row = tbody.insertRow();
            let kpis = kpisDisponibles ? (kpisDisponibles[tipo === 'bonus' ? 'bonusStructure' : tipo === 'additional' ? 'additionalIncentives' : tipo === 'decreased' ? 'decreasedKPIs' : 'keys'] || []) : [];
            let opts = '<option value="">-- Seleccionar --</option>' + kpis.map(k => `<option value="${k}">${k}</option>`).join('');

            let html = `<td><select class="kpi-nombre">${opts}</select></td>
                        <td><select class="kpi-comparacion"><option value="<"><</option><option value="<="><=</option><option value=">">></option><option value=">=">>=</option><option value="=">=</option></select></td>
                        <td><input type="number" class="kpi-score" step="0.01"></td>`;

            if (tipo !== 'keys') {
                html += `<td><input type="number" class="kpi-porcentaje" step="0.01" oninput="actualizarIndicadorBono()"></td>`;
            }
            html += `<td><button type="button" class="btn-delete" onclick="eliminarFila(this)" style="background:none;border:none;cursor:pointer;">üóëÔ∏è</button></td>`;
            row.innerHTML = html;
        }

        function eliminarFila(btn) {
            btn.closest('tr').remove();
            actualizarIndicadorBono();
        }

        function manejarSubmitRegistro(e) {
            e.preventDefault();
            const lob = document.getElementById('selectLob').value;
            const mes = document.getElementById('mes').value;

            // Validar Bonus <= 100
            let totalBonus = 0;
            document.querySelectorAll('#tbodyBonus .kpi-porcentaje').forEach(i => totalBonus += parseFloat(i.value) || 0);
            if (totalBonus > 100) { alert('Total Bonus excede 100%'); return; }

            const datos = {
                mes, lob,
                tipoHoja: document.getElementById('tipoHoja').value,
                accm: document.getElementById('accm').value,
                om: document.getElementById('om').value,
                salario: parseFloat(document.getElementById('salario').value),
                porcentaje: parseFloat(document.getElementById('porcentajeBono').value),
                pve: parseFloat(document.getElementById('pvePresupuesto').value) || 0, // üî• PVE
                keys: extraerKPIs('keys'),
                bonus: extraerKPIs('bonus'),
                additional: extraerKPIs('additional'),
                decreased: extraerKPIs('decreased')
            };

            if (!confirm(`¬øGuardar registro para ${lob}?`)) return;

            mostrarLoading('Guardando...');
            google.script.run.withSuccessHandler(function (r) {
                ocultarLoading();
                if (r.success) {
                    mostrarToast('‚úÖ Guardado exitosamente', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    mostrarToast('‚ùå ' + r.error, 'danger');
                }
            }).guardarRegistroMetricas(datos);
        }

        function extraerKPIs(tipo) {
            const kpis = [];
            document.querySelectorAll(`#tbody${capitalize(tipo)} tr`).forEach(row => {
                const nombre = row.querySelector('.kpi-nombre').value;
                if (nombre) {
                    kpis.push({
                        nombre,
                        comparacion: row.querySelector('.kpi-comparacion').value,
                        score: row.querySelector('.kpi-score').value,
                        porcentaje: row.querySelector('.kpi-porcentaje')?.value
                    });
                }
            });
            return kpis;
        }

        // ============================================================
        // üìä SCRIPT PRINCIPAL INTEGRADO
        // ============================================================

        // Variables Globales
        var datosUsuario = null;
        var lobsDisponibles = [];
        var kpisDisponibles = null;
        var limites = {
            'Registro': { keys: 2, bonus: 4, additional: 3, decreased: 2 },
            'Registro_pisos': { keys: 6, bonus: 25, additional: 3, decreased: 4 }
        };
        // ==========================================
        // üöÄ CLIENT-SIDE CACHE & OPTIMIZATIONS
        // ==========================================
        const ClientCache = {
            storage: window.sessionStorage,

            get: function (key) {
                const item = this.storage.getItem(key);
                if (!item) return null;
                try {
                    const record = JSON.parse(item);
                    if (new Date().getTime() > record.expiration) {
                        this.storage.removeItem(key);
                        return null;
                    }
                    console.log(`‚ö° Cache Hit: ${key}`);
                    return record.value;
                } catch (e) { return null; }
            },

            set: function (key, value, minutes) {
                const record = {
                    value: value,
                    expiration: new Date().getTime() + (minutes * 60 * 1000)
                };
                try {
                    this.storage.setItem(key, JSON.stringify(record));
                } catch (e) { console.error('Cache Full'); }
            },

            clear: function (prefix) {
                Object.keys(this.storage).forEach(k => {
                    if (k.startsWith(prefix)) this.storage.removeItem(k);
                });
            }
        };

        window.simulacionMasivaActual = null; // Para exportaci√≥n

        // Inicializaci√≥n
        window.addEventListener('DOMContentLoaded', function () {
            document.getElementById('fechaActual').textContent = new Date().toLocaleDateString();
            cargarDatosIniciales();
            inicializarEventos();
        });

        // Tabs
        function cambiarTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            const buttons = document.querySelectorAll('.tab-btn');
            if (tab === 'registro') buttons[0].classList.add('active');
            else buttons[1].classList.add('active');

            document.getElementById('tab-' + tab).classList.add('active');
        }

        // Carga de Datos (Optimizado con Cache)
        function cargarDatosIniciales() {
            mostrarLoading('Cargando datos del usuario...');

            // Intentar cargar de cach√© local primero (5 min TTL para datos iniciales)
            const cacheKey = 'init_data_user';
            const cachedData = ClientCache.get(cacheKey);

            if (cachedData) {
                procesarDatosIniciales(cachedData);
                return;
            }

            google.script.run
                .withSuccessHandler(function (response) {
                    if (response.success) {
                        ClientCache.set(cacheKey, response, 5); // Guardar en cach√© 5 min
                        procesarDatosIniciales(response);
                    } else {
                        ocultarLoading();
                        mostrarToast('‚ùå ' + response.error, 'danger');
                    }
                })
                .obtenerDatosParaFormularioRegistro();
        }

        function procesarDatosIniciales(response) {
            ocultarLoading();
            datosUsuario = response.usuario;
            lobsDisponibles = response.lobs;

            document.getElementById('nombreUsuario').textContent = datosUsuario.nombre;
            document.getElementById('correoUsuario').textContent = datosUsuario.correo;
            document.getElementById('rolUsuario').textContent = datosUsuario.rol;

            // Cargar LOBs en Registro
            const selectLob = document.getElementById('selectLob');
            selectLob.innerHTML = '<option value="">-- Seleccione LOB --</option>';
            lobsDisponibles.forEach(lob => selectLob.appendChild(new Option(lob, lob)));

            // Cargar LOBs en Simulaci√≥n
            cargarLobsRegistradasEnSimulacion();

            // Cargar KPIs
            cargarKPIsDisponibles();

            // üî• CONFIGURAR UI SEG√öN ROL
            configurarUISegunRol();

            document.getElementById('mensajeCarga').style.display = 'none';
            document.getElementById('formRegistroContainer').style.display = 'block';
        }

        // üî• NUEVA: Configurar UI seg√∫n rol
        function configurarUISegunRol() {
            const regionContainer = document.getElementById('regionSelectorContainer');
            const btnSimular = document.getElementById('btnSimularTodasLOBs');
            const titulo = document.getElementById('tituloSimMasiva');

            if (datosUsuario.rol === 'Reporting Analyst' || datosUsuario.rol === 'Audit') {
                // Mostrar selector de regi√≥n
                regionContainer.style.display = 'block';
                btnSimular.textContent = 'üìä SIMULAR LOBs DE REGI√ìN';
                titulo.textContent = 'üöÄ Simulaci√≥n Masiva por Regi√≥n';
            } else if (datosUsuario.rol === 'OM') {
                // Ocultar selector de regi√≥n
                regionContainer.style.display = 'none';
                btnSimular.textContent = 'üìä SIMULAR TODAS MIS LOBs';
                titulo.textContent = 'üöÄ Simulaci√≥n Masiva (Mis LOBs)';
            } else {
                // Otros roles: ocultar simulaci√≥n masiva
                regionContainer.style.display = 'none';
            }
        }

        function cargarLobsRegistradasEnSimulacion() {
            google.script.run
                .withSuccessHandler(function (lobs) {
                    const select = document.getElementById('simSelectLob');
                    select.innerHTML = '<option value="">-- Seleccione LOB --</option>';
                    if (lobs && lobs.length > 0) {
                        lobs.forEach(lob => select.appendChild(new Option(lob, lob)));
                    } else {
                        select.innerHTML = '<option value="">-- Sin registros --</option>';
                    }
                })
                .obtenerLobsRegistradas();
        }

        function cargarKPIsDisponibles() {
            google.script.run
                .withSuccessHandler(function (kpis) {
                    kpisDisponibles = kpis;
                })
                .obtenerTodosLosKPIsDisponibles();
        }

        // Eventos
        function inicializarEventos() {
            // Cambio de LOB en Registro
            document.getElementById('selectLob').addEventListener('change', function () {
                const lob = this.value;
                if (!lob) return;

                const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const mes = meses[(new Date().getMonth() + 1) % 12];
                document.getElementById('mes').value = mes;
                document.getElementById('mesTexto').textContent = mes;
                document.getElementById('mesInfo').style.display = 'block';

                // 1. Cargar Config Previa (Cache key: conf_LOB)
                const cacheKeyConfig = `conf_${lob.replace(/\s+/g, '_')}`;
                const cachedConfig = ClientCache.get(cacheKeyConfig);

                const procesarConfig = (config) => {
                    if (config.encontrado) {
                        document.getElementById('salario').value = config.salario;
                        document.getElementById('porcentajeBono').value = config.porcentaje;
                        document.getElementById('pvePresupuesto').value = config.pve || '';

                        document.getElementById('salarioTextoAlerta').textContent = formatearMoneda(config.salario);
                        document.getElementById('porcentajeTextoAlerta').textContent = config.porcentaje + '%';
                        document.getElementById('mesOrigenAlerta').textContent = config.mes;
                        document.getElementById('alertaSalarioPorcentaje').style.display = 'block';
                        calcularBonoMaximo();
                    } else {
                        document.getElementById('alertaSalarioPorcentaje').style.display = 'none';
                        document.getElementById('salario').value = '';
                        document.getElementById('porcentajeBono').value = '';
                        document.getElementById('pvePresupuesto').value = '';
                    }
                };

                if (cachedConfig) {
                    procesarConfig(cachedConfig);
                } else {
                    google.script.run.withSuccessHandler(function (config) {
                        ClientCache.set(cacheKeyConfig, config, 10); // Cache 10 min
                        procesarConfig(config);
                    }).obtenerSalarioPorLob(lob);
                }

                // 2. Cargar Responsables (Cache key: resp_LOB)
                const cacheKeyResp = `resp_${lob.replace(/\s+/g, '_')}`;
                const cachedResp = ClientCache.get(cacheKeyResp);

                if (cachedResp) {
                    document.getElementById('accm').value = cachedResp.accm || '';
                    document.getElementById('om').value = (datosUsuario.rol === 'OM') ? datosUsuario.nombre : (cachedResp.om || '');
                } else {
                    google.script.run.withSuccessHandler(function (resp) {
                        ClientCache.set(cacheKeyResp, resp, 60); // Cache 1 hora
                        document.getElementById('accm').value = resp.accm || '';
                        document.getElementById('om').value = (datosUsuario.rol === 'OM') ? datosUsuario.nombre : (resp.om || '');
                    }).obtenerResponsablesPorLob(lob);
                }

                // 3. Cargar HC (Cache key: hc_LOB)
                const cacheKeyHC = `hc_${lob.replace(/\s+/g, '_')}`;
                const cachedHC = ClientCache.get(cacheKeyHC);

                if (cachedHC) {
                    document.getElementById('totalAgentes').textContent = cachedHC;
                } else {
                    google.script.run.withSuccessHandler(function (count) {
                        ClientCache.set(cacheKeyHC, count, 60); // Cache 1 hora
                        document.getElementById('totalAgentes').textContent = count;
                    }).contarAgentesPorLob(lob);
                }

                mostrarSeccionesConBotones();
            });

            // Cambio de LOB en Simulaci√≥n
            document.getElementById('simSelectLob').addEventListener('change', function () {
                const lob = this.value;
                if (!lob) return;

                // Cargar meses registrados
                google.script.run.withSuccessHandler(function (meses) {
                    const select = document.getElementById('simSelectMes');
                    select.innerHTML = '<option value="">-- Seleccione Mes --</option>';
                    meses.forEach(m => select.appendChild(new Option(m, m)));
                }).obtenerMesesRegistrados(lob, datosUsuario);

                // üî• CARGAR SALARIO AUTOM√ÅTICAMENTE
                google.script.run.withSuccessHandler(function (config) {
                    if (config && config.encontrado) {
                        document.getElementById('simInputSalario').value = config.salario || '';
                        document.getElementById('simInputPorcentaje').value = config.porcentaje || '';
                        document.getElementById('simInputSalario').placeholder = 'Registrado: ' + formatearMoneda(config.salario);
                        document.getElementById('simInputPorcentaje').placeholder = 'Registrado: ' + config.porcentaje + '%';
                    } else {
                        document.getElementById('simInputSalario').value = '';
                        document.getElementById('simInputPorcentaje').value = '';
                        document.getElementById('simInputSalario').placeholder = 'No hay salario registrado';
                        document.getElementById('simInputPorcentaje').placeholder = 'No hay % registrado';
                    }
                }).obtenerSalarioPorLob(lob);
            });

            // Submit Registro
            document.getElementById('formRegistro').addEventListener('submit', manejarSubmitRegistro);
        }

        // Funciones de Formulario
        function mostrarSeccionesConBotones() {
            ['Keys', 'Bonus', 'Additional', 'Decreased'].forEach(id => {
                document.getElementById('section' + id).style.display = 'block';
            });
        }

        function agregarFilaKPI(tipo) {
            const tipoHoja = document.getElementById('tipoHoja').value;
            if (!tipoHoja) { alert('Seleccione Tipo de Hoja'); return; }

            const tbody = document.getElementById('tbody' + capitalize(tipo));
            if (tbody.rows.length >= limites[tipoHoja][tipo]) {
                alert('L√≠mite de KPIs alcanzado para esta secci√≥n');
                return;
            }

            const row = tbody.insertRow();
            let kpis = kpisDisponibles ? (kpisDisponibles[tipo === 'bonus' ? 'bonusStructure' : tipo === 'additional' ? 'additionalIncentives' : tipo === 'decreased' ? 'decreasedKPIs' : 'keys'] || []) : [];
            let opts = '<option value="">-- Seleccionar --</option>' + kpis.map(k => `<option value="${k}">${k}</option>`).join('');

            let html = `<td><select class="kpi-nombre">${opts}</select></td>
                    <td><select class="kpi-comparacion"><option value="<"><</option><option value="<="><=</option><option value=">">></option><option value=">=">>=</option><option value="=">=</option></select></td>
                    <td><input type="number" class="kpi-score" step="0.01"></td>`;

            if (tipo !== 'keys') {
                html += `<td><input type="number" class="kpi-porcentaje" step="0.01" oninput="actualizarIndicadorBono()"></td>`;
            }
            html += `<td><button type="button" class="btn-delete" onclick="eliminarFila(this)" style="background:none;border:none;cursor:pointer;">üóëÔ∏è</button></td>`;
            row.innerHTML = html;
        }

        function eliminarFila(btn) {
            btn.closest('tr').remove();
            actualizarIndicadorBono();
        }

        function manejarSubmitRegistro(e) {
            e.preventDefault();
            const lob = document.getElementById('selectLob').value;
            const mes = document.getElementById('mes').value;

            // Validar Bonus <= 100
            let totalBonus = 0;
            document.querySelectorAll('#tbodyBonus .kpi-porcentaje').forEach(i => totalBonus += parseFloat(i.value) || 0);
            if (totalBonus > 100) { alert('Total Bonus excede 100%'); return; }

            const datos = {
                mes, lob,
                tipoHoja: document.getElementById('tipoHoja').value,
                accm: document.getElementById('accm').value,
                om: document.getElementById('om').value,
                salario: parseFloat(document.getElementById('salario').value),
                porcentaje: parseFloat(document.getElementById('porcentajeBono').value),
                pve: parseFloat(document.getElementById('pvePresupuesto').value) || 0,
                keys: extraerKPIs('keys'),
                bonus: extraerKPIs('bonus'),
                additional: extraerKPIs('additional'),
                decreased: extraerKPIs('decreased')
            };

            if (!confirm(`¬øGuardar registro para ${lob}?`)) return;

            mostrarLoading('Guardando...');
            google.script.run.withSuccessHandler(function (r) {
                ocultarLoading();
                if (r.success) {
                    mostrarToast('‚úÖ Guardado exitosamente', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    mostrarToast('‚ùå ' + r.error, 'danger');
                }
            }).guardarRegistroMetricas(datos);
        }

        function extraerKPIs(tipo) {
            const kpis = [];
            document.querySelectorAll(`#tbody${capitalize(tipo)} tr`).forEach(row => {
                const nombre = row.querySelector('.kpi-nombre').value;
                if (nombre) {
                    kpis.push({
                        nombre,
                        comparacion: row.querySelector('.kpi-comparacion').value,
                        score: row.querySelector('.kpi-score').value,
                        porcentaje: row.querySelector('.kpi-porcentaje')?.value
                    });
                }
            });
            return kpis;
        }

        // ============================================================
        // üöÄ SIMULACI√ìN MASIVA UNIFICADA (OM + REPORTING ANALYST)
        // ============================================================

        // üî• FUNCI√ìN UNIFICADA: Detecta rol y ejecuta simulaci√≥n correspondiente
        function simularTodasLOBsUnificado() {
            if (!datosUsuario) {
                mostrarToast('‚ùå Usuario no cargado', 'danger');
                return;
            }

            const pveTotal = parseFloat(document.getElementById('simPVETotal').value) || 0;
            const porcPVE = parseFloat(document.getElementById('simPorcPVE').value) || 0;

            if (datosUsuario.rol === 'Reporting Analyst' || datosUsuario.rol === 'Audit') {
                // Simular por regi√≥n
                simularPorRegion(pveTotal, porcPVE);
            } else if (datosUsuario.rol === 'OM') {
                // Simular por OM
                simularPorOM(pveTotal, porcPVE);
            } else {
                mostrarToast('‚ùå Tu rol no permite simulaci√≥n masiva', 'warning');
            }
        }

        // üî• Simular para OM
        function simularPorOM(pveTotal, porcPVE) {
            mostrarLoading('Simulando todas tus LOBs...');

            const handler = function (response) {
                ocultarLoading();
                if (response.success) {
                    window.simulacionMasivaActual = response;
                    mostrarResultadosSimulacionMasiva(response);
                } else {
                    mostrarToast('‚ùå ' + response.error, 'danger');
                }
            };

            if (pveTotal > 0 && porcPVE > 0) {
                google.script.run.withSuccessHandler(handler)
                    .simularTodasLOBsPorOMConPVE(datosUsuario.nombre, pveTotal, porcPVE);
            } else {
                google.script.run.withSuccessHandler(handler)
                    .simularTodasLOBsPorOM(datosUsuario.nombre);
            }
        }

        // üî• Simular por Regi√≥n (Reporting Analyst)
        function simularPorRegion(pveTotal, porcPVE) {
            const region = document.getElementById('simSelectRegion').value;

            if (!region) {
                mostrarToast('‚ö†Ô∏è Selecciona una regi√≥n primero', 'warning');
                return;
            }

            mostrarLoading('Simulando LOBs de ' + region + '...');

            const handler = function (response) {
                ocultarLoading();
                if (response.success) {
                    window.simulacionMasivaActual = response;
                    mostrarResultadosSimulacionMasiva(response);
                } else {
                    mostrarToast('‚ùå ' + response.error, 'danger');
                }
            };

            if (pveTotal > 0 && porcPVE > 0) {
                google.script.run.withSuccessHandler(handler)
                    .simularTodasLOBsPorRegionConPVE(region, pveTotal, porcPVE);
            } else {
                google.script.run.withSuccessHandler(handler)
                    .simularTodasLOBsPorRegion(region);
            }
        }

        // üî• Filtrar LOBs por Regi√≥n (actualiza dropdown de LOBs)
        function filtrarLOBsPorRegion() {
            const region = document.getElementById('simSelectRegion').value;

            if (!region) {
                cargarLobsRegistradasEnSimulacion();
                return;
            }

            mostrarLoading('Cargando LOBs de ' + region + '...');

            google.script.run
                .withSuccessHandler(function (lobs) {
                    ocultarLoading();
                    const select = document.getElementById('simSelectLob');
                    select.innerHTML = '<option value="">-- Seleccione LOB --</option>';

                    if (lobs && lobs.length > 0) {
                        lobs.forEach(function (lob) {
                            select.appendChild(new Option(lob, lob));
                        });
                        mostrarToast('‚úÖ ' + lobs.length + ' LOBs en ' + region, 'success');
                    } else {
                        select.innerHTML = '<option value="">-- Sin LOBs registradas --</option>';
                        mostrarToast('‚ö†Ô∏è No hay LOBs con registros en ' + region, 'warning');
                    }
                })
                .withFailureHandler(function (err) {
                    ocultarLoading();
                    mostrarToast('‚ùå Error: ' + err, 'danger');
                })
                .obtenerLobsRegistradasPorRegion(region);
        }

        // Mantener compatibilidad con el nombre antiguo
        function simularTodasLOBsOM() {
            simularTodasLOBsUnificado();
        }

        function mostrarResultadosSimulacionMasiva(data) {
            const modal = document.getElementById('simulacionModal');
            const content = document.getElementById('contenidoSimulacion');

            // üî• T√≠tulo con regi√≥n o OM
            const titulo = data.region ?
                `üìä Simulaci√≥n Masiva: ${data.lobsProcesadas} LOBs de ${data.region}` :
                `üìä Simulaci√≥n Masiva: ${data.lobsProcesadas} LOBs de ${data.om || 'Usuario'}`;

            let html = `
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">${titulo}</h2>
            `;

            // üî• ESTADO DEL PRESUPUESTO PVE (si existe)
            if (data.estadoPresupuesto && data.pveConfig) {
                const estado = data.estadoPresupuesto;
                const pve = data.pveConfig;

                html += `
                <div style="background: ${estado.color || '#27ae60'}22; border: 2px solid ${estado.color || '#27ae60'}; 
                            padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="text-align: center; color: ${estado.color}; margin-bottom: 15px;">
                        ${estado.diferencia >= 0 ? '‚úÖ' : '‚ùå'} ${estado.texto}
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                        <div>
                            <div style="font-size: 0.8em; color: #666;">Presupuesto PVE</div>
                            <div style="font-size: 1.2em; font-weight: bold;">${formatearMoneda(pve.presupuestoDisponible)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8em; color: #666;">Inversi√≥n Total</div>
                            <div style="font-size: 1.2em; font-weight: bold;">${formatearMoneda(estado.inversionTotal)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8em; color: #666;">% Usado</div>
                            <div style="font-size: 1.2em; font-weight: bold; color: ${estado.color};">${estado.pctUsado}%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8em; color: #666;">Disponible</div>
                            <div style="font-size: 1.2em; font-weight: bold; color: ${estado.diferencia >= 0 ? '#27ae60' : '#e74c3c'};">
                                ${formatearMoneda(estado.diferencia)}
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }

            html += `
            <!-- Resumen General -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div style="background: #3498db; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.9em;">Total LOBs</div>
                    <div style="font-size: 1.5em; font-weight: bold;">${data.lobsProcesadas || 0}</div>
                </div>
                <div style="background: #2ecc71; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.9em;">Total Agentes</div>
                    <div style="font-size: 1.5em; font-weight: bold;">${data.resumen?.totalAgentes || 0}</div>
                </div>
                <div style="background: #9b59b6; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.9em;">Inversi√≥n Total</div>
                    <div style="font-size: 1.5em; font-weight: bold;">${formatearMoneda(data.resumen?.inversionTotal || 0)}</div>
                </div>
            </div>

            <!-- Tabla de Resultados -->
            <div style="overflow-x: auto;">
                <table class="kpi-table">
                    <thead>
                        <tr>
                            <th>LOB</th>
                            <th>HC</th>
                            <th>Salario Base</th>
                            <th>% Bono</th>
                            <th>Total Bono</th>
                            <th>Total Add.</th>
                            <th>Total LOB</th>
                            <th>Eficiencia</th>
                            ${data.pveConfig ? '<th>% PVE</th>' : ''}
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

            data.resultados.forEach(lob => {
                html += `
                <tr>
                    <td>${lob.lob || '-'}</td>
                    <td>${lob.hc || 0}</td>
                    <td>${formatearMoneda(lob.salarioBase)}</td>
                    <td>${lob.porcentajeBono || 0}%</td>
                    <td>${formatearMoneda(lob.totalBonus)}</td>
                    <td>${formatearMoneda(lob.totalAdditional)}</td>
                    <td style="font-weight: bold;">${formatearMoneda(lob.totalLOB)}</td>
                    <td>${lob.eficiencia || '0'}%</td>
                    ${data.pveConfig ? `<td style="color: ${(lob.pctDelPVE || 0) > 10 ? '#e74c3c' : '#27ae60'}; font-weight: bold;">${lob.pctDelPVE || 0}%</td>` : ''}
                    <td>
                        <button onclick="verDetalleLOB('${lob.lob}')" class="btn btn-primary" style="padding: 5px 10px; font-size: 0.8em;">
                            üîç Ver
                        </button>
                    </td>
                </tr>
            `;
            });

            html += `</tbody></table></div>`;

            // üî• AGREGAR AN√ÅLISIS Y COMPARADOR
            html += agregarAnalisisDistribucion(data);
            html += agregarComparadorEscenarios(data);

            // üî• BOTONES EXPORTAR Y ENVIAR CORREO
            html += `
            <div style="text-align: center; margin-top: 30px;">
                <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <button onclick="exportarSimulacionCompletaExcel(window.simulacionMasivaActual)" 
                            class="btn btn-success" style="font-size: 1.1em;">
                        üì• EXPORTAR REPORTE COMPLETO
                    </button>
                    <button onclick="togglePanelCorreo()" 
                            class="btn" style="font-size: 1.1em; background: #3498db; color: white;">
                        üìß ENVIAR POR CORREO
                    </button>
                </div>
                
                <!-- Panel de Correo Desplegable -->
                <div id="panelEnvioCorreo" style="display: none; margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: left;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">üìß Enviar Reporte por Correo</h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold;">Destinatarios:</label>
                        <div id="listaDestinatarios" style="margin-top: 10px;"></div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <input type="email" id="inputNuevoCorreo" class="form-control" 
                                   placeholder="correo@ejemplo.com" style="flex: 1;">
                            <button onclick="agregarDestinatario()" class="btn btn-primary" style="padding: 8px 15px;">
                                ‚ûï Agregar
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold;">Asunto:</label>
                        <input type="text" id="inputAsuntoCorreo" class="form-control" 
                               value="Reporte de Simulaci√≥n de Bonos - ${new Date().toLocaleDateString()}">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold;">Mensaje adicional (opcional):</label>
                        <textarea id="inputMensajeCorreo" class="form-control" rows="3" 
                                  placeholder="Adjunto el reporte de simulaci√≥n de bonos..."></textarea>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="enviarReportePorCorreo()" class="btn btn-success" style="padding: 12px 30px;">
                            ‚úâÔ∏è ENVIAR CORREO
                        </button>
                        <button onclick="togglePanelCorreo()" class="btn btn-secondary" style="padding: 12px 30px; margin-left: 10px;">
                            ‚ùå CANCELAR
                        </button>
                    </div>
                </div>
            </div>
        `;

            content.innerHTML = html;
            modal.style.display = 'block';
        }

        function verDetalleLOB(lobName) {
            const lobData = window.simulacionMasivaActual.resultados.find(l => l.lob === lobName);
            if (!lobData) return;

            // Necesitamos reconstruir la estructura 'data' que espera generarHTMLSimulacionConDetalle
            // Como simularTodasLOBsPorOM devuelve un resumen, idealmente deber√≠amos tener los KPIs detallados.
            // Si el backend devuelve los KPIs en 'resultados', perfecto. Si no, tendr√≠amos que consultar.
            // Asumiremos que simularTodasLOBsPorOM fue modificado para devolver KPIs o haremos una consulta r√°pida.
            // Para este caso, usaremos consultarEstructuraRegistrada si faltan datos, o mostraremos lo que hay.

            // Si faltan los KPIs en el objeto masivo, hacemos fetch:
            mostrarLoading('Cargando detalle...');
            google.script.run.withSuccessHandler(function (r) {
                ocultarLoading();
                if (r.encontrado) {
                    const html = generarHTMLSimulacionConDetalle(r, r.salario, r.porcentaje, (r.salario * r.porcentaje) / 100, lobData.hc);
                    // Mostrar en un modal secundario o reemplazar contenido
                    const content = document.getElementById('contenidoSimulacion');
                    content.innerHTML = `
                    <button onclick="mostrarResultadosSimulacionMasiva(window.simulacionMasivaActual)" class="btn btn-secondary" style="margin-bottom: 10px;">‚¨Ö Volver al Resumen</button>
                    ${html}
                `;
                }
            }).obtenerEstructuraRegistrada(lobName, lobData.mes);
        }

        // ============================================================
        // üéØ FUNCI√ìN CORREGIDA: MOSTRAR DETALLE ADICIONAL Y BONUS
        // ============================================================
        function generarHTMLSimulacionConDetalle(data, salario, porcentaje, bonoMaximo, hcCount) {
            let totalBonus = 0;
            let totalAdditional = 0;

            if (data.kpis?.bonusStructure) {
                data.kpis.bonusStructure.forEach(item => {
                    totalBonus += calcularMontoPorcentaje(item.porcentaje || 0, bonoMaximo);
                });
            }

            if (data.kpis?.additionalIncentives) {
                data.kpis.additionalIncentives.forEach(item => {
                    totalAdditional += calcularMontoPorcentaje(item.porcentaje || 0, bonoMaximo);
                });
            }

            const granTotal = totalBonus + totalAdditional;
            const eficiencia = bonoMaximo > 0 ? (granTotal / bonoMaximo) * 100 : 0;

            let html = `<div class="simulation-container">`;

            // Resumen Principal
            html += `
            <div class="summary-card" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div class="summary-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="summary-item"><strong>LOB:</strong> ${data.lob}</div>
                    <div class="summary-item"><strong>HC:</strong> ${hcCount}</div>
                    <div class="summary-item"><strong>Bono M√°x/Agente:</strong> ${formatearMoneda(bonoMaximo)}</div>
                    <div class="summary-item"><strong>Total Potencial:</strong> ${formatearMoneda(bonoMaximo * hcCount)}</div>
                </div>
            </div>
        `;

            // Indicador de Eficiencia
            html += `
            <div style="background: ${eficiencia >= 90 ? '#e8f5e9' : eficiencia >= 70 ? '#fff3e0' : '#ffebee'}; 
                        padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center;">
                <div style="font-size: 0.9em; color: #666;">üìä Eficiencia de Asignaci√≥n</div>
                <div style="font-size: 2.5em; font-weight: bold; 
                            color: ${eficiencia >= 90 ? '#27ae60' : eficiencia >= 70 ? '#f39c12' : '#e74c3c'};">
                    ${eficiencia.toFixed(1)}%
                </div>
            </div>
        `;

            // Detalle de KPIs
            html += `
            <div style="background: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">üìã Desglose Detallado</h3>
                
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #27ae60;">üí∞ Bonus Structure</h4>
                    ${data.kpis?.bonusStructure?.length > 0 ? generarTablaKPIsDetallada(data.kpis.bonusStructure, bonoMaximo, hcCount, 'bonus') : '<p>Sin KPIs</p>'}
                </div>
                
                <div>
                    <h4 style="color: #f39c12;">‚≠ê Additional Incentive</h4>
                    ${data.kpis?.additionalIncentives?.length > 0 ? generarTablaKPIsDetallada(data.kpis.additionalIncentives, bonoMaximo, hcCount, 'additional') : '<p>Sin KPIs</p>'}
                </div>
            </div>
        `;

            // Resumen Totales
            html += `
            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="text-align: center;">üìä Resumen Financiero</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                    <div>
                        <div>Bonus Structure</div>
                        <div style="font-size: 1.5em; font-weight: bold;">${formatearMoneda(totalBonus * hcCount)}</div>
                    </div>
                    <div>
                        <div>Additional</div>
                        <div style="font-size: 1.5em; font-weight: bold;">${formatearMoneda(totalAdditional * hcCount)}</div>
                    </div>
                    <div>
                        <div>TOTAL A PAGAR</div>
                        <div style="font-size: 2em; font-weight: bold;">${formatearMoneda(granTotal * hcCount)}</div>
                    </div>
                </div>
            </div>
        `;

            // Bot√≥n Editar
            html += `
            <div style="text-align: center; margin: 30px 0;">
                <button onclick="abrirEditorEstructura('${data.lob}', '${data.mes}')" 
                        class="btn btn-primary" style="padding: 15px 40px; font-size: 1.1em;">
                    ‚úèÔ∏è EDITAR ESTRUCTURA PARA NUEVO MES
                </button>
            </div>
        `;

            html += `</div>`;
            return html;
        }

        function generarTablaKPIsDetallada(kpis, bonoMaximo, hcCount, tipo) {
            const colorBorde = tipo === 'bonus' ? '#27ae60' : '#f39c12';
            let html = `<table class="kpi-table" style="border-left: 4px solid ${colorBorde};">
            <thead><tr><th>KPI</th><th>Meta</th><th>% Bono</th><th>Valor/Agente</th><th>Total x HC</th></tr></thead><tbody>`;

            let totalVal = 0;
            kpis.forEach(kpi => {
                const pct = parseFloat(kpi.porcentaje) || 0;
                const val = (bonoMaximo * pct) / 100;
                totalVal += val * hcCount;
                html += `<tr>
                <td>${kpi.nombre}</td>
                <td>${kpi.score || '-'}</td>
                <td>${pct.toFixed(2)}%</td>
                <td>${formatearMoneda(val)}</td>
                <td>${formatearMoneda(val * hcCount)}</td>
            </tr>`;
            });
            html += `</tbody></table>`;
            return html;
        }

        // ============================================================
        // üìä AN√ÅLISIS Y COMPARADOR
        // ============================================================
        function agregarAnalisisDistribucion(data) {
            // Top 5 LOBs
            const top5 = [...data.resultados].sort((a, b) => b.totalLOB - a.totalLOB).slice(0, 5);
            let topHtml = top5.map((l, i) => `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                <span>${i + 1}. ${l.lob}</span>
                <span style="font-weight: bold; color: #e74c3c;">${formatearMoneda(l.totalLOB)}</span>
            </div>
        `).join('');

            return `
            <div style="background: white; padding: 25px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">üîç An√°lisis de Distribuci√≥n</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <h4 style="color: #e74c3c; margin-bottom: 15px;">üèÜ Top 5 LOBs m√°s Costosas</h4>
                        ${topHtml}
                    </div>
                    <div style="padding: 15px; background: #fff3cd; border-left: 4px solid #f1c40f; border-radius: 5px;">
                        <h4 style="color: #d35400; margin-bottom: 10px;">üí° Recomendaciones</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #666;">
                            <li>Optimizar LOBs con eficiencia < 70%</li>
                            <li>Revisar KPIs de bajo impacto</li>
                        </ul>
                    </div>
                </div>
            </div>
        `;
        }

        function agregarComparadorEscenarios(data) {
            const escenarios = [
                { nombre: 'Conservador (-15%)', factor: 0.85, color: '#3498db' },
                { nombre: 'Actual', factor: 1, color: '#2ecc71' },
                { nombre: 'Agresivo (+20%)', factor: 1.20, color: '#e74c3c' }
            ];

            let html = `<div style="background: white; padding: 25px; border-radius: 10px; margin-top: 20px;">
            <h3 style="text-align: center; margin-bottom: 20px;">üîÑ Comparador de Escenarios</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">`;

            escenarios.forEach(esc => {
                const total = data.resumen.inversionTotal * esc.factor;
                html += `
                <div style="border: 2px solid ${esc.color}; border-radius: 10px; padding: 15px; text-align: center;">
                    <div style="font-weight: bold; color: ${esc.color};">${esc.nombre}</div>
                    <div style="font-size: 1.5em; font-weight: bold;">${formatearMoneda(total)}</div>
                </div>
            `;
            });

            html += `</div></div>`;
            return html;
        }

        // ============================================================
        // üì• EXPORTACI√ìN
        // ============================================================
        function exportarSimulacionCompletaExcel(data) {
            if (!data) return;
            mostrarLoading('Generando Excel...');

            const datosExportar = {
                encabezados: ['LOB', 'Mes', 'HC', 'Salario Base', '% Bono', 'Total Bonus', 'Total Additional', 'Total LOB', 'Eficiencia'],
                filas: data.resultados.map(l => [l.lob, l.mes, l.hc, l.salarioBase, l.porcentajeBono + '%', l.totalBonus, l.totalAdditional, l.totalLOB, l.eficiencia]),
                resumen: [['TOTAL', data.resumen.inversionTotal], ['AGENTES', data.resumen.totalAgentes]]
            };

            google.script.run.withSuccessHandler(function (url) {
                ocultarLoading();
                if (url) window.open(url, '_blank');
                else mostrarToast('‚úÖ Exportaci√≥n simulada (Placeholder)', 'success');
            }).exportarSimulacionAExcel(datosExportar);
        }

        // ============================================================
        // üìß FUNCIONES DE ENV√çO DE CORREO
        // ============================================================

        // Lista de destinatarios
        window.destinatariosCorreo = [];

        function togglePanelCorreo() {
            const panel = document.getElementById('panelEnvioCorreo');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                actualizarListaDestinatarios();
            } else {
                panel.style.display = 'none';
            }
        }

        function agregarDestinatario() {
            const input = document.getElementById('inputNuevoCorreo');
            const correo = input.value.trim();

            // Validar formato de correo
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(correo)) {
                mostrarToast('‚ö†Ô∏è Ingrese un correo v√°lido', 'warning');
                return;
            }

            // Verificar que no est√© duplicado
            if (window.destinatariosCorreo.includes(correo)) {
                mostrarToast('‚ö†Ô∏è Este correo ya est√° en la lista', 'warning');
                return;
            }

            window.destinatariosCorreo.push(correo);
            input.value = '';
            actualizarListaDestinatarios();
            mostrarToast('‚úÖ Destinatario agregado', 'success');
        }

        function eliminarDestinatario(correo) {
            window.destinatariosCorreo = window.destinatariosCorreo.filter(c => c !== correo);
            actualizarListaDestinatarios();
        }

        function actualizarListaDestinatarios() {
            const container = document.getElementById('listaDestinatarios');
            if (!container) return;

            if (window.destinatariosCorreo.length === 0) {
                container.innerHTML = '<span style="color: #999; font-style: italic;">No hay destinatarios agregados</span>';
                return;
            }

            let html = '';
            window.destinatariosCorreo.forEach(correo => {
                html += `
                <span style="display: inline-flex; align-items: center; background: #667eea; color: white; 
                            padding: 5px 10px; border-radius: 20px; margin: 3px; font-size: 0.9em;">
                    ${correo}
                    <button onclick="eliminarDestinatario('${correo}')" 
                            style="background: none; border: none; color: white; margin-left: 8px; cursor: pointer; font-size: 1.1em;">
                        √ó
                    </button>
                </span>
                `;
            });
            container.innerHTML = html;
        }

        function enviarReportePorCorreo() {
            // üî• A√±adir correo del usuario actual si no est√°
            const correoUsuario = datosUsuario.correo;
            const destinatariosFinales = [...window.destinatariosCorreo];

            if (correoUsuario && !destinatariosFinales.includes(correoUsuario)) {
                destinatariosFinales.push(correoUsuario);
            }

            // Si no hay destinatarios manuales, al menos se env√≠a al usuario
            if (destinatariosFinales.length === 0) {
                mostrarToast('‚ö†Ô∏è No hay destinatarios v√°lidos', 'warning');
                return;
            }

            const asunto = document.getElementById('inputAsuntoCorreo').value.trim();
            const mensaje = document.getElementById('inputMensajeCorreo').value.trim();

            if (!asunto) {
                mostrarToast('‚ö†Ô∏è El asunto no puede estar vac√≠o', 'warning');
                return;
            }

            const data = window.simulacionMasivaActual;
            if (!data) {
                mostrarToast('‚ùå No hay datos de simulaci√≥n para enviar', 'danger');
                return;
            }

            mostrarLoading('Enviando correo...');

            const datosCorreo = {
                destinatarios: destinatariosFinales,
                asunto: asunto,
                mensaje: mensaje,
                simulacion: window.simulacionMasivaActual
            };

            google.script.run
                .withSuccessHandler(function (response) {
                    ocultarLoading();
                    if (response.success) {
                        mostrarToast('‚úÖ Correo enviado exitosamente (incluyendo copia a ti mismo)', 'success');
                        window.destinatariosCorreo = [];
                        actualizarListaDestinatarios();
                        togglePanelCorreo();
                    } else {
                        mostrarToast('‚ùå Error: ' + response.error, 'danger');
                    }
                })
                .withFailureHandler(function (err) {
                    ocultarLoading();
                    mostrarToast('‚ùå Error al enviar: ' + err, 'danger');
                })
                .enviarReporteSimulacionPorCorreo(datosCorreo);
        }

        function actualizarTextoAyudaPVE(input) {
            const val = parseFloat(input.value) || 0;
            const helpText = document.getElementById('simPVETotalHelp');
            if (val > 0) {
                helpText.textContent = formatearMoneda(val);
                helpText.style.display = 'block';
            } else {
                helpText.style.display = 'none';
            }
        }

        // ============================================================
        // üîç VER ESTRUCTURA REGISTRADA
        // ============================================================
        function consultarEstructuraRegistrada() {
            const lob = document.getElementById('simSelectLob').value;
            const mes = document.getElementById('simSelectMes').value;

            if (!lob || !mes) {
                mostrarToast('‚ö†Ô∏è Seleccione LOB y Mes', 'warning');
                return;
            }

            mostrarLoading('Consultando estructura...');

            google.script.run
                .withSuccessHandler(function (response) {
                    ocultarLoading();
                    if (response.encontrado) {
                        window.estructuraActual = response;
                        mostrarEstructuraRegistrada(response);
                    } else {
                        mostrarToast('‚ùå ' + (response.mensaje || 'No se encontr√≥ estructura'), 'danger');
                    }
                })
                .withFailureHandler(function (err) {
                    ocultarLoading();
                    mostrarToast('‚ùå Error: ' + err, 'danger');
                })
                .obtenerEstructuraRegistrada(lob, mes, datosUsuario);
        }

        function mostrarEstructuraRegistrada(data) {
            // üî• MOSTRAR EN MODAL EN LUGAR DE ABAJO
            const modal = document.getElementById('simulacionModal');
            const content = document.getElementById('contenidoSimulacion');

            let html = `
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">üìã Estructura de ${data.lob} - ${data.mes}</h2>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div><strong>ACCM:</strong> ${data.accm || '-'}</div>
                    <div><strong>OM:</strong> ${data.om || '-'}</div>
                    <div><strong>HC:</strong> ${data.hc || '-'}</div>
                    <div><strong>Tipo:</strong> ${data.tipoHoja || data.hojaOrigen || '-'}</div>
                    <div><strong>Salario:</strong> ${formatearMoneda(data.salario || 0)}</div>
                    <div><strong>% Bono:</strong> ${data.porcentaje || 0}%</div>
                </div>
            </div>
            `;

            // Keys
            if (data.kpis?.keys?.length > 0) {
                html += `<h4 style="color: #3498db; margin-top: 20px;">üîë Keys</h4>
                <table class="kpi-table"><thead><tr><th>KPI</th><th>Score</th></tr></thead><tbody>`;
                data.kpis.keys.forEach(k => {
                    html += `<tr><td>${k.nombre}</td><td>${k.score || '-'}</td></tr>`;
                });
                html += `</tbody></table>`;
            }

            // Bonus Structure
            if (data.kpis?.bonusStructure?.length > 0) {
                html += `<h4 style="color: #27ae60; margin-top: 20px;">üí∞ Bonus Structure</h4>
                <table class="kpi-table"><thead><tr><th>KPI</th><th>Score</th><th>%</th></tr></thead><tbody>`;
                data.kpis.bonusStructure.forEach(k => {
                    html += `<tr><td>${k.nombre}</td><td>${k.score || '-'}</td><td>${k.porcentaje || 0}%</td></tr>`;
                });
                html += `</tbody></table>`;
            }

            // Additional
            if (data.kpis?.additionalIncentives?.length > 0) {
                html += `<h4 style="color: #f39c12; margin-top: 20px;">‚≠ê Additional Incentive</h4>
                <table class="kpi-table"><thead><tr><th>KPI</th><th>Score</th><th>%</th></tr></thead><tbody>`;
                data.kpis.additionalIncentives.forEach(k => {
                    html += `<tr><td>${k.nombre}</td><td>${k.score || '-'}</td><td>${k.porcentaje || 0}%</td></tr>`;
                });
                html += `</tbody></table>`;
            }

            // Decreased
            if (data.kpis?.decreasedKPIs?.length > 0) {
                html += `<h4 style="color: #e74c3c; margin-top: 20px;">üìâ Decreased</h4>
                <table class="kpi-table"><thead><tr><th>KPI</th><th>Score</th><th>%</th></tr></thead><tbody>`;
                data.kpis.decreasedKPIs.forEach(k => {
                    html += `<tr><td>${k.nombre}</td><td>${k.score || '-'}</td><td>${k.porcentaje || 0}%</td></tr>`;
                });
                html += `</tbody></table>`;
            }

            // Bot√≥n para editar
            html += `
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="abrirEditorEstructura('${data.lob}', '${data.mes}')" class="btn btn-primary" style="padding: 15px 40px;">
                    ‚úèÔ∏è EDITAR ESTRUCTURA PARA NUEVO MES
                </button>
            </div>
            `;

            content.innerHTML = html;
            modal.style.display = 'block';
        }

        // ============================================================
        // üí∞ ABRIR MODAL DE SIMULACI√ìN
        // ============================================================
        function abrirModalSimulacion() {
            const lob = document.getElementById('simSelectLob').value;
            const mes = document.getElementById('simSelectMes').value;

            if (!lob || !mes) {
                mostrarToast('‚ö†Ô∏è Seleccione LOB y Mes', 'warning');
                return;
            }

            mostrarLoading('Cargando simulaci√≥n...');

            google.script.run
                .withSuccessHandler(function (response) {
                    ocultarLoading();
                    if (response.encontrado) {
                        // Obtener salario (del input o del registro)
                        let salario = parseFloat(document.getElementById('simInputSalario').value) || response.salario || 0;
                        let porcentaje = parseFloat(document.getElementById('simInputPorcentaje').value) || response.porcentaje || 0;

                        if (salario === 0 || porcentaje === 0) {
                            mostrarToast('‚ö†Ô∏è Falta salario o % de bono. Configure en los campos.', 'warning');
                            return;
                        }

                        const bonoMaximo = (salario * porcentaje) / 100;
                        const hc = response.hc || 1;

                        // Generar HTML de simulaci√≥n
                        const html = generarHTMLSimulacionConDetalle(response, salario, porcentaje, bonoMaximo, hc);

                        document.getElementById('contenidoSimulacion').innerHTML = html;
                        document.getElementById('simulacionModal').style.display = 'block';
                    } else {
                        mostrarToast('‚ùå ' + (response.mensaje || 'No se encontr√≥ estructura'), 'danger');
                    }
                })
                .withFailureHandler(function (err) {
                    ocultarLoading();
                    mostrarToast('‚ùå Error: ' + err, 'danger');
                })
                .obtenerEstructuraRegistrada(lob, mes, datosUsuario);
        }

        // ============================================================
        // ‚úèÔ∏è EDITOR DE ESTRUCTURA COMPLETO
        // ============================================================
        function abrirEditorEstructura(lob, mes) {
            mostrarLoading('Cargando estructura para editar...');

            google.script.run
                .withSuccessHandler(function (response) {
                    ocultarLoading();
                    if (response.encontrado) {
                        // Cambiar a tab de registro
                        cambiarTab('registro');

                        // Llenar formulario con datos actuales
                        document.getElementById('selectLob').value = lob;

                        // Calcular mes siguiente
                        const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                        const mesActualIdx = meses.indexOf(mes);
                        const mesSiguiente = meses[(mesActualIdx + 1) % 12];

                        document.getElementById('mes').value = mesSiguiente;
                        document.getElementById('mesTexto').textContent = mesSiguiente;
                        document.getElementById('mesInfo').style.display = 'block';

                        // Llenar ACCM y OM
                        document.getElementById('accm').value = response.accm || '';
                        document.getElementById('om').value = response.om || '';

                        // Llenar salario y porcentaje
                        if (response.salario) document.getElementById('salario').value = response.salario;
                        if (response.porcentaje) document.getElementById('porcentajeBono').value = response.porcentaje;

                        // Determinar tipo de hoja
                        document.getElementById('tipoHoja').value = response.tipoHoja || response.hojaOrigen || 'Registro_pisos';

                        // Mostrar secciones
                        mostrarSeccionesConBotones();

                        // Llenar KPIs existentes
                        llenarKPIsEnFormulario(response.kpis);

                        // Calcular bono
                        calcularBonoMaximo();

                        mostrarToast('‚úÖ Estructura cargada para editar. Modifica y guarda.', 'success');

                        // Cerrar modal si est√° abierto
                        cerrarModalSimulacion();
                    } else {
                        mostrarToast('‚ùå No se pudo cargar la estructura', 'danger');
                    }
                })
                .withFailureHandler(function (err) {
                    ocultarLoading();
                    mostrarToast('‚ùå Error: ' + err, 'danger');
                })
                .obtenerEstructuraRegistrada(lob, mes, datosUsuario);
        }

        function llenarKPIsEnFormulario(kpis) {
            // Limpiar tablas existentes
            ['Keys', 'Bonus', 'Additional', 'Decreased'].forEach(tipo => {
                const tbody = document.getElementById('tbody' + tipo);
                if (tbody) tbody.innerHTML = '';
            });

            // Llenar Keys
            if (kpis?.keys) {
                kpis.keys.forEach(kpi => agregarFilaKPIConDatos('keys', kpi));
            }

            // Llenar Bonus
            if (kpis?.bonusStructure) {
                kpis.bonusStructure.forEach(kpi => agregarFilaKPIConDatos('bonus', kpi));
            }

            // Llenar Additional
            if (kpis?.additionalIncentives) {
                kpis.additionalIncentives.forEach(kpi => agregarFilaKPIConDatos('additional', kpi));
            }

            // Llenar Decreased
            if (kpis?.decreasedKPIs) {
                kpis.decreasedKPIs.forEach(kpi => agregarFilaKPIConDatos('decreased', kpi));
            }
        }

        function agregarFilaKPIConDatos(tipo, kpiData) {
            const tipoHoja = document.getElementById('tipoHoja').value || 'Registro_pisos';
            const tbody = document.getElementById('tbody' + capitalize(tipo));
            if (!tbody) return;

            // Verificar l√≠mites
            if (tbody.rows.length >= limites[tipoHoja][tipo]) return;

            const row = tbody.insertRow();
            let kpis = kpisDisponibles ? (kpisDisponibles[tipo === 'bonus' ? 'bonusStructure' : tipo === 'additional' ? 'additionalIncentives' : tipo === 'decreased' ? 'decreasedKPIs' : 'keys'] || []) : [];
            let opts = '<option value="">-- Seleccionar --</option>' + kpis.map(k => `<option value="${k}" ${k === kpiData.nombre ? 'selected' : ''}>${k}</option>`).join('');

            // Extraer comparaci√≥n del score si existe
            let score = kpiData.score || '';
            let comparacion = '>=';
            if (score.startsWith('<=')) { comparacion = '<='; score = score.substring(2); }
            else if (score.startsWith('>=')) { comparacion = '>='; score = score.substring(2); }
            else if (score.startsWith('<')) { comparacion = '<'; score = score.substring(1); }
            else if (score.startsWith('>')) { comparacion = '>'; score = score.substring(1); }
            else if (score.startsWith('=')) { comparacion = '='; score = score.substring(1); }

            let html = `<td><select class="kpi-nombre">${opts}</select></td>
                        <td><select class="kpi-comparacion">
                            <option value="<" ${comparacion === '<' ? 'selected' : ''}><</option>
                            <option value="<=" ${comparacion === '<=' ? 'selected' : ''}><=</option>
                            <option value=">" ${comparacion === '>' ? 'selected' : ''}>></option>
                            <option value=">=" ${comparacion === '>=' ? 'selected' : ''}>>=</option>
                            <option value="=" ${comparacion === '=' ? 'selected' : ''}>=</option>
                        </select></td>
                        <td><input type="number" class="kpi-score" step="0.01" value="${parseFloat(score) || ''}"></td>`;

            if (tipo !== 'keys') {
                html += `<td><input type="number" class="kpi-porcentaje" step="0.01" value="${parseFloat(kpiData.porcentaje) || ''}" oninput="actualizarIndicadorBono()"></td>`;
            }
            html += `<td><button type="button" class="btn-delete" onclick="eliminarFila(this)" style="background:none;border:none;cursor:pointer;">üóëÔ∏è</button></td>`;
            row.innerHTML = html;
        }

        // ============================================================
        // üîÑ CARGAR SALARIO AUTO EN SIMULACI√ìN
        // ============================================================
        function cargarSalarioEnSimulacion() {
            const lob = document.getElementById('simSelectLob').value;
            if (!lob) return;

            google.script.run
                .withSuccessHandler(function (config) {
                    if (config && config.encontrado) {
                        document.getElementById('simInputSalario').value = config.salario || '';
                        document.getElementById('simInputPorcentaje').value = config.porcentaje || '';
                        document.getElementById('simInputSalario').placeholder = formatearMoneda(config.salario);
                        document.getElementById('simInputPorcentaje').placeholder = config.porcentaje + '%';
                    }
                })
                .obtenerSalarioPorLob(lob);
        }

        // Helpers
        function mostrarLoading(txt) { document.getElementById('loadingOverlay').style.display = 'flex'; document.getElementById('loadingText').textContent = txt; }
        function ocultarLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }
        function cerrarModalSimulacion() { document.getElementById('simulacionModal').style.display = 'none'; }
        function mostrarToast(msg, type) {
            const t = document.getElementById('toast');
            t.className = 'toast show ' + type;
            document.getElementById('toastMessage').textContent = msg;
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        function formatearMoneda(val) { return '$' + (val || 0).toLocaleString('es-CO', { minimumFractionDigits: 0 }); }
        function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
        function calcularMontoPorcentaje(pct, max) { return (max * pct) / 100; }
        function calcularBonoMaximo() {
            const s = parseFloat(document.getElementById('salario').value) || 0;
            const p = parseFloat(document.getElementById('porcentajeBono').value) || 0;
            const max = (s * p) / 100;
            document.getElementById('bonoMaximoTexto').textContent = formatearMoneda(max);
            document.getElementById('bonoIndicator').style.display = max > 0 ? 'block' : 'none';
            actualizarIndicadorBono();
        }
        function actualizarIndicadorBono() {
            let total = 0;
            document.querySelectorAll('#tbodyBonus .kpi-porcentaje').forEach(i => total += parseFloat(i.value) || 0);
            const bar = document.getElementById('progressBar');
            if (bar) {
                bar.style.width = Math.min(total, 100) + '%';
                bar.textContent = total.toFixed(1) + '%';
            }
            const asignado = document.getElementById('porcentajeAsignadoTexto');
            const disponible = document.getElementById('porcentajeDisponibleTexto');
            if (asignado) asignado.textContent = total.toFixed(1) + '%';
            if (disponible) disponible.textContent = Math.max(0, 100 - total).toFixed(1) + '%';
            const s = parseFloat(document.getElementById('salario').value) || 0;
            const p = parseFloat(document.getElementById('porcentajeBono').value) || 0;
            const montoAsignado = document.getElementById('montoAsignadoTexto');
            if (montoAsignado) montoAsignado.textContent = formatearMoneda((s * p * total) / 10000);
        }
        function calcularPresupuestoPVE() {
            const t = parseFloat(document.getElementById('simPVETotal').value) || 0;
            const p = parseFloat(document.getElementById('simPorcPVE').value) || 0;
            const res = (t * p) / 100;
            document.getElementById('simPresupuestoDisponible').value = formatearMoneda(res);
            document.getElementById('alertaPVE').style.display = res > 0 ? 'block' : 'none';
        }
        function actualizarLimites() { /* Ya manejado */ }
        function aplicarFiltrosSimulacion() { /* Pendiente */ }
        function limpiarFiltros() { /* Pendiente */ }


        // ============================================================
        // üß≠ NAVEGACI√ìN
        // ============================================================
        function navegarAModulo() {
            const modulo = document.getElementById('navModuloSelect').value;
            if (!modulo) {
                mostrarToast('‚ö†Ô∏è Seleccione un m√≥dulo primero', 'warning');
                return;
            }

            mostrarLoading('Redirigiendo...');

            google.script.run
                .withSuccessHandler(function (url) {
                    if (url) {
                        const separator = url.includes('?') ? '&' : '?';
                        window.top.location.href = url + separator + 'page=' + modulo;
                    } else {
                        ocultarLoading();
                        mostrarToast('‚ùå Error al obtener URL', 'danger');
                    }
                })
                .withFailureHandler(function (err) {
                    ocultarLoading();
                    mostrarToast('‚ùå Error de red: ' + err, 'danger');
                })
                .getUrl();
        }
        // ============================================================
        // üîÑ CAMBIAR TIPO DE ACCESO
        // ============================================================
        function cambiarTipoAccesoUsuario() {
            const select = document.getElementById('tipoAccesoSelect');
            const statusSpan = document.getElementById('tipoAccesoStatus');

            if (!select) {
                console.error('‚ùå No se encontr√≥ el select de tipo de acceso');
                mostrarToast('‚ùå Error: No se encontr√≥ el selector', 'danger');
                return;
            }

            const tipoAcceso = select.value;
            console.log('üîÑ Cambiando tipo de acceso a:', tipoAcceso);

            // Validar selecci√≥n
            if (!tipoAcceso || tipoAcceso === '') {
                mostrarToast('‚ö†Ô∏è Por favor selecciona un tipo de acceso', 'warning');
                return;
            }

            // Deshabilitar bot√≥n temporalmente
            const boton = event.target;
            if (boton && boton.tagName === 'BUTTON') {
                boton.disabled = true;
                boton.textContent = '‚è≥ Procesando...';
            }

            // Usar correo del usuario actual
            const email = datosUsuario.correo || (document.getElementById('correoUsuario') ? document.getElementById('correoUsuario').textContent : '');

            mostrarLoading(`Cambiando acceso a ${tipoAcceso}...`);

            google.script.run
                .withSuccessHandler(function (response) {
                    ocultarLoading();

                    if (response.success) {
                        mostrarToast('‚úÖ Tipo de acceso cambiado a: ' + tipoAcceso + '. Recargando...', 'success');

                        setTimeout(function () {
                            // Recargar para aplicar cambios
                            google.script.run.withSuccessHandler(function (url) {
                                if (url) window.top.location.href = url + '?page=' + tipoAcceso;
                                else window.top.location.reload();
                            }).getUrl();
                        }, 1500);

                    } else {
                        mostrarToast('‚ùå Error: ' + response.error, 'danger');
                        if (boton && boton.tagName === 'BUTTON') {
                            boton.disabled = false;
                            boton.textContent = 'üîÑ Cambiar';
                        }
                    }
                })
                .withFailureHandler(function (error) {
                    ocultarLoading();
                    if (boton && boton.tagName === 'BUTTON') {
                        boton.disabled = false;
                        boton.textContent = 'üîÑ Cambiar';
                    }
                    mostrarToast('‚ùå Error de conexi√≥n: ' + error.message, 'danger');
                })
                .cambiarTipoAcceso(email, tipoAcceso);
        }
    </script>
</body>

</html>