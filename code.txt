/*

// Código.gs - Sistema de Gestión de Llamadas OPTIMIZADO V2
// CONSTANTES
var FOLDER_ID = '1SrPxDlsXxd-ohwiYh1QSaQx8R60kdji3'; // REEMPLAZAR CON TU ID DE CARPETA SI ES DIFERENTE
var SHEET_CALLS = 'Calls';
var SHEET_DATA = 'Data';
function doGet() {
  return HtmlService.createHtmlOutputFromFile('Index')
      .setTitle('Sistema de Gestión de Llamadas')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
// ==================== HELPERS ====================
function getSpreadsheet() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    if (ss) return ss;
  } catch (e) {
    Logger.log('No se pudo obtener ActiveSpreadsheet: ' + e.toString());
  }
  // Si es un script independiente (Standalone), buscamos o creamos la hoja
  var props = PropertiesService.getScriptProperties();
  var ssId = props.getProperty('SS_ID');
  if (ssId) {
    try {
      return SpreadsheetApp.openById(ssId);
    } catch (e) {
      Logger.log('No se pudo abrir Spreadsheet por ID guardado: ' + e.toString());
    }
  }
  // Si no existe, creamos una nueva
  try {
    var ss = SpreadsheetApp.create("DB_Gestion_Llamadas");
    props.setProperty('SS_ID', ss.getId());
    return ss;
  } catch (e) {
    Logger.log('Error creando nueva Spreadsheet: ' + e.toString());
    throw new Error('No se pudo acceder ni crear la base de datos (Spreadsheet).');
  }
}
// ==================== FUNCIÓN DE PRUEBA ====================
function testConexion() {
  return {
    success: true,
    message: 'Conexión OK',
    timestamp: new Date()
  };
}
// ==================== SUBIR ARCHIVOS ====================
function uploadFile(base64Data, fileName, mimeType, agentId, userEmail) {
  try {
    var folder = DriveApp.getFolderById(FOLDER_ID);
    var data = Utilities.base64Decode(base64Data);
    var blob = Utilities.newBlob(data, mimeType, fileName);
    var file = folder.createFile(blob);
    var fileId = file.getId();
    var fileUrl = file.getUrl();
    
    var ss = getSpreadsheet();
    var sheetCalls = ss.getSheetByName(SHEET_CALLS);
    
    if (!sheetCalls) {
      sheetCalls = ss.insertSheet(SHEET_CALLS);
      sheetCalls.appendRow([
        'Timestamp', 'Agent ID (CCM)', 'Agent Name', 'Supervisor',
        'File Name', 'File ID', 'File URL', 'Uploaded By', 'File Size (MB)', 'Type'
      ]);
    }
    
    var sheetData = ss.getSheetByName(SHEET_DATA);
    var agentName = '';
    var supervisor = '';
    
    if (sheetData) {
      var dataValues = sheetData.getDataRange().getValues();
      for (var i = 1; i < dataValues.length; i++) {
        var row = dataValues[i];
        var ccmId = row[16];
        if (ccmId && ccmId.toString().trim() === agentId.toString().trim()) {
          agentName = row[22] || 'Sin nombre';
          supervisor = row[21] || 'Sin supervisor';
          break;
        }
      }
    }
    
    if (!agentName) agentName = 'Agente ' + agentId;
    
    var timestamp = new Date();
    var fileSize = (file.getSize() / (1024 * 1024)).toFixed(2);
    var newFileName = agentName + ' - ' + agentId + '.' + fileName.split('.').pop();
    file.setName(newFileName);
    
    sheetCalls.appendRow([
      timestamp, agentId, agentName, supervisor, newFileName,
      fileId, fileUrl, userEmail, fileSize, mimeType
    ]);
    
    return {
      success: true,
      fileId: fileId,
      fileUrl: fileUrl,
      fileName: newFileName,
      message: 'Archivo subido exitosamente como: ' + newFileName
    };
    
  } catch (error) {
    return {
      success: false,
      message: 'Error al subir archivo: ' + error.toString()
    };
  }
}
// ==================== BUSCAR LLAMADAS POR AGENTE ====================
function buscarLlamadasPorAgente(agentId) {
  try {
    var ss = getSpreadsheet();
    var sheetData = ss.getSheetByName(SHEET_DATA);
    
    var agenteInfo = null;
    var agentIdStr = agentId.toString().trim();
    
    if (sheetData) {
      var dataValues = sheetData.getDataRange().getValues();
      for (var i = 1; i < dataValues.length; i++) {
        var row = dataValues[i];
        var ccmId = row[16] ? row[16].toString().trim() : '';
        if (ccmId === agentIdStr) {
          agenteInfo = {
            ccm: row[16],
            agente: row[22] || 'Sin nombre',
            supervisor: row[21] || 'Sin supervisor'
          };
          break;
        }
      }
    }
    
    if (!agenteInfo) {
      agenteInfo = {
        ccm: agentIdStr,
        agente: 'Agente ' + agentIdStr,
        supervisor: 'Sin supervisor'
      };
    }
    
    var sheetCalls = ss.getSheetByName(SHEET_CALLS);
    var llamadas = [];
    
    if (sheetCalls && sheetCalls.getLastRow() > 1) {
      var callsValues = sheetCalls.getRange(2, 1, sheetCalls.getLastRow() - 1, 10).getValues();
      for (var i = 0; i < callsValues.length; i++) {
        var row = callsValues[i];
        var callAgentId = row[1] ? row[1].toString().trim() : '';
        if (callAgentId === agentIdStr) {
          llamadas.push({
            timestamp: row[0],
            agentId: row[1],
            agentName: row[2],
            supervisor: row[3],
            fileName: row[4],
            fileId: row[5],
            fileUrl: row[6],
            uploadedBy: row[7],
            fileSize: row[8],
            type: row[9]
          });
        }
      }
    }
    
    return {
      success: true,
      agente: agenteInfo,
      llamadas: llamadas,
      message: 'Se encontraron ' + llamadas.length + ' llamada(s)'
    };
    
  } catch (error) {
    return {
      success: false,
      message: 'Error al buscar llamadas: ' + error.toString()
    };
  }
}
// ==================== OBTENER TODAS LAS LLAMADAS ====================
function obtenerTodasLasLlamadas(forzarSincronizacion) {
  try {
    Logger.log('Iniciando obtenerTodasLasLlamadas');
    
    var ss = getSpreadsheet();
    var sheetCalls = ss.getSheetByName(SHEET_CALLS);
    
    if (!sheetCalls) {
      sheetCalls = ss.insertSheet(SHEET_CALLS);
      sheetCalls.appendRow(['Timestamp','Agent ID','Agent Name','Supervisor','File Name','File ID','File URL','Uploaded By','Size','Type']);
    }
    
    // Auto-sync si está vacío o si se fuerza
    var lastRow = sheetCalls.getLastRow();
    if (lastRow <= 1 || forzarSincronizacion === true) {
      buscarArchivosManualDrive(); // Sincronizamos
      lastRow = sheetCalls.getLastRow(); // Actualizamos lastRow
    }
    
    if (lastRow <= 1) {
      return {
        success: true,
        llamadas: [],
        total: 0,
        message: 'No hay llamadas registradas (carpeta escaneada)'
      };
    }
    
    var allValues = sheetCalls.getRange(2, 1, lastRow - 1, 10).getValues();
    var llamadas = [];
    
    for (var i = 0; i < allValues.length; i++) {
      var row = allValues[i];
      if (row[4]) {
        // Asegurar que timestamp sea seguro para JSON
        var ts = row[0];
        if (ts instanceof Date) {
          ts = ts.toISOString();
        } else {
          ts = new Date().toISOString(); 
        }
        llamadas.push({
          timestamp: ts,
          agentId: row[1] ? row[1].toString() : 'DESCONOCIDO',
          agentName: row[2] || 'Sin nombre',
          supervisor: row[3] || 'Sin supervisor',
          fileName: row[4],
          fileId: row[5] || '',
          fileUrl: row[6] || '',
          uploadedBy: row[7] || 'Desconocido',
          fileSize: row[8] || '0',
          type: row[9] || 'audio/mpeg'
        });
      }
    }
    
    // Ordenar descendente
    llamadas.sort(function(a, b) {
      return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime();
    });
    
    return {
      success: true,
      llamadas: llamadas,
      total: llamadas.length,
      message: 'Se encontraron ' + llamadas.length + ' llamada(s)'
    };
    
  } catch (error) {
    Logger.log('ERROR en obtenerTodasLasLlamadas: ' + error.toString());
    return {
      success: false,
      message: 'Error interno: ' + error.toString(),
      llamadas: [],
      total: 0
    };
  }
}
// ==================== BUSCAR ARCHIVOS MANUALES EN DRIVE ====================
function buscarArchivosManualDrive() {
  try {
    var folder = DriveApp.getFolderById(FOLDER_ID);
    var files = folder.getFiles();
    var ss = getSpreadsheet();
    
    var sheetCalls = ss.getSheetByName(SHEET_CALLS);
    if (!sheetCalls) {
      sheetCalls = ss.insertSheet(SHEET_CALLS);
      sheetCalls.appendRow(['Timestamp','Agent ID','Agent Name','Supervisor','File Name','File ID','File URL','Uploaded By','Size','Type']);
    }
    
    var sheetData = ss.getSheetByName(SHEET_DATA);
    var agentesMap = {};
    
    if (sheetData) {
      var dataValues = sheetData.getRange(2, 1, sheetData.getLastRow() - 1, 23).getValues();
      for (var i = 0; i < dataValues.length; i++) {
        var ccm = dataValues[i][16] ? dataValues[i][16].toString().trim() : '';
        if (ccm) {
          agentesMap[ccm] = {
            nombre: dataValues[i][22] || '',
            supervisor: dataValues[i][21] || ''
          };
        }
      }
    }
    
    var idsRegistrados = {};
    if (sheetCalls.getLastRow() > 1) {
      var existingIds = sheetCalls.getRange(2, 6, sheetCalls.getLastRow() - 1, 1).getValues();
      for (var i = 0; i < existingIds.length; i++) {
        if (existingIds[i][0]) {
          idsRegistrados[existingIds[i][0]] = true;
        }
      }
    }
    
    var archivosNuevos = 0;
    while (files.hasNext()) {
      var file = files.next();
      var fileId = file.getId();
      
      if (idsRegistrados[fileId]) continue;
      
      var fileName = file.getName();
      var ccmId = '';
      var agentName = '';
      var supervisor = 'Manual Upload';
      var mimeType = file.getMimeType();
      
      // Intentar extraer info del nombre
      var match = fileName.match(/^(.+?)\s*[-–]\s*(\d+)/);
      if (match) {
        agentName = match[1].trim();
        ccmId = match[2].trim();
        if (agentesMap[ccmId]) {
          supervisor = agentesMap[ccmId].supervisor || supervisor;
          agentName = agentesMap[ccmId].nombre || agentName;
        }
      } else {
        // Fallback: usar nombre sin extensión
        agentName = fileName.replace(/\.(mp3|mp4|wav|m4a)$/i, '').trim();
        ccmId = 'DESCONOCIDO';
      }
      
      try {
        sheetCalls.appendRow([
          file.getDateCreated(), 
          ccmId, 
          agentName, 
          supervisor, 
          fileName,
          fileId, 
          file.getUrl(), 
          'Auto Sync',
          (file.getSize() / (1024 * 1024)).toFixed(2), 
          mimeType
        ]);
        archivosNuevos++;
      } catch (e) {
        // Ignorar error individual
      }
    }
    
    return {
      success: true,
      message: 'Sincronización completada. Nuevos: ' + archivosNuevos,
      archivosNuevos: archivosNuevos
    };
    
  } catch (error) {
    Logger.log('Error Sync: ' + error.toString());
    return {
      success: false,
      message: 'Error en sync: ' + error.toString()
    };
  }
}
// ==================== OBTENER TODOS LOS AGENTES ====================
function obtenerTodosLosAgentes() {
  try {
    var ss = getSpreadsheet();
    var sheetData = ss.getSheetByName(SHEET_DATA);
    
    if (!sheetData) return [];
    
    var dataValues = sheetData.getDataRange().getValues();
    var agentes = [];
    var agentesMap = {};
    
    for (var i = 1; i < dataValues.length; i++) {
      var row = dataValues[i];
      var ccmId = row[16];
      var agentName = row[22];
      var supervisor = row[21];
      
      if (ccmId && ccmId.toString().trim() !== '') {
        var ccmKey = ccmId.toString().trim();
        if (!agentesMap[ccmKey]) {
          agentesMap[ccmKey] = {
            ccm: ccmKey,
            nombre: agentName || 'Sin nombre',
            supervisor: supervisor || 'Sin supervisor'
          };
        }
      }
    }
    
    for (var key in agentesMap) {
      agentes.push(agentesMap[key]);
    }
    
    agentes.sort(function(a, b) {
      return a.nombre.localeCompare(b.nombre);
    });
    
    return agentes;
    
  } catch (error) {
    return [];
  }
}
// ==================== OBTENER EMAIL DEL USUARIO ====================
function obtenerEmailUsuario() {
  try {
    return Session.getActiveUser().getEmail() || 'usuario@desconocido.com';
  } catch (error) {
    return 'usuario@desconocido.com';
  }
}
// ==================== ELIMINAR LLAMADA ====================
function eliminarLlamada(fileId, agentId, fileName) {
  try {
    var file = DriveApp.getFileById(fileId);
    file.setTrashed(true);
    
    var ss = getSpreadsheet();
    var sheetCalls = ss.getSheetByName(SHEET_CALLS);
    
    if (sheetCalls) {
      var values = sheetCalls.getDataRange().getValues();
      for (var i = values.length - 1; i >= 1; i--) {
        if (values[i][5] === fileId) {
          sheetCalls.deleteRow(i + 1);
          break;
        }
      }
    }
    
    return { success: true, message: 'Llamada eliminada' };
  } catch (error) {
    return { success: false, message: 'Error: ' + error.toString() };
  }
}
// ==================== INICIALIZACIÓN ====================
function initSystem() {
  try {
    var ss = getSpreadsheet();
    var sheetCalls = ss.getSheetByName(SHEET_CALLS);
    if (!sheetCalls) {
      sheetCalls = ss.insertSheet(SHEET_CALLS);
      sheetCalls.appendRow([
        'Timestamp', 'Agent ID (CCM)', 'Agent Name', 'Supervisor',
        'File Name', 'File ID', 'File URL', 'Uploaded By', 'File Size (MB)', 'Type'
      ]);
    }
    return { success: true, message: 'Inicializado. ID hoja: ' + ss.getId() };
  } catch (error) {
    return { success: false, message: 'Error init: ' + error.toString() };
  }
}


*/
