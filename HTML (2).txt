<!DOCTYPE html>
<!--
=====================================================
Index.html - Dashboard de M√©tricas
=====================================================
Descripci√≥n: Frontend del dashboard que muestra m√©tricas
agrupadas por WOW (semana), MOM (mes), DOD (d√≠a), adem√°s
de un ranking de agentes y an√°lisis de mejores tiempos.

Pesta√±as:
- WOW: M√©tricas agrupadas por semana
- MOM: M√©tricas agrupadas por mes
- DOD: M√©tricas agrupadas por d√≠a
- OTROS: Ranking de agentes (carga con bot√≥n)
- AN√ÅLISIS: Mejores d√≠as y horas (carga con bot√≥n)

Librer√≠as:
- Chart.js: Para gr√°ficos de barras y l√≠neas combinados
=====================================================
-->
<html>

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de M√©tricas</title>
    <!-- Librer√≠a Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ============================================
           ESTILOS GLOBALES
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Contenedor principal */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        /* ============================================
           HEADER
           ============================================ */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* ============================================
           SECCI√ìN DE FILTROS
           ============================================ */
        .filters-section {
            background: #f8f9fa;
            padding: 25px;
            border-bottom: 3px solid #667eea;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
            font-size: 0.9em;
        }

        .filter-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .filters-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        /* ============================================
           BOTONES
           ============================================ */
        .btn {
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-clear {
            background: #e74c3c;
            color: white;
        }

        .btn-apply {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* ============================================
           TARJETAS DE M√âTRICAS
           ============================================ */
        .metrics-section {
            padding: 25px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .metric-card h3 {
            font-size: 2.5em;
            font-weight: 700;
        }

        /* ============================================
           PESTA√ëAS (TABS)
           ============================================ */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            min-width: 140px;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* ============================================
           ACORDEONES (DETAILS/SUMMARY)
           ============================================ */
        details {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }

        summary {
            background: #f1f2f6;
            padding: 15px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1em;
            list-style: none;
            display: flex;
            justify-content: space-between;
        }

        summary::-webkit-details-marker {
            display: none;
        }

        summary:after {
            content: '+';
            font-size: 1.5em;
            color: #667eea;
        }

        details[open] summary:after {
            content: '‚àí';
        }

        .details-content {
            padding: 20px;
        }

        /* ============================================
           GR√ÅFICOS
           ============================================ */
        .chart-wrapper {
            position: relative;
            height: 500px;
            width: 100%;
            margin-bottom: 30px;
        }

        /* ============================================
           TABLAS
           ============================================ */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        thead {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        th,
        td {
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            text-align: center;
            white-space: nowrap;
        }

        td:first-child {
            font-weight: 700;
            background: #f8f9fa;
            color: #667eea;
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 1;
        }

        /* ============================================
           LOADING OVERLAY
           ============================================ */
        #global-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* ============================================
           BOTONES DE CARGA BAJO DEMANDA
           ============================================ */
        .load-section {
            text-align: center;
            padding: 50px 20px;
        }

        .load-section h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .load-section p {
            color: #666;
            margin-bottom: 25px;
        }

        .btn-load {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            font-size: 1.2em;
            padding: 15px 40px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-load:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(39, 174, 96, 0.4);
        }

        .btn-load:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .inline-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        /* ============================================
           TARJETAS DE AN√ÅLISIS
           ============================================ */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .analysis-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-top: 5px solid #667eea;
        }

        .analysis-card.day {
            border-top-color: #27ae60;
        }

        .analysis-card.hour {
            border-top-color: #f39c12;
        }

        .analysis-card.combo {
            border-top-color: #9b59b6;
        }

        .analysis-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .analysis-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .analysis-value {
            font-size: 2em;
            font-weight: 700;
            color: #2c3e50;
        }

        .analysis-count {
            color: #667eea;
            font-size: 1.1em;
            font-weight: 600;
            margin-top: 5px;
        }

        /* Tablas de detalle */
        .detail-table {
            margin-top: 30px;
        }

        .detail-table h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <!-- ============================================
         OVERLAY DE CARGA
         ============================================ -->
    <div id="global-loading">
        <div class="spinner"></div>
        <h2 style="color:#667eea">Cargando...</h2>
    </div>

    <!-- ============================================
         CONTENEDOR PRINCIPAL
         ============================================ -->
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>üìä Dashboard de M√©tricas</h1>
            <p>An√°lisis WOW, MOM, DOD + Ranking + Tiempos</p>
        </div>

        <!-- SECCI√ìN DE FILTROS -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Month (T)</label>
                    <select id="filterBegin">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Country (I)</label>
                    <select id="filterI">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Stage (K)</label>
                    <select id="filterK">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Outreach Type (L)</label>
                    <select id="filterOutreachType">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Status (N)</label>
                    <select id="filterStatus">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Supervisor (V)</label>
                    <select id="filterSupervisor">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Agent (W)</label>
                    <select id="filterAgent">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Case Owner (J)</label>
                    <select id="filterCaseOwner">
                        <option value="">Todos</option>
                    </select>
                </div>
            </div>
            <div class="filters-actions">
                <button class="btn btn-clear" onclick="limpiarFiltros()">üßπ Limpiar</button>
                <button class="btn btn-apply" onclick="aplicarFiltros()">üîç Aplicar</button>
            </div>
        </div>

        <!-- TARJETAS DE M√âTRICAS -->
        <div class="metrics-section">
            <div class="metrics-grid">
                <div class="metric-card">
                    <h3 id="metricFT">-</h3>
                    <p>FT Cases</p>
                </div>
                <div class="metric-card">
                    <h3 id="metricCases">-</h3>
                    <p>Total Cases</p>
                </div>
                <div class="metric-card">
                    <h3 id="metricCT">-</h3>
                    <p>CT Average</p>
                </div>
                <div class="metric-card">
                    <h3 id="metricCR">-</h3>
                    <p>CR Average</p>
                </div>
            </div>
        </div>

        <!-- NAVEGACI√ìN POR PESTA√ëAS -->
        <div class="tabs">
            <button class="tab active" onclick="cambiarTab('wow')">WOW</button>
            <button class="tab" onclick="cambiarTab('mom')">MOM</button>
            <button class="tab" onclick="cambiarTab('dod')">DOD</button>
            <button class="tab" onclick="cambiarTab('ranking')">üèÜ OTROS</button>
            <button class="tab" onclick="cambiarTab('analisis')">üìà AN√ÅLISIS</button>
        </div>

        <!-- CONTENIDO DE CADA PESTA√ëA -->
        <div id="wow" class="tab-content active"></div>
        <div id="mom" class="tab-content"></div>
        <div id="dod" class="tab-content"></div>
        <div id="ranking" class="tab-content"></div>
        <div id="analisis" class="tab-content"></div>
    </div>

    <!-- ============================================
         JAVASCRIPT
         ============================================ -->



<script>
    // ============================================
    // VARIABLES GLOBALES
    // ============================================
    var charts = {};           // Almacena instancias de Chart.js
    var dashboardData = null;  // Datos procesados actuales
    var rawDataGlobal = [];    // Data cruda (Cache Cliente)
    var initialDashboardData = null; // Snapshot inicial sin filtros

    // INYECCI√ìN DE DATOS DEL SERVIDOR
    var serverPayload = null;
    try {
        serverPayload = <?!= payload ?>;
    } catch (e) {
        console.log('No payload found (development mode?)');
    }

    // Mapeo de √≠ndices de columnas (Igual que en Backend)
    var COLS = {
        CASE: 0, DATE: 1, COUNTRY: 2, OWNER: 3, STAGE: 4, OUTREACH: 5, STATUS: 6,
        WEEK: 7, MONTH: 8, SUP: 9, AGENT: 10, TRIP_DATE: 11, FT: 12, TRIP_HOUR: 13, CR: 14, CT: 15
    };

    // ============================================
    // INICIALIZACI√ìN ULTRA R√ÅPIDA
    // ============================================
    window.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Inicializando Dashboard...');
        
        if (serverPayload) {
            initFromPayload(serverPayload);
        } else {
            console.warn('‚ö†Ô∏è No hay payload del servidor');
        }
    });

    /**
     * Inicializa el dashboard con datos precargados (Instant√°neo)
     */
    function initFromPayload(data) {
        console.time('‚ö° Init Dashboard');
        
        // 1. Guardar RAW DATA
        if (data.rawData) {
            rawDataGlobal = data.rawData;
            console.log('üì¶ Raw Data Loaded: ' + rawDataGlobal.length + ' filas');
        }

        // 2. Llenar Filtros (Instant√°neo - ya vienen del servidor)
        if (data.filters) {
            fillFiltersInstant(data.filters);
        }

        // 3. Procesar Dashboard Inicial (sin filtros)
        if (rawDataGlobal.length > 0) {
            dashboardData = procesarDatos(rawDataGlobal);
            initialDashboardData = dashboardData; // Guardar snapshot inicial
            renderDashboard();
        }

        console.timeEnd('‚ö° Init Dashboard');
        console.log('‚úÖ Dashboard listo para usar');
    }

    /**
     * Llena los filtros de forma instant√°nea (sin llamadas as√≠ncronas)
     */
    function fillFiltersInstant(filters) {
        var map = {
            'T': 'filterBegin', 
            'I': 'filterI', 
            'K': 'filterK',
            'L': 'filterOutreachType', 
            'N': 'filterStatus',
            'V': 'filterSupervisor', 
            'W': 'filterAgent', 
            'J': 'filterCaseOwner'
        };

        for (var col in map) {
            var selectElement = document.getElementById(map[col]);
            if (selectElement && filters[col]) {
                // Limpiar opciones anteriores (excepto "Todos")
                while (selectElement.options.length > 1) {
                    selectElement.remove(1);
                }
                
                // Agregar nuevas opciones
                var fragment = document.createDocumentFragment(); // Optimizaci√≥n DOM
                filters[col].forEach(function(value) {
                    var option = document.createElement('option');
                    option.value = value;
                    option.text = value;
                    fragment.appendChild(option);
                });
                selectElement.appendChild(fragment);
            }
        }
    }

    // ============================================
    // FILTROS ULTRA R√ÅPIDOS
    // ============================================
    /**
     * Recopila los valores de todos los filtros
     */
    function getFiltros() {
        return {
            colI: document.getElementById('filterI').value,
            colK: document.getElementById('filterK').value,
            outreachType: document.getElementById('filterOutreachType').value,
            supervisor: document.getElementById('filterSupervisor').value,
            agent: document.getElementById('filterAgent').value,
            caseOwner: document.getElementById('filterCaseOwner').value,
            status: document.getElementById('filterStatus').value,
            begin: document.getElementById('filterBegin').value
        };
    }

    /**
     * Aplica los filtros LOCALMENTE (Instant√°neo < 50ms)
     */
    function aplicarFiltros() {
        console.time('‚ö° Filtrado');
        
        // 1. Obtener criterios
        var filtros = getFiltros();

        // 2. Verificar si hay filtros activos
        var hayFiltros = Object.values(filtros).some(v => v !== '');

        // 3. Si NO hay filtros, usar snapshot inicial (ultra r√°pido)
        if (!hayFiltros && initialDashboardData) {
            console.log('‚ö° Sin filtros - usando snapshot inicial');
            dashboardData = initialDashboardData;
            renderDashboard();
            console.timeEnd('‚ö° Filtrado');
            return;
        }

        // 4. Filtrar Data Global (optimizado con early return)
        var datosFiltrados = rawDataGlobal.filter(function(row) {
            // Early returns para mejor performance
            if (filtros.outreachType && row[COLS.OUTREACH] !== filtros.outreachType) return false;
            if (filtros.caseOwner && row[COLS.OWNER] !== filtros.caseOwner) return false;
            if (filtros.status && row[COLS.STATUS] !== filtros.status) return false;
            if (filtros.begin && row[COLS.MONTH] !== filtros.begin) return false;
            if (filtros.supervisor && row[COLS.SUP] !== filtros.supervisor) return false;
            if (filtros.agent && row[COLS.AGENT] !== filtros.agent) return false;
            if (filtros.colI && row[COLS.COUNTRY] !== filtros.colI) return false;
            if (filtros.colK && row[COLS.STAGE] !== filtros.colK) return false;
            return true;
        });

        console.log('üìä Filas filtradas: ' + datosFiltrados.length + ' de ' + rawDataGlobal.length);

        // 5. Procesar y Renderizar
        dashboardData = procesarDatos(datosFiltrados);
        renderDashboard();

        console.timeEnd('‚ö° Filtrado');
    }

    /**
     * Limpia todos los filtros (Instant√°neo)
     */
    function limpiarFiltros() {
        console.log('üßπ Limpiando filtros...');
        
        // 1. Resetear visualmente los selects
        document.querySelectorAll('.filters-grid select').forEach(function(select) {
            select.value = '';
        });

        // 2. Usar snapshot inicial (ultra r√°pido)
        if (initialDashboardData) {
            console.log('‚ö° Restaurando datos iniciales');
            dashboardData = initialDashboardData;
            renderDashboard();
        } else {
            // Fallback: recalcular
            aplicarFiltros();
        }
    }

    // ============================================
    // PROCESAMIENTO DE DATOS (Optimizado)
    // ============================================
    /**
     * Procesa los datos filtrados y genera m√©tricas
     */
    function procesarDatos(rows) {
        console.time('  üìä Procesamiento');
        
        var resultado = {
            metrics: calcularKPIs(rows),
            wow: { 
                main: agruparDatos(rows, COLS.WEEK), 
                breakdown: generarDesgloses(rows) 
            },
            mom: { 
                main: agruparDatos(rows, COLS.MONTH), 
                breakdown: generarDesgloses(rows) 
            },
            dod: { 
                main: agruparDatos(rows, COLS.DATE), 
                breakdown: generarDesgloses(rows) 
            },
            ranking: agruparDatos(rows, COLS.AGENT),
            analisis: analizarMejoresTiempos(rows)
        };

        console.timeEnd('  üìä Procesamiento');
        return resultado;
    }

    /**
     * Calcula KPIs (FT, Cases, CT, CR)
     */
    function calcularKPIs(rows) {
        var ft = 0, cases = 0, sumCT = 0, countCT = 0, sumCR = 0, countCR = 0;
        
        for (var i = 0; i < rows.length; i++) {
            var row = rows[i];
            cases++;
            
            if (row[COLS.FT] == 1 || row[COLS.FT] == '1') ft++;
            
            var ct = row[COLS.CT];
            if (ct !== '' && ct !== null && !isNaN(ct)) {
                sumCT += Number(ct);
                countCT++;
            }
            
            var cr = row[COLS.CR];
            if (cr !== '' && cr !== null && !isNaN(cr)) {
                sumCR += Number(cr);
                countCR++;
            }
        }

        return {
            ft: ft,
            cases: cases,
            ct: countCT ? sumCT / countCT : 0,
            cr: countCR ? sumCR / countCR : 0
        };
    }

    /**
     * Agrupa datos por una columna espec√≠fica
     */
    function agruparDatos(rows, colIdx) {
        var grupos = {};
        
        for (var i = 0; i < rows.length; i++) {
            var row = rows[i];
            var key = row[colIdx] || 'N/A';
            
            if (!grupos[key]) {
                grupos[key] = {
                    label: key,
                    ft: 0,
                    cases: 0,
                    ctSum: 0,
                    ctCount: 0,
                    crSum: 0,
                    crCount: 0
                };
            }
            
            var g = grupos[key];
            g.cases++;
            
            if (row[COLS.FT] == 1 || row[COLS.FT] == '1') g.ft++;
            
            var ct = row[COLS.CT];
            if (ct !== '' && ct !== null && !isNaN(ct)) {
                g.ctSum += Number(ct);
                g.ctCount++;
            }
            
            var cr = row[COLS.CR];
            if (cr !== '' && cr !== null && !isNaN(cr)) {
                g.crSum += Number(cr);
                g.crCount++;
            }
        }

        // Convertir a array y calcular promedios
        var resultado = [];
        for (var key in grupos) {
            var g = grupos[key];
            resultado.push({
                label: g.label,
                ft: g.ft,
                cases: g.cases,
                ct: g.ctCount ? g.ctSum / g.ctCount : 0,
                cr: g.crCount ? g.crSum / g.crCount : 0
            });
        }

        // Ordenar por label
        resultado.sort(function(a, b) {
            return a.label > b.label ? 1 : -1;
        });

        return resultado;
    }

    /**
     * Genera desgloses por columnas I, K, L, N
     */
    function generarDesgloses(rows) {
        return {
            I: agruparDatos(rows, COLS.COUNTRY),
            K: agruparDatos(rows, COLS.STAGE),
            L: agruparDatos(rows, COLS.OUTREACH),
            N: agruparDatos(rows, COLS.STATUS)
        };
    }

    /**
     * Analiza mejores tiempos (d√≠as y horas)
     */
    function analizarMejoresTiempos(rows) {
        var dias = {}, horas = {}, diaHora = {};
        var diasSemana = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];

        for (var i = 0; i < rows.length; i++) {
            var row = rows[i];
            var fechaStr = row[COLS.TRIP_DATE];
            
            if (!fechaStr) continue;

            // Parsear fecha (formato YYYY-MM-DD)
            var parts = fechaStr.split('-');
            if (parts.length < 3) continue;

            var dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
            var diaNombre = diasSemana[dateObj.getDay()];

            dias[diaNombre] = (dias[diaNombre] || 0) + 1;

            // Procesar hora
            var hora = row[COLS.TRIP_HOUR];
            var horaNum = -1;

            if (typeof hora === 'number') {
                if (hora < 1) {
                    horaNum = Math.floor(hora * 24); // Excel fraction
                } else {
                    horaNum = Math.floor(hora);
                }
            } else if (typeof hora === 'string' && hora.includes(':')) {
                horaNum = parseInt(hora.split(':')[0]);
            }

            if (horaNum >= 0 && horaNum <= 23) {
                var horaStr = (horaNum < 10 ? '0' + horaNum : horaNum) + ':00';
                horas[horaStr] = (horas[horaStr] || 0) + 1;
                var dh = diaNombre + ' ' + horaStr;
                diaHora[dh] = (diaHora[dh] || 0) + 1;
            }
        }

        // Helper: encontrar m√°ximo
        function getMax(obj) {
            var maxKey = '-', maxVal = 0;
            for (var k in obj) {
                if (obj[k] > maxVal) {
                    maxVal = obj[k];
                    maxKey = k;
                }
            }
            return { label: maxKey, count: maxVal };
        }

        // Helper: convertir a array ordenado
        function toArray(obj) {
            var arr = [];
            for (var k in obj) {
                arr.push({ label: k, count: obj[k] });
            }
            arr.sort(function(a, b) {
                return b.count - a.count;
            });
            return arr;
        }

        return {
            bestDay: getMax(dias),
            bestHour: getMax(horas),
            bestTime: getMax(diaHora),
            allDays: toArray(dias),
            allHours: toArray(horas)
        };
    }

    // ============================================
    // RENDERIZADO
    // ============================================
    /**
     * Actualiza las tarjetas de m√©tricas y renderiza la pesta√±a activa
     */
    function renderDashboard() {
        if (!dashboardData) return;

        console.time('  üé® Render');

        // Actualizar tarjetas de m√©tricas
        var m = dashboardData.metrics;
        document.getElementById('metricFT').innerText = m.ft.toLocaleString();
        document.getElementById('metricCases').innerText = m.cases.toLocaleString();
        document.getElementById('metricCT').innerText = (m.ct * 100).toFixed(2) + '%';
        document.getElementById('metricCR').innerText = (m.cr * 100).toFixed(2) + '%';

        // Renderizar pesta√±a activa
        renderCurrentTab();

        console.timeEnd('  üé® Render');
    }

    /**
     * Renderiza el contenido de la pesta√±a actualmente seleccionada
     */
    function renderCurrentTab() {
        var activeTabEl = document.querySelector('.tab.active');
        if (!activeTabEl) return;

        // Obtener ID de la pesta√±a activa
        var onclickAttr = activeTabEl.getAttribute('onclick');
        var match = onclickAttr.match(/'([^']+)'/);
        if (!match) return;
        
        var id = match[1];
        var container = document.getElementById(id);
        if (!container) return;
        
        container.innerHTML = '';

        if (!dashboardData) return;

        // Renderizar seg√∫n la pesta√±a
        if (id === 'ranking') {
            renderRankingTab(container);
        } else if (id === 'analisis') {
            renderAnalisisTab(container);
        } else {
            // WOW, MOM, DOD
            if (!dashboardData[id]) return;
            renderMainView(id, dashboardData[id].main, container);
            renderBreakdownAccordion(dashboardData[id].breakdown, container);
        }
    }

    // ============================================
    // PESTA√ëA RANKING (OTROS)
    // ============================================
    function renderRankingTab(container) {
        if (dashboardData && dashboardData.ranking) {
            renderRankingTable(dashboardData.ranking, container);
        } else {
            container.innerHTML = '<p style="text-align:center;padding:50px;color:#666;">No hay datos de ranking disponibles.</p>';
        }
    }

    function renderRankingTable(data, container) {
        if (!data || data.length === 0) {
            container.innerHTML = '<p style="text-align:center;padding:50px;color:#666;">No hay datos.</p>';
            return;
        }

        // Ordenar por FT Cases (mayor a menor)
        var sortedData = data.slice().sort(function(a, b) {
            return b.ft - a.ft;
        });

        var html = '<h2 style="color:#667eea;text-align:center;margin-bottom:25px;">üèÜ Top Performers</h2>';
        html += '<div class="table-container"><table><thead><tr><th>Rank</th><th>Agente</th><th>FT ‚≠ê</th><th>Cases</th><th>CT%</th><th>CR%</th></tr></thead><tbody>';

        for (var i = 0; i < sortedData.length; i++) {
            var d = sortedData[i];
            var rank = i + 1;
            var medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
            var style = rank <= 3 ? 'background:#fff9db;font-weight:bold;' : '';
            
            html += '<tr style="' + style + '">';
            html += '<td>' + rank + ' ' + medal + '</td>';
            html += '<td style="text-align:left;">' + d.label + '</td>';
            html += '<td style="color:#667eea;font-weight:bold;">' + d.ft + '</td>';
            html += '<td>' + d.cases + '</td>';
            html += '<td>' + (d.ct * 100).toFixed(2) + '%</td>';
            html += '<td>' + (d.cr * 100).toFixed(2) + '%</td>';
            html += '</tr>';
        }

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    // ============================================
    // PESTA√ëA AN√ÅLISIS
    // ============================================
    function renderAnalisisTab(container) {
        if (dashboardData && dashboardData.analisis) {
            renderAnalisisDetalle(dashboardData.analisis, container);
        } else {
            container.innerHTML = '<p style="text-align:center;padding:50px;color:#666;">No hay datos de an√°lisis disponibles.</p>';
        }
    }

    function renderAnalisisDetalle(ta, container) {
        var html = '<h2 style="color:#667eea;text-align:center;margin-bottom:25px;">üìà An√°lisis de Mejores Tiempos</h2>';

        // Tarjetas resumen
        html += '<div class="analysis-grid">';
        html += '<div class="analysis-card day"><div class="analysis-icon">üìÖ</div><div class="analysis-label">Mejor D√≠a</div><div class="analysis-value">' + ta.bestDay.label + '</div><div class="analysis-count">' + ta.bestDay.count + ' casos</div></div>';
        html += '<div class="analysis-card hour"><div class="analysis-icon">‚è∞</div><div class="analysis-label">Mejor Hora</div><div class="analysis-value">' + ta.bestHour.label + '</div><div class="analysis-count">' + ta.bestHour.count + ' casos</div></div>';
        html += '<div class="analysis-card combo"><div class="analysis-icon">üéØ</div><div class="analysis-label">Mejor Momento</div><div class="analysis-value">' + ta.bestTime.label + '</div><div class="analysis-count">' + ta.bestTime.count + ' casos</div></div>';
        html += '</div>';

        // Tabla de distribuci√≥n por d√≠a
        if (ta.allDays && ta.allDays.length > 0) {
            html += '<div class="detail-table"><h3>üìÖ Distribuci√≥n por D√≠a</h3><div class="table-container"><table><thead><tr><th>D√≠a</th><th>Casos</th></tr></thead><tbody>';
            for (var i = 0; i < ta.allDays.length; i++) {
                var d = ta.allDays[i];
                html += '<tr><td style="text-align:left;">' + d.label + '</td><td>' + d.count + '</td></tr>';
            }
            html += '</tbody></table></div></div>';
        }

        // Tabla de distribuci√≥n por hora
        if (ta.allHours && ta.allHours.length > 0) {
            html += '<div class="detail-table"><h3>‚è∞ Distribuci√≥n por Hora</h3><div class="table-container"><table><thead><tr><th>Hora</th><th>Casos</th></tr></thead><tbody>';
            for (var i = 0; i < ta.allHours.length; i++) {
                var h = ta.allHours[i];
                html += '<tr><td>' + h.label + '</td><td>' + h.count + '</td></tr>';
            }
            html += '</tbody></table></div></div>';
        }

        container.innerHTML = html;
    }

    // ============================================
    // VISTA PRINCIPAL (WOW, MOM, DOD)
    // ============================================
    function renderMainView(type, data, container) {
        if (!data || data.length === 0) {
            container.innerHTML += '<p style="text-align:center;">No hay datos.</p>';
            return;
        }

        // Crear acorde√≥n para gr√°fico y tabla
        var details = document.createElement('details');
        details.open = true;
        
        var summary = document.createElement('summary');
        summary.textContent = 'üìà Gr√°fico & Tabla';
        details.appendChild(summary);

        var content = document.createElement('div');
        content.className = 'details-content';
        
        var chartId = 'chart-' + type;
        content.innerHTML = '<div class="chart-wrapper"><canvas id="' + chartId + '"></canvas></div>';
        
        renderHorizontalTable('Principal', data, content);
        details.appendChild(content);
        container.appendChild(details);

        // Renderizar gr√°fico despu√©s de que el DOM est√© listo
        requestAnimationFrame(function() {
            requestAnimationFrame(function() {
                renderComboChart(chartId, data);
            });
        });
    }

    function renderBreakdownAccordion(bd, container) {
        var details = document.createElement('details');
        var summary = document.createElement('summary');
        summary.textContent = 'üìã Desglose';
        details.appendChild(summary);

        var content = document.createElement('div');
        content.className = 'details-content';

        var breakdowns = [
            { key: 'I', title: 'Country' },
            { key: 'K', title: 'Stage' },
            { key: 'L', title: 'Outreach Type' },
            { key: 'N', title: 'Status' }
        ];

        for (var i = 0; i < breakdowns.length; i++) {
            var item = breakdowns[i];
            var div = document.createElement('div');
            div.style.marginBottom = '25px';
            renderHorizontalTable('Columna ' + item.key + ' - ' + item.title, bd[item.key], div);
            content.appendChild(div);
        }

        details.appendChild(content);
        container.appendChild(details);
    }

    function renderHorizontalTable(title, data, container) {
        if (!data || data.length === 0) {
            container.innerHTML = '<p>No hay datos para: ' + title + '</p>';
            return;
        }

        var h4 = document.createElement('h4');
        h4.textContent = title;
        h4.style.color = '#667eea';
        h4.style.marginBottom = '8px';
        container.appendChild(h4);

        var div = document.createElement('div');
        div.className = 'table-container';

        // Crear tabla
        var html = '<table><thead><tr><th>Metric</th>';
        for (var i = 0; i < data.length; i++) {
            html += '<th>' + data[i].label + '</th>';
        }
        html += '</tr></thead><tbody>';

        // Filas de m√©tricas
        var metrics = [
            { label: 'FT Cases', key: 'ft', format: function(v) { return v; } },
            { label: 'Total Cases', key: 'cases', format: function(v) { return v; } },
            { label: 'CT %', key: 'ct', format: function(v) { return (v * 100).toFixed(2) + '%'; } },
            { label: 'CR %', key: 'cr', format: function(v) { return (v * 100).toFixed(2) + '%'; } }
        ];

        for (var m = 0; m < metrics.length; m++) {
            var metric = metrics[m];
            html += '<tr><td><strong>' + metric.label + '</strong></td>';
            for (var i = 0; i < data.length; i++) {
                html += '<td>' + metric.format(data[i][metric.key]) + '</td>';
            }
            html += '</tr>';
        }

        html += '</tbody></table>';
        div.innerHTML = html;
        container.appendChild(div);
    }

    function renderComboChart(id, data) {
        var canvas = document.getElementById(id);
        if (!canvas) return;
        
        var ctx = canvas.getContext('2d');

        // Destruir gr√°fico anterior si existe
        if (charts[id]) {
            charts[id].destroy();
        }

        // Preparar datos
        var labels = [];
        var ftData = [];
        var casesData = [];
        var ctData = [];
        var crData = [];

        for (var i = 0; i < data.length; i++) {
            labels.push(data[i].label);
            ftData.push(data[i].ft);
            casesData.push(data[i].cases);
            ctData.push(data[i].ct * 100);
            crData.push(data[i].cr * 100);
        }

        // Crear nuevo gr√°fico
        charts[id] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'FT Cases',
                        data: ftData,
                        backgroundColor: 'rgba(102,126,234,0.7)',
                        yAxisID: 'y'
                    },
                    {
                        label: 'Total Cases',
                        data: casesData,
                        backgroundColor: 'rgba(118,75,162,0.7)',
                        yAxisID: 'y'
                    },
                    {
                        type: 'line',
                        label: 'CT %',
                        data: ctData,
                        borderColor: '#ff9f43',
                        borderWidth: 3,
                        yAxisID: 'y1',
                        fill: false
                    },
                    {
                        type: 'line',
                        label: 'CR %',
                        data: crData,
                        borderColor: '#eb3b5a',
                        borderWidth: 3,
                        yAxisID: 'y1',
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Cases' }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: '%' },
                        grid: { drawOnChartArea: false },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    function cambiarTab(type) {
        // Remover clase active de todas las pesta√±as
        var tabs = document.querySelectorAll('.tab');
        for (var i = 0; i < tabs.length; i++) {
            tabs[i].classList.remove('active');
        }
        
        var contents = document.querySelectorAll('.tab-content');
        for (var i = 0; i < contents.length; i++) {
            contents[i].classList.remove('active');
        }

        // Activar pesta√±a seleccionada
        var btn = document.querySelector("button[onclick=\"cambiarTab('" + type + "')\"]");
        if (btn) btn.classList.add('active');
        
        var content = document.getElementById(type);
        if (content) content.classList.add('active');

        // Renderizar contenido
        renderCurrentTab();
    }
</script>
```

## üöÄ **Optimizaciones Realizadas:**

### ‚úÖ **1. Carga Inicial Ultra R√°pida:**
- `DOMContentLoaded` para iniciar apenas cargue el DOM
- `console.time()` para medir performance
- Snapshot inicial guardado en `initialDashboardData`

### ‚úÖ **2. Filtros Instant√°neos (< 50ms):**
- **Sin filtros activos**: Usa snapshot inicial (0ms)
- **Con filtros**: Early return en el filter loop
- Evita reprocesar si no hay cambios

### ‚úÖ **3. Limpiar Filtros Instant√°neo:**
- Restaura snapshot inicial directamente
- No recalcula nada

### ‚úÖ **4. Procesamiento Optimizado:**
- For loops cl√°sicos (m√°s r√°pidos que forEach)
- Variables locales en lugar de accesos a propiedades
- `toLocaleString()` para formatear n√∫meros

### ‚úÖ **5. Renderizado Optimizado:**
- `DocumentFragment` para insertar m√∫ltiples opciones
- Construcci√≥n de HTML como string (m√°s r√°pido que DOM)
- `requestAnimationFrame` doble para gr√°ficos

### ‚úÖ **6. Sin Llamadas al Servidor:**
- TODO se procesa en el cliente
- Ranking y An√°lisis tambi√©n son instant√°neos

## üìä **Performance Esperado:**
```
‚ö° Init Dashboard: ~200-500ms (primera carga)
‚ö° Filtrado SIN filtros: ~0-5ms (snapshot)
‚ö° Filtrado CON filtros: ~20-100ms (seg√∫n datos)
üé® Render: ~50-150ms
</body>

</html>