<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard KPIs - Business Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --purple: #9b59b6;
            --gold: #f39c12;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* TABS NAVIGATION */
        .tabs-nav {
            background: white;
            border-radius: 12px 12px 0 0;
            padding: 0;
            margin-bottom: 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            overflow-x: auto;
        }
        
        .tab-button {
            flex: 1;
            min-width: 200px;
            padding: 20px 25px;
            border: none;
            background: white;
            color: #7f8c8d;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .tab-button:hover {
            background: #f8f9fa;
            color: var(--primary);
        }
        
        .tab-button.active {
            color: var(--secondary);
            border-bottom: 4px solid var(--secondary);
            background: #f8f9fa;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* HEADER */
        .header {
            background: white;
            border-radius: 0 0 15px 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .header h1 {
            color: var(--primary);
            font-size: 2.2rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-subtitle {
            color: #7f8c8d;
            font-size: 1rem;
        }
        
        /* USER INFO CARD */
        .user-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .user-card h3 {
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }
        
        .user-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .user-info-item {
            display: flex;
            flex-direction: column;
        }
        
        .user-info-label {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .user-info-value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        /* FILTROS */
        .filters-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .filters-title {
            color: var(--primary);
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        select {
            padding: 12px 15px;
            border: 2px solid #dfe6e9;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        select:hover {
            border-color: var(--secondary);
        }
        
        select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        select:disabled {
            background: #f8f9fa;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* INDICATOR */
        .status-indicator {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .status-indicator.hidden {
            display: none;
        }
        
        /* METRICS CARDS */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 4px solid var(--secondary);
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .metric-card.success { border-left-color: var(--success); }
        .metric-card.warning { border-left-color: var(--warning); }
        .metric-card.danger { border-left-color: var(--danger); }
        
        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .metric-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .metric-subtitle {
            color: #95a5a6;
            font-size: 0.85rem;
        }
        
        /* CHARTS */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .chart-title {
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* TABLE */
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .table-title {
            color: var(--primary);
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary) 0%, #2980b9 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #229954 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            color: white;
        }
        
        .btn-dispute {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .table-scroll {
            overflow-x: auto;
            margin-top: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        
   th {
    background: var(--primary);
    color: white;
    padding: 14px 12px;
    text-align: center;
    font-weight: 600;
    border: 1px solid #34495e;
    white-space: nowrap;
    position: sticky;
    top: 0;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
        
        td {
            padding: 12px;
            text-align: center;
            border: 1px solid #dfe6e9;
        }
        
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        tr:hover {
            background: #e8f4f8;
        }
        
        .cumple {
            background: #d4edda !important;
            color: #155724;
            font-weight: 600;
        }
        
        .no-cumple {
            background: #f8d7da !important;
            color: #721c24;
            font-weight: 600;
        }
        
        .sin-datos {
            background: #f5f5f5 !important;
            color: #999 !important;
            font-style: italic;
        }
        
        .sin-datos-valor {
            background: #fafafa !important;
            color: #bbb !important;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--secondary);
            font-size: 1.3rem;
        }
        
        .info-message {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
            font-style: italic;
            background: #ecf0f1;
            border-radius: 10px;
        }
        
        /* TOP 3 PODIUM */
        .podium-container {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 20px;
            margin: 40px 0;
            min-height: 300px;
        }
        
        .podium-place {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.3s ease;
        }
        
        .podium-place:hover {
            transform: translateY(-10px);
        }
        
        .podium-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold) 0%, #e67e22 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin-bottom: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            border: 5px solid white;
        }
        
        .podium-place:nth-child(1) .podium-avatar {
            width: 80px;
            height: 80px;
            font-size: 2.5rem;
            background: linear-gradient(135deg, #c0c0c0 0%, #a8a8a8 100%);
        }
        
        .podium-place:nth-child(2) .podium-avatar {
            width: 120px;
            height: 120px;
            font-size: 3.5rem;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        }
        
        .podium-place:nth-child(3) .podium-avatar {
            width: 80px;
            height: 80px;
            font-size: 2.5rem;
            background: linear-gradient(135deg, #cd7f32 0%, #b5651d 100%);
        }
        
        .podium-base {
            background: white;
            border-radius: 12px 12px 0 0;
            padding: 20px;
            text-align: center;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
        }
        
        .podium-place:nth-child(1) .podium-base {
            height: 150px;
        }
        
        .podium-place:nth-child(2) .podium-base {
            height: 220px;
        }
        
        .podium-place:nth-child(3) .podium-base {
            height: 120px;
        }
        
        .podium-rank {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .podium-name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        
        .podium-bms {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        
        .podium-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success);
        }
        
        /* HISTORICAL RECORDS */
        .historical-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        
        .historical-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .historical-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #ecf0f1;
        }
        
        .historical-kpi-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .historical-category {
            font-size: 0.85rem;
            padding: 5px 15px;
            border-radius: 20px;
            background: var(--secondary);
            color: white;
        }
        
        .historical-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-value.highlight {
            color: var(--success);
            font-size: 2.2rem;
        }
        
        .accordion-header {
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0;
            transition: all 0.3s ease;
        }
        
        .accordion-header:hover {
            opacity: 0.8;
            transform: none;
            box-shadow: none;
        }
        
        .accordion-arrow {
            transition: transform 0.3s ease;
            font-size: 1.2rem;
        }
        
        .accordion-arrow.expanded {
            transform: rotate(180deg);
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .filters-grid {
                grid-template-columns: 1fr;
            }
            .podium-container {
                flex-direction: column;
                align-items: center;
            }
            .podium-place:nth-child(1),
            .podium-place:nth-child(2),
            .podium-place:nth-child(3) {
                width: 100%;
            }
        }


        .table-scroll {
    overflow-x: auto;
    overflow-y: auto;
    max-height: 600px; /* Ajusta seg√∫n necesites */
    margin-top: 15px;
    position: relative;
}

#tabla-agentes {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

#tabla-agentes thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--primary);
}

#tabla-agentes thead th {
    position: sticky;
    top: 0;
    background: var(--primary);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Canvas Ruleta */
#ruletaCanvas {
    cursor: pointer;
    transition: transform 0.1s ease;
}

#ruletaCanvas:hover {
    transform: scale(1.02);
}

.prorrateo-check:disabled {
    cursor: not-allowed;
    opacity: 0.5;
}

.prorrateo-check:disabled + .checkbox-label {
    color: #95a5a6;
    cursor: not-allowed;
}

/* Estilo para celdas con prorrateo aplicado */
.celda-prorrateo {
    background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%) !important;
    color: white !important;
    font-weight: bold !important;
}
.btn-cambiar-acceso:hover {
    background: #2980b9 !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.btn-cambiar-acceso:active {
    transform: translateY(0);
}

.tipo-acceso-select:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}


    </style>
</head>
<body>


<div class="container">
    <!-- ============================================ -->
    <!-- TABS NAVIGATION -->
    <!-- ============================================ -->
    <div class="tabs-nav">
        <button class="tab-button active" onclick="switchTab('dashboard')">
            üìä Dashboard Principal
        </button>
        <button class="tab-button" onclick="switchTab('top3')">
            üèÜ Top 3 Performers
        </button>
        <button class="tab-button" onclick="switchTab('historical')">
            üìà Hist√≥rico M√°ximos
        </button>
        <button class="tab-button" onclick="switchTab('ruleta')">
            üé∞ Ruleta de Ganadores
        </button>
    </div>
    
    <!-- ============================================ -->
    <!-- HEADER -->
    <!-- ============================================ -->
    <div class="header">
        <h1>üìä Dashboard de KPIs</h1>
        <p class="header-subtitle">Sistema de An√°lisis de Bonos y Desempe√±o</p>
    </div>
    
    <!-- ============================================ -->
   


   <!-- ============================================ -->
<!-- üßë Informaci√≥n del Usuario -->
<!-- ============================================ -->
<div class="user-card">
    <h3>üë§ Informaci√≥n del Usuario</h3>
    <div class="user-info-grid">
        <div class="user-info-item">
            <span class="user-info-label">Nombre</span>
            <span class="user-info-value" id="nombreUsuario">Cargando...</span>
        </div>
        <div class="user-info-item">
            <span class="user-info-label">Correo</span>
            <span class="user-info-value" id="correoUsuario">---</span>
        </div>
        <div class="user-info-item">
            <span class="user-info-label">Rol</span>
            <span class="user-info-value" id="rolUsuario">---</span>
        </div>
        <div class="user-info-item">
            <span class="user-info-label">üîê Tipo de Acceso</span>
            <div style="display:flex;align-items:center;gap:8px;">
                <select id="tipoAccesoSelect" 
                        class="tipo-acceso-select"
                        style="padding:6px 10px;border:1px solid #ddd;border-radius:4px;font-size:0.9rem;cursor:pointer;">
                    <option value="Registro">üìù Registro</option>
                    <option value="Audit">üîç Audit</option>
                    <option value="OM">‚öôÔ∏è OM</option>
                </select>
                <button onclick="cambiarTipoAccesoUsuario()" 
                        class="btn-cambiar-acceso"
                        style="padding:6px 16px;background:#3498db;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.9rem;font-weight:600;transition:all 0.3s ease;">
                    üîÑ Cambiar
                </button>
            </div>
        </div>
        <!-- Status debajo del selector -->
        <div class="user-info-item" style="grid-column:1/-1;">
            <span id="tipoAccesoStatus" style="font-size:0.85rem;color:#7f8c8d;"></span>
        </div>
    </div>
</div>

    <!-- ============================================ -->
    <!-- TAB 1: DASHBOARD PRINCIPAL -->
    <!-- ============================================ -->
    <div id="tab-dashboard" class="tab-content active">
        <!-- FILTERS -->
        <div class="filters-section">
            <h3 class="filters-title">üîç Filtros de B√∫squeda</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label" for="selectLob">üè¢ LOB</label>
                    <select id="selectLob">
                        <option value="">Selecciona una LOB</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="selectFechas">üìÖ Fecha</label>
                    <select id="selectFechas" disabled>
                        <option value="">Primero selecciona LOB</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="selectMesComparativo">üìÜ Mes Comparativo CDM</label>
                    <select id="selectMesComparativo" disabled>
                        <option value="">Primero selecciona LOB y Fecha</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- STATUS INDICATOR -->
        <div id="status-indicator" class="status-indicator hidden">
            üîÑ Comparando con datos de: <span id="mes-texto">---</span>
        </div>
        
        <!-- METRICS -->
        <div id="metrics-grid" class="metrics-grid" style="display:none;"></div>
        
        <!-- CHARTS -->
        <div id="charts-grid" class="charts-grid" style="display:none;"></div>

        <!-- GR√ÅFICO DE KPIs VS MONTO PAGADO -->
        <div id="kpi-payment-chart-container" style="display:none;">
            <div class="chart-card" style="margin-bottom:25px;">
                <div class="chart-header">
                    <h3 class="chart-title">üíµ Monto Total Pagado por KPI</h3>
                    <button class="btn-primary" onclick="toggleKPIChart()" style="padding:8px 15px;font-size:0.9rem;">
                        üëÅÔ∏è <span id="toggle-kpi-text">Ocultar</span>
                    </button>
                </div>
                <div id="kpi-chart-wrapper">
                    <canvas id="chartKPIPagos"></canvas>
                </div>
            </div>
        </div>
        
        <!-- TABLE -->
        <div id="table-container" class="table-container" style="display:none;"></div>
    </div>
    
    <!-- ============================================ -->
    <!-- TAB 2: TOP 3 PERFORMERS -->
    <!-- ============================================ -->
    <div id="tab-top3" class="tab-content">
        <div class="filters-section">
            <h3 class="filters-title">üèÜ Top 3 Performers por KPI - Todos los Meses</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label" for="top3SelectLob">üè¢ LOB</label>
                    <select id="top3SelectLob">
                        <option value="">Selecciona una LOB</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="top3SelectFecha">üìÖ Fecha</label>
                    <select id="top3SelectFecha" disabled>
                        <option value="">Primero selecciona LOB</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="top3SelectKpi">üéØ KPI</label>
                    <select id="top3SelectKpi" disabled>
                        <option value="">Primero selecciona fecha</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div id="top3-all-months-results"></div>
    </div>
    
    <!-- ============================================ -->
    <!-- TAB 3: HIST√ìRICO M√ÅXIMOS -->
    <!-- ============================================ -->
    <div id="tab-historical" class="tab-content">
        <div class="filters-section">
            <h3 class="filters-title">üìà Bonos Totales por LOB - Hist√≥rico por Mes</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label" for="histSelectLob">üè¢ LOB</label>
                    <select id="histSelectLob">
                        <option value="">Selecciona una LOB</option>
                    </select>
                </div>
              
            </div>
        </div>
        
        <!-- Gr√°fico de Bonos por Mes -->
        <div id="historical-chart-container" style="display:none;margin-bottom:25px;">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">üíµ Bonos Totales por Mes CDM</h3>
                </div>
                <canvas id="chartHistoricalMeses"></canvas>
            </div>
        </div>
        
        <!-- Desglose por mes -->
        <div id="historical-results"></div>
    </div>
    
    <!-- ============================================ -->
    <!-- TAB 4: RULETA DE GANADORES -->
    <!-- ============================================ -->
    <div id="tab-ruleta" class="tab-content">
        <div class="filters-section">
            <h3 class="filters-title">üé∞ Ruleta de Ganadores - Top 3 por LOB</h3>
            <p style="color:#7f8c8d;margin-top:10px;">
                Selecciona un KPI para ver los Top 3 agentes de TODAS las LOBs y girar la ruleta para elegir un ganador
            </p>
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label" for="ruletaSelectFecha">üìÖ Fecha</label>
                    <select id="ruletaSelectFecha">
                        <option value="">Selecciona una fecha</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="ruletaSelectKpi">üéØ KPI</label>
                    <select id="ruletaSelectKpi" disabled>
                        <option value="">Primero selecciona fecha</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Canvas de la Ruleta -->
        <div id="ruleta-canvas-container" style="display:none;text-align:center;margin:40px 0;">
            <canvas id="ruletaCanvas" width="600" height="600" style="max-width:100%;border-radius:50%;box-shadow:0 8px 30px rgba(0,0,0,0.3);"></canvas>
            <div style="margin-top:30px;">
                <button class="btn-primary" onclick="girarRuleta()" style="padding:20px 50px;font-size:1.3rem;">
                    üé≤ GIRAR RULETA
                </button>
            </div>
        </div>
        
        <!-- Ganador -->
        <div id="ruleta-ganador" style="display:none;text-align:center;margin-top:40px;">
            <div style="background:linear-gradient(135deg, #f39c12 0%, #e67e22 100%);color:white;padding:40px;border-radius:20px;box-shadow:0 10px 30px rgba(243,156,18,0.4);">
                <div style="font-size:4rem;margin-bottom:20px;">üèÜ</div>
                <h2 style="font-size:2.5rem;margin:0 0 15px 0;">¬°GANADOR!</h2>
                <div id="ganador-nombre" style="font-size:2rem;font-weight:700;margin-bottom:10px;"></div>
                <div id="ganador-lob" style="font-size:1.2rem;opacity:0.9;margin-bottom:10px;"></div>
                <div id="ganador-bono" style="font-size:1.8rem;font-weight:700;margin-top:20px;"></div>
            </div>
        </div>
        
        <!-- Lista de Participantes -->
        <div id="ruleta-participantes" style="display:none;margin-top:30px;"></div>
    </div>
    
</div>
















  <script>


// ========================================
// CARGAR TIPO DE ACCESO AL INICIAR
// ========================================
window.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ Cargando tipo de acceso actual...');
    
    google.script.run
        .withSuccessHandler(function(tipoAcceso) {
            console.log('‚úÖ Tipo de acceso recibido:', tipoAcceso);
            
            const select = document.getElementById('tipoAccesoSelect');
            const statusSpan = document.getElementById('tipoAccesoStatus');
            
            if (select) {
                select.value = tipoAcceso;
            }
            
            if (statusSpan) {
                statusSpan.textContent = '‚úì Actual: ' + tipoAcceso;
                statusSpan.style.color = '#27ae60';
            }
        })
        .withFailureHandler(function(error) {
            console.error('‚ùå Error al cargar tipo de acceso:', error);
            
            const statusSpan = document.getElementById('tipoAccesoStatus');
            if (statusSpan) {
                statusSpan.textContent = '‚ö†Ô∏è Error al cargar tipo de acceso';
                statusSpan.style.color = '#e74c3c';
            }
        })
        .obtenerTipoAccesoActual();
});

// ========================================
// CAMBIAR TIPO DE ACCESO
// ========================================
function cambiarTipoAccesoUsuario() {
    const select = document.getElementById('tipoAccesoSelect');
    const statusSpan = document.getElementById('tipoAccesoStatus');
    
    if (!select) {
        console.error('‚ùå No se encontr√≥ el select de tipo de acceso');
        alert('‚ùå Error: No se encontr√≥ el selector');
        return;
    }
    
    const tipoAcceso = select.value;
    console.log('üîÑ Cambiando tipo de acceso a:', tipoAcceso);
    
    // Validar selecci√≥n
    if (!tipoAcceso || tipoAcceso === '') {
        alert('‚ö†Ô∏è Por favor selecciona un tipo de acceso');
        return;
    }
    
    // Actualizar status (si existe)
    if (statusSpan) {
        statusSpan.textContent = '‚è≥ Actualizando...';
        statusSpan.style.color = '#f39c12';
    }
    
    // Deshabilitar bot√≥n temporalmente
    const boton = event.target;
    boton.disabled = true;
    boton.textContent = '‚è≥ Procesando...';
    
    const email = document.getElementById('correoUsuario').textContent;
    
    google.script.run
        .withSuccessHandler(function(response) {
            console.log('‚úÖ Respuesta:', response);
            
            // Rehabilitar bot√≥n
            boton.disabled = false;
            boton.textContent = 'üîÑ Cambiar';
            
            if (response.success) {
                if (statusSpan) {
                    statusSpan.textContent = '‚úì ' + response.mensaje;
                    statusSpan.style.color = '#27ae60';
                }
                
                // Mostrar alerta de √©xito
                alert('‚úÖ Tipo de acceso cambiado exitosamente a: ' + tipoAcceso + '\n\nüîÑ La p√°gina se recargar√° para aplicar los cambios.');
                
                // Recargar p√°gina despu√©s de 1 segundo
                setTimeout(function() {
                    location.reload();
                }, 1000);
                
            } else {
                if (statusSpan) {
                    statusSpan.textContent = '‚úó Error: ' + response.error;
                    statusSpan.style.color = '#e74c3c';
                }
                alert('‚ùå Error al cambiar tipo de acceso: ' + response.error);
            }
        })
        .withFailureHandler(function(error) {
            console.error('‚ùå Error:', error);
            
            // Rehabilitar bot√≥n
            boton.disabled = false;
            boton.textContent = 'üîÑ Cambiar';
            
            if (statusSpan) {
                statusSpan.textContent = '‚úó Error de conexi√≥n';
                statusSpan.style.color = '#e74c3c';
            }
            alert('‚ùå Error de conexi√≥n: ' + error.message);
        })
        .cambiarTipoAcceso(email, tipoAcceso);
}

    // Variables globales para la ruleta
  let participantesRuleta = [];
  let anguloActual = 0;
  let girando = false;
  let animacionRuleta = null;
  let canvas = null;
  let ctx = null;
  let ganadorActual = null;
  


  function cargarRuletaDatos() {
      console.log('üé∞ Inicializando Ruleta...');
      
      // ‚≠ê MOSTRAR LOADING
      const selectFecha = document.getElementById('ruletaSelectFecha');
      const selectKpi = document.getElementById('ruletaSelectKpi');
      selectFecha.innerHTML = '<option value="">Cargando fechas...</option>';
      selectFecha.disabled = true;
      selectKpi.innerHTML = '<option value="">Primero selecciona fecha</option>';
      selectKpi.disabled = true;
      
      mostrarAlerta('‚è≥ Cargando datos de la ruleta...', 'info');
      
      // Cargar todas las fechas disponibles (de todas las LOBs)
      google.script.run
          .withSuccessHandler(function(res) {
              console.log('‚úÖ Datos recibidos para Ruleta:', res);
              
              if (!res.lobs || res.lobs.length === 0) {
                  mostrarAlerta('‚ö†Ô∏è No hay LOBs disponibles', 'warning');
                  return;
              }
              
              // Obtener fechas de todas las LOBs
              const todasLasFechas = new Set();
              let procesadas = 0;
              
              res.lobs.forEach(lob => {
                  google.script.run
                      .withSuccessHandler(function(fechas) {
                          fechas.forEach(f => todasLasFechas.add(f));
                          procesadas++;
                          
                          if (procesadas === res.lobs.length) {
                              // Todas las LOBs procesadas
                              const selectFecha = document.getElementById('ruletaSelectFecha');
                              selectFecha.innerHTML = '<option value="">Selecciona una fecha</option>';
                              
                              Array.from(todasLasFechas).sort().forEach(f => {
                                  const opt = document.createElement('option');
                                  opt.value = f;
                                  opt.textContent = f;
                                  selectFecha.appendChild(opt);
                              });
                              
                              selectFecha.disabled = false; // ‚≠ê Habilitar selector
                              console.log(`‚úÖ ${todasLasFechas.size} fechas √∫nicas cargadas`);
                              mostrarAlerta(`‚úÖ Ruleta lista. ${todasLasFechas.size} fechas disponibles`, 'success');
                          }
                      })
                      .withFailureHandler(function(error) {
                          console.error('‚ùå Error:', error);
                          procesadas++;
                      })
                      .obtenerFechasPorLob(lob);
              });
          })
          .withFailureHandler(function(error) {
              console.error('‚ùå Error:', error);
              mostrarAlerta('Error al cargar datos: ' + error.message, 'danger');
          })
          .obtenerDatosParaFrontend();
  }




  document.getElementById('ruletaSelectFecha').addEventListener('change', function() {
      const fecha = this.value;
      const selectKpi = document.getElementById('ruletaSelectKpi');
      
      selectKpi.innerHTML = '<option value="">Cargando KPIs...</option>';
      selectKpi.disabled = true;
      document.getElementById('ruleta-canvas-container').style.display = 'none';
      document.getElementById('ruleta-ganador').style.display = 'none';
      document.getElementById('ruleta-participantes').style.display = 'none';
      
      if (!fecha) return;
      
      console.log('üìÖ Fecha seleccionada para Ruleta:', fecha);
      
      // Cargar KPIs de TODAS las LOBs para esta fecha
      google.script.run
          .withSuccessHandler(function(res) {
              if (!res.lobs || res.lobs.length === 0) {
                  selectKpi.innerHTML = '<option value="">No hay LOBs</option>';
                  return;
              }
              
              const kpisUnicos = new Set();
              let procesadas = 0;
              
              res.lobs.forEach(lob => {
                  google.script.run
                      .withSuccessHandler(function(datosRecibidos) {
                          if (!datosRecibidos.error && datosRecibidos.metricasPorLob && datosRecibidos.metricasPorLob[lob]) {
                              const metricas = datosRecibidos.metricasPorLob[lob];
                              
                              if (!metricas.error) {
                                  // ‚≠ê EXCLUIR 'keys' de las categor√≠as
                                  const categorias = ['bonusStructure', 'additionalIncentives', 'decreasedKPIs'];
                                  categorias.forEach(cat => {
                                      const kpis = metricas[cat] || [];
                                      kpis.forEach(kpiObj => {
                                          kpisUnicos.add(kpiObj.kpi);
                                      });
                                  });
                              }
                          }
                          
                          procesadas++;
                          
                          if (procesadas === res.lobs.length) {
                              selectKpi.innerHTML = '<option value="">Selecciona un KPI</option>';
                              
                              if (kpisUnicos.size === 0) {
                                  selectKpi.innerHTML = '<option value="">No hay KPIs disponibles</option>';
                                  mostrarAlerta('‚ö†Ô∏è No hay KPIs disponibles', 'warning');
                                  return;
                              }
                              
                              Array.from(kpisUnicos).sort().forEach(kpi => {
                                  const opt = document.createElement('option');
                                  opt.value = kpi;
                                  opt.textContent = kpi;
                                  selectKpi.appendChild(opt);
                              });
                              
                              selectKpi.disabled = false;
                              mostrarAlerta(`‚úÖ ${kpisUnicos.size} KPIs disponibles (Keys excluidas)`, 'success');
                          }
                      })
                      .withFailureHandler(function(error) {
                          console.error('‚ùå Error:', error);
                          procesadas++;
                      })
                      .obtenerDatosParaFrontend(lob, fecha, null);
              });
          })
          .withFailureHandler(function(error) {
              console.error('‚ùå Error:', error);
              selectKpi.innerHTML = '<option value="">Error</option>';
          })
          .obtenerDatosParaFrontend();
  });

  document.getElementById('ruletaSelectKpi').addEventListener('change', function() {
      const fecha = document.getElementById('ruletaSelectFecha').value;
      const kpi = this.value;
      
      if (!fecha || !kpi) return;
      
      console.log('üéØ Generando participantes de Ruleta:', { fecha, kpi });
      
      document.getElementById('ruleta-ganador').style.display = 'none';
      
      // Obtener Top 3 de cada LOB
      google.script.run
          .withSuccessHandler(function(res) {
              if (!res.lobs || res.lobs.length === 0) return;
              
              participantesRuleta = [];
              let procesadas = 0;
              
              res.lobs.forEach(lob => {
                  google.script.run
                      .withSuccessHandler(function(datosRecibidos) {
                          if (!datosRecibidos.error && datosRecibidos.metricasPorLob && datosRecibidos.metricasPorLob[lob]) {
                              const metricas = datosRecibidos.metricasPorLob[lob];
                              
                              if (!metricas.error) {
  const categorias = ['bonusStructure', 'additionalIncentives', 'decreasedKPIs']; // ‚≠ê Sin 'keys'
                                  
                                  for (const cat of categorias) {
                                      const kpis = metricas[cat] || [];
                                      const kpiMatch = kpis.find(k => k.kpi === kpi);
                                      
                                      if (kpiMatch && kpiMatch.validacion) {
                                          const empleadosCumplen = kpiMatch.validacion.empleadosCumplen || [];
                                          
                                          const top3 = empleadosCumplen
                                              .sort((a, b) => (b.bono || 0) - (a.bono || 0))
                                              .slice(0, 3);
                                          
                                          top3.forEach(agente => {
                                              participantesRuleta.push({
                                                  nombre: agente.nombre,
                                                  bmsId: agente.bmsId,
                                                  lob: lob,
                                                  bono: agente.bono || 0
                                              });
                                          });
                                          
                                          break;
                                      }
                                  }
                              }
                          }
                          
                          procesadas++;
                          
                          if (procesadas === res.lobs.length) {
                              if (participantesRuleta.length === 0) {
                                  mostrarAlerta('‚ö†Ô∏è No se encontraron participantes para este KPI', 'warning');
                                  return;
                              }
                              
                              console.log(`‚úÖ ${participantesRuleta.length} participantes cargados`);
                              mostrarRuleta();
                          }
                      })
                      .withFailureHandler(function(error) {
                          console.error('‚ùå Error:', error);
                          procesadas++;
                      })
                      .obtenerDatosParaFrontend(lob, fecha, null);
              });
          })
          .withFailureHandler(function(error) {
              console.error('‚ùå Error:', error);
          })
          .obtenerDatosParaFrontend();
  });

  function mostrarRuleta() {
      canvas = document.getElementById('ruletaCanvas');
      ctx = canvas.getContext('2d');
      
      dibujarRuleta();
      mostrarListaParticipantes();
      
      document.getElementById('ruleta-canvas-container').style.display = 'block';
      document.getElementById('ruleta-participantes').style.display = 'block';
  }

  function dibujarRuleta() {
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = 250;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const anglePerSegment = (2 * Math.PI) / participantesRuleta.length;
      
      // Colores vibrantes para cada segmento
      const colores = [
          '#e74c3c', '#3498db', '#2ecc71', '#f39c12', 
          '#9b59b6', '#1abc9c', '#e67e22', '#34495e',
          '#16a085', '#c0392b', '#8e44ad', '#27ae60'
      ];
      
      participantesRuleta.forEach((participante, i) => {
          const startAngle = anguloActual + (i * anglePerSegment);
          const endAngle = startAngle + anglePerSegment;
          
          // Dibujar segmento
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.arc(centerX, centerY, radius, startAngle, endAngle);
          ctx.closePath();
          ctx.fillStyle = colores[i % colores.length];
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 3;
          ctx.stroke();
          
          // Dibujar texto
          ctx.save();
          ctx.translate(centerX, centerY);
          ctx.rotate(startAngle + anglePerSegment / 2);
          ctx.textAlign = 'center';
          ctx.fillStyle = '#fff';
          ctx.font = 'bold 14px Arial';
          ctx.fillText(participante.nombre.split(',')[0].substring(0, 15), radius * 0.65, 5);
          ctx.font = '12px Arial';
          ctx.fillText(participante.lob, radius * 0.65, 20);
          ctx.restore();
      });
      
      // Indicador (flecha apuntando arriba)
      ctx.beginPath();
      ctx.moveTo(centerX, 30);
      ctx.lineTo(centerX - 20, 70);
      ctx.lineTo(centerX + 20, 70);
      ctx.closePath();
      ctx.fillStyle = '#e74c3c';
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 3;
      ctx.stroke();
      
      // Centro de la ruleta
      ctx.beginPath();
      ctx.arc(centerX, centerY, 40, 0, 2 * Math.PI);
      ctx.fillStyle = '#2c3e50';
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 4;
      ctx.stroke();
      
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 16px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('GIRAR', centerX, centerY);
  }

  function girarRuleta() {
      if (girando) return;
      
      girando = true;
      document.getElementById('ruleta-ganador').style.display = 'none';
      
      // Velocidad inicial y desaceleraci√≥n
      let velocidad = 0.5;
      const desaceleracion = 0.99;
      const minimoVelocidad = 0.005;
      
      // Rotaciones aleatorias (3-6 vueltas completas)
      const vueltasExtra = Math.random() * 3 * Math.PI + 6 * Math.PI;
      let anguloTotal = 0;
      
      function animar() {
          anguloTotal += velocidad;
          anguloActual += velocidad;
          velocidad *= desaceleracion;
          
          dibujarRuleta();
          
          if (velocidad > minimoVelocidad) {
              animacionRuleta = requestAnimationFrame(animar);
          } else {
              girando = false;
              seleccionarGanador();
          }
      }
      
      animar();
  }

  function seleccionarGanador() {
      const anglePerSegment = (2 * Math.PI) / participantesRuleta.length;
      
      let anguloNormalizado = (anguloActual % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);
      const anguloIndicador = Math.PI * 1.5;
      let diferencia = (anguloIndicador - anguloNormalizado + 2 * Math.PI) % (2 * Math.PI);
      const indiceGanador = Math.floor(diferencia / anglePerSegment) % participantesRuleta.length;
      
      ganadorActual = participantesRuleta[indiceGanador];
      
  console.log('üèÜ GANADOR:', ganadorActual);

  // Mostrar ganador
  document.getElementById('ganador-nombre').textContent = ganadorActual.nombre;
  document.getElementById('ganador-lob').textContent = 'LOB: ' + ganadorActual.lob;
  document.getElementById('ganador-bono').textContent = 'Bono: $' + ganadorActual.bono.toLocaleString('es-CO', {minimumFractionDigits: 2});

  // ‚≠ê LIMPIAR CONTENIDO PREVIO Y AGREGAR BOT√ìN
// Encuentra esta secci√≥n en la funci√≥n seleccionarGanador():
const ganadorDiv = document.getElementById('ruleta-ganador');
const contenidoInterno = ganadorDiv.querySelector('div');
contenidoInterno.innerHTML = `
    <div style="font-size:2rem;font-weight:700;margin-bottom:10px;color:white;" id="ganador-nombre"></div>
    <div style="font-size:1.2rem;margin-bottom:5px;color:white;" id="ganador-lob"></div>
    <div style="font-size:1.5rem;font-weight:600;color:#f1c40f;" id="ganador-bono"></div>
    <div style="margin-top:30px;">
        <div style="margin-bottom:15px;">
            <label style="color:white;font-size:1.1rem;margin-right:10px;">% Adicional sobre bono:</label>
            <input type="number" id="porcentajeAdicional" value="30" min="0" max="100" step="1" 
                  style="padding:10px;font-size:1.2rem;width:100px;border:none;border-radius:8px;text-align:center;">
            <span style="color:white;font-size:1.2rem;margin-left:5px;">%</span>
        </div>
        
        <!-- ‚≠ê NUEVO: Campo de mensaje -->
        <div style="margin-bottom:20px;">
            <label style="color:white;font-size:1.1rem;display:block;margin-bottom:8px;">üí¨ Mensaje para el ganador:</label>
            <textarea id="mensajeGanador" 
                      placeholder="Ej: ¬°Felicitaciones por tu excelente desempe√±o!"
                      style="width:100%;padding:12px;font-size:1rem;border:none;border-radius:8px;resize:vertical;min-height:80px;"></textarea>
        </div>
        
        <button class="btn-success" onclick="registrarGanador()" style="padding:15px 40px;font-size:1.2rem;">
            üíæ Registrar Ganador
        </button>
    </div>
`;
  // Actualizar textos
  document.getElementById('ganador-nombre').textContent = ganadorActual.nombre;
  document.getElementById('ganador-lob').textContent = 'LOB: ' + ganadorActual.lob;
  document.getElementById('ganador-bono').textContent = 'Bono: $' + ganadorActual.bono.toLocaleString('es-CO', {minimumFractionDigits: 2});

  ganadorDiv.style.display = 'block';
  ganadorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

  mostrarAlerta('üéâ ¬°Tenemos un ganador! ' + ganadorActual.nombre.split(',')[0], 'success');
  }



function registrarGanador() {
    if (!ganadorActual) {
        mostrarAlerta('‚ö†Ô∏è No hay ganador seleccionado', 'warning');
        return;
    }
    
    const porcentaje = parseFloat(document.getElementById('porcentajeAdicional').value) || 0;
    const mensaje = document.getElementById('mensajeGanador').value.trim(); // ‚≠ê CAPTURAR mensaje
    
    if (porcentaje < 0 || porcentaje > 100) {
        mostrarAlerta('‚ö†Ô∏è El porcentaje debe estar entre 0 y 100', 'warning');
        return;
    }
    
    // ‚≠ê VALIDACI√ìN: Advertir si no hay mensaje
    if (!mensaje) {
        const confirmar = confirm('‚ö†Ô∏è No has escrito un mensaje personalizado.\n\n¬øDeseas continuar sin mensaje?');
        if (!confirmar) return;
    }
    
    const fecha = document.getElementById('ruletaSelectFecha').value;
    const kpi = document.getElementById('ruletaSelectKpi').value;
    
    console.log('üíæ Registrando ganador:', ganadorActual, 'Porcentaje:', porcentaje, 'Mensaje:', mensaje);
    
    mostrarLoading('Registrando ganador...');
    
    google.script.run
        .withSuccessHandler(function(response) {
            ocultarLoading();
            
            if (response.success) {
                mostrarAlerta('‚úÖ Ganador registrado exitosamente. Bono total: $' + response.bonoTotal.toLocaleString('es-CO', {minimumFractionDigits: 2}), 'success');
                
                // ‚≠ê 1. ELIMINAR GANADOR DE LA LISTA DE PARTICIPANTES
                participantesRuleta = participantesRuleta.filter(p => p.bmsId !== ganadorActual.bmsId);
                console.log(`üóëÔ∏è Ganador eliminado. Participantes restantes: ${participantesRuleta.length}`);
                
                // ‚≠ê 2. ACTUALIZAR INTERFAZ
                if (participantesRuleta.length > 0) {
                    // Hay m√°s participantes: actualizar ruleta y lista
                    anguloActual = 0; // Resetear √°ngulo
                    dibujarRuleta();
                    mostrarListaParticipantes();
                    document.getElementById('ruleta-ganador').style.display = 'none';
                    ganadorActual = null;
                } else {
                    // No quedan participantes
                    document.getElementById('ruleta-canvas-container').innerHTML = 
                        '<div style="background:#f39c12;color:white;padding:30px;border-radius:12px;text-align:center;font-size:1.2rem;">' +
                        'üèÅ ¬°Todos los participantes han sido registrados!<br>' +
                        '<small style="font-size:0.9rem;opacity:0.9;margin-top:10px;display:block;">Selecciona otra fecha o KPI para continuar</small>' +
                        '</div>';
                    document.getElementById('ruleta-participantes').style.display = 'none';
                    document.getElementById('ruleta-ganador').style.display = 'none';
                }
                
                // Guardar participantes
                google.script.run
                    .withSuccessHandler(function(resp) {
                        console.log('‚úÖ Participantes actualizados');
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå Error al guardar participantes:', error);
                    })
                    .guardarParticipantesRuleta(participantesRuleta, fecha, kpi);
                
                // Recargar lista de ganadores
                cargarGanadoresDelMes(fecha);
                
            } else {
                mostrarAlerta('‚ùå Error al registrar: ' + response.error, 'danger');
            }
        })
        .withFailureHandler(function(error) {
            ocultarLoading();
            mostrarAlerta('‚ùå Error: ' + error.message, 'danger');
            console.error('Error:', error);
        })
        .guardarGanadorRuleta(ganadorActual, fecha, kpi, porcentaje, mensaje); // ‚≠ê AGREGAR mensaje
}






  function cargarGanadoresDelMes(fecha) {
      if (!fecha) return;
      
      google.script.run
          .withSuccessHandler(function(ganadores) {
              console.log('üèÜ Ganadores del mes:', ganadores);
              
              if (ganadores.length === 0) {
                  return;
              }
              
              mostrarGanadoresDelMes(ganadores);
          })
          .withFailureHandler(function(error) {
              console.error('‚ùå Error:', error);
          })
          .obtenerGanadoresDelMes(fecha);
  }

  function mostrarGanadoresDelMes(ganadores) {
      let html = '<div style="background:white;border-radius:12px;padding:25px;margin-top:30px;box-shadow:0 5px 15px rgba(0,0,0,0.08);">';
      html += '<h3 style="color:var(--primary);margin-bottom:20px;">üèÜ Ganadores Registrados</h3>';
      html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.95rem;">';
      html += '<thead><tr style="background:var(--primary);color:white;">';
      html += '<th style="padding:12px;text-align:left;">Fecha</th>';
      html += '<th style="padding:12px;text-align:left;">KPI</th>';
      html += '<th style="padding:12px;text-align:left;">Ganador</th>';
      html += '<th style="padding:12px;text-align:left;">LOB</th>';
      html += '<th style="padding:12px;text-align:right;">Bono Original</th>';
      html += '<th style="padding:12px;text-align:center;">% Adicional</th>';
      html += '<th style="padding:12px;text-align:right;">Bono Total</th>';
      html += '</tr></thead><tbody>';
      
      ganadores.forEach((g, i) => {
          const bgColor = i % 2 === 0 ? '#f8f9fa' : 'white';
          html += '<tr style="background:' + bgColor + ';">';
          html += '<td style="padding:10px;">' + (g.fechaRegistro instanceof Date ? Utilities.formatDate(g.fechaRegistro, Session.getScriptTimeZone(), 'dd/MM/yyyy HH:mm') : g.fechaRegistro) + '</td>';
          html += '<td style="padding:10px;">' + g.kpi + '</td>';
          html += '<td style="padding:10px;"><strong>' + g.nombre.split(',')[0] + '</strong><br><small style="color:#7f8c8d;">BMS ' + g.bmsId + '</small></td>';
          html += '<td style="padding:10px;">' + g.lob + '</td>';
          html += '<td style="padding:10px;text-align:right;">$' + g.bonoOriginal.toLocaleString('es-CO', {minimumFractionDigits: 2}) + '</td>';
          html += '<td style="padding:10px;text-align:center;"><span style="background:#27ae60;color:white;padding:4px 10px;border-radius:12px;font-weight:600;">+' + g.porcentajeAdicional.toFixed(0) + '%</span></td>';
          html += '<td style="padding:10px;text-align:right;"><strong style="color:#27ae60;font-size:1.1rem;">$' + g.bonoTotal.toLocaleString('es-CO', {minimumFractionDigits: 2}) + '</strong></td>';
          html += '</tr>';
      });
      
      html += '</tbody></table></div></div>';
      
      // Agregar despu√©s de la lista de participantes
      const container = document.getElementById('ruleta-participantes');
      container.insertAdjacentHTML('afterend', '<div id="ganadores-mes">' + html + '</div>');
  }

  console.log('‚úÖ Sistema de Ganadores Ruleta cargado');

  function cargarParticipantesRuleta(fecha, kpi, callback) {
      // Primero obtener ganadores previos
      google.script.run
          .withSuccessHandler(function(ganadoresPrevios) {
              console.log('üìã Ganadores previos:', ganadoresPrevios);
              
              // Crear Set de BMS IDs de ganadores
              const ganadoresSet = new Set(ganadoresPrevios.map(g => g.bmsId));
              
              // Continuar con la carga normal pero filtrar
              google.script.run
                  .withSuccessHandler(function(res) {
                      if (!res.lobs || res.lobs.length === 0) return;
                      
                      participantesRuleta = [];
                      let procesadas = 0;
                      
                      res.lobs.forEach(lob => {
                          google.script.run
                              .withSuccessHandler(function(datosRecibidos) {
                                  if (!datosRecibidos.error && datosRecibidos.metricasPorLob && datosRecibidos.metricasPorLob[lob]) {
                                      const metricas = datosRecibidos.metricasPorLob[lob];
                                      
                                      if (!metricas.error) {
                                          const categorias = ['keys', 'bonusStructure', 'additionalIncentives', 'decreasedKPIs'];
                                          
                                          for (const cat of categorias) {
                                              const kpis = metricas[cat] || [];
                                              const kpiMatch = kpis.find(k => k.kpi === kpi);
                                              
                                              if (kpiMatch && kpiMatch.validacion) {
                                                  const empleadosCumplen = kpiMatch.validacion.empleadosCumplen || [];
                                                  
                                                  const top3 = empleadosCumplen
                                                      .sort((a, b) => (b.bono || 0) - (a.bono || 0))
                                                      .slice(0, 3);
                                                  
                                                  // ‚≠ê FILTRAR: Excluir ganadores previos
                                                  top3.forEach(agente => {
                                                      if (!ganadoresSet.has(agente.bmsId)) {
                                                          participantesRuleta.push({
                                                              nombre: agente.nombre,
                                                              bmsId: agente.bmsId,
                                                              lob: lob,
                                                              bono: agente.bono || 0
                                                          });
                                                      } else {
                                                          console.log('üö´ Excluido (ya gan√≥):', agente.nombre);
                                                      }
                                                  });
                                                  
                                                  break;
                                              }
                                          }
                                      }
                                  }
                                  
                                  procesadas++;
                                  
                                  if (procesadas === res.lobs.length) {
                                      if (participantesRuleta.length === 0) {
                                          mostrarAlerta('‚ö†Ô∏è No hay participantes disponibles (todos ya ganaron)', 'warning');
                                          return;
                                      }
                                      
                                      console.log(`‚úÖ ${participantesRuleta.length} participantes (${ganadoresPrevios.length} excluidos)`);
                                      
                                      if (callback) callback();
                                  }
                              })
                              .withFailureHandler(function(error) {
                                  console.error('‚ùå Error:', error);
                                  procesadas++;
                              })
                              .obtenerDatosParaFrontend(lob, fecha, null);
                      });
                  })
                  .withFailureHandler(function(error) {
                      console.error('‚ùå Error:', error);
                  })
                  .obtenerDatosParaFrontend();
          })
          .withFailureHandler(function(error) {
              console.error('‚ùå Error al obtener ganadores previos:', error);
              // Continuar sin filtrar
              if (callback) callback();
          })
          .obtenerGanadoresPrevios(fecha, kpi);
  }




  function mostrarListaParticipantes() {
      const container = document.getElementById('ruleta-participantes');
      
      let html = '<div style="background:white;border-radius:12px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,0.08);">';
      html += '<h3 style="color:var(--primary);margin-bottom:20px;">üë• Participantes (' + participantesRuleta.length + ')</h3>';
      html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px;">';
      
      participantesRuleta.forEach((p, i) => {
          const colores = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#34495e'];
          const color = colores[i % colores.length];
          
          html += '<div style="background:' + color + '15;border-left:4px solid ' + color + ';padding:15px;border-radius:8px;">';
          html += '<div style="font-weight:600;color:var(--primary);margin-bottom:5px;">' + p.nombre.split(',')[0] + '</div>';
          html += '<div style="font-size:0.85rem;color:#7f8c8d;margin-bottom:5px;">BMS ' + p.bmsId + ' | ' + p.lob + '</div>';
          html += '<div style="font-size:1.1rem;font-weight:700;color:' + color + ';">$' + p.bono.toLocaleString('es-CO', {minimumFractionDigits: 2}) + '</div>';
          html += '</div>';
      });
      
      html += '</div></div>';
      
      container.innerHTML = html;
  }

  console.log('‚úÖ M√≥dulo Ruleta cargado');



    
  // ========================================
  // VARIABLES GLOBALES
  // ========================================
  let datos = {};
  const empleadosPorLob = {};
  let chartKPIs = null;
  let chartLOBs = null;
  let chartDistribucion = null;
  let mesComparativoActual = null;
  let chartKPIPagos = null;
  // Al inicio con las otras variables (l√≠nea ~10):
  let chartHistoricalMeses = null;
  let prorrateosMarcados = [];



  const mesesNombres = {
      1: 'Enero', 2: 'Febrero', 3: 'Marzo', 4: 'Abril',
      5: 'Mayo', 6: 'Junio', 7: 'Julio', 8: 'Agosto',
      9: 'Septiembre', 10: 'Octubre', 11: 'Noviembre', 12: 'Diciembre'
  };

  const selectLob = document.getElementById('selectLob');
  const selectFecha = document.getElementById('selectFechas');
  const selectMesComparativo = document.getElementById('selectMesComparativo');

  // ========================================
  // INICIALIZACI√ìN
  // ========================================
  console.log('üöÄ Iniciando aplicaci√≥n Dashboard KPIs...');

  google.script.run
      .withSuccessHandler(function(res) {
          console.log('‚úÖ Datos iniciales recibidos:', res);
          if (res.error) {
              mostrarAlerta('Error: ' + res.error, 'danger');
              return;
          }
          mostrarDatosUsuario(res);
      })
      .withFailureHandler(function(error) {
          console.error('‚ùå Error al cargar datos iniciales:', error);
          mostrarAlerta('Error al cargar datos del usuario: ' + error.message, 'danger');
      })
      .obtenerDatosParaFrontend();

  // ========================================
  // EVENTOS DE FILTROS
  // ========================================

  selectLob.addEventListener('change', function() {
      const lobSeleccionada = this.value;
      console.log('üîµ LOB seleccionada:', lobSeleccionada);
      
      selectFecha.innerHTML = '<option value="">Selecciona una fecha</option>';
      selectFecha.disabled = true;
      selectMesComparativo.innerHTML = '<option value="">Primero selecciona fecha</option>';
      selectMesComparativo.disabled = true;
      ocultarResultados();
      limpiarAlertas();
      ocultarIndicador();
      limpiarExtras();
      
      if (!lobSeleccionada) return;
      
      mostrarLoading('Cargando fechas disponibles...');
      
      google.script.run
          .withSuccessHandler(function(fechas) {
              console.log('üìÖ Fechas recibidas:', fechas);
              selectFecha.innerHTML = '<option value="">Selecciona una fecha</option>';
              
              if (!fechas || fechas.length === 0) {
                  selectFecha.innerHTML = '<option value="">No hay fechas disponibles</option>';
                  mostrarAlerta('‚ö†Ô∏è No hay fechas registradas para esta LOB', 'warning');
                  ocultarLoading();
                  return;
              }
              
              fechas.forEach(f => {
                  const opt = document.createElement('option');
                  opt.value = f;
                  opt.textContent = f;
                  selectFecha.appendChild(opt);
              });
              
              selectFecha.disabled = false;
              ocultarLoading();
              mostrarAlerta(`‚úÖ Se encontraron ${fechas.length} fechas disponibles`, 'success');
          })
          .withFailureHandler(function(error) {
              console.error('‚ùå Error al cargar fechas:', error);
              mostrarAlerta('Error al cargar fechas: ' + error.message, 'danger');
              ocultarLoading();
          })
          .obtenerFechasPorLob(lobSeleccionada);
  });

  selectFecha.addEventListener('change', function() {
      const fechaSeleccionada = this.value;
      console.log('üìÜ Fecha seleccionada:', fechaSeleccionada);
      
      selectMesComparativo.innerHTML = '<option value="">Selecciona mes CDM</option>';
      selectMesComparativo.disabled = true;
      ocultarResultados();
      limpiarAlertas();
      ocultarIndicador();
      limpiarExtras();
      
      if (!fechaSeleccionada) return;
      
      mostrarLoading('Cargando meses CDM disponibles...');
      
      google.script.run
          .withSuccessHandler(function(meses) {
              console.log('üìä Meses CDM disponibles:', meses);
              selectMesComparativo.innerHTML = '<option value="">CDM General</option>';
              
              if (meses && meses.length > 0) {
                  meses.forEach(mesObj => {
                      const opt = document.createElement('option');
                      opt.value = mesObj.numero;
                      opt.textContent = mesObj.nombre;
                      selectMesComparativo.appendChild(opt);
                  });
              }
              
              selectMesComparativo.disabled = false;
              ocultarLoading();
              mostrarAlerta('‚ÑπÔ∏è Selecciona el mes CDM para comparar (o deja "CDM General")', 'info');
          })
          .withFailureHandler(function(error) {
              console.error('‚ùå Error al cargar meses:', error);
              mostrarAlerta('Error al cargar meses: ' + error.message, 'danger');
              ocultarLoading();
          })
          .obtenerMesesCDMDisponibles();
  });

  selectMesComparativo.addEventListener('change', function() {
      mesComparativoActual = this.value ? parseInt(this.value) : null;
      const lobSeleccionada = selectLob.value;
      const fechaSeleccionada = selectFecha.value;
      
      console.log('üîÑ Mes comparativo seleccionado:', mesComparativoActual);
      
      if (!lobSeleccionada || !fechaSeleccionada) {
          mostrarAlerta('‚ö†Ô∏è Debes seleccionar LOB y Fecha primero', 'warning');
          return;
      }
      
      mostrarIndicadorComparacion(mesComparativoActual);
      cargarDatosCompletos(lobSeleccionada, fechaSeleccionada, mesComparativoActual);
  });

  // ========================================
  // CARGA DE DATOS
  // ========================================


  function cargarDatosCompletos(lob, fecha, mes) {
      console.log('üîç Cargando datos completos:', { lob, fecha, mes });
      
      limpiarComponentesDuplicados();
      mostrarLoading('Procesando datos de KPIs y agentes...');
      limpiarAlertas();
      limpiarExtras();
      
      let intentos = 0;
      const maxIntentos = 2;
      
      function ejecutarCarga() {
          intentos++;
          console.log(`üîÑ Intento ${intentos} de ${maxIntentos}`);
          
          google.script.run
              .withSuccessHandler(function(datosRecibidos) {
                  console.log('‚úÖ Respuesta recibida del servidor en intento', intentos);
                  console.log('üì¶ Datos completos recibidos:', datosRecibidos);
                  
                  if (!datosRecibidos) {
                      console.error('‚ùå datosRecibidos es null/undefined en intento', intentos);
                      
                      if (intentos < maxIntentos) {
                          console.log('üîÑ Reintentando...');
                          setTimeout(ejecutarCarga, 2000);
                          return;
                      }
                      
                      mostrarError('No se pudieron cargar los datos despu√©s de ' + maxIntentos + ' intentos.');
                      return;
                  }
                  
                  if (datosRecibidos.error) {
                      mostrarError('Error del servidor: ' + datosRecibidos.error);
                      return;
                  }
                  
                  datos = datosRecibidos;
                  
                  // ‚≠ê NUEVO: Cargar horas por agente
                  if (datosRecibidos.horasPorAgente) {
                      horasPorAgente = datosRecibidos.horasPorAgente;
                      console.log('‚è±Ô∏è Horas cargadas:', horasPorAgente);
                      console.log('‚è±Ô∏è Total agentes con horas:', Object.keys(horasPorAgente).length);
                      
                      // Mostrar detalles de cada agente con horas
                      Object.keys(horasPorAgente).forEach(bmsId => {
                          const h = horasPorAgente[bmsId];
                          console.log(`   üë§ BMS ${bmsId}: ${h.horas}h, Ausencias: ${h.ausencias}`);
                      });
                  } else {
                      horasPorAgente = {};
                      console.warn('‚ö†Ô∏è No se recibieron horas por agente');
                  }
                  
                  console.log('‚úÖ Datos cargados exitosamente en intento', intentos);
                  validarYMostrarAgentes(lob);
                  procesarYMostrarDatos(lob);
                  ocultarLoading();
              })
              .withFailureHandler(function(err) {
                  console.error('‚ùå Error en intento', intentos, ':', err);
                  
                  if (intentos < maxIntentos) {
                      console.log('üîÑ Reintentando en 2 segundos...');
                      setTimeout(ejecutarCarga, 2000);
                      return;
                  }
                  
                  mostrarError('Error de conexi√≥n despu√©s de ' + maxIntentos + ' intentos: ' + err.message);
              })
              .obtenerDatosParaFrontend(lob, fecha, mes);
      }
      
      ejecutarCarga();
  }


  function validarYMostrarAgentes(lob) {
      console.log('üîç Validando agentes para LOB:', lob);
      
      // ‚≠ê VALIDACI√ìN: Verificar que datos exista
      if (!datos || !datos.metricasPorLob) {
          mostrarAlerta('‚ùå No se encontraron datos de m√©tricas', 'danger');
          return;
      }
      
      if (!datos.metricasPorLob[lob]) {
          mostrarAlerta(`‚ùå No se encontraron m√©tricas para esta LOB: ${lob}`, 'danger');
          return;
      }
      
      const metricas = datos.metricasPorLob[lob];
      
      // ‚≠ê VALIDACI√ìN SEGURA para error
      if (metricas.error) {
          mostrarAlerta(`‚ö†Ô∏è ${metricas.error}`, 'warning');
          return;
      }
      
      let totalAgentes = 0;
      const agentesUnicos = new Set();
      const categorias = ['keys', 'bonusStructure', 'additionalIncentives', 'decreasedKPIs'];
      
      categorias.forEach(cat => {
          if (metricas[cat]) {
              metricas[cat].forEach(kpiObj => {
                  const val = kpiObj.validacion || {};
                  
                  (val.empleadosCumplen || []).forEach(emp => {
                      agentesUnicos.add(emp.bmsId);
                      totalAgentes++;
                  });
                  
                  (val.empleadosNoCumplen || []).forEach(emp => {
                      agentesUnicos.add(emp.bmsId);
                      totalAgentes++;
                  });
                  
                  (val.empleadosSinDatos || []).forEach(emp => {
                      agentesUnicos.add(emp.bmsId);
                      totalAgentes++;
                  });
              });
          }
      });
      
      console.log(`üìä Agentes: ${agentesUnicos.size} √∫nicos, ${totalAgentes} registros`);
      
      if (agentesUnicos.size === 0) {
          mostrarAlerta('‚ö†Ô∏è <strong>NO se encontraron agentes para esta LOB</strong>', 'danger');
      } else {
          mostrarAlerta(`‚úÖ Se encontraron <strong>${agentesUnicos.size} agentes √∫nicos</strong> (${totalAgentes} evaluaciones) para: <strong>${lob}</strong>`, 'success');
      }
  }


  // ‚≠ê FUNCI√ìN AUXILIAR: Limpiar componentes duplicados
  function limpiarComponentesDuplicados() {
      const componentes = [
          '.indicadores-container',
          '.top10-container',
          '.agentes-trasladados-info',
          '.traslados-mensaje'
      ];
      
      componentes.forEach(selector => {
          const elementos = document.querySelectorAll(selector);
          if (elementos.length > 1) {
              // Mantener solo el primero, eliminar los dem√°s
              for (let i = 1; i < elementos.length; i++) {
                  elementos[i].remove();
              }
              console.log(`üßπ Limpiados duplicados de: ${selector}`);
          }
      });
  }

  // ‚≠ê FUNCI√ìN AUXILIAR: Limpiar extras
  function limpiarExtras() {
      const elementos = [
          '.top10-container',
          '.indicadores-container',
          '.agentes-trasladados-info',
          '.traslados-mensaje'
      ];
      
      elementos.forEach(selector => {
          const elemento = document.querySelector(selector);
          if (elemento) {
              elemento.remove();
          }
      });
  }

  // ‚≠ê FUNCI√ìN AUXILIAR: Mostrar loading
  function mostrarLoading(mensaje = 'Cargando...') {
      const container = document.getElementById('table-container');
      if (container) {
          container.innerHTML = '<div class="loading">‚è≥ ' + mensaje + '</div>';
          container.style.display = 'block';
      }
      ocultarResultados();
  }
  // ‚≠ê FUNCI√ìN AUXILIAR: Ocultar loading
  function ocultarLoading() {
      const container = document.getElementById('table-container');
      if (container && container.querySelector('.loading')) {
          container.style.display = 'none';
      }
  }

  // ‚≠ê FUNCI√ìN AUXILIAR: Ocultar resultados
  function ocultarResultados() {
      const elementos = [
          'metrics-grid',
          'charts-grid',
          'kpi-payment-chart-container'
      ];
      
      elementos.forEach(id => {
          const elemento = document.getElementById(id);
          if (elemento) {
              elemento.style.display = 'none';
          }
      });
  }

  // ‚≠ê FUNCI√ìN AUXILIAR: Limpiar alertas
  function limpiarAlertas() {
      const container = document.getElementById('alerts-container');
      if (container) {
          container.innerHTML = '';
      }
  }


  // ‚≠ê NUEVA FUNCI√ìN: Mostrar informaci√≥n de traslados
  function cargarInformacionTraslados(lob, fecha, mes) {
      google.script.run
          .withSuccessHandler(function(traslados) {
              mostrarMensajesTraslados(traslados, lob);
              resaltarAgentesTrasladados(traslados.salientes);
          })
          .withFailureHandler(function(error) {
              console.error('‚ùå Error al cargar traslados:', error);
          })
          .obtenerAgentesTrasladados(lob, fecha, mes);
  }

  // ‚≠ê NUEVA FUNCI√ìN: Mostrar mensajes informativos
  function mostrarMensajesTraslados(traslados, lobActual) {
      const { salientes, entrantes } = traslados;
      
      // Mensaje para agentes que SALIERON
      if (salientes.length > 0) {
          const mensajeSalientes = `
              <div style="background:#fff3cd;border-left:4px solid #f39c12;padding:15px;margin-bottom:15px;border-radius:8px;">
                  <strong>üì§ Agentes Trasladados Temporalmente</strong><br>
                  <small>${salientes.length} agente(s) de <strong>${lobActual}</strong> fueron trasladados a otras LOBs este mes:</small>
                  <ul style="margin:8px 0 0 0;padding-left:20px;">
                      ${salientes.map(agente => 
                          `<li><strong>${agente.nombre}</strong> (BMS ${agente.bmsId}) ‚Üí ${agente.lobDestino}</li>`
                      ).join('')}
                  </ul>
              </div>
          `;
          
          document.getElementById('table-container').insertAdjacentHTML('beforebegin', mensajeSalientes);
      }
      
      // Mensaje para agentes que LLEGARON
      if (entrantes.length > 0) {
          const mensajeEntrantes = `
              <div style="background:#d4edda;border-left:4px solid #28a745;padding:15px;margin-bottom:15px;border-radius:8px;">
                  <strong>üì• Agentes Recibidos Temporalmente</strong><br>
                  <small>${entrantes.length} agente(s) se unieron a <strong>${lobActual}</strong> desde otras LOBs:</small>
                  <ul style="margin:8px 0 0 0;padding-left:20px;">
                      ${entrantes.map(agente => 
                          `<li><strong>${agente.nombre}</strong> (BMS ${agente.bmsId}) ‚Üê ${agente.lobOrigen}</li>`
                      ).join('')}
                  </ul>
              </div>
          `;
          
          document.getElementById('table-container').insertAdjacentHTML('beforebegin', mensajeEntrantes);
      }
  }

  // ‚≠ê NUEVA FUNCI√ìN: Resaltar agentes trasladados en la tabla
  function resaltarAgentesTrasladados(agentesSalientes) {
      if (agentesSalientes.length === 0) return;
      
      agentesSalientes.forEach(agente => {
          const fila = document.querySelector(`tr[data-bms="${agente.bmsId}"]`);
          if (fila) {
              fila.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%)';
              fila.style.borderLeft = '4px solid #f39c12';
              
              // Agregar badge informativo
              const celdaAcciones = fila.querySelector('td:nth-child(2)'); // Celda de rec√°lculo
              if (celdaAcciones) {
                  celdaAcciones.innerHTML += `
                      <div style="margin-top:5px;">
                          <span style="background:#f39c12;color:white;padding:2px 8px;border-radius:10px;font-size:0.7rem;font-weight:bold;">
                              üì§ Trasladado a ${agente.lobDestino}
                          </span>
                      </div>
                  `;
              }
          }
      });
  }









  function procesarYMostrarDatos(lobSeleccionada) {
      console.log('üìä Procesando datos para LOB:', lobSeleccionada);
      
      // ‚≠ê VALIDACI√ìN: Verificar que datos exista
      if (!datos) {
          mostrarError('No hay datos disponibles para procesar');
          return;
      }
      
      // ‚≠ê VALIDACI√ìN: Verificar metricasPorLob
      if (!datos.metricasPorLob || !datos.metricasPorLob[lobSeleccionada]) {
          mostrarError(`No se encontraron m√©tricas para la LOB: ${lobSeleccionada}`);
          return;
      }
      
      mostrarTablaPorLob(lobSeleccionada);
      generarMetricas(lobSeleccionada);
      generarTop10(lobSeleccionada);
      generarIndicadoresPerformance(lobSeleccionada);
      generarGraficos();
  }

  function mostrarDatosUsuario(res) {
      document.getElementById('nombreUsuario').textContent = res.usuario.nombre;
      document.getElementById('correoUsuario').textContent = res.usuario.correo;
      document.getElementById('rolUsuario').textContent = res.usuario.rol;
      
      const lobList = res.lobs || [];
      
      if (lobList.length === 0) {
          selectLob.innerHTML = '<option value="">No hay LOBs asignadas</option>';
          selectLob.disabled = true;
          mostrarAlerta('‚ö†Ô∏è No tienes LOBs asignadas', 'warning');
          return;
      }
      
      selectLob.innerHTML = '<option value="">Selecciona una LOB</option>';
      lobList.forEach(lob => {
          const opt = document.createElement('option');
          opt.value = lob;
          opt.textContent = lob;
          selectLob.appendChild(opt);
      });
      
      console.log(`‚úÖ Usuario: ${res.usuario.nombre}, LOBs: ${lobList.length}`);
      mostrarAlerta(`üëã Bienvenido <strong>${res.usuario.nombre}</strong>`, 'info');
  }

  // ========================================
  // M√âTRICAS
  // ========================================

function generarMetricas(lobSeleccionada) {
    const empleados = empleadosPorLob[lobSeleccionada];
    
    if (!empleados || Object.keys(empleados).length === 0) {
        console.warn('‚ö†Ô∏è No hay empleados');
        document.getElementById('metrics-grid').style.display = 'none';
        return;
    }
    
    const keys = Object.keys(empleados);
    let totalBonos = 0;
    let totalKPIs = 0;
    let kpisCumplidos = 0;
    let topBono = 0;
    let topNombre = '';
    
    console.log('üìä Calculando m√©tricas para LOB:', lobSeleccionada);
    
    keys.forEach(key => {
        const emp = empleados[key];
        let bonoEmpleado = 0;
        let keysDelEmpleado = [];
        let otrasCategoriasDelEmpleado = 0;
        
        // ========================================
        // ‚≠ê CALCULAR KEYS PRIMERO
        // ========================================
        Object.keys(emp.resultados).forEach(resKey => {
            if (resKey.startsWith('keys_')) {
                const res = emp.resultados[resKey];
                totalKPIs++;
                
                if (!res.sinDatos) {
                    if (res.cumple) {
                        kpisCumplidos++;
                        const bono = res.bono || 0;
                        if (bono > 0) {
                            keysDelEmpleado.push({ cumple: true, bono: bono });
                        }
                    } else {
                        keysDelEmpleado.push({ cumple: false, bono: 0 });
                    }
                }
            }
        });
        
        // ========================================
        // ‚≠ê CALCULAR OTRAS CATEGOR√çAS
        // ========================================
        Object.keys(emp.resultados).forEach(resKey => {
            if (!resKey.startsWith('keys_')) {
                const res = emp.resultados[resKey];
                totalKPIs++;
                
                if (res.cumple && !res.sinDatos) {
                    kpisCumplidos++;
                    const bono = res.bono || 0;
                    if (bono > 0) {
                        otrasCategoriasDelEmpleado += bono;
                    }
                }
            }
        });
        
        // ========================================
        // ‚≠ê APLICAR L√ìGICA DE KEYS
        // ========================================
        if (keysDelEmpleado.length > 0) {
            // Tiene keys: validar que todos cumplan
            const todosKeysCumplen = keysDelEmpleado.every(k => k.cumple);
            
            if (todosKeysCumplen) {
                // ‚úÖ Todos los keys OK: sumar keys + otras
                const totalKeys = keysDelEmpleado.reduce((sum, k) => sum + k.bono, 0);
                bonoEmpleado = totalKeys + otrasCategoriasDelEmpleado;
                console.log(`‚úÖ ${emp.nombre}: Keys OK ($${totalKeys}) + Otras ($${otrasCategoriasDelEmpleado}) = $${bonoEmpleado}`);
            } else {
                // ‚ùå Fall√≥ alg√∫n key: bono = 0
                bonoEmpleado = 0;
                console.log(`‚ùå ${emp.nombre}: Fall√≥ key ‚Üí $0 (perdi√≥ $${otrasCategoriasDelEmpleado})`);
            }
        } else {
            // Sin keys: solo otras categor√≠as
            bonoEmpleado = otrasCategoriasDelEmpleado;
            console.log(`‚ÑπÔ∏è ${emp.nombre}: Sin keys ‚Üí $${bonoEmpleado}`);
        }
        
        // ========================================
        // ‚≠ê GARANTIZAR QUE NUNCA SEA NEGATIVO
        // ========================================
        if (bonoEmpleado < 0) {
            console.warn(`‚ö†Ô∏è ${emp.nombre}: Bono negativo detectado (${bonoEmpleado}), forzando a 0`);
            bonoEmpleado = 0;
        }
        
        // ‚≠ê SOLO SUMAR SI ES POSITIVO
        if (bonoEmpleado > 0) {
            totalBonos += bonoEmpleado;
        }
        
        // Actualizar top performer
        if (bonoEmpleado > topBono) {
            topBono = bonoEmpleado;
            topNombre = emp.nombre;
        }
    });
    
    const porcentajeCumplimiento = totalKPIs > 0 ? ((kpisCumplidos / totalKPIs) * 100).toFixed(1) : 0;
    
    console.log('üìä Resumen de m√©tricas:');
    console.log(`   Total Bonos: $${totalBonos.toFixed(2)}`);
    console.log(`   Total KPIs: ${totalKPIs}`);
    console.log(`   KPIs Cumplidos: ${kpisCumplidos}`);
    console.log(`   Cumplimiento: ${porcentajeCumplimiento}%`);
    console.log(`   Top Performer: ${topNombre} - $${topBono.toFixed(2)}`);
    
    const metricsGrid = document.getElementById('metrics-grid');
    metricsGrid.innerHTML = `
        <div class="metric-card success">
            <div class="metric-icon">üí∞</div>
            <div class="metric-label">Total Bonos</div>
            <div class="metric-value">$${totalBonos.toLocaleString('es-CO', {minimumFractionDigits: 2})}</div>
            <div class="metric-subtitle">Suma total pagada</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon">üìä</div>
            <div class="metric-label">Cumplimiento</div>
            <div class="metric-value">${porcentajeCumplimiento}%</div>
            <div class="metric-subtitle">${kpisCumplidos} de ${totalKPIs} KPIs</div>
        </div>
        
        <div class="metric-card warning">
            <div class="metric-icon">üë•</div>
            <div class="metric-label">Empleados</div>
            <div class="metric-value">${keys.length}</div>
            <div class="metric-subtitle">Total evaluados</div>
        </div>
        
        <div class="metric-card danger">
            <div class="metric-icon">üèÜ</div>
            <div class="metric-label">Top Performer</div>
            <div class="metric-value">$${topBono.toLocaleString('es-CO', {minimumFractionDigits: 2})}</div>
            <div class="metric-subtitle">${topNombre.split(',')[0]}</div>
        </div>
    `;
    
    metricsGrid.style.display = 'grid';
    console.log(`‚úÖ M√©tricas generadas: ${keys.length} empleados`);
}







  function generarTop10(lobSeleccionada) {
      // ‚≠ê PRIMERO: Limpiar Top 10 existente
      const top10Existente = document.querySelector('.top10-container');
      if (top10Existente) {
          top10Existente.remove();
      }
      
      const empleados = empleadosPorLob[lobSeleccionada];
      
      if (!empleados || Object.keys(empleados).length === 0) return;
      
      const ranking = [];
      
      Object.keys(empleados).forEach(key => {
          const emp = empleados[key];
          let totalBono = 0;
          
          Object.values(emp.resultados).forEach(res => {
              if (res.cumple && !res.sinDatos) {
                  totalBono += res.bono || 0;
              }
          });
          
          if (totalBono > 0) {
              ranking.push({ bmsId: emp.bmsId, nombre: emp.nombre, bono: totalBono });
          }
      });
      
      ranking.sort((a, b) => b.bono - a.bono);
      const top10 = ranking.slice(0, 10);
      
      if (top10.length === 0) return;
      
      let html = '<div class="top10-container" style="background:white;border-radius:12px;padding:25px;margin-bottom:25px;box-shadow:0 5px 15px rgba(0,0,0,0.08);"><button class="accordion-header" onclick="toggleAccordion(this)"><h3 style="color:var(--primary);margin:0;">üèÜ Top 10 Performers - ' + lobSeleccionada + '</h3><span class="accordion-arrow">‚ñº</span></button><div class="accordion-content" style="display:none;grid-template-columns:1fr;gap:10px;margin-top:20px;">';
      
      top10.forEach((emp, i) => {
          const medalla = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i + 1) + '.';
          const bgColor = i === 0 ? '#ffd700' : i === 1 ? '#c0c0c0' : i === 2 ? '#cd7f32' : '#f8f9fa';
          
          html += '<div style="display:flex;align-items:center;justify-content:space-between;padding:12px 15px;background:' + bgColor + '15;border-radius:8px;border-left:4px solid ' + bgColor + ';"><div style="display:flex;align-items:center;gap:10px;"><span style="font-size:1.5rem;">' + medalla + '</span><div><div style="font-weight:600;color:var(--primary);">' + emp.nombre.split(',')[0] + '</div><div style="font-size:0.85rem;color:#7f8c8d;">BMS ' + emp.bmsId + '</div></div></div><div style="text-align:right;"><div style="font-size:1.3rem;font-weight:700;color:var(--success);">$' + emp.bono.toLocaleString('es-CO', {minimumFractionDigits: 2}) + '</div></div></div>';
      });
      
      html += '</div></div>';
      
      // ‚≠ê INSERTAR en posici√≥n espec√≠fica (despu√©s de indicadores, antes de tabla)
      const indicadores = document.querySelector('.indicadores-container');
      const tableContainer = document.getElementById('table-container');
      
      if (indicadores && tableContainer) {
          indicadores.insertAdjacentHTML('afterend', html);
      } else if (tableContainer) {
          tableContainer.insertAdjacentHTML('beforebegin', html);
      }
      
      console.log(`‚úÖ Top 10 generado`);
  }




  function generarIndicadoresPerformance(lobSeleccionada) {
      // ‚≠ê PRIMERO: Limpiar indicadores existentes
      const indicadoresExistente = document.querySelector('.indicadores-container');
      if (indicadoresExistente) {
          indicadoresExistente.remove();
      }
      
      const empleados = empleadosPorLob[lobSeleccionada];
      if (!empleados || Object.keys(empleados).length === 0) return;
      
      const metricas = datos.metricasPorLob[lobSeleccionada];
      if (!metricas) return;
      
      const categorias = ['keys', 'bonusStructure', 'additionalIncentives', 'decreasedKPIs'];
      const indicadores = {};
      
      // ‚≠ê TOTAL DE AGENTES √öNICOS
      const totalAgentesUnicos = Object.keys(empleados).length;
      
      categorias.forEach(cat => {
          const kpis = metricas[cat] || [];
          
          // ‚≠ê Contar cu√°ntos agentes √öNICOS cumplieron AL MENOS 1 KPI de esta categor√≠a
          const agentesCumplen = new Set();
          
          kpis.forEach(kpiObj => {
              const val = kpiObj.validacion || {};
              (val.empleadosCumplen || []).forEach(emp => {
                  agentesCumplen.add(emp.bmsId);
              });
          });
          
          const cumplidos = agentesCumplen.size;
          const total = totalAgentesUnicos;
          const porcentaje = total > 0 ? ((cumplidos / total) * 100).toFixed(1) : 0;
          const color = porcentaje >= 80 ? '#27ae60' : porcentaje >= 50 ? '#f39c12' : '#e74c3c';
          
          indicadores[cat] = { cumplidos, total, porcentaje, color };
      });
      
      const nombres = { 
          keys: 'Keys', 
          bonusStructure: 'Bonus Structure', 
          additionalIncentives: 'Additional Incentives', 
          decreasedKPIs: 'Decreased KPIs' 
      };
      
      let html = '<div class="indicadores-container" style="background:white;border-radius:12px;padding:25px;margin-bottom:25px;box-shadow:0 5px 15px rgba(0,0,0,0.08);"><h3 style="color:var(--primary);margin-bottom:20px;">üìà Indicadores por Categor√≠a</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;">';
      
      Object.keys(indicadores).forEach(cat => {
          const ind = indicadores[cat];
          html += '<div style="padding:15px;border-radius:8px;background:' + ind.color + '10;border-left:4px solid ' + ind.color + ';"><div style="font-size:0.9rem;color:#7f8c8d;margin-bottom:8px;">' + nombres[cat] + '</div><div style="font-size:2rem;font-weight:700;color:' + ind.color + ';margin-bottom:5px;">' + ind.porcentaje + '%</div><div style="font-size:0.85rem;color:#95a5a6;">' + ind.cumplidos + ' de ' + ind.total + ' agentes</div><div style="margin-top:10px;background:#ecf0f1;border-radius:10px;height:8px;overflow:hidden;"><div style="width:' + ind.porcentaje + '%;height:100%;background:' + ind.color + ';"></div></div></div>';
      });
      
      html += '</div></div>';
      
      // ‚≠ê INSERTAR en posici√≥n espec√≠fica (antes de la tabla)
      const tableContainer = document.getElementById('table-container');
      if (tableContainer) {
          tableContainer.insertAdjacentHTML('beforebegin', html);
      }
      
      console.log('‚úÖ Indicadores generados:', indicadores);
  }



  // CONTIN√öA EN PARTE 2...
  // ========================================
  // GR√ÅFICOS
  // ========================================
 function generarGraficos() {
    if (!datos.metricasPorLob) return;
    
    const chartsGrid = document.getElementById('charts-grid');
    chartsGrid.innerHTML = '<div class="chart-card"><div class="chart-header"><h3 class="chart-title">üìä Cumplimiento de KPIs</h3></div><canvas id="chartKPIs"></canvas></div><div class="chart-card"><div class="chart-header"><h3 class="chart-title">üíµ Monto Total Pagado por KPI</h3></div><canvas id="chartLOBs"></canvas></div><div class="chart-card"><div class="chart-header"><h3 class="chart-title">üéØ Distribuci√≥n</h3></div><canvas id="chartDistribucion"></canvas></div>';
    
    chartsGrid.style.display = 'grid';
    crearGraficoKPIs();
    crearGraficoLOBs();
    crearGraficoDistribucion();
    crearGraficoKPIPagos();
}

  function crearGraficoKPIs() {
      const kpisCumplimiento = {
          keys: { cumplidos: 0, noCumplidos: 0, sinDatos: 0, valorPagado: 0 },
          bonusStructure: { cumplidos: 0, noCumplidos: 0, sinDatos: 0, valorPagado: 0 },
          additionalIncentives: { cumplidos: 0, noCumplidos: 0, sinDatos: 0, valorPagado: 0 },
          decreasedKPIs: { cumplidos: 0, noCumplidos: 0, sinDatos: 0, valorPagado: 0 }
      };
      
      const lobActual = selectLob.value;
      const empleados = empleadosPorLob[lobActual];
      
      if (!empleados || Object.keys(empleados).length === 0) return;
      
      Object.keys(empleados).forEach(empKey => {
          const emp = empleados[empKey];
          Object.keys(emp.resultados).forEach(resKey => {
              const res = emp.resultados[resKey];
              const categoria = resKey.split('_')[0];
              
              if (!kpisCumplimiento[categoria]) return;
              
              if (res.sinDatos) {
                  kpisCumplimiento[categoria].sinDatos++;
              } else if (res.cumple) {
                  kpisCumplimiento[categoria].cumplidos++;
                  kpisCumplimiento[categoria].valorPagado += res.bono || 0;
              } else {
                  kpisCumplimiento[categoria].noCumplidos++;
              }
          });
      });
      
      const ctx = document.getElementById('chartKPIs');
      if (chartKPIs) chartKPIs.destroy();
      
      const categoriasLabels = ['Keys', 'Bonus Structure', 'Additional Incentives', 'Decreased KPIs'];
      const categoriasKeys = ['keys', 'bonusStructure', 'additionalIncentives', 'decreasedKPIs'];
      
      chartKPIs = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: categoriasLabels,
              datasets: [
                  { label: 'Cumplidos', data: categoriasKeys.map(k => kpisCumplimiento[k].cumplidos), backgroundColor: 'rgba(39,174,96,0.8)', borderColor: 'rgba(39,174,96,1)', borderWidth: 2 },
                  { label: 'No Cumplidos', data: categoriasKeys.map(k => kpisCumplimiento[k].noCumplidos), backgroundColor: 'rgba(231,76,60,0.8)', borderColor: 'rgba(231,76,60,1)', borderWidth: 2 },
                  { label: 'Sin Datos', data: categoriasKeys.map(k => kpisCumplimiento[k].sinDatos), backgroundColor: 'rgba(149,165,166,0.6)', borderColor: 'rgba(149,165,166,1)', borderWidth: 2 }
              ]
          },
          options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                  tooltip: { callbacks: { afterLabel: function(context) {
                      const catIndex = context.dataIndex;
                      const catKey = categoriasKeys[catIndex];
                      const valor = kpisCumplimiento[catKey].valorPagado;
                      return 'Valor: $' + valor.toLocaleString('es-CO', {minimumFractionDigits: 2});
                  }}},
                  legend: { display: true, position: 'top' }
              },
              scales: { y: { beginAtZero: true, title: { display: true, text: 'Cantidad' }, ticks: { stepSize: 1 }}}
          }
      });
  }

  function crearGraficoLOBs() {
      const bonosPorLob = {};

      // Iterar a trav√©s de todas las LOBs que tienen m√©tricas procesadas en datos.metricasPorLob
      for (const lob in datos.metricasPorLob) {
          bonosPorLob[lob] = 0;
          const metricasDeLob = datos.metricasPorLob[lob];

          // Si hay un error para esta LOB, la saltamos
          if (metricasDeLob.error) {
              continue;
          }

          // Iterar a trav√©s de las categor√≠as de KPIs para sumar los bonos
          ['keys', 'bonusStructure', 'additionalIncentives', 'decreasedKPIs'].forEach(cat => {
              if (metricasDeLob[cat]) {
                  metricasDeLob[cat].forEach(kpiObj => {
                      const validacion = kpiObj.validacion;
                      if (validacion && validacion.empleadosCumplen) {
                          validacion.empleadosCumplen.forEach(emp => {
                              bonosPorLob[lob] += emp.bono || 0;
                          });
                      }
                  });
              }
          });
      }

      // >>> INICIO DEL CAMBIO: Filtrar LOBs con bonos mayores a 0
      const lobsConBonos = Object.keys(bonosPorLob).filter(lob => bonosPorLob[lob] > 0);
      // <<< FIN DEL CAMBIO

      const ctx = document.getElementById('chartLOBs');
      if (chartLOBs) chartLOBs.destroy();

      // Usar las LOBs filtradas para el gr√°fico
      const lobsLabels = lobsConBonos;
      const lobsData = lobsConBonos.map(lob => bonosPorLob[lob]);

      if (lobsLabels.length === 0) {
          // Si no hay LOBs con bonos, no se crea el gr√°fico
          return;
      }

      chartLOBs = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: lobsLabels,
              datasets: [{ label: 'Total Bonos ($)', data: lobsData, backgroundColor: 'rgba(52,152,219,0.8)', borderColor: 'rgba(52,152,219,1)', borderWidth: 2 }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: { tooltip: { callbacks: { label: function(context) { return '$' + context.parsed.y.toLocaleString('es-CO', {minimumFractionDigits: 2}); }}}, legend: { display: false }},
              scales: { y: { beginAtZero: true, title: { display: true, text: 'Total ($)' }, ticks: { callback: function(value) { return '$' + value.toLocaleString('es-CO'); }}}, x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 }}}
          }
      });
  }

  function crearGraficoDistribucion() {
      const lobActual = selectLob.value;
      const empleados = empleadosPorLob[lobActual];
      
      if (!empleados || Object.keys(empleados).length === 0) return;
      
      let cumplidos = 0, noCumplidos = 0, sinDatos = 0;
      
      Object.keys(empleados).forEach(empKey => {
          const emp = empleados[empKey];
          Object.values(emp.resultados).forEach(res => {
              if (res.sinDatos) sinDatos++;
              else if (res.cumple) cumplidos++;
              else noCumplidos++;
          });
      });
      
      const ctx = document.getElementById('chartDistribucion');
      if (chartDistribucion) chartDistribucion.destroy();
      
      chartDistribucion = new Chart(ctx, {
          type: 'doughnut',
          data: {
              labels: ['‚úÖ Cumplidos', '‚ùå No Cumplidos', '‚ö†Ô∏è Sin Datos'],
              datasets: [{ data: [cumplidos, noCumplidos, sinDatos], backgroundColor: ['rgba(39,174,96,0.8)', 'rgba(231,76,60,0.8)', 'rgba(149,165,166,0.6)'], borderColor: ['rgba(39,174,96,1)', 'rgba(231,76,60,1)', 'rgba(149,165,166,1)'], borderWidth: 2 }]
          },
          options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: function(context) { const total = cumplidos + noCumplidos + sinDatos; const porcentaje = ((context.parsed / total) * 100).toFixed(1); return context.label + ': ' + context.parsed + ' (' + porcentaje + '%)'; }}}}}
      });
  }


  // AGREGAR ESTA FUNCI√ìN COMPLETA despu√©s de la funci√≥n crearGraficoDistribucion() (aproximadamente l√≠nea 800):

  function crearGraficoKPIPagos() {
      const lobActual = selectLob.value;
      const metricas = datos.metricasPorLob ? datos.metricasPorLob[lobActual] : null;
      
      if (!metricas || metricas.error) return;
      
      const categorias = ['keys', 'bonusStructure', 'additionalIncentives', 'decreasedKPIs'];
      const kpisPagos = {};
      
      // Recopilar todos los pagos por KPI
      categorias.forEach(cat => {
          const kpis = metricas[cat] || [];
          kpis.forEach(kpiObj => {
              const kpiNombre = kpiObj.kpi;
              const validacion = kpiObj.validacion || {};
              
              if (!kpisPagos[kpiNombre]) {
                  kpisPagos[kpiNombre] = {
                      nombre: kpiNombre,
                      totalPagado: 0,
                      categoria: cat,
                      agentesQueCobraron: 0
                  };
              }
              
              // Sumar bonos de empleados que cumplieron
              (validacion.empleadosCumplen || []).forEach(emp => {
                  kpisPagos[kpiNombre].totalPagado += emp.bono || 0;
                  kpisPagos[kpiNombre].agentesQueCobraron++;
              });
          });
      });
      
      // Convertir a array y ordenar por monto pagado (descendente)
      const kpisArray = Object.values(kpisPagos).sort((a, b) => b.totalPagado - a.totalPagado);
      
      if (kpisArray.length === 0) {
          document.getElementById('kpi-payment-chart-container').style.display = 'none';
          return;
      }
      
      // Preparar datos para el gr√°fico
      const labels = kpisArray.map(k => k.nombre);
      const data = kpisArray.map(k => k.totalPagado);
      const agentes = kpisArray.map(k => k.agentesQueCobraron);
      
      // Colores seg√∫n categor√≠a
      const coloresPorCategoria = {
          'keys': 'rgba(52, 152, 219, 0.8)',
          'bonusStructure': 'rgba(39, 174, 96, 0.8)',
          'additionalIncentives': 'rgba(243, 156, 18, 0.8)',
          'decreasedKPIs': 'rgba(231, 76, 60, 0.8)'
      };
      
      const backgroundColors = kpisArray.map(k => coloresPorCategoria[k.categoria] || 'rgba(149, 165, 166, 0.8)');
      const borderColors = kpisArray.map(k => coloresPorCategoria[k.categoria]?.replace('0.8', '1') || 'rgba(149, 165, 166, 1)');
      
      const ctx = document.getElementById('chartKPIPagos');
      if (chartKPIPagos) chartKPIPagos.destroy();
      
      chartKPIPagos = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: labels,
              datasets: [{
                  label: 'Total Pagado ($)',
                  data: data,
                  backgroundColor: backgroundColors,
                  borderColor: borderColors,
                  borderWidth: 2
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: true,
              indexAxis: 'y', // Gr√°fico horizontal
              plugins: {
                  tooltip: {
                      callbacks: {
                          label: function(context) {
                              const valor = context.parsed.x;
                              const index = context.dataIndex;
                              const agentesCount = agentes[index];
                              return [
                                  'Total: $' + valor.toLocaleString('es-CO', {minimumFractionDigits: 2}),
                                  'Agentes que cobraron: ' + agentesCount
                              ];
                          }
                      }
                  },
                  legend: {
                      display: false
                  },
                  title: {
                      display: true,
                      text: 'Monto total pagado por cada KPI - LOB: ' + lobActual,
                      font: {
                          size: 14,
                          weight: 'bold'
                      }
                  }
              },
              scales: {
                  x: {
                      beginAtZero: true,
                      title: {
                          display: true,
                          text: 'Monto Total Pagado ($)'
                      },
                      ticks: {
                          callback: function(value) {
                              return '$' + value.toLocaleString('es-CO');
                          }
                      }
                  },
                  y: {
                      title: {
                          display: true,
                          text: 'KPIs'
                      },
                      ticks: {
                          autoSkip: false,
                          font: {
                              size: 10
                          }
                      }
                  }
              }
          }
      });
      
      // Mostrar el contenedor del gr√°fico
      document.getElementById('kpi-payment-chart-container').style.display = 'block';
      
      console.log('‚úÖ Gr√°fico de KPI Pagos generado:', kpisArray.length, 'KPIs');
  }

  // AGREGAR funci√≥n para toggle
  function toggleKPIChart() {
      const wrapper = document.getElementById('kpi-chart-wrapper');
      const toggleText = document.getElementById('toggle-kpi-text');
      
      if (wrapper.style.display === 'none') {
          wrapper.style.display = 'block';
          toggleText.textContent = 'Ocultar';
      } else {
          wrapper.style.display = 'none';
          toggleText.textContent = 'Mostrar';
      }
  }

  // ========================================
  // TABLA
  // ========================================
  let ordenActual = { columna: null, ascendente: true };





function mostrarTablaPorLob(lob) {
    const metricas = datos.metricasPorLob ? datos.metricasPorLob[lob] : null;
    
    if (!metricas || metricas.error) {
        const container = document.getElementById('table-container');
        container.innerHTML = '<div class="info-message">' + (metricas?.error || 'No hay datos') + '</div>';
        container.style.display = 'block';
        return;
    }
    
    const categorias = ['keys', 'bonusStructure', 'additionalIncentives', 'decreasedKPIs'];
    const empleados = {};
    
    categorias.forEach(cat => {
        const kpis = metricas[cat] || [];
        kpis.forEach((kpiObj, idx) => {
            const valid = kpiObj.validacion || {};
            const tipoValidacion = kpiObj.tipo || 'mayor';
            
            // ‚≠ê EMPLEADOS QUE CUMPLEN
            (valid.empleadosCumplen || []).forEach(emp => {
                const key = emp.bmsId + '_' + emp.nombre;
                if (!empleados[key]) {
                    empleados[key] = {bmsId: emp.bmsId, nombre: emp.nombre, resultados: {}};
                }
                
                const esKey = cat === 'keys';
                
                empleados[key].resultados[cat + '_' + idx] = {
                    ...emp,
                    cumple: true,
                    sinDatos: false,
                    esKey: esKey,
                    tipoValidacion: tipoValidacion,
                    categoria: cat
                };
            });
            
            // ‚≠ê EMPLEADOS QUE NO CUMPLEN
            (valid.empleadosNoCumplen || []).forEach(emp => {
                const key = emp.bmsId + '_' + emp.nombre;
                if (!empleados[key]) {
                    empleados[key] = {bmsId: emp.bmsId, nombre: emp.nombre, resultados: {}};
                }
                
                const esKey = cat === 'keys';
                
                empleados[key].resultados[cat + '_' + idx] = {
                    ...emp,
                    cumple: false,
                    sinDatos: false,
                    esKey: esKey,
                    tipoValidacion: tipoValidacion,
                    categoria: cat
                };
            });
            
            // ‚≠ê EMPLEADOS SIN DATOS
            (valid.empleadosSinDatos || []).forEach(emp => {
                const key = emp.bmsId + '_' + emp.nombre;
                if (!empleados[key]) {
                    empleados[key] = {bmsId: emp.bmsId, nombre: emp.nombre, resultados: {}};
                }
                
                empleados[key].resultados[cat + '_' + idx] = {
                    ...emp,
                    cumple: false,
                    sinDatos: true,
                    esKey: cat === 'keys',
                    tipoValidacion: tipoValidacion,
                    categoria: cat
                };
            });
        });
    });
    
    empleadosPorLob[lob] = empleados;
    
    // ‚≠ê CARGAR TODAS LAS LOBS DEL SISTEMA
    mostrarLoading('Cargando LOBs disponibles...');
    
    google.script.run
        .withSuccessHandler(function(todasLasLobs) {
            console.log('‚úÖ Todas las LOBs del sistema:', todasLasLobs);
            generarTablaConLobs(lob, empleados, metricas, categorias, todasLasLobs);
        })
        .withFailureHandler(function(error) {
            console.error('‚ùå Error al cargar LOBs:', error);
            const todasLasLobs = datos.lobs || [lob];
            generarTablaConLobs(lob, empleados, metricas, categorias, todasLasLobs);
        })
        .obtenerTodasLasLobsDelSistema();
}




  /////////////////////////////////////////7
function generarTablaConLobs(lob, empleados, metricas, categorias, todasLasLobs) {
    if (!empleados || !metricas || !categorias || !todasLasLobs) {
        console.error('‚ùå Par√°metros inv√°lidos en generarTablaConLobs');
        mostrarError('Datos incompletos para generar la tabla');
        return;
    }
    
    console.log('üìä Generando tabla para LOB:', lob);
    ocultarLoading();
    
    const traslados = datos.trasladosPorLob && datos.trasladosPorLob[lob] ? datos.trasladosPorLob[lob] : { salientes: [], entrantes: [] };
    const agentesTrasladados = traslados.salientes.map(t => t.bmsId);
    
    // ‚≠ê VARIABLE PARA ACUMULAR TOTAL GENERAL
    let totalGeneralTabla = 0;
    
    // ========================================
    // THEAD
    // ========================================
    let theadHTML = '<tr><th rowspan="2" onclick="ordenarTabla(0)" style="cursor:pointer;" title="Ordenar">#</th>';
    theadHTML += '<th rowspan="2" style="background:#3498db;color:white;min-width:200px;">üîÑ Trasladar</th>';
    theadHTML += '<th rowspan="2" onclick="ordenarTabla(1)" style="cursor:pointer;" title="Ordenar">BMS ID</th>';
    theadHTML += '<th rowspan="2" onclick="ordenarTabla(2)" style="cursor:pointer;" title="Ordenar">Nombre</th>';
        
    categorias.forEach(cat => {
        const kpis = metricas[cat] || [];
        theadHTML += kpis.length > 0 ? '<th colspan="' + (kpis.length * 2) + '">' + cat + '</th>' : '<th colspan="2">' + cat + '</th>';
    });
    
    theadHTML += '<th rowspan="2" onclick="ordenarTabla(-1)" style="cursor:pointer;background:#27ae60;" title="Ordenar">Total $</th>';
    theadHTML += '<th rowspan="2" style="background:#16a085;color:white;">‚è±Ô∏è Horas</th>';
    theadHTML += '<th rowspan="2" style="background:#16a085;color:white;">üìä Prorrateo</th>';
    
    // COLUMNA APROBAR
    theadHTML += '<th rowspan="2" style="background:#28a745;color:white;min-width:100px;">';
    theadHTML += '‚úÖ Aprobar<br>';
    theadHTML += '<label style="font-size:0.75rem;font-weight:normal;cursor:pointer;margin-top:5px;display:inline-block;">';
    theadHTML += '<input type="checkbox" id="select-all-aprobar" onchange="seleccionarTodosAprobar(this)" style="width:16px;height:16px;cursor:pointer;margin-right:5px;">';
    theadHTML += 'Todos</label>';
    theadHTML += '</th>';
    
    theadHTML += '<th rowspan="2" style="background:#9b59b6;color:white;">Disputar</th>';
    theadHTML += '<th rowspan="2" style="background:#9b59b6;color:white;">Comentario</th></tr><tr>';
    
    categorias.forEach(cat => {
        const kpis = metricas[cat] || [];
        if (kpis.length === 0) {
            theadHTML += '<th colspan="2">-</th>';
        } else {
            kpis.forEach(kpiObj => {
                theadHTML += '<th style="font-size:0.8rem;">' + kpiObj.kpi + '<br>Score: ' + (kpiObj.score || '-') + '</th>';
                theadHTML += '<th style="font-size:0.8rem;background:#34495e;">Bono $</th>';
            });
        }
    });
    
    theadHTML += '</tr>';
    
    // ========================================
    // TBODY
    // ========================================
    let tbodyHTML = '';
    const keys = Object.keys(empleados);
    
    if (keys.length === 0) {
        tbodyHTML = '<tr><td colspan="100" class="info-message">No hay empleados</td></tr>';
    } else {
        let contadorVisible = 0;
        
        // LOOP DE EMPLEADOS
        keys.forEach((empKey, i) => {
            const emp = empleados[empKey];
            const fueTrasladado = agentesTrasladados.includes(emp.bmsId);
            const estiloFila = fueTrasladado ? 'style="background:linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);border-left:4px solid #f39c12;"' : '';
            const claseFila = fueTrasladado ? 'class="agente-trasladado"' : '';
            
            tbodyHTML += `<tr data-bms="${emp.bmsId}" data-nombre="${emp.nombre.toLowerCase()}" id="row-${emp.bmsId}" ${estiloFila} ${claseFila}>`;
            tbodyHTML += '<td>' + (++contadorVisible) + '</td>';
            
            // CELDA DE TRASLADO
            tbodyHTML += '<td style="padding:8px;"><div style="display:flex;align-items:center;gap:8px;justify-content:center;">';
            
            if (fueTrasladado) {
                const trasladoInfo = traslados.salientes.find(t => t.bmsId === emp.bmsId);
                tbodyHTML += `<span style="background:#f39c12;color:white;padding:4px 8px;border-radius:10px;font-size:0.7rem;font-weight:bold;white-space:nowrap;">
                    üì§ Trasladado a ${trasladoInfo ? trasladoInfo.lobDestino : 'otra LOB'}
                </span>`;
            } else {
                tbodyHTML += '<input type="checkbox" class="recalc-check" data-bms="' + emp.bmsId + '" onchange="toggleRecalcLob(this)" style="width:18px;height:18px;cursor:pointer;">';
                tbodyHTML += '<select class="recalc-lob-select" data-bms="' + emp.bmsId + '" disabled style="padding:5px;border:1px solid #ddd;border-radius:4px;font-size:0.85rem;width:110px;"><option value="">LOB destino</option>';
                
                todasLasLobs.forEach(lobOption => {
                    if (lobOption !== lob) {
                        tbodyHTML += '<option value="' + lobOption + '">' + lobOption + '</option>';
                    }
                });
                
                tbodyHTML += '</select>';
            }
            
            tbodyHTML += '</div></td>';
            
            // BMS ID Y NOMBRE
            tbodyHTML += '<td>' + emp.bmsId + '</td>';
            tbodyHTML += '<td style="text-align:left;">' + emp.nombre;
            if (fueTrasladado) {
                tbodyHTML += '<br><small style="color:#e67e22;font-weight:bold;">üö® Trasladado temporalmente</small>';
            }
            tbodyHTML += '</td>';

            // CALCULAR TOTAL
            let totalKeys = 0;
            let todosKeysOK = true;
            let tieneAlgunKey = false;
            
            const kpisKeys = metricas['keys'] || [];
            kpisKeys.forEach((kpiObj, idx) => {
                const res = emp.resultados['keys_' + idx] || {};
                const bono = res.bono || 0;
                
                if (!res.sinDatos) {
                    tieneAlgunKey = true;
                    if (res.cumple) {
                        totalKeys += bono;
                    } else {
                        todosKeysOK = false;
                    }
                }
            });
            
            if (tieneAlgunKey && !todosKeysOK) {
                totalKeys = 0;
            }
            
            let totalOtrasCategorias = 0;

        // GENERAR CELDAS DE KPIs
categorias.forEach(cat => {
    const kpis = metricas[cat] || [];
    
    if (kpis.length === 0) {
        tbodyHTML += '<td colspan="2">-</td>';
    } else {
        kpis.forEach((kpiObj, idx) => {
            const res = emp.resultados[cat + '_' + idx] || {};
            const bono = res.bono || 0;
            const esKey = cat === 'keys';
            
            // ‚≠ê FORMATEAR valorF para mostrar m√°ximo 2 decimales
            let valorFormateado = '-';
            if (res.valorF !== undefined && res.valorF !== null) {
                const valor = parseFloat(res.valorF);
                if (!isNaN(valor)) {
                    // Si es n√∫mero entero, mostrar sin decimales; si tiene decimales, mostrar m√°ximo 2
                    if (Number.isInteger(valor)) {
                        valorFormateado = valor.toLocaleString('es-CO', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        });
                    } else {
                        valorFormateado = valor.toLocaleString('es-CO', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    }
                } else {
                    // Si no es n√∫mero (ej: "Si", "No"), mostrar tal cual
                    valorFormateado = res.valorF;
                }
            }
            
            if (esKey) {
                if (res.sinDatos) {
                    tbodyHTML += '<td style="background:#f0f0f0;color:#999;">Sin datos</td>';
                    tbodyHTML += '<td style="background:#f0f0f0;color:#999;">$0.00</td>';
                } else if (res.cumple) {
                    tbodyHTML += '<td style="background:#d4edda;color:#155724;font-weight:bold;">' + valorFormateado + '</td>';
                    tbodyHTML += '<td style="background:#d4edda;color:#155724;font-weight:bold;">$' + bono.toLocaleString('es-CO', {minimumFractionDigits: 2}) + '</td>';
                } else {
                    tbodyHTML += '<td style="background:#f8d7da;color:#721c24;font-weight:bold;">' + valorFormateado + '</td>';
                    tbodyHTML += '<td style="background:#f8d7da;color:#e74c3c;font-weight:bold;">$0.00</td>';
                }
            } else {
                if (res.cumple && !res.sinDatos && bono > 0) {
                    totalOtrasCategorias += bono;
                }
                
                if (res.sinDatos) {
                    tbodyHTML += '<td style="background:#f0f0f0;color:#999;">Sin datos</td>';
                    tbodyHTML += '<td style="background:#f0f0f0;">$0.00</td>';
                } else {
                    const claseEstilo = res.cumple ? 'cumple' : 'no-cumple';
                    tbodyHTML += '<td class="' + claseEstilo + '">' + valorFormateado + '</td>';
                    tbodyHTML += '<td>$' + Math.max(0, bono).toLocaleString('es-CO', {minimumFractionDigits: 2}) + '</td>';
                }
            }
        });
    }
});
            
            // CALCULAR TOTAL FINAL
            let totalFinal = 0;
            let mensajeTotal = '';
            let estiloTotal = 'background:#d5f4e6;font-weight:bold;';
            
            if (tieneAlgunKey) {
                if (todosKeysOK) {
                    totalFinal = Math.max(0, totalKeys) + Math.max(0, totalOtrasCategorias);
                } else {
                    totalFinal = 0;
                    if (totalOtrasCategorias > 0) {
                        estiloTotal = 'background:#f8d7da;font-weight:bold;border-left:4px solid #e74c3c;';
                        mensajeTotal = '<br><small style="font-size:0.65rem;color:#721c24;">‚ùå No cumple todos los keys</small>';
                    }
                }
            } else {
                totalFinal = Math.max(0, totalOtrasCategorias);
            }
            
            totalFinal = Math.max(0, totalFinal);
            const total = totalFinal;
            
            // ‚≠ê ACUMULAR AL TOTAL GENERAL
            totalGeneralTabla += total;
            
            // CELDA TOTAL
            tbodyHTML += `<td class="celda-total" 
                data-bms="${emp.bmsId}" 
                data-bono-original="${total}" 
                style="${estiloTotal}">
                $${total.toLocaleString('es-CO', {minimumFractionDigits: 2})}${mensajeTotal}
            </td>`;
            
            // CELDA DE HORAS
            const horasAgente = horasPorAgente[emp.bmsId];
            const tieneHoras = horasAgente && horasAgente.horas > 0;

            tbodyHTML += '<td style="text-align:center;">';
            if (tieneHoras) {
                tbodyHTML += `<span style="background:#16a085;color:white;padding:4px 10px;border-radius:12px;font-weight:600;">
                    ${horasAgente.horas}h
                </span>`;
                if (horasAgente.ausencias > 0) {
                    tbodyHTML += `<br><small style="color:#e74c3c;">‚ö†Ô∏è ${horasAgente.ausencias} aus.</small>`;
                }
            } else {
                tbodyHTML += '<span style="color:#95a5a6;">Sin datos</span>';
            }
            tbodyHTML += '</td>';

            // CELDA PRORRATEO
            tbodyHTML += '<td style="text-align:center;padding:8px;">';

            if (tieneHoras && total > 0) {
                const horasSemanales = horasAgente.horasSemanales || 42;
                const umbralMinimo = 150;
                const debeHabilitarse = horasAgente.horas < umbralMinimo;
                
                if (debeHabilitarse) {
                    tbodyHTML += `<input type="checkbox" 
                        class="prorrateo-check" 
                        data-bms="${emp.bmsId}" 
                        data-horas="${horasAgente.horas}" 
                        data-horas-semanales="${horasSemanales}"
                        data-bono-original="${total}"
                        onchange="calcularProrrateoInstantaneo(this)"
                        style="width:20px;height:20px;cursor:pointer;"
                        title="‚úÖ Habilitado: ${horasAgente.horas}h">`;
                } else {
                    tbodyHTML += `<input type="checkbox" disabled style="width:20px;height:20px;cursor:not-allowed;opacity:0.3;">`;
                }
            } else if (tieneHoras && total === 0) {
                tbodyHTML += `<span style="color:#e74c3c;font-size:0.8rem;">üö´</span>`;
            } else {
                tbodyHTML += '<span style="color:#95a5a6;">-</span>';
            }

            tbodyHTML += '</td>';
            
            // CELDA APROBAR
            tbodyHTML += '<td style="text-align:center;padding:8px;background:#f0fff4;">';
            tbodyHTML += `<input type="checkbox" 
                class="aprobado-check" 
                data-bms="${emp.bmsId}" 
                data-nombre="${emp.nombre}"
                data-total="${total}"
                onchange="actualizarTotalAprobar()"
                style="width:22px;height:22px;cursor:pointer;accent-color:#28a745;">`;
            tbodyHTML += '</td>';
            
            // DISPUTAR Y COMENTARIO
            tbodyHTML += '<td style="text-align:center;">';
            tbodyHTML += '<input type="checkbox" class="dispute-check" data-bms="' + emp.bmsId + '" data-nombre="' + emp.nombre + '" data-total="' + total + '" style="width:20px;height:20px;cursor:pointer;">';
            tbodyHTML += '</td>';
            tbodyHTML += '<td>';
            tbodyHTML += '<input type="text" class="dispute-comment" data-bms="' + emp.bmsId + '" placeholder="Agregar comentario..." style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">';
            tbodyHTML += '</td>';
            tbodyHTML += '</tr>';
        });
    }
    
    // ‚≠ê FILA DE TOTALES AL FINAL DE LA TABLA
    if (keys.length > 0) {
        // Calcular cu√°ntas columnas hay antes de "Total $"
        let colspanAntes = 4; // #, Trasladar, BMS ID, Nombre
        categorias.forEach(cat => {
            const kpis = metricas[cat] || [];
            colspanAntes += kpis.length > 0 ? (kpis.length * 2) : 2;
        });
        
        tbodyHTML += '<tr style="background:#27ae60;color:white;font-weight:bold;font-size:1.1rem;">';
        tbodyHTML += '<td colspan="' + colspanAntes + '" style="text-align:right;padding:15px;">TOTAL GENERAL SIN PRORRATEO:</td>';
        tbodyHTML += '<td style="text-align:center;padding:15px;font-size:1.3rem;">$' + totalGeneralTabla.toLocaleString('es-CO', {minimumFractionDigits: 2}) + '</td>';
        tbodyHTML += '<td colspan="5"></td>'; // Horas, Prorrateo, Aprobar, Disputar, Comentario
        tbodyHTML += '</tr>';
    }
    
    // CONSTRUCCI√ìN HTML FINAL
    const container = document.getElementById('table-container');
    let html = '<div class="table-header"><h3 class="table-title">üìã Agentes - ' + lob + '</h3>';
    html += '<div style="display:flex;align-items:center;gap:15px;flex-wrap:wrap;">';
    html += '<input type="text" id="search-input" placeholder="üîç Buscar..." onkeyup="filtrarTabla()" style="padding:10px 15px;border:2px solid #dfe6e9;border-radius:8px;font-size:1rem;width:300px;">';
    html += '<span id="search-count" style="color:#7f8c8d;font-size:0.9rem;"></span>';
    
    // INDICADOR DE TOTAL EN TIEMPO REAL
    html += '<div id="total-aprobar-indicator" style="background:#28a745;color:white;padding:10px 20px;border-radius:8px;font-weight:bold;display:none;">';
    html += '<span>Total a aprobar: </span><span id="total-aprobar-monto">$0</span>';
    html += '</div>';
    
    html += '<div class="btn-group">';
    html += '<button class="btn-success" onclick="exportarAExcel()">üì• Excel</button>';
    html += '<button class="btn-primary" onclick="aplicarTraslados()" style="background:#e67e22;">üîÑ Aplicar Traslados</button>';
    html += '<button class="btn-primary" onclick="enviaraprobados()" style="background:#28a745;">‚úÖ Enviar y Aprobar</button>';
    html += '<button class="btn-primary" onclick="limpiarTodosLosProrrateos()" style="background:#e74c3c;">üóëÔ∏è Desmarcar Prorrateos</button>';
    html += '<button class="btn-primary" onclick="toggleTabla()">üëÅÔ∏è Ocultar</button>';
    html += '</div></div></div>';
    
    if (traslados.salientes.length > 0 || traslados.entrantes.length > 0) {
        html += '<div style="margin-bottom:20px;">';
        if (traslados.salientes.length > 0) {
            html += `<div style="background:#fff3cd;border-left:4px solid #f39c12;padding:12px;margin-bottom:10px;border-radius:6px;">
                <strong>üì§ Agentes Trasladados:</strong> 
                <span style="font-size:0.9rem;">${traslados.salientes.length} agente(s) salieron</span>
            </div>`;
        }
        if (traslados.entrantes.length > 0) {
            html += `<div style="background:#d4edda;border-left:4px solid #28a745;padding:12px;margin-bottom:10px;border-radius:6px;">
                <strong>üì• Agentes Recibidos:</strong> 
                <span style="font-size:0.9rem;">${traslados.entrantes.length} agente(s) llegaron</span>
            </div>`;
        }
        html += '</div>';
    }
    
    html += '<div id="tabla-detalle" class="table-scroll"><table id="tabla-agentes"><thead>' + theadHTML + '</thead><tbody id="tbody-agentes">' + tbodyHTML + '</tbody></table>';
    html += '<div style="text-align:center;padding:20px;border-top:3px solid #ecf0f1;">';
    html += '<button class="btn-dispute" onclick="enviarDisputas()" style="padding:15px 40px;font-size:1.1rem;">üì® Enviar Disputas</button>';
    html += '</div></div>';
    
    container.innerHTML = html;
    container.style.display = 'block';
    
    setTimeout(() => {
        const agentesDetectados = configurarProrrateosAutomaticos();
        if (agentesDetectados > 0) {
            mostrarAlerta(`‚öôÔ∏è ${agentesDetectados} agente(s) con menos de 150h`, 'info');
        }
        actualizarTotalAprobar();
    }, 1000);
}

// FUNCIONES AUXILIARES (sin cambios)
function actualizarTotalAprobar() {
    const checkboxes = document.querySelectorAll('.aprobado-check:checked');
    const indicator = document.getElementById('total-aprobar-indicator');
    const montoSpan = document.getElementById('total-aprobar-monto');
    
    if (!indicator || !montoSpan) return;
    
    let totalGeneral = 0;
    
    checkboxes.forEach(check => {
        const total = parseFloat(check.getAttribute('data-total')) || 0;
        totalGeneral += total;
    });
    
    if (checkboxes.length > 0) {
        montoSpan.textContent = '$' + totalGeneral.toLocaleString('es-CO', {minimumFractionDigits: 2});
        indicator.style.display = 'flex';
    } else {
        indicator.style.display = 'none';
    }
}

function seleccionarTodosAprobar(checkbox) {
    const checkboxes = document.querySelectorAll('.aprobado-check');
    checkboxes.forEach(check => {
        check.checked = checkbox.checked;
    });
    actualizarTotalAprobar();
}


    



  /////////////////////////////////

  function ordenarTabla(columnIndex) {
      const tbody = document.getElementById('tbody-agentes');
      const rows = Array.from(tbody.getElementsByTagName('tr'));
      
      if (ordenActual.columna === columnIndex) {
          ordenActual.ascendente = !ordenActual.ascendente;
      } else {
          ordenActual.columna = columnIndex;
          ordenActual.ascendente = true;
      }
      
      rows.sort((a, b) => {
          let valA, valB;
          
          if (columnIndex === -1) {
              const celdasA = a.getElementsByTagName('td');
              const celdasB = b.getElementsByTagName('td');
              valA = parseFloat(celdasA[celdasA.length - 1].textContent.replace(/[^0-9.-]/g, ''));
              valB = parseFloat(celdasB[celdasB.length - 1].textContent.replace(/[^0-9.-]/g, ''));
          } else {
              valA = a.getElementsByTagName('td')[columnIndex].textContent.trim().toLowerCase();
              valB = b.getElementsByTagName('td')[columnIndex].textContent.trim().toLowerCase();
              if (!isNaN(valA) && !isNaN(valB)) {
                  valA = parseFloat(valA);
                  valB = parseFloat(valB);
              }
          }
          
          if (valA < valB) return ordenActual.ascendente ? -1 : 1;
          if (valA > valB) return ordenActual.ascendente ? 1 : -1;
          return 0;
      });
      
      rows.forEach(row => tbody.appendChild(row));
  }

  function filtrarTabla() {
      const input = document.getElementById('search-input');
      const filter = input.value.toLowerCase().trim();
      const tbody = document.getElementById('tbody-agentes');
      const rows = tbody.getElementsByTagName('tr');
      let visibleCount = 0;
      
      for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const bms = row.getAttribute('data-bms') || '';
          const nombre = row.getAttribute('data-nombre') || '';
          
          if (bms.includes(filter) || nombre.includes(filter)) {
              row.style.display = '';
              visibleCount++;
          } else {
              row.style.display = 'none';
          }
      }
      
      const countSpan = document.getElementById('search-count');
      countSpan.textContent = filter ? 'Mostrando ' + visibleCount + ' de ' + rows.length : '';
  }

  function toggleTabla() {
      const tabla = document.getElementById('tabla-detalle');
      tabla.style.display = tabla.style.display === 'none' ? 'block' : 'none';
  }

  function exportarAExcel() {
      const tabla = document.querySelector('#table-container table');
      if (!tabla) { alert('No hay datos'); return; }
      const wb = XLSX.utils.table_to_book(tabla, {sheet: 'KPIs'});
      XLSX.writeFile(wb, 'Dashboard_' + selectLob.value + '_' + selectFecha.value + '_' + Date.now() + '.xlsx');
  }


  // ========================================
  // DISPUTE Y ACCORDION
  // ========================================
  function goToAuditPage() {
      const disputeUrl = 'https://script.google.com/macros/s/AKfycbwB3cpmY-v5-RSL8hHWuPMouVXNIpi1Bq-PUhSLrTsjiqx8TLmgCLQdeWItXihl7M-bEg/exec';
      const lob = selectLob.value;
      const fecha = selectFecha.value;

      if (!lob || !fecha) {
          mostrarAlerta('‚ö†Ô∏è Por favor, selecciona LOB y Fecha antes de ir a Disputar.', 'warning');
          return;
      }

      const urlConParams = `${disputeUrl}?page=audit&lob=${encodeURIComponent(lob)}&fecha=${encodeURIComponent(fecha)}`;
      window.open(urlConParams, '_blank');
  }

  function toggleAccordion(button) {
      const content = button.nextElementSibling;
      const arrow = button.querySelector('.accordion-arrow');
      
      if (content.style.display === 'none' || content.style.display === '') {
          content.style.display = 'grid';
          arrow.classList.add('expanded');
      } else {
          content.style.display = 'none';
          arrow.classList.remove('expanded');
      }
  }

  // ========================================
  // UTILIDADES
  // ========================================
  // ========================================
  // UTILIDADES
  // ========================================
  function mostrarLoading(mensaje = 'Cargando...') {
      const container = document.getElementById('table-container');
      container.innerHTML = '<div class="loading">‚è≥ ' + mensaje + '</div>';
      container.style.display = 'block';
      ocultarResultados();
  }

  function ocultarLoading() {
      const container = document.getElementById('table-container');
      if (container && container.querySelector('.loading')) {
          container.style.display = 'none';
      }
  }

  function mostrarError(mensaje) {
      const container = document.getElementById('table-container');
      
      if (!container) {
          console.error('‚ùå No se encontr√≥ table-container para mostrar error');
          const errorDiv = document.createElement('div');
          errorDiv.style.cssText = 'background:#f8d7da;color:#721c24;padding:20px;border-radius:8px;margin:20px;';
          errorDiv.innerHTML = `
              <strong>‚ùå Error:</strong> ${mensaje}
              <div style="margin-top:15px;">
                  <button onclick="recargarPagina()" style="padding:10px 20px;background:#e67e22;color:white;border:none;border-radius:5px;cursor:pointer;">
                      üîÑ Reintentar
                  </button>
              </div>
          `;
          document.querySelector('.container').appendChild(errorDiv);
          return;
      }
      
      container.innerHTML = `
          <div class="info-message">
              ‚ùå ${mensaje}
              <div style="margin-top:15px;">
                  <button onclick="recargarPagina()" style="padding:10px 20px;background:#e67e22;color:white;border:none;border-radius:5px;cursor:pointer;">
                      üîÑ Reintentar
                  </button>
              </div>
          </div>
      `;
      container.style.display = 'block';
      ocultarResultados();
      mostrarAlerta('‚ùå ' + mensaje, 'danger');
  }

  function recargarPagina() {
      console.log('üîÑ Recargando p√°gina...');
      location.reload();
  }

  /////////////////////////////////////////////
  function ocultarResultados() {
      document.getElementById('metrics-grid').style.display = 'none';
      document.getElementById('charts-grid').style.display = 'none';
          document.getElementById('kpi-payment-chart-container').style.display = 'none';

  }

  function mostrarIndicadorComparacion(mes) {
      const indicator = document.getElementById('status-indicator');
      const textoMes = document.getElementById('mes-texto');
      if (indicator && textoMes) {
          indicator.classList.remove('hidden');
          textoMes.textContent = mes ? (mesesNombres[mes] || 'Mes ' + mes) : 'CDM General';
      }
  }

  function ocultarIndicador() {
      const indicator = document.getElementById('status-indicator');
      if (indicator) indicator.classList.add('hidden');
  }

  function limpiarExtras() {
      const top10 = document.querySelector('.top10-container');
      const indicadores = document.querySelector('.indicadores-container');
      if (top10) top10.remove();
      if (indicadores) indicadores.remove();
  }

  function mostrarAlerta(mensaje, tipo = 'info') {
      let container = document.getElementById('alerts-container');
      
      if (!container) {
          container = document.createElement('div');
          container.id = 'alerts-container';
          container.style.marginBottom = '20px';
          const statusIndicator = document.getElementById('status-indicator');
          if (statusIndicator) statusIndicator.parentNode.insertBefore(container, statusIndicator.nextSibling);
      }
      
      const colores = { success: '#d4edda', info: '#d1ecf1', warning: '#fff3cd', danger: '#f8d7da' };
      const iconos = { success: '‚úÖ', info: '‚ÑπÔ∏è', warning: '‚ö†Ô∏è', danger: '‚ùå' };
      
      const alert = document.createElement('div');
      alert.style.cssText = 'padding:15px 20px;border-radius:8px;margin-bottom:15px;display:flex;align-items:flex-start;gap:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);background:' + (colores[tipo] || colores.info);
      alert.innerHTML = '<span style="flex:1;">' + (iconos[tipo] || iconos.info) + ' ' + mensaje + '</span><span class="alert-close" style="cursor:pointer;font-size:1.5rem;line-height:1;margin-left:15px;">&times;</span>';
      
      alert.querySelector('.alert-close').onclick = function() { alert.remove(); };
      container.appendChild(alert);
      
      if (tipo === 'success' || tipo === 'info') {
          setTimeout(() => {
              if (alert.parentNode) {
                  alert.style.transition = 'opacity 0.5s ease';
                  alert.style.opacity = '0';
                  setTimeout(() => alert.remove(), 500);
              }
          }, 10000);
      }
  }

  function limpiarAlertas() {
      const container = document.getElementById('alerts-container');
      if (container) {
          container.innerHTML = '';
      }
  }

  console.log('‚úÖ Dashboard KPIs inicializado');


  function enviarDisputas() {
      const checkboxes = document.querySelectorAll('.dispute-check:checked');
      
      if (checkboxes.length === 0) {
          mostrarAlerta('‚ö†Ô∏è Debes seleccionar al menos un agente para disputar', 'warning');
          return;
      }
      
      const disputas = [];
      checkboxes.forEach(check => {
          const bmsId = check.getAttribute('data-bms');
          const nombre = check.getAttribute('data-nombre');
          const total = check.getAttribute('data-total');
          const commentInput = document.querySelector('.dispute-comment[data-bms="' + bmsId + '"]');
          const comentario = commentInput ? commentInput.value.trim() : '';
          
          disputas.push({
              bmsId: bmsId,
              nombre: nombre,
              total: parseFloat(total),
              comentario: comentario,
              lob: selectLob.value,
              fecha: selectFecha.value,
              fechaDisputa: new Date().toISOString()
          });
      });
      
      console.log('üì§ Enviando disputas:', disputas);
      mostrarLoading('Enviando disputas...');
      
      google.script.run
          .withSuccessHandler(function(response) {
              ocultarLoading();
              if (response.success) {
                  mostrarAlerta('‚úÖ ' + disputas.length + ' disputa(s) enviada(s) exitosamente', 'success');
                  // Limpiar checkboxes y comentarios
                  checkboxes.forEach(check => {
                      check.checked = false;
                      const commentInput = document.querySelector('.dispute-comment[data-bms="' + check.getAttribute('data-bms') + '"]');
                      if (commentInput) commentInput.value = '';
                  });
              } else {
                  mostrarAlerta('‚ùå Error al enviar disputas: ' + response.error, 'danger');
              }
          })
          .withFailureHandler(function(error) {
              ocultarLoading();
              mostrarAlerta('‚ùå Error al enviar disputas: ' + error.message, 'danger');
              console.error('Error:', error);
          })
          .guardarDisputas(disputas);
  }



  ////////////////////////////////////////////// Enlaces



  // ========================================
  // SISTEMA DE PESTA√ëAS
  // ========================================
  function switchTab(tabName) {
      console.log('üîÑ Cambiando a pesta√±a:', tabName);
      
      document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
      });
      
      document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('active');
      });
      
      const tabContent = document.getElementById('tab-' + tabName);
      if (tabContent) {
          tabContent.classList.add('active');
      }
      
      event.target.classList.add('active');
      
      // ‚≠ê AGREGAR TIMEOUT PARA ASEGURAR QUE EL DOM EST√â LISTO
      setTimeout(() => {
          if (tabName === 'top3') {
              cargarTop3Meses();
          } else if (tabName === 'historical') {
              cargarHistoricoMaximos();
          } else if (tabName === 'ruleta') {
              cargarRuletaDatos();
          }
      }, 100);
  }
  // ========================================
  // TAB 2: TOP 3 PERFORMERS
  // ========================================

  // ========================================
  // TAB 2: TOP 3 PERFORMERS - TODOS LOS MESES
  // ========================================

function cargarTop3Meses() {
    console.log('üèÜ Inicializando Top 3 Performers...');
    
    const selectLob = document.getElementById('top3SelectLob');
    const selectFecha = document.getElementById('top3SelectFecha');
    const selectKpi = document.getElementById('top3SelectKpi');
    
    selectLob.innerHTML = '<option value="">Cargando LOBs...</option>';
    selectFecha.innerHTML = '<option value="">Primero selecciona LOB</option>';
    selectKpi.innerHTML = '<option value="">Primero selecciona fecha</option>';
    selectFecha.disabled = true;
    selectKpi.disabled = true;
    
    mostrarAlerta('‚è≥ Cargando LOBs disponibles...', 'info');
    
    // Cargar LOBs
    google.script.run
        .withSuccessHandler(function(res) {
            console.log('‚úÖ LOBs recibidas:', res.lobs);
            selectLob.innerHTML = '<option value="">Selecciona una LOB</option>';
            
            if (res.lobs && res.lobs.length > 0) {
                res.lobs.forEach(lob => {
                    const opt = document.createElement('option');
                    opt.value = lob;
                    opt.textContent = lob;
                    selectLob.appendChild(opt);
                });
                mostrarAlerta(`‚úÖ ${res.lobs.length} LOBs disponibles`, 'success');
            } else {
                mostrarAlerta('‚ö†Ô∏è No hay LOBs disponibles', 'warning');
            }
        })
        .withFailureHandler(function(error) {
            console.error('‚ùå Error:', error);
            selectLob.innerHTML = '<option value="">Error al cargar</option>';
            mostrarAlerta('‚ùå Error al cargar LOBs: ' + error.message, 'danger');
        })
        .obtenerDatosParaFrontend();
}
// Evento: Cambio de LOB en Top 3
document.getElementById('top3SelectLob').addEventListener('change', function() {
    const lob = this.value;
    const selectFecha = document.getElementById('top3SelectFecha');
    const selectKpi = document.getElementById('top3SelectKpi');
    
    selectFecha.innerHTML = '<option value="">Cargando fechas...</option>';
    selectFecha.disabled = true;
    selectKpi.innerHTML = '<option value="">Primero selecciona fecha</option>';
    selectKpi.disabled = true;
    document.getElementById('top3-all-months-results').innerHTML = '';
    
    if (!lob) return;
    
    google.script.run
        .withSuccessHandler(function(fechas) {
            selectFecha.innerHTML = '<option value="">Selecciona una fecha</option>';
            fechas.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f;
                opt.textContent = f;
                selectFecha.appendChild(opt);
            });
            selectFecha.disabled = false;
        })
        .withFailureHandler(function(error) {
            console.error('‚ùå Error:', error);
            selectFecha.innerHTML = '<option value="">Error al cargar</option>';
        })
        .obtenerFechasPorLob(lob);
});
// Evento: Cambio de Fecha en Top 3
document.getElementById('top3SelectFecha').addEventListener('change', function() {
    const lob = document.getElementById('top3SelectLob').value;
    const fecha = this.value;
    const selectKpi = document.getElementById('top3SelectKpi');
    
    selectKpi.innerHTML = '<option value="">Cargando KPIs...</option>';
    selectKpi.disabled = true;
    document.getElementById('top3-all-months-results').innerHTML = '';
    
    if (!lob || !fecha) return;
    
    console.log('üìÖ Cargando KPIs para:', { lob, fecha });
    mostrarAlerta('‚è≥ Cargando KPIs disponibles...', 'info');
    
    google.script.run
        .withSuccessHandler(function(datosRecibidos) {
            console.log('üì¶ Datos recibidos:', datosRecibidos);
            
            if (!datosRecibidos.metricasPorLob || !datosRecibidos.metricasPorLob[lob]) {
                selectKpi.innerHTML = '<option value="">No hay KPIs</option>';
                mostrarAlerta('‚ö†Ô∏è No hay KPIs disponibles para esta LOB', 'warning');
                return;
            }
            
            const metricas = datosRecibidos.metricasPorLob[lob];
            
            if (metricas.error) {
                selectKpi.innerHTML = '<option value="">Error: ' + metricas.error + '</option>';
                mostrarAlerta('‚ùå Error: ' + metricas.error, 'danger');
                return;
            }
            
            const kpisUnicos = new Set();
            
            // ‚≠ê PROCESAR TODAS LAS CATEGOR√çAS
            ['keys', 'bonusStructure', 'additionalIncentives', 'decreasedKPIs'].forEach(cat => {
                console.log(`üìÇ Procesando categor√≠a: ${cat}`);
                
                if (metricas[cat] && Array.isArray(metricas[cat])) {
                    console.log(`   ${metricas[cat].length} KPIs en ${cat}`);
                    
                    metricas[cat].forEach(kpiObj => {
                        const kpiNombre = kpiObj.kpi;
                        
                        // ‚≠ê VALIDAR: Solo agregar si tiene validaci√≥n con empleados
                        if (kpiNombre && kpiObj.validacion) {
                            const val = kpiObj.validacion;
                            const totalEmpleados = (val.empleadosCumplen || []).length + 
                                                  (val.empleadosNoCumplen || []).length;
                            
                            if (totalEmpleados > 0) {
                                kpisUnicos.add(kpiNombre);
                                console.log(`      ‚úÖ KPI: "${kpiNombre}" - ${totalEmpleados} empleados`);
                            } else {
                                console.log(`      ‚ö†Ô∏è KPI: "${kpiNombre}" - SIN empleados`);
                            }
                        }
                    });
                } else {
                    console.log(`   ‚ö†Ô∏è Categor√≠a ${cat} vac√≠a o no es array`);
                }
            });
            
            console.log(`üìä Total KPIs √∫nicos encontrados: ${kpisUnicos.size}`);
            
            selectKpi.innerHTML = '<option value="">Selecciona un KPI</option>';
            
            if (kpisUnicos.size === 0) {
                selectKpi.innerHTML = '<option value="">No hay KPIs con datos</option>';
                mostrarAlerta('‚ö†Ô∏è No hay KPIs con datos de empleados', 'warning');
                return;
            }
            
            // ‚≠ê AGREGAR KPIs AL SELECT
            Array.from(kpisUnicos).sort().forEach(kpi => {
                const opt = document.createElement('option');
                opt.value = kpi;
                opt.textContent = kpi;
                selectKpi.appendChild(opt);
            });
            
            selectKpi.disabled = false;
            mostrarAlerta(`‚úÖ ${kpisUnicos.size} KPIs disponibles`, 'success');
            
        })
        .withFailureHandler(function(error) {
            console.error('‚ùå Error:', error);
            selectKpi.innerHTML = '<option value="">Error</option>';
            mostrarAlerta('‚ùå Error al cargar KPIs: ' + error.message, 'danger');
        })
        .obtenerDatosParaFrontend(lob, fecha, null);
});


// Evento: Cambio de KPI en Top 3
document.getElementById('top3SelectKpi').addEventListener('change', function() {
    const lob = document.getElementById('top3SelectLob').value;
    const fecha = document.getElementById('top3SelectFecha').value;
    const kpi = this.value;
    
    if (!lob || !fecha || !kpi) return;
    
    const resultsDiv = document.getElementById('top3-all-months-results');
    resultsDiv.innerHTML = '<div class="loading">‚è≥ Cargando Top 3...</div>';
    
    console.log('üèÜ Cargando Top 3 para:', { lob, fecha, kpi });
    mostrarAlerta('‚è≥ Cargando Top 3...', 'info');
    
    // ‚≠ê OBTENER N√öMERO DE MES DESDE LA FECHA SELECCIONADA
    const numeroMes = obtenerNumeroMesDesdeNombre(fecha);
    console.log(`üìÖ Mes detectado: ${fecha} ‚Üí N√∫mero: ${numeroMes}`);
    
    // ‚≠ê CARGAR DATOS DE ESE MES ESPEC√çFICO
    google.script.run
        .withSuccessHandler(function(datosRecibidos) {
            console.log(`üì¶ Datos recibidos para ${fecha}:`, datosRecibidos);
            
            if (!datosRecibidos.metricasPorLob || !datosRecibidos.metricasPorLob[lob]) {
                resultsDiv.innerHTML = '<div class="info-message">‚ö†Ô∏è No hay datos para esta LOB y fecha</div>';
                mostrarAlerta('‚ö†Ô∏è No hay datos disponibles', 'warning');
                return;
            }
            
            const metricas = datosRecibidos.metricasPorLob[lob];
            let top3 = [];
            
            if (!metricas.error) {
                // ‚≠ê BUSCAR EN TODAS LAS CATEGOR√çAS
                ['keys', 'bonusStructure', 'additionalIncentives', 'decreasedKPIs'].forEach(cat => {
                    if (metricas[cat]) {
                        metricas[cat].forEach(kpiObj => {
                            if (kpiObj.kpi === kpi && kpiObj.validacion) {
                                const empleadosCumplen = kpiObj.validacion.empleadosCumplen || [];
                                
                                console.log(`   ‚úÖ ${cat}: ${empleadosCumplen.length} empleados cumplen`);
                                
                                // ‚≠ê ORDENAR Y TOMAR TOP 3
                                top3 = empleadosCumplen
                                    .sort((a, b) => (b.bono || 0) - (a.bono || 0))
                                    .slice(0, 3);
                                
                                console.log(`   üèÜ Top 3:`, top3);
                            }
                        });
                    }
                });
            }
            
            // ‚≠ê MOSTRAR SOLO ESTE MES
            mostrarTop3ResultadoUnicoMes(fecha, top3, lob, kpi);
            
        })
        .withFailureHandler(function(error) {
            console.error('‚ùå Error:', error);
            resultsDiv.innerHTML = '<div class="info-message">‚ùå Error: ' + error.message + '</div>';
            mostrarAlerta('‚ùå Error: ' + error.message, 'danger');
        })
        .obtenerDatosParaFrontend(lob, fecha, numeroMes);
});


function mostrarTop3ResultadoUnicoMes(mes, top3, lob, kpi) {
    console.log('üé® Mostrando Top 3 para mes √∫nico:', mes, top3);
    
    const resultsDiv = document.getElementById('top3-all-months-results');
    
    const tieneData = top3 && top3.length > 0;
    
    let html = '<div style="background:white;border-radius:12px;padding:25px;margin-top:25px;box-shadow:0 5px 15px rgba(0,0,0,0.08);">';
    
    // ‚≠ê HEADER
    html += '<div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:20px;border-radius:12px;margin-bottom:25px;">';
    html += '<h2 style="margin:0 0 10px 0;font-size:1.8rem;">üèÜ Top 3 Performers</h2>';
    html += '<div style="font-size:1.1rem;opacity:0.95;">';
    html += '<strong>KPI:</strong> ' + kpi + ' | ';
    html += '<strong>LOB:</strong> ' + lob + ' | ';
    html += '<strong>Mes:</strong> ' + mes;
    html += '</div>';
    html += '<div style="font-size:0.9rem;opacity:0.9;margin-top:8px;">';
    html += tieneData ? '‚úÖ ' + top3.length + ' agente(s) encontrado(s)' : '‚ö†Ô∏è Sin datos para este mes';
    html += '</div>';
    html += '</div>';
    
    // ‚≠ê CONTENIDO
    html += '<div style="background:' + (tieneData ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#95a5a6') + ';color:white;border-radius:12px;padding:30px;">';
    
    if (!tieneData) {
        html += '<div style="text-align:center;padding:40px;">';
        html += '<div style="font-size:4rem;margin-bottom:20px;">üòî</div>';
        html += '<h3 style="margin:0 0 10px 0;">No hay agentes que cumplan este KPI</h3>';
        html += '<p style="opacity:0.9;margin:0;">Intenta con otro KPI o mes</p>';
        html += '</div>';
    } else {
        html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;">';
        
        top3.forEach((agente, i) => {
            const medalla = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â';
            const bgOpacity = i === 0 ? '0.30' : i === 1 ? '0.22' : '0.18';
            const borderWidth = i === 0 ? '3px' : '2px';
            
            html += '<div style="background:rgba(255,255,255,' + bgOpacity + ');padding:20px;border-radius:12px;border:' + borderWidth + ' solid rgba(255,255,255,0.4);text-align:center;transition:transform 0.3s;">';
            html += '<div style="font-size:3rem;margin-bottom:15px;">' + medalla + '</div>';
            html += '<div style="font-weight:700;font-size:1.3rem;margin-bottom:8px;">' + agente.nombre.split(',')[0] + '</div>';
            html += '<div style="font-size:0.9rem;opacity:0.95;margin-bottom:15px;background:rgba(255,255,255,0.2);padding:5px 15px;border-radius:20px;display:inline-block;">BMS ' + agente.bmsId + '</div>';
            
            if (agente.valorF !== undefined && agente.valorF !== null) {
                html += '<div style="font-size:1rem;opacity:0.95;margin-bottom:12px;padding:8px;background:rgba(255,255,255,0.15);border-radius:8px;">üìä Valor: <strong>' + agente.valorF + '</strong></div>';
            }
            
            html += '<div style="font-size:2rem;font-weight:700;margin-top:15px;padding:15px;background:rgba(255,255,255,0.2);border-radius:12px;">$' + (agente.bono || 0).toLocaleString('es-CO', {minimumFractionDigits: 2}) + '</div>';
            html += '</div>';
        });
        
        html += '</div>';
    }
    
    html += '</div></div>';
    
    resultsDiv.innerHTML = html;
    
    if (tieneData) {
        mostrarAlerta(`‚úÖ Top 3 cargado para ${mes}`, 'success');
    } else {
        mostrarAlerta(`‚ö†Ô∏è No hay datos para ${mes}`, 'warning');
    }
}
      




function mostrarTop3Resultados(resultadosPorMes, lob, kpi) {
    console.log('üé® Mostrando resultados Top 3:', resultadosPorMes);
    
    const resultsDiv = document.getElementById('top3-all-months-results');
    
    if (!resultadosPorMes || resultadosPorMes.length === 0) {
        resultsDiv.innerHTML = '<div class="info-message">‚ö†Ô∏è No hay datos para mostrar</div>';
        mostrarAlerta('‚ö†Ô∏è No hay datos para mostrar', 'warning');
        return;
    }
    
    // ‚≠ê CONTAR MESES CON DATOS
    const mesesConDatos = resultadosPorMes.filter(r => r.top3 && r.top3.length > 0).length;
    const mesesSinDatos = resultadosPorMes.length - mesesConDatos;
    
    console.log(`üìä Resumen: ${mesesConDatos} meses con datos, ${mesesSinDatos} sin datos`);
    
    let html = '<div style="background:white;border-radius:12px;padding:25px;margin-top:25px;box-shadow:0 5px 15px rgba(0,0,0,0.08);">';
    
    // ‚≠ê HEADER CON INFORMACI√ìN
    html += '<div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:20px;border-radius:12px;margin-bottom:25px;">';
    html += '<h2 style="margin:0 0 10px 0;font-size:1.8rem;">üèÜ Top 3 Performers</h2>';
    html += '<div style="font-size:1.1rem;opacity:0.95;">';
    html += '<strong>KPI:</strong> ' + kpi + ' | ';
    html += '<strong>LOB:</strong> ' + lob;
    html += '</div>';
    html += '<div style="font-size:0.9rem;opacity:0.9;margin-top:8px;">';
    html += 'üìä ' + mesesConDatos + ' mes(es) con datos | ';
    html += '‚ö†Ô∏è ' + mesesSinDatos + ' mes(es) sin datos';
    html += '</div>';
    html += '</div>';
    
    // ‚≠ê MOSTRAR CADA MES
    resultadosPorMes.forEach(resultado => {
        const tieneData = resultado.top3 && resultado.top3.length > 0;
        
        html += '<div style="background:' + (tieneData ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#95a5a6') + ';color:white;border-radius:12px;padding:20px;margin-bottom:20px;">';
        html += '<h3 style="margin:0 0 15px 0;display:flex;align-items:center;justify-content:space-between;">';
        html += '<span>üìÖ ' + resultado.mes + '</span>';
        
        if (tieneData) {
            html += '<span style="background:rgba(255,255,255,0.2);padding:5px 15px;border-radius:20px;font-size:0.9rem;">‚úÖ ' + resultado.top3.length + ' agente(s)</span>';
        } else {
            html += '<span style="background:rgba(255,255,255,0.2);padding:5px 15px;border-radius:20px;font-size:0.9rem;">‚ö†Ô∏è Sin datos</span>';
        }
        
        html += '</h3>';
        
        if (!tieneData) {
            html += '<p style="opacity:0.9;margin:0;">No hay agentes que cumplan este KPI en este mes</p>';
        } else {
            html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;">';
            
            resultado.top3.forEach((agente, i) => {
                const medalla = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â';
                const bgOpacity = i === 0 ? '0.25' : i === 1 ? '0.20' : '0.15';
                
                html += '<div style="background:rgba(255,255,255,' + bgOpacity + ');padding:15px;border-radius:8px;border:2px solid rgba(255,255,255,0.3);">';
                html += '<div style="font-size:2rem;margin-bottom:8px;">' + medalla + '</div>';
                html += '<div style="font-weight:700;font-size:1.1rem;margin-bottom:5px;">' + agente.nombre.split(',')[0] + '</div>';
                html += '<div style="font-size:0.85rem;opacity:0.9;margin-bottom:10px;">BMS ' + agente.bmsId + '</div>';
                
                if (agente.valorF !== undefined && agente.valorF !== null) {
                    html += '<div style="font-size:0.9rem;opacity:0.95;margin-bottom:8px;">Valor: ' + agente.valorF + '</div>';
                }
                
                html += '<div style="font-size:1.5rem;font-weight:700;">$' + (agente.bono || 0).toLocaleString('es-CO', {minimumFractionDigits: 2}) + '</div>';
                html += '</div>';
            });
            
            html += '</div>';
        }
        
        html += '</div>';
    });
    
    html += '</div>';
    resultsDiv.innerHTML = html;
    
    mostrarAlerta(`‚úÖ Resultados cargados: ${mesesConDatos} mes(es) con datos`, 'success');
}


// ========================================
// FUNCI√ìN: CARGAR HIST√ìRICO M√ÅXIMOS (SIN SELECTOR DE FECHA)
// ========================================
function cargarHistoricoMaximos() {
    console.log('üìà Inicializando Hist√≥rico de Bonos...');
    
    // Cargar LOBs disponibles
    google.script.run
        .withSuccessHandler(function(res) {
            console.log('‚úÖ LOBs recibidas:', res.lobs);
            const selectLob = document.getElementById('histSelectLob');
            selectLob.innerHTML = '<option value="">Selecciona una LOB</option>';
            
            if (res.lobs && res.lobs.length > 0) {
                res.lobs.forEach(lob => {
                    const opt = document.createElement('option');
                    opt.value = lob;
                    opt.textContent = lob;
                    selectLob.appendChild(opt);
                });
            }
        })
        .withFailureHandler(function(error) {
            console.error('‚ùå Error:', error);
            mostrarAlerta('Error al cargar LOBs: ' + error.message, 'danger');
        })
        .obtenerDatosParaFrontend();
}

// ========================================
// ‚≠ê EVENTO CAMBIO DE LOB - CARGAR DIRECTO SIN FECHA
// ========================================
document.getElementById('histSelectLob').addEventListener('change', function() {
    const lob = this.value;
    
    document.getElementById('historical-results').innerHTML = '';
    document.getElementById('historical-chart-container').style.display = 'none';
    
    if (!lob) return;
    
    console.log('üìä Cargando hist√≥rico desde Historico_MAX para LOB:', lob);
    
    const resultsDiv = document.getElementById('historical-results');
    resultsDiv.innerHTML = '<div class="loading">‚è≥ Cargando desde Historico_MAX...</div>';
    
    // ========================================
    // ‚≠ê LECTURA DIRECTA DESDE HISTORICO_MAX
    // ========================================
   

       google.script.run
        .withSuccessHandler(function(cacheData) {
            console.log('üì¶ Datos recibidos de Historico_MAX:', cacheData);
            
            if (cacheData && cacheData.length > 0) {
                console.log(`‚úÖ ${cacheData.length} meses cargados desde Historico_MAX`);
                
                generarGraficoHistoricoMeses(cacheData);
                generarTarjetasHistoricoMeses(cacheData, lob);
                
                mostrarAlerta(`‚úÖ Hist√≥rico cargado: ${cacheData.length} meses desde Historico_MAX`, 'success');
            } else {
                resultsDiv.innerHTML = `
                    <div class="info-message">
                        <div style="background:#fff3cd;border-left:4px solid #ffc107;padding:20px;border-radius:8px;text-align:center;">
                            <h3 style="color:#856404;margin:0 0 10px 0;">üì≠ No hay datos en Historico_MAX</h3>
                            <p style="color:#856404;margin:0;">
                                No se encontraron datos hist√≥ricos para ${lob} en Historico_MAX.
                            </p>
                        </div>
                    </div>
                `;
                mostrarAlerta('‚ö†Ô∏è No hay datos hist√≥ricos disponibles', 'warning');
            }
        })
        .withFailureHandler(function(error) {
            console.error('‚ùå Error al leer Historico_MAX:', error);
            resultsDiv.innerHTML = `
                <div class="info-message">
                    <div style="background:#f8d7da;border-left:4px solid #dc3545;padding:20px;border-radius:8px;text-align:center;">
                        <h3 style="color:#721c24;margin:0 0 10px 0;">‚ùå Error al cargar datos</h3>
                        <p style="color:#721c24;margin:0;">
                            Error al leer desde Historico_MAX: ${error.message}
                        </p>
                    </div>
                </div>
            `;
            mostrarAlerta('‚ùå Error al cargar desde Historico_MAX: ' + error.message, 'danger');
        })
        .leerHistoricoDesdeCache(lob);
});



// ========================================
// ‚≠ê FUNCI√ìN: GENERAR GR√ÅFICO HIST√ìRICO
// ========================================
function generarGraficoHistoricoMeses(datosPorMes) {
    // Ordenar por n√∫mero de mes
    datosPorMes.sort((a, b) => a.numeroMes - b.numeroMes);
    
    const labels = datosPorMes.map(d => d.mes);
    const data = datosPorMes.map(d => d.total);
    
    const ctx = document.getElementById('chartHistoricalMeses');
    if (chartHistoricalMeses) chartHistoricalMeses.destroy();
    
    chartHistoricalMeses = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Total Bonos ($)',
                data: data,
                backgroundColor: 'rgba(155, 89, 182, 0.8)',
                borderColor: 'rgba(155, 89, 182, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const index = context.dataIndex;
                            const agentes = datosPorMes[index].agentes;
                            return [
                                'Total: $' + context.parsed.y.toLocaleString('es-CO', {minimumFractionDigits: 2}),
                                'Agentes √∫nicos: ' + agentes
                            ];
                        }
                    }
                },
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Hist√≥rico de Bonos por Mes',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Total Bonos ($)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString('es-CO');
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Mes CDM'
                    }
                }
            }
        }
    });
    
    document.getElementById('historical-chart-container').style.display = 'block';
    console.log('‚úÖ Gr√°fico hist√≥rico generado con', datosPorMes.length, 'meses');
}

// ========================================
// ‚≠ê FUNCI√ìN: GENERAR TARJETAS HIST√ìRICAS
// ========================================

// ========================================
// FUNCI√ìN: GENERAR TARJETAS HIST√ìRICAS COMPLETA
// ========================================
// ========================================
// ‚≠ê FUNCI√ìN: GENERAR TARJETAS HIST√ìRICAS (CORREGIDA)
// ========================================
function generarTarjetasHistoricoMeses(datosPorMes, lob) {
    const resultsDiv = document.getElementById('historical-results');
    
    let html = '<div style="background:white;border-radius:12px;padding:25px;margin-top:25px;box-shadow:0 5px 15px rgba(0,0,0,0.08);">';
    html += '<h2 style="color:var(--primary);margin-bottom:25px;text-align:center;">üìä Desglose Mensual - ' + lob + '</h2>';
    
    const categoriasNombres = {
        keys: 'Keys',
        bonusStructure: 'Bonus Structure',
        additionalIncentives: 'Additional Incentives',
        decreasedKPIs: 'Decreased KPIs'
    };
    
    const categoriasColores = {
        keys: '#3498db',
        bonusStructure: '#27ae60',
        additionalIncentives: '#f39c12',
        decreasedKPIs: '#e74c3c'
    };
    
    // ‚≠ê CALCULAR TOTAL GENERAL DE TODOS LOS MESES Y DESGLOSE
    let totalGeneralHistorico = 0;
    let desgloseGeneral = {
        keys: 0,
        bonusStructure: 0,
        additionalIncentives: 0,
        decreasedKPIs: 0
    };
    
    datosPorMes.forEach(dato => {
        totalGeneralHistorico += dato.total;
        // ‚≠ê SUMAR DESGLOSE GENERAL
        if (dato.desglose) {
            desgloseGeneral.keys += dato.desglose.keys || 0;
            desgloseGeneral.bonusStructure += dato.desglose.bonusStructure || 0;
            desgloseGeneral.additionalIncentives += dato.desglose.additionalIncentives || 0;
            desgloseGeneral.decreasedKPIs += dato.desglose.decreasedKPIs || 0;
        }
    });
    
    // ‚≠ê MOSTRAR RESUMEN GENERAL CON TODAS LAS CATEGOR√çAS
    html += '<div style="background:linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);color:white;padding:30px;border-radius:12px;margin-bottom:30px;">';
    html += '<h3 style="margin:0 0 15px 0;font-size:1.5rem;">üí∞ TOTAL HIST√ìRICO</h3>';
    html += '<div style="font-size:3rem;font-weight:700;margin-bottom:10px;">$' + totalGeneralHistorico.toLocaleString('es-CO', {minimumFractionDigits: 2}) + '</div>';
    html += '<div style="font-size:1.1rem;opacity:0.9;margin-bottom:20px;">' + datosPorMes.length + ' meses en Historico_MAX</div>';
    
    // ‚≠ê DESGLOSE GENERAL - MOSTRAR TODAS LAS CATEGOR√çAS SIEMPRE
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:20px;">';
    
    // ‚≠ê ITERAR POR TODAS LAS CATEGOR√çAS EN ORDEN
    const categorias = ['keys', 'bonusStructure', 'additionalIncentives', 'decreasedKPIs'];
    
    categorias.forEach(cat => {
        const valor = desgloseGeneral[cat] || 0;
        const porcentaje = totalGeneralHistorico > 0 ? ((valor / totalGeneralHistorico) * 100).toFixed(1) : 0;
        const opacidad = valor > 0 ? '0.25' : '0.15';
        
        html += '<div style="background:rgba(255,255,255,' + opacidad + ');padding:12px;border-radius:8px;border:2px solid rgba(255,255,255,0.3);">';
        html += '<div style="font-size:0.75rem;opacity:0.9;margin-bottom:5px;">' + categoriasNombres[cat] + '</div>';
        html += '<div style="font-size:1.2rem;font-weight:700;">$' + valor.toLocaleString('es-CO', {minimumFractionDigits: 2}) + '</div>';
        html += '<div style="font-size:0.7rem;opacity:0.8;margin-top:3px;">' + porcentaje + '%</div>';
        html += '</div>';
    });
    
    html += '</div></div>';
    
    // ‚≠ê TARJETAS POR MES
    datosPorMes.forEach(dato => {
        console.log('üìã Generando tarjeta para mes:', dato.mes, 'Desglose:', dato.desglose);
        
        html += '<div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:25px;border-radius:12px;margin-bottom:20px;">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">';
        html += '<h3 style="margin:0;font-size:1.8rem;">üìÖ ' + dato.mes + '</h3>';
        html += '<div style="text-align:right;">';
        html += '<div style="font-size:2.5rem;font-weight:700;">$' + dato.total.toLocaleString('es-CO', {minimumFractionDigits: 2}) + '</div>';
        html += '<div style="font-size:0.9rem;opacity:0.9;">' + dato.agentes + ' agentes √∫nicos</div>';
        html += '</div></div>';
        
        // ‚≠ê DESGLOSE POR CATEGOR√çA - MOSTRAR TODAS SIEMPRE
        html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">';
        
        categorias.forEach(cat => {
            const valor = dato.desglose && dato.desglose[cat] ? dato.desglose[cat] : 0;
            const porcentaje = dato.total > 0 ? ((valor / dato.total) * 100).toFixed(1) : 0;
            const opacidad = valor > 0 ? '0.95' : '0.5';
            
            html += '<div style="background:rgba(255,255,255,' + opacidad + ');color:#2c3e50;padding:15px;border-radius:8px;border-left:4px solid ' + categoriasColores[cat] + ';">';
            html += '<div style="font-size:0.85rem;color:#7f8c8d;margin-bottom:8px;">' + categoriasNombres[cat] + '</div>';
            html += '<div style="font-size:1.3rem;font-weight:700;color:' + categoriasColores[cat] + ';">$' + valor.toLocaleString('es-CO', {minimumFractionDigits: 2}) + '</div>';
            html += '<div style="font-size:0.8rem;color:#95a5a6;margin-top:5px;">' + porcentaje + '% del mes</div>';
            html += '</div>';
        });
        
        html += '</div></div>';
    });
    
    html += '</div>';
    resultsDiv.innerHTML = html;
    
    console.log('‚úÖ Tarjetas generadas. Total general:', totalGeneralHistorico, 'Desglose general:', desgloseGeneral);
}



// ========================================
// ‚≠ê FUNCI√ìN AUXILIAR: OBTENER NOMBRE DEL MES (CORREGIDA)
// ========================================
function obtenerNombreMesDeFecha(fecha) {
  if (!fecha) return 'General';
  
  console.log('üîç Obteniendo nombre del mes para fecha:', fecha);
  
  // Buscar nombres de meses en espa√±ol en la fecha
  const mesesNombres = {
    'enero': 'Enero', 'febrero': 'Febrero', 'marzo': 'Marzo', 'abril': 'Abril',
    'mayo': 'Mayo', 'junio': 'Junio', 'julio': 'Julio', 'agosto': 'Agosto',
    'septiembre': 'Septiembre', 'octubre': 'Octubre', 'noviembre': 'Noviembre', 'diciembre': 'Diciembre'
  };
  
  const fechaLower = fecha.toString().toLowerCase().trim();
  console.log('üìÖ Fecha en min√∫sculas:', fechaLower);
  
  // Buscar si la fecha contiene el nombre de alg√∫n mes
  for (const mes in mesesNombres) {
    if (fechaLower.includes(mes)) {
      console.log('‚úÖ Mes encontrado:', mes, '->', mesesNombres[mes]);
      return mesesNombres[mes];
    }
  }
  
  // Si no encuentra nombre de mes, intentar con fecha JavaScript
  try {
    const fechaObj = new Date(fecha);
    if (!isNaN(fechaObj.getTime())) {
      const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      const nombreMes = meses[fechaObj.getMonth()];
      console.log('üìÖ Mes desde Date object:', fechaObj.getMonth() + 1, '->', nombreMes);
      return nombreMes;
    }
  } catch (e) {
    console.log('‚ö†Ô∏è No se pudo parsear como fecha:', e);
  }
  
  console.log('‚ùå No se pudo determinar el mes, usando "General"');
  return 'General';
}

// ========================================
// ‚≠ê FUNCI√ìN AUXILIAR: OBTENER N√öMERO DE MES (CORREGIDA)
// ========================================
function obtenerNumeroMesDeFecha(fecha) {
  if (!fecha) return 0;
  
  console.log('üîç Obteniendo n√∫mero del mes para fecha:', fecha);
  
  // Mapeo CORREGIDO: Enero=1, Febrero=2, etc.
  const mesesMap = {
    'enero': 1, 'febrero': 2, 'marzo': 3, 'abril': 4,
    'mayo': 5, 'junio': 6, 'julio': 7, 'agosto': 8,
    'septiembre': 9, 'octubre': 10, 'noviembre': 11, 'diciembre': 12
  };
  
  const fechaLower = fecha.toString().toLowerCase().trim();
  
  for (const mes in mesesMap) {
    if (fechaLower.includes(mes)) {
      console.log('‚úÖ N√∫mero de mes encontrado:', mes, '->', mesesMap[mes]);
      return mesesMap[mes];
    }
  }
  
  // Si es una fecha tipo "2024-05-15"
  try {
    const fechaObj = new Date(fecha);
    if (!isNaN(fechaObj.getTime())) {
      const numeroMes = fechaObj.getMonth() + 1; // getMonth() retorna 0-11
      console.log('üìÖ N√∫mero de mes desde Date:', numeroMes);
      return numeroMes;
    }
  } catch (e) {
    console.log('‚ö†Ô∏è No se pudo parsear como fecha para n√∫mero:', e);
  }
  
  console.log('‚ùå No se pudo determinar n√∫mero de mes, usando 0');
  return 0;
}


  // ========================================
  // SISTEMA DE REC√ÅLCULO POR AGENTE
  // ========================================

  // ========================================
  // SISTEMA DE REC√ÅLCULO POR AGENTE
  // ========================================

  function toggleRecalcLob(checkbox) {
      const bmsId = checkbox.getAttribute('data-bms');
      const select = document.querySelector('.recalc-lob-select[data-bms="' + bmsId + '"]');
      
      if (checkbox.checked) {
          select.disabled = false;
          select.style.background = '#fff3cd';
          select.style.borderColor = '#f39c12';
      } else {
          select.disabled = true;
          select.style.background = '';
          select.style.borderColor = '#ddd';
      }
  }

  // ‚≠ê REEMPLAZAR aplicarRecalculos() con esta nueva funci√≥n:
  function aplicarTraslados() {
      const checkboxes = document.querySelectorAll('.recalc-check:checked');
      
      if (checkboxes.length === 0) {
          mostrarAlerta('‚ö†Ô∏è Debes seleccionar al menos un agente para trasladar', 'warning');
          return;
      }
      
      const traslados = [];
      const lobActual = selectLob.value;
      const fechaActual = selectFecha.value;
      const mesActual = mesComparativoActual;
      
      let error = false;
      
      checkboxes.forEach(check => {
          const bmsId = check.getAttribute('data-bms');
          const select = document.querySelector('.recalc-lob-select[data-bms="' + bmsId + '"]');
          const lobDestino = select.value;
          
          if (!lobDestino) {
              mostrarAlerta('‚ö†Ô∏è Debes seleccionar una LOB destino para BMS ' + bmsId, 'warning');
              error = true;
              return;
          }
          
          if (lobDestino === lobActual) {
              mostrarAlerta('‚ö†Ô∏è No puedes trasladar un agente a la misma LOB', 'warning');
              error = true;
              return;
          }
          
          const fila = document.querySelector(`tr[data-bms="${bmsId}"]`);
          const nombre = fila ? fila.querySelector('td:nth-child(4)').textContent.trim().split('\n')[0] : 'Agente ' + bmsId;
          
          traslados.push({
              bmsId: bmsId,
              nombre: nombre,
              lobOriginal: lobActual,
              lobDestino: lobDestino,
              fecha: fechaActual,
              mes: mesActual
          });
      });
      
      if (error || traslados.length === 0) return;
      
      // ‚≠ê CONFIRMACI√ìN DETALLADA
      let mensajeConfirmacion = `‚ö†Ô∏è TRASLADO PERMANENTE EN H_C\n\n`;
      mensajeConfirmacion += `Vas a trasladar ${traslados.length} agente(s):\n\n`;
      
      traslados.forEach((t, i) => {
          mensajeConfirmacion += `${i+1}. ${t.nombre} (BMS ${t.bmsId})\n`;
          mensajeConfirmacion += `   De: ${t.lobOriginal} ‚Üí A: ${t.lobDestino}\n\n`;
      });
      
      mensajeConfirmacion += `‚ùó IMPORTANTE:\n`;
      mensajeConfirmacion += `‚Ä¢ El agente cambiar√° de LOB en la hoja H_C\n`;
      mensajeConfirmacion += `‚Ä¢ Aparecer√° inmediatamente en ${traslados[0].lobDestino}\n`;
      mensajeConfirmacion += `‚Ä¢ Se registrar√° en "Ajustes_Traslados" para auditor√≠a\n\n`;
      mensajeConfirmacion += `¬øContinuar?`;
      
      if (!confirm(mensajeConfirmacion)) return;
      
      console.log('üîÑ Aplicando traslados:', traslados);
      mostrarLoading('Trasladando ' + traslados.length + ' agente(s)...');
      
      google.script.run
          .withSuccessHandler(function(response) {
              ocultarLoading();
              
              if (response.success) {
                  mostrarAlerta('‚úÖ ' + response.mensaje + '\n\nüí° Los agentes ya est√°n en la nueva LOB. Recarga para ver los cambios.', 'success');
                  
                  // Recargar despu√©s de 2 segundos
                  setTimeout(() => {
                      cargarDatosCompletos(lobActual, fechaActual, mesActual);
                  }, 2000);
                  
              } else {
                  mostrarAlerta('‚ùå Error: ' + (response.error || 'Error desconocido'), 'danger');
              }
          })
          .withFailureHandler(function(error) {
              ocultarLoading();
              mostrarAlerta('‚ùå Error de conexi√≥n: ' + error.message, 'danger');
              console.error('Error completo:', error);
          })
          .trasladarAgentesTemporalmente(traslados);
  }


  // ========================================
  // SISTEMA DE PRORRATEO (AGREGAR AL C√ìDIGO FRONTEND)
  // ========================================

  /**
   * Aplicar prorrateo a los agentes seleccionados
   */
  // ========================================
  // FUNCI√ìN APLICAR PRORRATEO
  // ========================================
  function aplicarProrrateo() {
      const checkboxes = document.querySelectorAll('.prorrateo-check:checked');
      
      if (checkboxes.length === 0) {
          mostrarAlerta('‚ö†Ô∏è Debes seleccionar al menos un agente para prorratear', 'warning');
          return;
      }
      
      const agentesProrrateo = [];
      const lobActual = selectLob.value;
      const fechaActual = selectFecha.value;
      const mesActual = mesComparativoActual;
      
      checkboxes.forEach(check => {
          const bmsId = check.getAttribute('data-bms');
          const horas = parseFloat(check.getAttribute('data-horas')) || 0;
          
          // Obtener el total del agente
          const fila = document.querySelector(`tr[data-bms="${bmsId}"]`);
          if (!fila) return;
          
          const celdas = fila.getElementsByTagName('td');
          const celdaTotal = celdas[celdas.length - 3]; // Columna Total $
          const bonoActual = parseFloat(celdaTotal.textContent.replace(/[^0-9.-]/g, ''));
          
          const nombre = fila.querySelector('td:nth-child(4)').textContent.trim().split('\n')[0];
          
          agentesProrrateo.push({
              bmsId: bmsId,
              nombre: nombre,
              horas: horas,
              bonoActual: bonoActual
          });
      });
      
      // Mostrar confirmaci√≥n con detalles
      let mensajeConfirmacion = `üìä PRORRATEO DE BONOS POR HORAS\n\n`;
      mensajeConfirmacion += `Vas a prorratear ${agentesProrrateo.length} agente(s):\n\n`;
      
      const HORAS_COMPLETAS = 160;
      
      agentesProrrateo.forEach((a, i) => {
          const factorProrrateo = a.horas / HORAS_COMPLETAS;
          const bonoProrateado = a.bonoActual * factorProrrateo;
          const diferencia = a.bonoActual - bonoProrateado;
          
          mensajeConfirmacion += `${i+1}. ${a.nombre} (BMS ${a.bmsId})\n`;
          mensajeConfirmacion += `   Horas: ${a.horas}h de ${HORAS_COMPLETAS}h (${(factorProrrateo * 100).toFixed(1)}%)\n`;
          mensajeConfirmacion += `   Bono Original: $${a.bonoActual.toLocaleString('es-CO', {minimumFractionDigits: 2})}\n`;
          mensajeConfirmacion += `   Bono Prorrateado: $${bonoProrateado.toLocaleString('es-CO', {minimumFractionDigits: 2})}\n`;
          mensajeConfirmacion += `   Diferencia: -$${diferencia.toLocaleString('es-CO', {minimumFractionDigits: 2})}\n\n`;
      });
      
      mensajeConfirmacion += `¬øDeseas aplicar el prorrateo?`;
      
      if (!confirm(mensajeConfirmacion)) return;
      
      console.log('üìä Aplicando prorrateo:', agentesProrrateo);
      mostrarLoading('Calculando prorrateo para ' + agentesProrrateo.length + ' agente(s)...');
      
      google.script.run
          .withSuccessHandler(function(response) {
              ocultarLoading();
              
              if (response.success) {
                  mostrarAlerta('‚úÖ ' + response.mensaje, 'success');
                  
                  // Actualizar la tabla con los nuevos valores
                  response.resultados.forEach(resultado => {
                      if (resultado.success) {
                          const fila = document.querySelector(`tr[data-bms="${resultado.bmsId}"]`);
                          if (fila) {
                              const celdas = fila.getElementsByTagName('td');
                              const celdaTotal = celdas[celdas.length - 3];
                              
                              // Actualizar el total con animaci√≥n
                              celdaTotal.style.transition = 'all 0.5s ease';
                              celdaTotal.style.background = '#27ae60';
                              celdaTotal.style.color = 'white';
                              celdaTotal.innerHTML = '<strong>$' + resultado.bonoProrateado.toLocaleString('es-CO', {minimumFractionDigits: 2}) + '</strong><br>' +
                                                    '<small style="font-size:0.75rem;">Prorrateado (' + resultado.horasTrabajadas + 'h)</small>';
                              
                              setTimeout(() => {
                                  celdaTotal.style.background = '#d5f4e6';
                                  celdaTotal.style.color = '#000';
                              }, 2000);
                              
                              // Desmarcar checkbox
                              const checkbox = fila.querySelector('.prorrateo-check');
                              if (checkbox) checkbox.checked = false;
                          }
                      }
                  });
                  
                  // Recargar m√©tricas
                  generarMetricas(lobActual);
                  generarGraficos();
                  
              } else {
                  mostrarAlerta('‚ùå Error: ' + (response.error || 'Error desconocido'), 'danger');
              }
          })
          .withFailureHandler(function(error) {
              ocultarLoading();
              mostrarAlerta('‚ùå Error de conexi√≥n: ' + error.message, 'danger');
              console.error('Error completo:', error);
          })
          .aplicarProrrateoAgentes(agentesProrrateo, lobActual, fechaActual, mesActual);
  }

  // ========================================
  // PRORRATEO INSTANT√ÅNEO (Sin necesidad de bot√≥n)
  // ========================================



  // ========================================
  // ‚≠ê CALCULAR PRORRATEO BASADO EN PROPORCI√ìN DE D√çAS TRABAJADOS
  // ========================================
function calcularProrrateoInstantaneo(checkbox) {
    const bmsId = checkbox.getAttribute('data-bms');
    const horasReales = parseFloat(checkbox.getAttribute('data-horas')) || 0;
    const horasSemanales = parseFloat(checkbox.getAttribute('data-horas-semanales')) || 42;
    const bonoOriginal = parseFloat(checkbox.getAttribute('data-bono-original')) || 0;
    
    console.log(`üìä Prorrateo para BMS ${bmsId}:`, {
        checked: checkbox.checked,
        horasReales,
        horasSemanales,
        bonoOriginal
    });
    
    const fila = document.querySelector(`tr[data-bms="${bmsId}"]`);
    if (!fila) {
        console.error('‚ùå Fila no encontrada');
        return;
    }
    
    const celdaTotal = fila.querySelector('.celda-total');
    if (!celdaTotal) {
        console.error('‚ùå Celda total no encontrada');
        return;
    }
    
    if (checkbox.checked) {
        // ========================================
        // ‚úÖ APLICAR PRORRATEO
        // ========================================
        const proporcionTrabajada = horasReales / horasSemanales;
        const diasEquivalentes = proporcionTrabajada * 6;
        const diasTotalesMes = 24;
        const bonoProrateado = (bonoOriginal / diasTotalesMes) * diasEquivalentes;
        
        console.log(`üí∞ Calculando:`, {
            proporcionTrabajada: proporcionTrabajada.toFixed(2),
            diasEquivalentes: diasEquivalentes.toFixed(1),
            bonoProrateado: bonoProrateado.toFixed(2)
        });
        
        // Actualizar celda con animaci√≥n
        celdaTotal.style.transition = 'all 0.3s ease';
        celdaTotal.style.background = 'linear-gradient(135deg, #16a085 0%, #1abc9c 100%)';
        celdaTotal.style.color = 'white';
        celdaTotal.style.fontWeight = 'bold';
        celdaTotal.innerHTML = `
            <div style="padding:8px;">
                <div style="font-size:1.15rem;margin-bottom:4px;">
                    $${bonoProrateado.toLocaleString('es-CO', {minimumFractionDigits: 2})}
                </div>
                <div style="font-size:0.7rem;opacity:0.95;margin-bottom:3px;">
                    üìä ${diasEquivalentes.toFixed(1)} d√≠as / ${diasTotalesMes} d√≠as
                </div>
                <div style="font-size:0.65rem;opacity:0.85;border-top:1px solid rgba(255,255,255,0.3);padding-top:3px;margin-top:3px;">
                    Original: $${bonoOriginal.toLocaleString('es-CO', {minimumFractionDigits: 2})}
                </div>
            </div>
        `;
        
        // Guardar valor prorrateado
        checkbox.setAttribute('data-bono-prorrateado', bonoProrateado);
        
        console.log(`‚úÖ Prorrateo aplicado: $${bonoProrateado.toFixed(2)}`);
        
    } else {
        // ========================================
        // ‚ùå QUITAR PRORRATEO (Restaurar original)
        // ========================================
        celdaTotal.style.transition = 'all 0.3s ease';
        celdaTotal.style.background = '#d5f4e6';
        celdaTotal.style.color = '#000';
        celdaTotal.style.fontWeight = 'bold';
        celdaTotal.innerHTML = '$' + bonoOriginal.toLocaleString('es-CO', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        
        // Limpiar atributo
        checkbox.removeAttribute('data-bono-prorrateado');
        
        console.log(`‚úÖ Valor original restaurado: $${bonoOriginal.toFixed(2)}`);
    }
    
    // Actualizar m√©tricas totales
    actualizarMetricasConProrrateo();
}
  // ========================================
  // ‚≠ê HABILITAR/DESHABILITAR CHECKBOX SEG√öN HORAS Y JORNADA
  // ========================================
// ========================================
// ‚≠ê FUNCI√ìN COMPLETA: CONFIGURAR PRORRATEOS AUTOM√ÅTICOS
// ========================================
function configurarProrrateosAutomaticos() {
    const checkboxes = document.querySelectorAll('.prorrateo-check');
    
    let habilitados = 0;
    let deshabilitados = 0;
    
    checkboxes.forEach(checkbox => {
        const horasReales = parseFloat(checkbox.getAttribute('data-horas')) || 0;
        const horasSemanales = parseFloat(checkbox.getAttribute('data-horas-semanales')) || 42;
        
        // ‚≠ê UMBRALES FIJOS SEG√öN JORNADA
        let umbralMinimo;
        if (horasSemanales >= 42) {
            umbralMinimo = 150; // 42h/sem ‚Üí < 150h = vacaciones (7-15 d√≠as)
        } else if (horasSemanales >= 40) {
            umbralMinimo = 143; // 40h/sem ‚Üí < 143h = vacaciones
        } else if (horasSemanales >= 38) {
            umbralMinimo = 136; // 38h/sem ‚Üí < 136h = vacaciones
        } else {
            umbralMinimo = 130; // Otras jornadas
        }
        
        const proporcionTrabajada = horasReales / horasSemanales;
        const diasEquivalentes = proporcionTrabajada * 6;
        const diasFaltantes = 24 - diasEquivalentes;
        
        // ‚≠ê SOLO HABILITAR si tiene MENOS del umbral m√≠nimo
        if (horasReales > 0 && horasReales < umbralMinimo) {
            checkbox.disabled = false;
            checkbox.checked = false; // ‚≠ê IMPORTANTE: No marcar autom√°ticamente
            checkbox.title = `‚úÖ Habilitado: ${horasReales.toFixed(0)}h (< ${umbralMinimo}h) - Aprox. ${diasFaltantes.toFixed(0)} d√≠as menos`;
            checkbox.parentElement.style.opacity = '1';
            checkbox.parentElement.style.cursor = 'pointer';
            habilitados++;
        } else {
            checkbox.disabled = true;
            checkbox.checked = false;
            if (horasReales > 0) {
                checkbox.title = `‚ùå No requiere: ${horasReales.toFixed(0)}h (‚â• ${umbralMinimo}h - Mes completo)`;
            } else {
                checkbox.title = '‚ùå Sin horas registradas';
            }
            checkbox.parentElement.style.opacity = '0.3';
            checkbox.parentElement.style.cursor = 'not-allowed';
            deshabilitados++;
        }
        
        // ‚≠ê GARANTIZAR: Restaurar valor original si est√° deshabilitado
        if (checkbox.disabled && checkbox.checked) {
            checkbox.checked = false;
            const bmsId = checkbox.getAttribute('data-bms');
            const bonoOriginal = parseFloat(checkbox.getAttribute('data-bono-original')) || 0;
            const fila = document.querySelector(`tr[data-bms="${bmsId}"]`);
            if (fila) {
                const celdas = fila.getElementsByTagName('td');
                const celdaTotal = celdas[celdas.length - 3];
                if (celdaTotal) {
                    celdaTotal.textContent = '$' + bonoOriginal.toLocaleString('es-CO', {minimumFractionDigits: 2});
                    celdaTotal.style.background = '#d5f4e6';
                    celdaTotal.style.color = '#000';
                    celdaTotal.style.fontWeight = 'bold';
                }
            }
            checkbox.removeAttribute('data-bono-prorrateado');
        }
    });
    
    console.log(`‚úÖ Checkboxes: ${habilitados} habilitados (< 150h), ${deshabilitados} deshabilitados (‚â• 150h)`);
    
    // ‚≠ê LIMPIAR ARRAY AL RECONFIGURAR
    prorrateosMarcados = [];
    console.log('üßπ Array de prorrateos limpiado por reconfiguraci√≥n autom√°tica');
    
    return habilitados; // ‚≠ê RETORNAR cantidad para uso externo
}
// ========================================
// ‚≠ê FUNCI√ìN CON DEBUG COMPLETO
// ========================================





function limpiarTodosLosProrrateos() {
    console.log('üóëÔ∏è Desmarcando todos los prorrateos...');
    
    const checkboxesMarcados = document.querySelectorAll('.prorrateo-check:checked');
    
    if (checkboxesMarcados.length === 0) {
        mostrarAlerta('‚ÑπÔ∏è No hay prorrateos aplicados', 'info');
        return;
    }
    
    let contador = 0;
    
    // Simplemente desmarcar cada uno (el evento onChange har√° el resto)
    checkboxesMarcados.forEach(checkbox => {
        checkbox.checked = false;
        // Disparar el evento onchange manualmente
        calcularProrrateoInstantaneo(checkbox);
        contador++;
    });
    
    mostrarAlerta(`‚úÖ Se desmarcaron ${contador} prorrateo(s)`, 'success');
    console.log(`‚úÖ ${contador} prorrateos desmarcados`);
}
// ========================================
// ‚≠ê VERSI√ìN 1 - DESMARCADO DIRECTO
// ========================================

function actualizarMetricasConProrrateo() {
    const lobActual = selectLob.value;
    if (!lobActual) return;
    
    const todasFilas = document.querySelectorAll('tbody tr[data-bms]');
    let totalGeneral = 0;
    let cantidadProrrateos = 0;
    
    console.log('üîÑ Recalculando m√©tricas con prorrateos...');
    
    todasFilas.forEach(fila => {
        const celdaTotal = fila.querySelector('.celda-total');
        if (!celdaTotal) return;
        
        const bonoOriginal = parseFloat(celdaTotal.getAttribute('data-bono-original')) || 0;
        const checkbox = fila.querySelector('.prorrateo-check');
        
        let bonoFinal = bonoOriginal;
        
        if (checkbox && checkbox.checked && !checkbox.disabled) {
            const bonoProrateado = parseFloat(checkbox.getAttribute('data-bono-prorrateado')) || bonoOriginal;
            bonoFinal = bonoProrateado;
            cantidadProrrateos++;
        }
        
        // ‚≠ê SOLO SUMAR SI ES POSITIVO
        if (bonoFinal > 0) {
            totalGeneral += bonoFinal;
        }
    });
    
    console.log(`üìä Total recalculado: $${totalGeneral.toFixed(2)} (${cantidadProrrateos} prorrateos)`);
    
    // Actualizar m√©trica visual
    const metricsGrid = document.getElementById('metrics-grid');
    if (metricsGrid && metricsGrid.style.display !== 'none') {
        const metricCards = metricsGrid.querySelectorAll('.metric-card');
        if (metricCards.length > 0) {
            const totalBonosCard = metricCards[0];
            const metricValue = totalBonosCard.querySelector('.metric-value');
            const metricSubtitle = totalBonosCard.querySelector('.metric-subtitle');
            
            metricValue.textContent = '$' + totalGeneral.toLocaleString('es-CO', {minimumFractionDigits: 2});
            
            if (cantidadProrrateos > 0) {
                metricSubtitle.innerHTML = `${cantidadProrrateos} prorrateo(s) aplicado(s)`;
                totalBonosCard.style.borderLeft = '4px solid #16a085';
            } else {
                metricSubtitle.textContent = 'Suma total pagada';
                totalBonosCard.style.borderLeft = '4px solid #27ae60';
            }
        }
    }
}

  // ========================================
  // ‚≠ê BOTONES EN LA INTERFAZ
  // ========================================
  function agregarBotonesProrrateo() {
      return `
          <button class="btn-primary" onclick="configurarProrrateosAutomaticos()" style="background:#16a085;" title="Detecta qui√©n tiene menos del 85% de horas (posibles vacaciones)">
              ‚öôÔ∏è Detectar Vacaciones
          </button>
          <button class="btn-primary" onclick="limpiarTodosLosProrrateos()" style="background:#e74c3c;" title="Desmarca todos los checkboxes que marcaste">
              üóëÔ∏è Desmarcar Todo
          </button>
      `;
  }

  // ========================================
  // ‚≠ê EJECUTAR AL CARGAR
  // ========================================
  function inicializarSistemaProrrateo() {
      setTimeout(() => {
          configurarProrrateosAutomaticos();
          console.log('‚úÖ Sistema de prorrateo inicializado');
      }, 1500);
  }

  // ========================================
// ‚≠ê NUEVA FUNCI√ìN: DETECCI√ìN AUTOM√ÅTICA DE VACACIONES
// ========================================

// ========================================
function inicializarDeteccionVacaciones() {
    console.log('üîç Inicializando detecci√≥n autom√°tica de vacaciones...');
    
    // Esperar a que la tabla se cargue completamente
    setTimeout(() => {
        const agentesDetectados = configurarProrrateosAutomaticos();
        console.log('‚úÖ Detecci√≥n autom√°tica de vacaciones completada');
        
        // Mostrar resumen de agentes detectados
        if (agentesDetectados > 0) {
            mostrarAlerta(`‚öôÔ∏è Se detectaron ${agentesDetectados} agente(s) con menos de 150h (posibles vacaciones)`, 'info');
        }
    }, 2000);
}


// ========================================
// ‚≠ê FUNCI√ìN PARA VER ESTADO DE PRORRATEOS (DEBUG)
// ========================================
function verEstadoProrrateos() {
    console.log('üìä Estado actual de prorrateos:');
    console.log(`üìã Prorrateos en memoria: ${prorrateosMarcados.length}`);
    
    prorrateosMarcados.forEach((p, index) => {
        console.log(`  ${index + 1}. BMS ${p.bmsId}: ${p.nombre} - $${p.bonoOriginal} ‚Üí $${p.bonoProrateado}`);
    });
    
    const checkboxesMarcados = document.querySelectorAll('.prorrateo-check:checked');
    console.log(`‚úÖ Checkboxes marcados en DOM: ${checkboxesMarcados.length}`);
}

// ========================================
// ‚≠ê FUNCI√ìN DE DEBUG PARA VER ESTADO DE CHECKBOXES
// ========================================
function debugProrrateos() {
    console.log('üêõ DEBUG - Estado de prorrateos:');
    
    const todosCheckboxes = document.querySelectorAll('.prorrateo-check');
    const checkboxesMarcados = document.querySelectorAll('.prorrateo-check:checked');
    const checkboxesHabilitados = document.querySelectorAll('.prorrateo-check:not([disabled])');
    const checkboxesMarcadosHabilitados = document.querySelectorAll('.prorrateo-check:checked:not([disabled])');
    
    console.log(`üìä Total checkboxes: ${todosCheckboxes.length}`);
    console.log(`‚úÖ Checkboxes marcados: ${checkboxesMarcados.length}`);
    console.log(`üîì Checkboxes habilitados: ${checkboxesHabilitados.length}`);
    console.log(`üéØ Checkboxes marcados y habilitados: ${checkboxesMarcadosHabilitados.length}`);
    
    // Mostrar detalles de cada checkbox marcado
    checkboxesMarcadosHabilitados.forEach((checkbox, index) => {
        console.log(`  ${index + 1}. BMS ${checkbox.getAttribute('data-bms')} - Horas: ${checkbox.getAttribute('data-horas')} - Checked: ${checkbox.checked} - Disabled: ${checkbox.disabled}`);
    });
    
    return checkboxesMarcadosHabilitados.length;
}


// ========================================
// ‚≠ê FUNCI√ìN FRONTEND: OBTENER NOMBRE DEL MES DESDE N√öMERO
// ========================================
function obtenerNombreMesDesdeNumero(numeroMes) {
    if (!numeroMes || isNaN(numeroMes)) return 'General';
    
    const meses = [
        'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
    ];
    
    // Asegurar que el n√∫mero est√© entre 1-12
    const numero = parseInt(numeroMes);
    if (numero >= 1 && numero <= 12) {
        return meses[numero - 1];
    }
    
    return 'General';
}

// ========================================
// FUNCI√ìN: ENVIAR Y APROBAR (NUEVA)
// ========================================

function enviaraprobados() {
    const checkboxes = document.querySelectorAll('.aprobado-check:checked');
    
    if (checkboxes.length === 0) {
        mostrarAlerta('‚ö†Ô∏è Debes seleccionar al menos un agente para aprobar', 'warning');
        return;
    }
    
    const aprobaciones = [];
    const lobActual = selectLob.value;
    const fechaActual = selectFecha.value;
    
    // ‚≠ê CORREGIDO: Obtener el nombre del mes desde el n√∫mero
    const nombreMesActual = obtenerNombreMesDesdeNumero(mesComparativoActual) || 'General';
    
    let totalGeneral = 0;
    
    // ‚≠ê OBTENER DATOS DE EMPLEADOS PARA CALCULAR DESGLOSE
    const empleados = empleadosPorLob[lobActual];
    
    if (!empleados) {
        mostrarAlerta('‚ùå No hay datos de empleados cargados', 'danger');
        return;
    }
    
    // Recopilar datos de todos los agentes seleccionados
    checkboxes.forEach(check => {
        const bmsId = check.getAttribute('data-bms');
        const nombre = check.getAttribute('data-nombre');
        const total = parseFloat(check.getAttribute('data-total')) || 0;
        
        totalGeneral += total;
        
        // ‚≠ê CALCULAR DESGLOSE POR CATEGOR√çA PARA ESTE AGENTE
        const desglose = {
            keys: 0,
            bonusStructure: 0,
            additionalIncentives: 0,
            decreasedKPIs: 0
        };
        
        // Buscar el agente en empleadosPorLob
        const keyEmpleado = Object.keys(empleados).find(k => empleados[k].bmsId === bmsId);
        
        if (keyEmpleado) {
            const empleado = empleados[keyEmpleado];
            
            // Iterar sobre sus resultados
            Object.keys(empleado.resultados).forEach(resKey => {
                const resultado = empleado.resultados[resKey];
                
                // Solo contar si cumple y no est√° sin datos
                if (resultado.cumple && !resultado.sinDatos) {
                    const bono = resultado.bono || 0;
                    
                    // Clasificar por categor√≠a
                    if (resKey.startsWith('keys_')) {
                        desglose.keys += bono;
                    } else if (resKey.startsWith('bonusStructure_')) {
                        desglose.bonusStructure += bono;
                    } else if (resKey.startsWith('additionalIncentives_')) {
                        desglose.additionalIncentives += bono;
                    } else if (resKey.startsWith('decreasedKPIs_')) {
                        desglose.decreasedKPIs += bono;
                    }
                }
            });
        }
        
        console.log(`üí∞ Desglose para ${nombre} (BMS ${bmsId}):`, desglose);
        
        aprobaciones.push({
            bmsId: bmsId,
            nombre: nombre,
            total: total,
            lob: lobActual,
            fecha: fechaActual,
            mes: nombreMesActual,  // ‚≠ê ENVIAR NOMBRE DEL MES, NO N√öMERO
            fechaAprobacion: new Date().toISOString(),
            desglose: desglose  // ‚≠ê AGREGAR DESGLOSE COMPLETO
        });
    });
    
    console.log('üì§ Enviando aprobaciones con mes y desglose:', nombreMesActual, aprobaciones);
    
    // ========================================
    // ‚≠ê MENSAJE DE CONFIRMACI√ìN DETALLADO
    // ========================================
    let mensaje = `‚ö†Ô∏è DECLARACI√ìN DE APROBACI√ìN DE KPIs Y BONOS\n\n`;
    mensaje += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
    
    mensaje += `Al confirmar esta aprobaci√≥n, usted declara que:\n\n`;
    
    mensaje += `‚úì Ha revisado los KPIs y m√©tricas de cada agente\n`;
    mensaje += `‚úì Est√° de acuerdo con los valores calculados\n`;
    mensaje += `‚úì Aprueba los montos a pagar presentados\n`;
    mensaje += `‚úì Autoriza el desembolso de los bonos\n\n`;
    
    mensaje += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
    
    mensaje += `üìä RESUMEN DE APROBACI√ìN:\n\n`;
    mensaje += `LOB: ${lobActual}\n`;
    mensaje += `Fecha: ${fechaActual}\n`;
    mensaje += `Mes CDM: ${nombreMesActual}\n`;  // ‚≠ê USAR NOMBRE DEL MES
    mensaje += `Agentes a aprobar: ${aprobaciones.length}\n`;
    mensaje += `MONTO TOTAL A PAGAR: $${totalGeneral.toLocaleString('es-CO', {minimumFractionDigits: 2})}\n\n`;
    
    mensaje += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
    
    mensaje += `DETALLE DE AGENTES:\n\n`;
    
    aprobaciones.slice(0, 10).forEach((a, i) => {
        mensaje += `${i+1}. ${a.nombre.split(',')[0]}\n`;
        mensaje += `   BMS: ${a.bmsId}\n`;
        mensaje += `   Bono: $${a.total.toLocaleString('es-CO', {minimumFractionDigits: 2})}\n\n`;
    });
    
    if (aprobaciones.length > 10) {
        mensaje += `... y ${aprobaciones.length - 10} agente(s) m√°s\n\n`;
    }
    
    mensaje += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
    mensaje += `‚ùó IMPORTANTE:\n`;
    mensaje += `‚Ä¢ Esta aprobaci√≥n quedar√° registrada con su usuario\n`;
    mensaje += `‚Ä¢ Se generar√° un registro auditable en la hoja "Audit"\n`;
    mensaje += `‚Ä¢ No se podr√° revertir una vez confirmada\n\n`;
    
    mensaje += `¬øCONFIRMA QUE APRUEBA ESTOS KPIs Y MONTOS?`;
    
    // ========================================
    // ‚≠ê CONFIRMACI√ìN DOBLE (SEGURIDAD)
    // ========================================
    if (!confirm(mensaje)) {
        mostrarAlerta('‚ÑπÔ∏è Aprobaci√≥n cancelada', 'info');
        return;
    }
    
    // Segunda confirmaci√≥n para seguridad
    const confirmacionFinal = confirm(
        `‚ö†Ô∏è CONFIRMACI√ìN FINAL\n\n` +
        `Va a aprobar el pago de:\n` +
        `$${totalGeneral.toLocaleString('es-CO', {minimumFractionDigits: 2})}\n\n` +
        `Para ${aprobaciones.length} agente(s)\n\n` +
        `¬øEst√° completamente seguro?`
    );
    
    if (!confirmacionFinal) {
        mostrarAlerta('‚ÑπÔ∏è Aprobaci√≥n cancelada', 'info');
        return;
    }
    
    console.log('‚úÖ Enviando aprobaciones:', aprobaciones);
    mostrarLoading('Guardando aprobaciones...');
    
    google.script.run
        .withSuccessHandler(function(response) {
            ocultarLoading();
            
            if (response.success) {
                // ‚≠ê MENSAJE DE √âXITO DETALLADO
                let mensajeExito = `‚úÖ APROBACI√ìN REGISTRADA EXITOSAMENTE\n\n`;
                mensajeExito += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
                mensajeExito += `üìã Resumen:\n`;
                mensajeExito += `‚Ä¢ ${response.count} agente(s) aprobado(s)\n`;
                mensajeExito += `‚Ä¢ Monto total: $${totalGeneral.toLocaleString('es-CO', {minimumFractionDigits: 2})}\n`;
                mensajeExito += `‚Ä¢ LOB: ${lobActual}\n`;
                mensajeExito += `‚Ä¢ Mes: ${nombreMesActual}\n`;  // ‚≠ê USAR NOMBRE DEL MES
                mensajeExito += `‚Ä¢ Fecha registro: ${new Date().toLocaleString('es-CO')}\n\n`;
                mensajeExito += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
                mensajeExito += `‚úì Los datos fueron guardados en la hoja "Audit"\n`;
                mensajeExito += `‚úì Su aprobaci√≥n qued√≥ registrada\n`;
                mensajeExito += `‚úì Los checkboxes se deshabilitaron autom√°ticamente\n\n`;
                mensajeExito += `Puede verificar el registro en:\n`;
                mensajeExito += `Hoja "Audit" del sistema`;
                
                alert(mensajeExito);
                mostrarAlerta('‚úÖ ' + response.mensaje, 'success');
                
                // Desmarcar el checkbox maestro
                const masterCheckbox = document.getElementById('select-all-aprobar');
                if (masterCheckbox) masterCheckbox.checked = false;
                
                // Marcar visualmente como aprobados
                checkboxes.forEach(check => {
                    const bmsId = check.getAttribute('data-bms');
                    const fila = document.getElementById(`row-${bmsId}`);
                    
                    // Cambiar celda a estado "Aprobado"
                    check.parentElement.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
                    check.parentElement.style.border = '2px solid #28a745';
                    check.parentElement.innerHTML = `
                        <div style="text-align:center;padding:5px;">
                            <span style="color:#155724;font-weight:bold;font-size:0.9rem;">‚úì APROBADO</span>
                            <br>
                            <small style="color:#155724;font-size:0.65rem;">${new Date().toLocaleDateString('es-CO')}</small>
                        </div>
                    `;
                    
                    // Resaltar fila completa
                    if (fila) {
                        fila.style.background = 'linear-gradient(135deg, #d4edda 0%, #f8f9fa 100%)';
                        fila.style.borderLeft = '5px solid #28a745';
                    }
                });
                
            } else {
                alert('‚ùå ERROR AL GUARDAR\n\n' + response.error + '\n\nPor favor, intente nuevamente o contacte soporte.');
                mostrarAlerta('‚ùå Error: ' + response.error, 'danger');
            }
        })
        .withFailureHandler(function(error) {
            ocultarLoading();
            
            const mensajeError = `‚ùå ERROR DE CONEXI√ìN\n\n` +
                               `No se pudo guardar la aprobaci√≥n.\n\n` +
                               `Detalles t√©cnicos:\n${error.message}\n\n` +
                               `Por favor:\n` +
                               `1. Verifique su conexi√≥n a internet\n` +
                               `2. Refresque la p√°gina\n` +
                               `3. Intente nuevamente\n\n` +
                               `Si el problema persiste, contacte soporte t√©cnico.`;
            
            alert(mensajeError);
            mostrarAlerta('‚ùå Error: ' + error.message, 'danger');
            console.error('Error completo:', error);
        })
        .guardarAprobaciones(aprobaciones);
}


// ========================================
// FUNCI√ìN: SELECCIONAR/DESELECCIONAR TODOS LOS APROBAR
// ========================================
function seleccionarTodosAprobar(masterCheckbox) {
    const checkboxes = document.querySelectorAll('.aprobado-check:not([disabled])');
    const seleccionar = masterCheckbox.checked;
    
    let contador = 0;
    let totalBono = 0;
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = seleccionar;
        if (seleccionar) {
            contador++;
            const bono = parseFloat(checkbox.getAttribute('data-total')) || 0;
            totalBono += bono;
        }
    });
    
    if (seleccionar) {
        mostrarAlerta(`‚úÖ ${contador} agente(s) seleccionado(s) - Total: $${totalBono.toLocaleString('es-CO', {minimumFractionDigits: 2})}`, 'success');
    } else {
        mostrarAlerta('‚ÑπÔ∏è Selecci√≥n limpiada', 'info');
    }
    
    console.log(`${seleccionar ? '‚úÖ' : '‚ùå'} Selecci√≥n masiva: ${contador} checkboxes - Total: $${totalBono.toFixed(2)}`);
}

  console.log('‚úÖ Sistema de Prorrateo por D√≠as Trabajados cargado');


  console.log('‚úÖ Sistema de Rec√°lculo cargado');
</script>

</body>
</html>


