/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * üìù M√ìDULO DE REGISTRO DE M√âTRICAS Y KPIs
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * Permite crear/editar registros de metas para LOBs
 * Compatible con estructura de Registro y Registro_pisos
 */
// ========================================
// OBTENER DATOS INICIALES PARA FORMULARIO
// ========================================
/**
 * Obtiene LOBs y datos del usuario para el formulario
 */
function obtenerDatosParaFormularioRegistro() {
    try {
        console.log('üîç Obteniendo datos para formulario de registro...');
        const usuario = obtenerDatosUsuarioActivo();
        if (!usuario) {
            return {
                success: false,
                error: 'Usuario no encontrado',
                usuario: {},
                lobs: []
            };
        }
        let lobs = [];
        // Obtener LOBs seg√∫n el rol
        if (usuario.rol === 'Reporting Analyst' || usuario.rol === 'Audit') {
            lobs = obtenerTodasLasLobs();
            console.log('‚úÖ Reporting Analyst/Audit: Todas las LOBs');
        } else if (usuario.rol === 'OM') {
            lobs = obtenerLobsPorOM(usuario.nombre);
            console.log(`‚úÖ OM: ${lobs.length} LOBs asignadas`);
        } else if (usuario.rol === 'ACCM') {
            lobs = obtenerLobsPorACCM(usuario.nombre);
            console.log(`‚úÖ ACCM: ${lobs.length} LOBs asignadas`);
        } else if (usuario.rol === 'Supervisor') {
            lobs = obtenerLobsPorSupervisor(usuario.nombre);
            console.log(`‚úÖ Supervisor: ${lobs.length} LOBs asignadas`);
        }
        console.log(`üìã Total LOBs disponibles: ${lobs.length}`);
        return {
            success: true,
            usuario: usuario,
            lobs: lobs.sort()
        };
    } catch (error) {
        console.log('‚ùå Error en obtenerDatosParaFormularioRegistro:', error.toString());
        return {
            success: false,
            error: error.toString(),
            usuario: {},
            lobs: []
        };
    }
}
// ========================================
// OBTENER RESPONSABLES DE UNA LOB
// ========================================
/**
 * Obtiene ACCM, OM, Supervisor de una LOB desde H_C
 */
function obtenerResponsablesPorLob(lob) {
    try {
        console.log(`üîç Buscando responsables para LOB: ${lob}`);
        const ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        const hojaHC = ss.getSheetByName('H_C');
        
        if (!hojaHC) {
            console.log('‚ùå Hoja H_C no encontrada');
            return { supervisor: '', accm: '', om: '' };
        }
        
        const dataHC = hojaHC.getDataRange().getValues();
        const normalizar = s => s ? s.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : "";
        const lobNorm = normalizar(lob);
        
        // ‚≠ê‚≠ê OBTENER USUARIO ACTUAL
        const usuario = obtenerDatosUsuarioActivo();
        
        for (let i = 1; i < dataHC.length; i++) {
            const lobFila = normalizar(dataHC[i][1]); // Columna B
            
            if (lobFila === lobNorm) {
                const omAsignado = String(dataHC[i][6] || '').trim(); // Columna G
                const omAsignadoNorm = normalizar(omAsignado);
                const usuarioNombreNorm = normalizar(usuario.nombre);
                
                // ‚≠ê‚≠ê VALIDACI√ìN CR√çTICA: Solo OM puede ver sus propias LOBs
                if (usuario.rol === 'OM' && omAsignadoNorm !== usuarioNombreNorm) {
                    console.log(`üö´ ACCESO DENEGADO: OM ${usuario.nombre} intenta acceder a LOB de OM ${omAsignado}`);
                    
                    return { 
                        supervisor: '', 
                        accm: '', 
                        om: '', 
                        error: `Esta LOB est√° asignada a otro OM (${omAsignado}).` 
                    };
                }
                
                const responsables = {
                    supervisor: String(dataHC[i][4] || '').trim(),  // Columna E
                    accm: String(dataHC[i][5] || '').trim(),        // Columna F
                    om: omAsignado
                };
                
                console.log('‚úÖ Responsables encontrados:', responsables);
                return responsables;
            }
        }
        
        console.log('‚ö†Ô∏è No se encontraron responsables para esta LOB');
        return { supervisor: '', accm: '', om: '', error: 'LOB no encontrada en H_C' };
        
    } catch (error) {
        console.log('‚ùå Error en obtenerResponsablesPorLob:', error.toString());
        return { supervisor: '', accm: '', om: '', error: error.toString() };
    }
}
// ========================================
// CONTAR AGENTES POR LOB
// ========================================
function contarAgentesPorLob(lob) {
    try {
        const ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        const hojaHC = ss.getSheetByName('H_C');
        if (!hojaHC) return 0;
        const data = hojaHC.getDataRange().getValues();
        if (data.length < 2) return 0;
        const headers = data[0].map(h => String(h).toLowerCase());
        const colLob = headers.indexOf('lob') > -1 ? headers.indexOf('lob') : 1; // Default col B
        const colStatus = headers.findIndex(h => h.includes('status') || h.includes('estado'));
        const normalizar = s => s ? s.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : "";
        const lobNorm = normalizar(lob);
        let count = 0;
        for (let i = 1; i < data.length; i++) {
            const filaLob = normalizar(data[i][colLob]);
            if (filaLob === lobNorm) {
                // Si encontramos columna de estado, verificamos. Si no, contamos todos los de la LOB.
                if (colStatus > -1) {
                    const estado = String(data[i][colStatus]).toLowerCase();
                    if (estado === 'activo' || estado === 'active' || estado === 'alta') {
                        count++;
                    }
                } else {
                    // Fallback: asumir columna H (√≠ndice 7) si existe, o contar todos
                    if (data[i].length > 7) {
                        const estado = String(data[i][7]).toLowerCase();
                        if (estado === 'activo' || estado === 'active' || estado === 'alta') {
                            count++;
                        } else if (estado === '') {
                            // A veces vac√≠o significa activo? Mejor no asumir.
                            // Si no hay columna status clara, contamos por LOB.
                            // Pero el usuario se queja de la cantidad, as√≠ que intentemos ser precisos.
                        }
                    } else {
                        count++;
                    }
                }
            }
        }
        // Si el conteo da 0 con estado, intentemos contar solo por LOB como fallback extremo
        if (count === 0) {
            for (let i = 1; i < data.length; i++) {
                if (normalizar(data[i][colLob]) === lobNorm) count++;
            }
        }
        return count;
    } catch (e) {
        console.error(e);
        return 0;
    }
}
// ========================================
// OBTENER MESES REGISTRADOS
// ========================================
function obtenerMesesRegistrados(lob, usuario) {
    try {
        console.log('üîç Buscando meses registrados para LOB:', lob, 'Usuario:', usuario.nombre, 'Rol:', usuario.rol);
        
        const ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        const hojas = [ss.getSheetByName('Registro'), ss.getSheetByName('Registro_pisos')];
        const meses = new Set();
        
        const normalizar = s => {
            if (!s) return '';
            return s.toString()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .toLowerCase()
                .trim();
        };
        
        const lobNorm = normalizar(lob);
        const usuarioNombreNorm = normalizar(usuario.nombre);
        
        hojas.forEach(hoja => {
            if (!hoja) {
                console.log(`‚ö†Ô∏è Hoja ${hoja?.getName()} no encontrada`);
                return;
            }
            
            console.log(`\nüìã Procesando hoja ${hoja.getName()}, buscando LOB: "${lob}"`);
            const data = hoja.getDataRange().getValues();
            console.log(`   ‚Ä¢ Total filas: ${data.length}`);
            
            // Mostrar headers para referencia
            if (data.length > 0) {
                console.log(`   ‚Ä¢ Headers: A="${data[0][0] || ''}", B="${data[0][1] || ''}", C="${data[0][2] || ''}", D="${data[0][3] || ''}"`);
            }
            
            for (let i = 1; i < data.length; i++) {
                const mesFila = String(data[i][0] || '').trim();
                const lobFila = String(data[i][1] || '').trim(); // Columna B
                const accmFila = String(data[i][2] || '').trim(); // Columna C
                const omFila = String(data[i][3] || '').trim(); // Columna D (OM/Director)
                
                // Normalizar para comparaci√≥n
                const mesFilaNorm = normalizar(mesFila);
                const lobFilaNorm = normalizar(lobFila);
                const accmFilaNorm = normalizar(accmFila);
                const omFilaNorm = normalizar(omFila);
                
                // DEBUG: Mostrar las primeras filas
                if (i <= 5) {
                    console.log(`   Fila ${i + 1}: Mes="${mesFila}", LOB="${lobFila}", ACCM="${accmFila}", OM="${omFila}"`);
                }
                
                // 1. Primero verificar que la LOB coincida
                if (lobFilaNorm !== lobNorm) {
                    continue;
                }
                
                console.log(`   ‚úÖ Fila ${i + 1}: LOB COINCIDE "${lobFila}"`);
                
                // 2. Verificar permisos seg√∫n rol
                let tienePermiso = false;
                
                if (usuario.rol === 'Reporting Analyst' || usuario.rol === 'Audit') {
                    // Reporting Analyst y Audit ven todo
                    tienePermiso = true;
                    console.log(`      ‚úÖ ${usuario.rol} tiene acceso a todo`);
                } 
                else if (usuario.rol === 'OM') {
                    // OM solo ve si √©l es el OM en columna D
                    tienePermiso = (omFilaNorm === usuarioNombreNorm);
                    console.log(`      ${tienePermiso ? '‚úÖ' : '‚ùå'} OM ${usuario.nombre} vs fila OM "${omFila}": ${tienePermiso ? 'COINCIDE' : 'NO COINCIDE'}`);
                }
                else if (usuario.rol === 'ACCM') {
                    // ACCM solo ve si √©l es el ACCM en columna C
                    tienePermiso = (accmFilaNorm === usuarioNombreNorm);
                    console.log(`      ${tienePermiso ? '‚úÖ' : '‚ùå'} ACCM ${usuario.nombre} vs fila ACCM "${accmFila}": ${tienePermiso ? 'COINCIDE' : 'NO COINCIDE'}`);
                }
                else if (usuario.rol === 'Supervisor') {
                    // Supervisor: verificar si tiene esta LOB asignada en H_C
                    const tieneLob = verificarSupervisorTieneLOB(usuario.nombre, lob);
                    tienePermiso = tieneLob;
                    console.log(`      ${tienePermiso ? '‚úÖ' : '‚ùå'} Supervisor ${usuario.nombre} tiene LOB "${lob}": ${tienePermiso ? 'SI' : 'NO'}`);
                }
                
                if (!tienePermiso) {
                    console.log(`      ‚ö†Ô∏è Sin permisos para ver esta fila`);
                    continue;
                }
                
                // 3. Si tiene permisos y la LOB coincide, agregar el mes
                if (mesFila) {
                    meses.add(mesFila);
                    console.log(`      üìÖ Mes agregado: "${mesFila}"`);
                }
            }
        });
        
        const resultado = Array.from(meses).sort();
        console.log(`\nüìÖ Meses encontrados para LOB "${lob}" que ${usuario.nombre} (${usuario.rol}) puede ver: ${resultado.length}`);
        resultado.forEach((mes, idx) => {
            console.log(`   ${idx + 1}. "${mes}"`);
        });
        
        return resultado;
        
    } catch (e) {
        console.error('‚ùå Error en obtenerMesesRegistrados:', e);
        console.error(e.stack);
        return [];
    }
}
/**
 * Obtiene todas las LOBs √∫nicas que tienen registros en las hojas de registro
 */



/**
 * Obtiene responsables de una LOB, PERO si el usuario es OM, verifica que sea √©l
 */
function obtenerResponsablesPorLobConValidacion(lob, usuarioActual) {
    try {
        console.log(`üîç Validando responsables para LOB: ${lob}, Usuario: ${usuarioActual.nombre} (${usuarioActual.rol})`);
        
        const responsables = obtenerResponsablesPorLob(lob); // Funci√≥n original
        
        // ‚≠ê‚≠ê CR√çTICO: Si el usuario es OM, verificar que sea el OM asignado
        if (usuarioActual.rol === 'OM') {
            const normalizar = s => s ? s.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : "";
            
            const omAsignadoNorm = normalizar(responsables.om);
            const usuarioActualNorm = normalizar(usuarioActual.nombre);
            
            if (omAsignadoNorm !== usuarioActualNorm) {
                console.log(`üö´ OM ${usuarioActual.nombre} intenta acceder a LOB de OM ${responsables.om} - ACCESO DENEGADO`);
                
                // ‚≠ê Retornar valores VAC√çOS o del usuario actual
                return {
                    supervisor: '',
                    accm: '',
                    om: usuarioActual.nombre, // ‚≠ê Usar nombre del usuario actual
                    error: `Esta LOB est√° asignada a otro OM (${responsables.om}). No puedes registrarla.`
                };
            } else {
                console.log(`‚úÖ OM ${usuarioActual.nombre} tiene acceso a esta LOB`);
            }
        }
        
        return responsables;
        
    } catch (error) {
        console.log('‚ùå Error en obtenerResponsablesPorLobConValidacion:', error.toString());
        return { supervisor: '', accm: '', om: '', error: error.toString() };
    }
}
/**
 * Obtiene todas las LOBs √∫nicas que tienen registros en las hojas de registro
 * FILTRADAS por el OM del usuario actual
 */
function guardarConfiguracion(mes, om, lob, salarioBase, porcentajeBono) {
    try {
        console.log('=== PASO 1: Iniciando guardarConfiguracion ===');
        console.log('Mes:', mes);
        console.log('OM:', om);
        console.log('LOB:', lob);
        console.log('Salario:', salarioBase);
        console.log('Porcentaje:', porcentajeBono);
        
        const ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        console.log('‚úÖ Spreadsheet abierto');
        
        let hojaConfig = ss.getSheetByName('Configuracion');
        
        if (!hojaConfig) {
            console.log('‚ö†Ô∏è Hoja Configuracion no existe, cre√°ndola...');
            hojaConfig = ss.insertSheet('Configuracion');
            hojaConfig.getRange(1, 1, 1, 5).setValues([['Mes', 'OM', 'LOB', 'Salario_Base', '%_Bono']]);
            hojaConfig.getRange(1, 1, 1, 5).setFontWeight('bold').setBackground('#667eea').setFontColor('#ffffff');
            console.log('‚úÖ Hoja Configuracion creada');
        } else {
            console.log('‚úÖ Hoja Configuracion encontrada');
        }
        
        const data = hojaConfig.getDataRange().getValues();
        console.log('üìä Total filas en Configuracion:', data.length);
        
        let filaExistente = -1;
        const normalizar = s => s ? s.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : "";
        const mesNorm = normalizar(mes);
        const lobNorm = normalizar(lob);
        
        console.log('üîç Buscando Mes:', mesNorm, '| LOB:', lobNorm);
        
        for (let i = 1; i < data.length; i++) {
            const mesFilaNorm = normalizar(String(data[i][0]));
            const lobFilaNorm = normalizar(String(data[i][2]));
            console.log('  Fila', i, '- Mes:', mesFilaNorm, '| LOB:', lobFilaNorm);
            if (mesFilaNorm === mesNorm && lobFilaNorm === lobNorm) {
                filaExistente = i + 1;
                console.log('‚úÖ Fila existente encontrada:', filaExistente);
                break;
            }
        }
        
        const nuevaFila = [mes, om, lob, salarioBase, porcentajeBono];
        console.log('üìù Fila a guardar:', nuevaFila);
        
        if (filaExistente > 0) {
            hojaConfig.getRange(filaExistente, 1, 1, 5).setValues([nuevaFila]);
            console.log('‚úÖ Configuraci√≥n ACTUALIZADA en fila', filaExistente);
        } else {
            hojaConfig.appendRow(nuevaFila);
            console.log('‚úÖ Nueva configuraci√≥n AGREGADA');
        }
        
        return { success: true };
        
    } catch (error) {
        console.error('‚ùå ERROR en guardarConfiguracion:', error);
        console.error('Stack:', error.stack);
        return { success: false, error: error.toString() };
    }
}

// ========================================
// OBTENER KPIs REGISTRADOS
// ========================================
/**
 * Obtiene KPIs ya registrados para una LOB desde Registro/Registro_pisos
 */
function obtenerKPIsRegistradosPorLob(lob, usuario) {
    try {
        console.log(`üîç Buscando KPIs registrados para LOB: ${lob}, Usuario: ${usuario.nombre}, Rol: ${usuario.rol}`);
        const ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        const hojaRegistro = ss.getSheetByName('Registro');
        const hojaRegistroPisos = ss.getSheetByName('Registro_pisos');
        
        const normalizar = s => {
            if (!s) return "";
            return s.toString()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .toLowerCase()
                .trim();
        };
        
        const lobNorm = normalizar(lob);
        const usuarioNombreNorm = normalizar(usuario.nombre);
        
        // Buscar en ambas hojas
        const hojas = [
            { hoja: hojaRegistro, nombre: 'Registro' },
            { hoja: hojaRegistroPisos, nombre: 'Registro_pisos' }
        ];
        
        for (const { hoja, nombre } of hojas) {
            if (!hoja) {
                console.log(`‚ö†Ô∏è Hoja ${nombre} no encontrada`);
                continue;
            }
            
            const data = hoja.getDataRange().getValues();
            console.log(`üìã Procesando hoja ${nombre}, ${data.length} filas`);
            
            // Buscar registro de esta LOB
            for (let i = 1; i < data.length; i++) {
                const lobFila = normalizar(data[i][1]); // Columna B
                if (lobFila !== lobNorm) continue;
                
                // ‚≠ê‚≠ê FILTRO CR√çTICO: Verificar si el usuario tiene acceso
                let omFila = "";
                if (data[i][3]) { // Columna D (OM)
                    omFila = normalizar(String(data[i][3]));
                }
                
                // REGLAS DE ACCESO:
                // 1. Reporting Analyst: Puede ver todo
                // 2. Audit: Puede ver todo
                // 3. OM: Solo ve sus propias LOBs
                // 4. ACCM: Solo ve sus LOBs
                // 5. Supervisor: Solo ve sus LOBs
                
                let tieneAcceso = false;
                
                if (usuario.rol === 'Reporting Analyst' || usuario.rol === 'Audit') {
                    tieneAcceso = true;
                    console.log(`   ‚úÖ ${usuario.rol} tiene acceso a todo`);
                } 
                else if (usuario.rol === 'OM') {
                    tieneAcceso = (omFila === usuarioNombreNorm);
                    console.log(`   ${tieneAcceso ? '‚úÖ' : '‚ùå'} OM ${usuario.nombre} vs fila OM ${data[i][3]}: ${tieneAcceso ? 'ACCESO PERMITIDO' : 'ACCESO DENEGADO'}`);
                }
                else if (usuario.rol === 'ACCM') {
                    const accmFila = normalizar(String(data[i][2] || '')); // Columna C (ACCM)
                    tieneAcceso = (accmFila === usuarioNombreNorm);
                    console.log(`   ${tieneAcceso ? '‚úÖ' : '‚ùå'} ACCM ${usuario.nombre} vs fila ACCM ${data[i][2]}: ${tieneAcceso ? 'ACCESO PERMITIDO' : 'ACCESO DENEGADO'}`);
                }
                else if (usuario.rol === 'Supervisor') {
                    // Para Supervisor, necesitamos obtener su supervisor desde H_C
                    const tieneLob = verificarSupervisorTieneLOB(usuario.nombre, lob);
                    tieneAcceso = tieneLob;
                    console.log(`   ${tieneAcceso ? '‚úÖ' : '‚ùå'} Supervisor ${usuario.nombre} tiene LOB ${lob}: ${tieneAcceso ? 'SI' : 'NO'}`);
                }
                
                if (!tieneAcceso) continue;
                
                console.log(`‚úÖ Registro encontrado en hoja: ${nombre}, fila ${i + 1}`);
                
                const kpis = {
                    keys: [],
                    bonusStructure: [],
                    additionalIncentives: [],
                    decreasedKPIs: []
                };
                
                if (nombre === 'Registro') {
                    // ========== REGISTRO NORMAL ==========
                    // Keys: F-I (√≠ndices 5-8, inc=1)
                    for (let col = 5; col <= 8; col++) {
                        const kpiNombre = String(data[i][col] || '').trim();
                        if (kpiNombre) {
                            kpis.keys.push({ 
                                nombre: kpiNombre,
                                score: String(data[i][col + 1] || '').trim() 
                            });
                        }
                    }
                    
                    // Bonus: K-V (√≠ndices 10-21, inc=3)
                    for (let col = 10; col <= 21; col += 3) {
                        const kpiNombre = String(data[i][col] || '').trim();
                        if (kpiNombre) {
                            kpis.bonusStructure.push({
                                nombre: kpiNombre,
                                score: String(data[i][col + 1] || ''),
                                porcentaje: String(data[i][col + 2] || '')
                            });
                        }
                    }
                    
                    // Additional: X-AF (√≠ndices 23-31, inc=3)
                    for (let col = 23; col <= 31; col += 3) {
                        const kpiNombre = String(data[i][col] || '').trim();
                        if (kpiNombre) {
                            kpis.additionalIncentives.push({
                                nombre: kpiNombre,
                                score: String(data[i][col + 1] || ''),
                                porcentaje: String(data[i][col + 2] || '')
                            });
                        }
                    }
                    
                    // Decreased: AH-AM (√≠ndices 33-38, inc=3)
                    for (let col = 33; col <= 38; col += 3) {
                        const kpiNombre = String(data[i][col] || '').trim();
                        if (kpiNombre) {
                            kpis.decreasedKPIs.push({
                                nombre: kpiNombre,
                                score: String(data[i][col + 1] || ''),
                                porcentaje: String(data[i][col + 2] || '')
                            });
                        }
                    }
                    
                } else if (nombre === 'Registro_pisos') {
                    // ========== REGISTRO_PISOS ==========
                    // Keys: F-K (√≠ndices 5-10, inc=2)
                    for (let col = 5; col <= 10; col += 2) {
                        const kpiNombre = String(data[i][col] || '').trim();
                        if (kpiNombre) {
                            kpis.keys.push({ 
                                nombre: kpiNombre,
                                score: String(data[i][col + 1] || '').trim()
                            });
                        }
                    }
                    
                    // Bonus: M-AY (√≠ndices 12-50, inc=3)
                    for (let col = 12; col <= 50; col += 3) {
                        const kpiNombre = String(data[i][col] || '').trim();
                        if (kpiNombre && kpiNombre !== 'Bonus Structure') {
                            kpis.bonusStructure.push({
                                nombre: kpiNombre,
                                score: String(data[i][col + 1] || ''),
                                porcentaje: String(data[i][col + 2] || '')
                            });
                        }
                    }
                    
                    // Additional: BA-BI (√≠ndices 52-60, inc=3)
                    for (let col = 52; col <= 60; col += 3) {
                        const kpiNombre = String(data[i][col] || '').trim();
                        if (kpiNombre && kpiNombre !== 'Additional Incentive') {
                            kpis.additionalIncentives.push({
                                nombre: kpiNombre,
                                score: String(data[i][col + 1] || ''),
                                porcentaje: String(data[i][col + 2] || '')
                            });
                        }
                    }
                    
                    // Decreased: BK-BV (√≠ndices 62-73, inc=3)
                    for (let col = 62; col <= 73; col += 3) {
                        const kpiNombre = String(data[i][col] || '').trim();
                        if (kpiNombre && kpiNombre !== 'Decreased') {
                            kpis.decreasedKPIs.push({
                                nombre: kpiNombre,
                                score: String(data[i][col + 1] || ''),
                                porcentaje: String(data[i][col + 2] || '')
                            });
                        }
                    }
                }
                
                return {
                    encontrado: true,
                    hojaOrigen: nombre,
                    kpis: kpis,
                    datosContexto: {
                        accm: String(data[i][2] || '').trim(),      // Columna C
                        om: String(data[i][3] || '').trim(),        // Columna D
                        mes: String(data[i][0] || '').trim(),       // Columna A
                        lob: String(data[i][1] || '').trim()        // Columna B
                    }
                };
            }
        }
        
        console.log(`‚ö†Ô∏è No se encontraron registros para LOB: ${lob} que el usuario ${usuario.nombre} (${usuario.rol}) pueda acceder`);
        return {
            encontrado: false,
            mensaje: 'No se encontr√≥ registro previo para esta LOB o no tienes permisos para verlo.'
        };
    } catch (error) {
        console.log('‚ùå Error en obtenerKPIsRegistradosPorLob:', error.toString());
        console.error(error.stack);
        return {
            encontrado: false,
            error: error.toString()
        };
    }
}

// Funci√≥n auxiliar para verificar si Supervisor tiene una LOB
function verificarSupervisorTieneLOB(nombreSupervisor, lob) {
    try {
        const lobsDelSupervisor = obtenerLobsPorSupervisor(nombreSupervisor);
        const normalizar = s => s ? s.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : "";
        
        const lobNorm = normalizar(lob);
        return lobsDelSupervisor.some(lobSupervisor => normalizar(lobSupervisor) === lobNorm);
    } catch (error) {
        console.error('Error en verificarSupervisorTieneLOB:', error);
        return false;
    }
}



// ========================================
// GUARDAR REGISTRO
// ========================================
/**
 * Guarda un nuevo registro de m√©tricas
 */


function guardarRegistroMetricas(datos) {
    try {
        console.log('\n========== INICIO GUARDAR REGISTRO ==========');
        console.log('Datos recibidos:', JSON.stringify(datos, null, 2));
        
        if (!datos || !datos.mes || !datos.lob || !datos.tipoHoja) {
            console.error('‚ùå Faltan datos obligatorios');
            return { success: false, error: 'Faltan campos obligatorios' };
        }
        
        // ‚≠ê NORMALIZAR KPIs: Combinar comparaci√≥n + score
        const normalizarKPI = function(kpi) {
            console.log('üîß Normalizando KPI:', kpi);
            
            if (kpi.comparacion && kpi.score) {
                const scoreClean = String(kpi.score).replace('%', '').trim();
                const tienePorc = String(kpi.score).includes('%');
                kpi.score = kpi.comparacion + scoreClean + (tienePorc ? '%' : '');
                console.log('‚úÖ Score normalizado:', kpi.score);
            } else if (kpi.score) {
                console.log('‚ö†Ô∏è Score sin comparaci√≥n:', kpi.score);
            }
            
            if (kpi.porcentaje) {
                kpi.porcentaje = String(kpi.porcentaje).replace('%', '').trim();
                console.log('‚úÖ Porcentaje normalizado:', kpi.porcentaje);
            }
            
            return kpi;
        };
        
        // ‚≠ê DEBUG: Mostrar datos ANTES de normalizar
        console.log('\nüìã DATOS ANTES DE NORMALIZAR:');
        console.log('Additional antes:', datos.additional ? JSON.stringify(datos.additional, null, 2) : 'undefined');
        console.log('Decreased antes:', datos.decreased ? JSON.stringify(datos.decreased, null, 2) : 'undefined');
        
        // ‚≠ê APLICAR NORMALIZACI√ìN A TODOS LOS KPIS
        if (datos.keys && Array.isArray(datos.keys)) {
            console.log('Normalizando Keys...');
            datos.keys = datos.keys.map(k => normalizarKPI(k));
        }
        if (datos.bonus && Array.isArray(datos.bonus)) {
            console.log('Normalizando Bonus...');
            datos.bonus = datos.bonus.map(k => normalizarKPI(k));
        }
        if (datos.additional && Array.isArray(datos.additional)) {
            console.log('Normalizando Additional...');
            datos.additional = datos.additional.map(k => normalizarKPI(k));
        }
        if (datos.decreased && Array.isArray(datos.decreased)) {
            console.log('Normalizando Decreased...');
            datos.decreased = datos.decreased.map(k => normalizarKPI(k));
        }
        
        console.log('\nüìã DATOS DESPU√âS DE NORMALIZAR:');
        console.log('Additional despu√©s:', datos.additional ? JSON.stringify(datos.additional, null, 2) : 'undefined');
        console.log('Decreased despu√©s:', datos.decreased ? JSON.stringify(datos.decreased, null, 2) : 'undefined');
        
        // ‚≠ê VALIDAR TOTAL BONUS <= 100%
        if (datos.bonus && datos.bonus.length > 0) {
            let totalPct = 0;
            datos.bonus.forEach(kpi => {
                const pct = parseFloat(kpi.porcentaje || 0);
                totalPct += pct;
            });
            
            if (totalPct > 100) {
                return {
                    success: false,
                    error: `‚ùå Total Bonus Structure (${totalPct.toFixed(2)}%) supera el 100%. Ajuste los porcentajes.`
                };
            }
            
            console.log(`‚úÖ Validaci√≥n Bonus: ${totalPct.toFixed(2)}% (OK)`);
        }
        
        // 1. Guardar configuraci√≥n SOLO si viene salario y porcentaje
        if (datos.salario && datos.porcentaje) {
            console.log('\n[1/3] Guardando configuraci√≥n...');
            guardarConfiguracion(datos.mes, datos.om, datos.lob, datos.salario, datos.porcentaje);
        } else {
            console.log('\n[1/3] ‚ö†Ô∏è No se guardar√° configuraci√≥n (salario/porcentaje no proporcionados)');
        }
        
        // 2. Abrir hoja
        console.log('\n[2/3] Abriendo hoja de registro...');
        const ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        const hoja = ss.getSheetByName(datos.tipoHoja);
        
        if (!hoja) {
            console.error('‚ùå Hoja no encontrada:', datos.tipoHoja);
            return { success: false, error: 'Hoja no encontrada' };
        }
        
        console.log('‚úÖ Hoja encontrada:', datos.tipoHoja);
        
        // 3. Buscar fila existente
        const normalizar = s => s ? s.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : "";
        const dataExistente = hoja.getDataRange().getValues();
        let filaExistente = -1;
        
        for (let i = 1; i < dataExistente.length; i++) {
            if (normalizar(String(dataExistente[i][0])) === normalizar(datos.mes) && 
                normalizar(String(dataExistente[i][1])) === normalizar(datos.lob)) {
                filaExistente = i + 1;
                break;
            }
        }
        
        console.log('Fila existente:', filaExistente > 0 ? filaExistente : 'NO (se agregar√° nueva)');
        
        // 4. Preparar fila
        console.log('\n[3/3] Preparando datos...');
        let fila = [
            datos.mes,         // A (1)
            datos.lob,         // B (2)
            datos.accm || '',  // C (3)
            datos.om || ''     // D (4) - Director
        ];
        
       

       if (datos.tipoHoja === 'Registro') {
    // ==============================================
    // üî• ESTRUCTURA REGISTRO NORMAL - SIN SALARIO/PORCENTAJE
    // ==============================================
    
    console.log('üìù Preparando estructura REGISTRO normal (SIN salario/%)...');
    
    // üî• Columna E vac√≠a (NO se guarda salario aqu√≠, va en Configuracion)
    fila.push('');  // E (col 5)
    
    // ‚≠ê KEYS: F-I (2 keys: F=KPI1, G=Score1, H=KPI2, I=Score2)
    console.log('üìù Keys (F-I): 2 KPIs √ó 2 columnas');
    for (let i = 0; i < 2; i++) {
        if (datos.keys && datos.keys[i]) {
            fila.push(datos.keys[i].nombre || '');  // F, H
            fila.push(datos.keys[i].score || '');   // G, I
        } else {
            fila.push('', '');
        }
    }
    
    // Columna J vac√≠a (separador)
    fila.push('');  // J (col 10)
    
    // ‚≠ê BONUS STRUCTURE: K-V (4 KPIs x 3 campos = 12 columnas)
    console.log('üìù Bonus Structure (K-V): 4 KPIs √ó 3 columnas');
    for (let i = 0; i < 4; i++) {
        if (datos.bonus && datos.bonus[i]) {
            fila.push(datos.bonus[i].nombre || '');      // K, N, Q, T
            fila.push(datos.bonus[i].score || '');       // L, O, R, U
            fila.push(datos.bonus[i].porcentaje || '');  // M, P, S, V
        } else {
            fila.push('', '', '');
        }
    }
    
    // Columna W vac√≠a (separador)
    fila.push('');  // W (col 23)
    
    // ‚≠ê ADDITIONAL INCENTIVE: X-AF (3 KPIs x 3 campos = 9 columnas)
    console.log('üìù Additional Incentive (X-AF): 3 KPIs √ó 3 columnas');
    for (let i = 0; i < 3; i++) {
        if (datos.additional && datos.additional[i]) {
            fila.push(datos.additional[i].nombre || '');     // X, AA, AD
            fila.push(datos.additional[i].score || '');      // Y, AB, AE
            fila.push(datos.additional[i].porcentaje || ''); // Z, AC, AF
        } else {
            fila.push('', '', '');
        }
    }
    
    // Columna AG vac√≠a (separador)
    fila.push('');  // AG (col 33)
    
    // ‚≠ê DECREASED: AH-AM (2 KPIs x 3 campos = 6 columnas)
    console.log('üìù Decreased (AH-AM): 2 KPIs √ó 3 columnas');
    for (let i = 0; i < 2; i++) {
        if (datos.decreased && datos.decreased[i]) {
            fila.push(datos.decreased[i].nombre || '');     // AH, AK
            fila.push(datos.decreased[i].score || '');      // AI, AL
            fila.push(datos.decreased[i].porcentaje || ''); // AJ, AM
        } else {
            fila.push('', '', '');
        }
    }
    
} else if (datos.tipoHoja === 'Registro_pisos') {
    // ==============================================
    // ‚úÖ ESTRUCTURA REGISTRO PISOS
    // ==============================================
    
    console.log('üìù Preparando estructura REGISTRO PISOS...');
    
    // ‚úÖ Columna E: H_c (n√∫mero de agentes)
    const numAgentes = contarAgentesPorLob(datos.lob);
    fila.push(numAgentes || '');  // E (5) - H_c
    
    console.log(`üìä N√∫mero de agentes para ${datos.lob}: ${numAgentes}`);
    
    // ‚úÖ 1. KEYS: F-K (3 KPIs √ó 2 columnas = 6 columnas)
    console.log('üìä Keys (F-K): 3 KPIs √ó 2 columnas');
    for (let i = 0; i < 3; i++) {
        if (datos.keys && datos.keys[i]) {
            fila.push(datos.keys[i].nombre || '');  // KPI (F, H, J)
            fila.push(datos.keys[i].score || '');   // Score (G, I, K)
        } else {
            fila.push('', '');
        }
    }
    
    // ‚úÖ 2. HEADER BONUS: L (12)
    fila.push('Bonus Structure');  // L (12) - Header
    
    // ‚úÖ 3. BONUS STRUCTURE: M-AY (39 columnas = 13 KPIs √ó 3)
    console.log('üìä Bonus (M-AY): 13 KPIs √ó 3 columnas');
    for (let i = 0; i < 13; i++) {
        if (datos.bonus && datos.bonus[i]) {
            fila.push(datos.bonus[i].nombre || '');      // KPI
            fila.push(datos.bonus[i].score || '');       // Score
            fila.push(datos.bonus[i].porcentaje || '');  // porcentage
        } else {
            fila.push('', '', '');
        }
    }
    
    // ‚úÖ 4. HEADER ADDITIONAL: AZ (52)
    fila.push('Additional Incentive');  // AZ (52) - Header
    
    // ‚úÖ 5. ADDITIONAL INCENTIVE: BA-BI (9 columnas = 3 KPIs √ó 3)
    console.log('üìä Additional (BA-BI): 3 KPIs √ó 3 columnas');
    for (let i = 0; i < 3; i++) {
        if (datos.additional && datos.additional[i]) {
            const kpi = datos.additional[i];
            fila.push(kpi.nombre || '');
            fila.push(kpi.score || '');
            fila.push(kpi.porcentaje || '');
        } else {
            fila.push('', '', '');
        }
    }
    
    // ‚úÖ 6. HEADER DECREASED: BJ (62)
    fila.push('Decreased');  // BJ (62) - Header
    
    // ‚úÖ 7. DECREASED: BK-BV (12 columnas = 4 KPIs √ó 3)
    console.log('üìä Decreased (BK-BV): 4 KPIs √ó 3 columnas');
    for (let i = 0; i < 4; i++) {
        if (datos.decreased && datos.decreased[i]) {
            const kpi = datos.decreased[i];
            fila.push(kpi.nombre || '');
            fila.push(kpi.score || '');
            fila.push(kpi.porcentaje || '');
        } else {
            fila.push('', '', '');
        }
    }

            
        } else if (datos.tipoHoja === 'Registro_pisos') {

          
            // ==============================================
            // ‚úÖ ESTRUCTURA REGISTRO PISOS (ESTRUCTURA REAL)
            // ==============================================
            
            console.log('üìù Preparando estructura REGISTRO PISOS...');
            
            // ‚úÖ Columna E: H_c (n√∫mero de agentes)
            const numAgentes = contarAgentesPorLob(datos.lob);
            fila.push(numAgentes || '');  // E (5) - H_c
            
            console.log(`üìä N√∫mero de agentes para ${datos.lob}: ${numAgentes}`);
            
            // ‚úÖ 1. KEYS: F-K (3 KPIs √ó 2 columnas = 6 columnas)
            console.log('üìä Keys (F-K): 3 KPIs √ó 2 columnas');
            console.log('üìå Datos Keys recibidos:', datos.keys);
            
            for (let i = 0; i < 3; i++) {
                if (datos.keys && datos.keys[i]) {
                    console.log(`  Key ${i + 1}: "${datos.keys[i].nombre}" | Score: "${datos.keys[i].score}"`);
                    fila.push(datos.keys[i].nombre || '');  // KPI (F, H, J)
                    fila.push(datos.keys[i].score || '');   // Score (G, I, K)
                } else {
                    console.log(`  Key ${i + 1}: NO HAY DATOS`);
                    fila.push('', '');
                }
            }
            
            // ‚úÖ 2. HEADER BONUS: L (12)
            fila.push('Bonus Structure');  // L (12) - Header
            
            // ‚úÖ 3. BONUS STRUCTURE: M-AY (39 columnas = 13 KPIs √ó 3)
            console.log('üìä Bonus (M-AY): 13 KPIs √ó 3 columnas');
            console.log('üìå Datos Bonus recibidos:', datos.bonus);
            
            for (let i = 0; i < 13; i++) {
                if (datos.bonus && datos.bonus[i]) {
                    console.log(`  Bonus ${i + 1}: "${datos.bonus[i].nombre}" | Score: "${datos.bonus[i].score}" | %: "${datos.bonus[i].porcentaje}"`);
                    fila.push(datos.bonus[i].nombre || '');      // KPI
                    fila.push(datos.bonus[i].score || '');       // Score
                    fila.push(datos.bonus[i].porcentaje || '');  // porcentage
                } else {
                    console.log(`  Bonus ${i + 1}: NO HAY DATOS`);
                    fila.push('', '', '');
                }
            }
            
            // ‚úÖ 4. HEADER ADDITIONAL: AZ (52)
            fila.push('Additional Incentive');  // AZ (52) - Header
            
            // ‚úÖ 5. ADDITIONAL INCENTIVE: BA-BI (9 columnas = 3 KPIs √ó 3)
            console.log('\nüìä Additional (BA-BI): 3 KPIs √ó 3 columnas');
            console.log('üìå Datos Additional recibidos:', datos.additional);
            console.log('üìå Tipo de datos Additional:', typeof datos.additional);
            console.log('üìå Es array?:', Array.isArray(datos.additional));
            
            if (datos.additional && Array.isArray(datos.additional)) {
                console.log(`üìå Longitud de Additional: ${datos.additional.length}`);
            }
            
            const additionalStartIndex = fila.length;
            console.log(`üìç Additional comienza en columna: ${additionalStartIndex + 1} (deber√≠a ser 53=BA)`);
            
            for (let i = 0; i < 3; i++) {
                console.log(`\nüîç Procesando Additional KPI ${i + 1}:`);
                
                if (datos.additional && datos.additional[i]) {
                    const kpi = datos.additional[i];
                    console.log(`  ‚úÖ HAY DATOS:`);
                    console.log(`    ‚Ä¢ Nombre: "${kpi.nombre}" (tipo: ${typeof kpi.nombre})`);
                    console.log(`    ‚Ä¢ Score: "${kpi.score}" (tipo: ${typeof kpi.score})`);
                    console.log(`    ‚Ä¢ Porcentaje: "${kpi.porcentaje}" (tipo: ${typeof kpi.porcentaje})`);
                    console.log(`    ‚Ä¢ Comparaci√≥n: "${kpi.comparacion}"`);
                    
                    // Guardar los valores
                    const nombre = kpi.nombre || '';
                    const score = kpi.score || '';
                    const porcentaje = kpi.porcentaje || '';
                    
                    console.log(`  üíæ Guardando: "${nombre}", "${score}", "${porcentaje}"`);
                    
                    fila.push(nombre);
                    fila.push(score);
                    fila.push(porcentaje);
                } else {
                    console.log(`  ‚ùå NO HAY DATOS para Additional KPI ${i + 1}`);
                    console.log(`    ‚Ä¢ datos.additional existe?: ${!!datos.additional}`);
                    console.log(`    ‚Ä¢ datos.additional[i] existe?: ${!!(datos.additional && datos.additional[i])}`);
                    
                    fila.push('', '', '');
                }
            }
            
            // ‚úÖ 6. HEADER DECREASED: BJ (62)
            fila.push('Decreased');  // BJ (62) - Header
            
            // ‚úÖ 7. DECREASED: BK-BV (12 columnas = 4 KPIs √ó 3)
            console.log('\nüìä Decreased (BK-BV): 4 KPIs √ó 3 columnas');
            console.log('üìå Datos Decreased recibidos:', datos.decreased);
            
            const decreasedStartIndex = fila.length;
            console.log(`üìç Decreased comienza en columna: ${decreasedStartIndex + 1} (deber√≠a ser 63=BK)`);
            
            for (let i = 0; i < 4; i++) {
                console.log(`\nüîç Procesando Decreased KPI ${i + 1}:`);
                
                if (datos.decreased && datos.decreased[i]) {
                    const kpi = datos.decreased[i];
                    console.log(`  ‚úÖ HAY DATOS:`);
                    console.log(`    ‚Ä¢ Nombre: "${kpi.nombre}"`);
                    console.log(`    ‚Ä¢ Score: "${kpi.score}"`);
                    console.log(`    ‚Ä¢ Porcentaje: "${kpi.porcentaje}"`);
                    
                    // Guardar los valores
                    const nombre = kpi.nombre || '';
                    const score = kpi.score || '';
                    const porcentaje = kpi.porcentaje || '';
                    
                    console.log(`  üíæ Guardando: "${nombre}", "${score}", "${porcentaje}"`);
                    
                    fila.push(nombre);
                    fila.push(score);
                    fila.push(porcentaje);
                } else {
                    console.log(`  ‚ùå NO HAY DATOS para Decreased KPI ${i + 1}`);
                    fila.push('', '', '');
                }
            }
            
            // üìå VERIFICACI√ìN FINAL DE LA FILA
            console.log('\nüìå VERIFICACI√ìN FINAL DE LA FILA:');
            console.log(`‚Ä¢ Total columnas: ${fila.length}`);
            
            // Verificar posiciones exactas
            console.log(`\nüìç POSICIONES EXACTAS:`);
            console.log(`‚Ä¢ Additional Header (AZ): columna 52 = "${fila[51]}"`);
            console.log(`‚Ä¢ Additional KPI1 (BA): columna 53 = "${fila[52]}"`);
            console.log(`‚Ä¢ Additional Score1 (BB): columna 54 = "${fila[53]}"`);
            console.log(`‚Ä¢ Additional %1 (BC): columna 55 = "${fila[54]}"`);
            console.log(`‚Ä¢ Additional KPI2 (BD): columna 56 = "${fila[55]}"`);
            console.log(`‚Ä¢ Additional Score2 (BE): columna 57 = "${fila[56]}"`);
            console.log(`‚Ä¢ Additional %2 (BF): columna 58 = "${fila[57]}"`);
            console.log(`‚Ä¢ Additional KPI3 (BG): columna 59 = "${fila[58]}"`);
            console.log(`‚Ä¢ Additional Score3 (BH): columna 60 = "${fila[59]}"`);
            console.log(`‚Ä¢ Additional %3 (BI): columna 61 = "${fila[60]}"`);
            
            console.log(`\n‚Ä¢ Decreased Header (BJ): columna 62 = "${fila[61]}"`);
            console.log(`‚Ä¢ Decreased KPI1 (BK): columna 63 = "${fila[62]}"`);
            console.log(`‚Ä¢ Decreased Score1 (BL): columna 64 = "${fila[63]}"`);
            console.log(`‚Ä¢ Decreased %1 (BM): columna 65 = "${fila[64]}"`);
            
            // Mostrar un segmento de la fila para debug
            console.log('\nüìä SEGMENTO DE LA FILA (columnas 50-70):');
            for (let j = 49; j < Math.min(70, fila.length); j++) {
                const letraCol = obtenerLetraColumna(j + 1);
                console.log(`${letraCol} (${j + 1}): "${fila[j]}"`);
            }
        }
        
        console.log('\nüìä TOTAL DE COLUMNAS EN FILA:', fila.length);
        
        // 5. Guardar
        if (filaExistente > 0) {
            console.log(`\nüíæ ACTUALIZANDO fila ${filaExistente}...`);
            hoja.getRange(filaExistente, 1, 1, fila.length).setValues([fila]);
            console.log(`‚úÖ ACTUALIZADA fila ${filaExistente}`);
        } else {
            console.log('\nüíæ AGREGANDO nueva fila...');
            hoja.appendRow(fila);
            console.log('‚úÖ NUEVA fila AGREGADA');
        }
        
        console.log('========== FIN EXITOSO ==========\n');
        return { success: true };
        
    } catch (error) {
        console.error('========== ERROR ==========');
        console.error(error.toString());
        console.error(error.stack);
        return { success: false, error: error.toString() };
    }
}

// Funci√≥n auxiliar para obtener letra de columna
function obtenerLetraColumna(numero) {
    let letra = '';
    while (numero > 0) {
        const modulo = (numero - 1) % 26;
        letra = String.fromCharCode(65 + modulo) + letra;
        numero = Math.floor((numero - 1) / 26);
    }
    return letra;
}



// ========================================
// OBTENER TODOS LOS KPIS DISPONIBLES
// ========================================
function obtenerTodosLosKPIsDisponibles() {
    try {
        console.log('üîç Obteniendo KPIs √∫nicos de hojas CDM...');
        const ssCDM = SpreadsheetApp.openById('1PtYuAb5C2kIoX8sE7dOvt1nVS-aLamZLOJQUSbTBBCw');
        const hojas = ssCDM.getSheets();
        const kpisUnicos = {
            keys: new Set(),
            bonusStructure: new Set(),
            additionalIncentives: new Set(),
            decreasedKPIs: new Set()
        };
        hojas.forEach(hoja => {
            const nombreHoja = hoja.getName();
            // Procesar cualquier hoja que empiece con "CDM" (ej. CDM_1, CDM_Enero, etc.)
            if (!nombreHoja.startsWith('CDM')) return;
            // console.log(`üìã Procesando: ${nombreHoja}`);
            const data = hoja.getDataRange().getValues();
            if (data.length < 2) return;
            // El usuario indic√≥ que los KPIs est√°n en la Columna D (√≠ndice 3)
            const kpiColumnIndex = 3;
            // Extraer KPIs desde la fila 1 en adelante
            for (let i = 1; i < data.length; i++) {
                const celda = String(data[i][kpiColumnIndex] || '').trim();
                if (!celda) continue;
                // L√≥gica para extraer el nombre del KPI
                let kpiNombre = celda;
                // El usuario solicit√≥ que TODOS los KPIs est√©n disponibles en TODOS los selects
                kpisUnicos.keys.add(kpiNombre);
                kpisUnicos.bonusStructure.add(kpiNombre);
                kpisUnicos.additionalIncentives.add(kpiNombre);
                kpisUnicos.decreasedKPIs.add(kpiNombre);
            }
        });
        const resultado = {
            keys: Array.from(kpisUnicos.keys).sort(),
            bonusStructure: Array.from(kpisUnicos.bonusStructure).sort(),
            additionalIncentives: Array.from(kpisUnicos.additionalIncentives).sort(),
            decreasedKPIs: Array.from(kpisUnicos.decreasedKPIs).sort()
        };
        console.log(`‚úÖ KPIs √∫nicos extra√≠dos: ${resultado.keys.length}`);
        return resultado;
    } catch (error) {
        console.log('‚ùå Error:', error.toString());
        return {
            keys: [],
            bonusStructure: [],
            additionalIncentives: [],
            decreasedKPIs: []
        };
    }
}
// ========================================
// OBTENER ESTRUCTURA REGISTRADA (SIMULACI√ìN)
// ========================================
/**
 * Obtiene estructura registrada por LOB y Mes
 */
/**
 * Obtiene estructura registrada por LOB y Mes
 */


function obtenerEstructuraRegistrada(lob, mes, usuario) {
    try {
        console.log(`üîç INICIANDO B√öSQUEDA PARA: LOB="${lob}", Mes="${mes}", Usuario="${usuario ? usuario.nombre : 'N/A'}" (${usuario ? usuario.rol : 'N/A'})`);
        
        const ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        const hojaRegistro = ss.getSheetByName('Registro');
        const hojaRegistroPisos = ss.getSheetByName('Registro_pisos');
        
        console.log(`üìä Hojas disponibles:`);
        console.log(`   ‚Ä¢ Registro: ${!!hojaRegistro}`);
        console.log(`   ‚Ä¢ Registro_pisos: ${!!hojaRegistroPisos}`);
        
        // Funci√≥n de normalizaci√≥n consistente
        const normalizar = s => {
            if (!s) return '';
            return s.toString()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .toLowerCase()
                .trim();
        };
        
        const lobNorm = normalizar(lob);
        const mesNorm = normalizar(mes);
        
        // üî• OBTENER USUARIO ACTUAL SI NO SE PASA
        if (!usuario) {
            usuario = obtenerDatosUsuarioActivo();
            console.log(`‚ö†Ô∏è Usuario no pasado, obteniendo actual: ${usuario ? usuario.nombre : 'NO ENCONTRADO'}`);
        }
        
        const usuarioNombreNorm = normalizar(usuario ? usuario.nombre : '');
        
        console.log(`üìå B√∫squeda normalizada: LOB="${lobNorm}", Mes="${mesNorm}", Usuario="${usuarioNombreNorm}"`);
        
        // Buscar en ambas hojas
        const hojas = [
            { hoja: hojaRegistro, nombre: 'Registro' },
            { hoja: hojaRegistroPisos, nombre: 'Registro_pisos' }
        ];
        
        for (const { hoja, nombre } of hojas) {
            if (!hoja) {
                console.log(`‚ö†Ô∏è Hoja ${nombre} no encontrada`);
                continue;
            }
            
            console.log(`\nüìã BUSCANDO EN HOJA: ${nombre}`);
            const data = hoja.getDataRange().getValues();
            console.log(`   ‚Ä¢ Filas totales: ${data.length}`);
            
            if (data.length < 2) {
                console.log(`   ‚Ä¢ Hoja vac√≠a o solo headers`);
                continue;
            }
            
            // Mostrar headers para debug
            console.log(`   ‚Ä¢ Headers (primeras 5 columnas): ${data[0].slice(0, 5).join(" | ")}...`);
            
            // Buscar registro
            for (let i = 1; i < data.length; i++) {
                const mesFila = String(data[i][0] || '');
                const lobFila = String(data[i][1] || '');
                const accmFila = String(data[i][2] || ''); // Columna C
                const omFila = String(data[i][3] || '');   // Columna D
                
                const mesFilaNorm = normalizar(mesFila);
                const lobFilaNorm = normalizar(lobFila);
                const accmFilaNorm = normalizar(accmFila);
                const omFilaNorm = normalizar(omFila);
                
                // ‚≠ê‚≠ê VERIFICAR SI COINCIDE MES Y LOB
                const mesCoincide = mesFilaNorm === mesNorm;
                const lobCoincide = lobFilaNorm === lobNorm;
                
                // üî• DEBUG: Mostrar todas las filas que coinciden con la LOB
                if (lobCoincide && i <= 10) {
                    console.log(`   üîç Fila ${i + 1}: Mes="${mesFila}", LOB="${lobFila}", ACCM="${accmFila}", OM="${omFila}"`);
                }
                
                if (!mesCoincide || !lobCoincide) continue;
                
                console.log(`\n   ‚úÖ‚úÖ COINCIDENCIA ENCONTRADA en fila ${i + 1}`);
                console.log(`      ‚Ä¢ Mes: "${mesFila}" (normalizado: "${mesFilaNorm}")`);
                console.log(`      ‚Ä¢ LOB: "${lobFila}" (normalizado: "${lobFilaNorm}")`);
                console.log(`      ‚Ä¢ ACCM: "${accmFila}"`);
                console.log(`      ‚Ä¢ OM: "${omFila}"`);
                
                // ‚≠ê‚≠ê VERIFICAR PERMISOS SEG√öN ROL
                let tieneAcceso = false;
                
                if (!usuario) {
                    console.log(`   ‚ö†Ô∏è Usuario no definido, permitiendo acceso`);
                    tieneAcceso = true;
                } 
                else if (usuario.rol === 'Reporting Analyst' || usuario.rol === 'Audit') {
                    tieneAcceso = true;
                    console.log(`   ‚úÖ ${usuario.rol} tiene acceso a todo`);
                } 
                else if (usuario.rol === 'OM') {
                    tieneAcceso = (omFilaNorm === usuarioNombreNorm);
                    console.log(`   ${tieneAcceso ? '‚úÖ' : '‚ùå'} OM ${usuario.nombre} vs fila OM "${omFila}": ${tieneAcceso ? 'COINCIDE' : 'NO COINCIDE'}`);
                    
                    if (!tieneAcceso) {
                        console.log(`      üîç Comparaci√≥n detallada:`);
                        console.log(`         Usuario normalizado: "${usuarioNombreNorm}"`);
                        console.log(`         OM fila normalizado: "${omFilaNorm}"`);
                    }
                }
                else if (usuario.rol === 'ACCM') {
                    tieneAcceso = (accmFilaNorm === usuarioNombreNorm);
                    console.log(`   ${tieneAcceso ? '‚úÖ' : '‚ùå'} ACCM ${usuario.nombre} vs fila ACCM "${accmFila}": ${tieneAcceso ? 'COINCIDE' : 'NO COINCIDE'}`);
                }
                else if (usuario.rol === 'Supervisor') {
                    const tieneLob = verificarSupervisorTieneLOB(usuario.nombre, lob);
                    tieneAcceso = tieneLob;
                    console.log(`   ${tieneAcceso ? '‚úÖ' : '‚ùå'} Supervisor ${usuario.nombre} tiene LOB ${lob}: ${tieneAcceso ? 'SI' : 'NO'}`);
                }
                
                if (!tieneAcceso) {
                    console.log(`   ‚ùå ACCESO DENEGADO - El usuario no tiene permisos para ver esta LOB`);
                    continue;
                }
                
                console.log(`   üéâüéâ ACCESO CONCEDIDO - Procesando KPIs...`);
                
                // Procesar datos seg√∫n la hoja
                const kpis = {
                    keys: [],
                    bonusStructure: [],
                    additionalIncentives: [],
                    decreasedKPIs: []
                };
                
                if (nombre === 'Registro') {
                    console.log('üìã Procesando estructura de Registro normal...');
                    
                    // KEYS: F-I (columnas 5-8)
                    for (let col = 5; col <= 8; col += 2) {
                        const kpiNombre = String(data[i][col] || '').trim();
                        if (kpiNombre) {
                            kpis.keys.push({ 
                                nombre: kpiNombre,
                                score: String(data[i][col + 1] || '').trim() 
                            });
                        }
                    }
                    
                    // BONUS: K-V (columnas 10-21)
                    for (let col = 10; col <= 21; col += 3) {
                        const kpiNombre = String(data[i][col] || '').trim();
                        if (kpiNombre) {
                            kpis.bonusStructure.push({
                                nombre: kpiNombre,
                                score: String(data[i][col + 1] || ''),
                                porcentaje: String(data[i][col + 2] || '')
                            });
                        }
                    }
                    
                    // ADDITIONAL: X-AF (columnas 23-31)
                    for (let col = 23; col <= 31; col += 3) {
                        const kpiNombre = String(data[i][col] || '').trim();
                        if (kpiNombre) {
                            kpis.additionalIncentives.push({
                                nombre: kpiNombre,
                                score: String(data[i][col + 1] || ''),
                                porcentaje: String(data[i][col + 2] || '')
                            });
                        }
                    }
                    
                    // DECREASED: AH-AM (columnas 33-38)
                    for (let col = 33; col <= 38; col += 3) {
                        const kpiNombre = String(data[i][col] || '').trim();
                        if (kpiNombre) {
                            kpis.decreasedKPIs.push({
                                nombre: kpiNombre,
                                score: String(data[i][col + 1] || ''),
                                porcentaje: String(data[i][col + 2] || '')
                            });
                        }
                    }
                    
                } else if (nombre === 'Registro_pisos') {
                    console.log('üìã Procesando estructura de Registro_pisos...');
                    
                    // KEYS: F-K (columnas 5-10)
                    for (let col = 5; col <= 10; col += 2) {
                        const kpiNombre = String(data[i][col] || '').trim();
                        const kpiScore = String(data[i][col + 1] || '').trim();
                        
                        if (kpiNombre) {
                            kpis.keys.push({ 
                                nombre: kpiNombre,
                                score: kpiScore || '-'
                            });
                        }
                    }
                    
                    // BONUS: M-AY (columnas 12-50, saltando header en L=11)
                    for (let col = 12; col <= 50; col += 3) {
                        const kpiNombre = String(data[i][col] || '').trim();
                        if (kpiNombre && kpiNombre !== 'Bonus Structure') {
                            kpis.bonusStructure.push({
                                nombre: kpiNombre,
                                score: String(data[i][col + 1] || ''),
                                porcentaje: String(data[i][col + 2] || '')
                            });
                        }
                    }
                    
                    // ADDITIONAL: BA-BI (columnas 52-60)
                    for (let col = 52; col <= 60; col += 3) {
                        const kpiNombre = String(data[i][col] || '').trim();
                        if (kpiNombre && kpiNombre !== 'Additional Incentive') {
                            kpis.additionalIncentives.push({
                                nombre: kpiNombre,
                                score: String(data[i][col + 1] || ''),
                                porcentaje: String(data[i][col + 2] || '')
                            });
                        }
                    }
                    
                    // DECREASED: BK-BV (columnas 62-73)
                    for (let col = 62; col <= 73; col += 3) {
                        const kpiNombre = String(data[i][col] || '').trim();
                        if (kpiNombre && kpiNombre !== 'Decreased') {
                            kpis.decreasedKPIs.push({
                                nombre: kpiNombre,
                                score: String(data[i][col + 1] || ''),
                                porcentaje: String(data[i][col + 2] || '')
                            });
                        }
                    }
                    
                    console.log(`üìä KPIs encontrados:`);
                    console.log(`   ‚Ä¢ Keys: ${kpis.keys.length}`);
                    console.log(`   ‚Ä¢ Bonus: ${kpis.bonusStructure.length}`);
                    console.log(`   ‚Ä¢ Additional: ${kpis.additionalIncentives.length}`);
                    console.log(`   ‚Ä¢ Decreased: ${kpis.decreasedKPIs.length}`);
                }
                
                // Obtener datos de configuraci√≥n
                let configSalario = 0;
                let configPorcentaje = 0;
                
                try {
                    const config = obtenerConfiguracionPorMesYLob(mes, lob);
                    if (config.success) {
                        configSalario = config.configuracion.salarioBase || 0;
                        configPorcentaje = config.configuracion.porcentajeBono || 0;
                        console.log(`üí∞ Configuraci√≥n encontrada: Salario=${configSalario}, %=${configPorcentaje}`);
                    } else {
                        console.log(`‚ö†Ô∏è No se encontr√≥ configuraci√≥n para ${mes} - ${lob}`);
                    }
                } catch (configError) {
                    console.log('‚ö†Ô∏è No se pudo obtener configuraci√≥n:', configError);
                }
                
                return {
                    encontrado: true,
                    hojaOrigen: nombre,
                    tipoHoja: nombre, // üî• AGREGADO
                    lob: String(data[i][1] || '').trim(),
                    mes: String(data[i][0] || '').trim(),
                    accm: String(data[i][2] || '').trim(),
                    om: String(data[i][3] || '').trim(),
                    hc: data[i][4] || 0,
                    salario: configSalario,
                    porcentaje: configPorcentaje,
                    kpis: kpis
                };
            }
            
            console.log(`‚ùå NO ENCONTRADO EN HOJA ${nombre} (despu√©s de verificar ${data.length - 1} filas)`);
        }
        
        console.log(`\n‚ùå‚ùå‚ùå NO SE ENCONTR√ì ESTRUCTURA PARA LOB "${lob}" EN MES "${mes}"`);
        console.log(`   ‚Ä¢ LOB buscado: "${lob}" (normalizado: "${lobNorm}")`);
        console.log(`   ‚Ä¢ Mes buscado: "${mes}" (normalizado: "${mesNorm}")`);
        console.log(`   ‚Ä¢ Usuario: "${usuario ? usuario.nombre : 'N/A'}" (${usuario ? usuario.rol : 'N/A'})`);
        
        return {
            encontrado: false,
            mensaje: `No se encontr√≥ estructura registrada para LOB "${lob}" en el mes "${mes}".`
        };
        
    } catch (error) {
        console.log('‚ùå ERROR en obtenerEstructuraRegistrada:', error.toString());
        console.error(error.stack);
        return {
            encontrado: false,
            error: error.toString()
        };
    }
}



function guardarConfiguracion(mes, om, lob, salarioBase, porcentajeBono) {
    try {
        console.log('=== PASO 1: Iniciando guardarConfiguracion ===');
        console.log('Mes:', mes);
        console.log('OM:', om);
        console.log('LOB:', lob);
        console.log('Salario:', salarioBase);
        console.log('Porcentaje:', porcentajeBono);
        
        const ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        console.log('‚úÖ Spreadsheet abierto');
        
        let hojaConfig = ss.getSheetByName('Configuracion');
        
        if (!hojaConfig) {
            console.log('‚ö†Ô∏è Hoja Configuracion no existe, cre√°ndola...');
            hojaConfig = ss.insertSheet('Configuracion');
            hojaConfig.getRange(1, 1, 1, 6).setValues([['Mes', 'OM', 'LOB', 'Salario_Base', '%_Bono', 'Timestamp']]);
            hojaConfig.getRange(1, 1, 1, 6).setFontWeight('bold').setBackground('#667eea').setFontColor('#ffffff');
            console.log('‚úÖ Hoja Configuracion creada');
        } else {
            console.log('‚úÖ Hoja Configuracion encontrada');
        }
        
        const data = hojaConfig.getDataRange().getValues();
        console.log('üìä Total filas en Configuracion:', data.length);
        
        let filaExistente = -1;
        const normalizar = s => s ? s.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : "";
        const mesNorm = normalizar(mes);
        const lobNorm = normalizar(lob);
        
        console.log('üîç Buscando Mes:', mesNorm, '| LOB:', lobNorm);
        
        for (let i = 1; i < data.length; i++) {
            const mesFilaNorm = normalizar(String(data[i][0]));
            const lobFilaNorm = normalizar(String(data[i][2]));
            console.log('  Fila', i, '- Mes:', mesFilaNorm, '| LOB:', lobFilaNorm);
            if (mesFilaNorm === mesNorm && lobFilaNorm === lobNorm) {
                filaExistente = i + 1;
                console.log('‚úÖ Fila existente encontrada:', filaExistente);
                break;
            }
        }
        
        // üî• AGREGAR TIMESTAMP
        const timestamp = new Date();
        const nuevaFila = [mes, om, lob, salarioBase, porcentajeBono, timestamp];
        console.log('üìù Fila a guardar:', nuevaFila);
        
        if (filaExistente > 0) {
            hojaConfig.getRange(filaExistente, 1, 1, 6).setValues([nuevaFila]);
            console.log('‚úÖ Configuraci√≥n ACTUALIZADA en fila', filaExistente);
        } else {
            hojaConfig.appendRow(nuevaFila);
            console.log('‚úÖ Nueva configuraci√≥n AGREGADA');
        }
        
        return { success: true };
        
    } catch (error) {
        console.error('‚ùå ERROR en guardarConfiguracion:', error);
        console.error('Stack:', error.stack);
        return { success: false, error: error.toString() };
    }
}

// üî• NUEVA FUNCI√ìN: Obtener salario existente de una LOB (sin importar el mes)
function obtenerSalarioPorLob(lob) {
    try {
        console.log('üîç Buscando salario existente para LOB:', lob);
        
        const ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        const hojaConfig = ss.getSheetByName('Configuracion');
        
        if (!hojaConfig) {
            console.log('‚ö†Ô∏è No existe hoja Configuracion');
            return { encontrado: false };
        }
        
        const data = hojaConfig.getDataRange().getValues();
        const normalizar = s => s ? s.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : "";
        const lobNorm = normalizar(lob);
        
        // Buscar cualquier registro de esta LOB (sin importar mes)
        for (let i = 1; i < data.length; i++) {
            const lobFila = normalizar(String(data[i][2] || ''));
            
            if (lobFila === lobNorm) {
                console.log('‚úÖ Salario encontrado para LOB:', data[i][3], '%:', data[i][4]);
                return {
                    encontrado: true,
                    salario: data[i][3],
                    porcentaje: data[i][4],
                    mes: data[i][0]
                };
            }
        }
        
        console.log('‚ö†Ô∏è No se encontr√≥ salario previo para esta LOB');
        return { encontrado: false };
        
    } catch (error) {
        console.error('‚ùå Error en obtenerSalarioPorLob:', error);
        return { encontrado: false, error: error.toString() };
    }
}




// Agregar esta funci√≥n en el backend
function obtenerConfiguracionPorMesYLob(mes, lob) {
    try {
        const ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        const hojaConfig = ss.getSheetByName('Configuracion');
        
        if (!hojaConfig) {
            return { success: false, mensaje: 'No hay configuraci√≥n guardada' };
        }
        
        const data = hojaConfig.getDataRange().getValues();
        
        const normalizar = s => s ? s.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : "";
        const mesNorm = normalizar(mes);
        const lobNorm = normalizar(lob);
        
        for (let i = 1; i < data.length; i++) {
            const mesFila = data[i][0];
            const lobFila = data[i][2];
            
            if (normalizar(mesFila) === mesNorm && normalizar(lobFila) === lobNorm) {
                return {
                    success: true,
                    configuracion: {
                        mes: data[i][0],
                        om: data[i][1],
                        lob: data[i][2],
                        salarioBase: data[i][3],
                        porcentajeBono: data[i][4]
                    }
                };
            }
        }
        
        return { success: false, mensaje: 'No se encontr√≥ configuraci√≥n para este mes y LOB' };
        
    } catch (error) {
        console.error('Error al obtener configuraci√≥n:', error);
        return { success: false, error: error.toString() };
    }
}

function obtenerLobsRegistradas() {
    try {
        console.log('üîç Obteniendo LOBs registradas (para simulador)...');
        
        const usuario = obtenerDatosUsuarioActivo();
        if (!usuario) {
            console.log('‚ùå Usuario no encontrado');
            return [];
        }
        
        const ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        const hojas = [ss.getSheetByName('Registro'), ss.getSheetByName('Registro_pisos')];
        const lobsSet = new Set();
        
        const normalizar = s => s ? s.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : "";
        const usuarioNombreNorm = normalizar(usuario.nombre);
        
        console.log(`üë§ Usuario: ${usuario.nombre} (${usuario.rol})`);
        
        hojas.forEach(hoja => {
            if (!hoja) return;
            
            const data = hoja.getDataRange().getValues();
            console.log(`üìã Hoja ${hoja.getName()}: ${data.length} filas`);
            
            for (let i = 1; i < data.length; i++) {
                const lob = String(data[i][1] || '').trim(); // Columna B
                const om = String(data[i][3] || '').trim();  // Columna D (OM)
                const accm = String(data[i][2] || '').trim(); // Columna C (ACCM)
                
                if (!lob) continue;
                
                // üî• FILTRAR POR PERMISOS SEG√öN ROL
                let tienePermiso = false;
                
                if (usuario.rol === 'Reporting Analyst' || usuario.rol === 'Audit') {
                    tienePermiso = true;
                } 
                else if (usuario.rol === 'OM') {
                    const omNorm = normalizar(om);
                    tienePermiso = (omNorm === usuarioNombreNorm);
                }
                else if (usuario.rol === 'ACCM') {
                    const accmNorm = normalizar(accm);
                    tienePermiso = (accmNorm === usuarioNombreNorm);
                }
                else if (usuario.rol === 'Supervisor') {
                    const tieneLob = verificarSupervisorTieneLOB(usuario.nombre, lob);
                    tienePermiso = tieneLob;
                }
                
                if (tienePermiso) {
                    lobsSet.add(lob);
                    console.log(`‚úÖ ${usuario.rol} puede ver LOB: "${lob}"`);
                }
            }
        });
        
        const resultado = Array.from(lobsSet).sort();
        console.log(`üìä Total LOBs registradas que ${usuario.nombre} puede ver: ${resultado.length}`);
        
        return resultado;
        
    } catch (e) {
        console.error('‚ùå Error en obtenerLobsRegistradas:', e);
        return [];
    }
}


// ========================================
// üî• NUEVA FUNCI√ìN DE VALIDACI√ìN PARA OM
// ========================================




// ========================================
// üî• NUEVA FUNCI√ìN DE VALIDACI√ìN PARA OM
// ========================================

function verificarLOBPerteneceAOM(lob, nombreOM) {
    try {
        console.log(`üõ°Ô∏è [BACKEND] Verificando si LOB "${lob}" pertenece a OM "${nombreOM}"`);
        
        const ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        const hojaHC = ss.getSheetByName('H_C');
        
        if (!hojaHC) {
            console.log('‚ùå Hoja H_C no encontrada');
            return false;
        }
        
        const dataHC = hojaHC.getDataRange().getValues();
        const normalizar = s => {
            if (!s) return "";
            return s.toString()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .toLowerCase()
                .trim()
                .replace(/\s+/g, ' ');
        };
        
        const lobNorm = normalizar(lob);
        const omNorm = normalizar(nombreOM);
        
        console.log(`üîç [BACKEND] Buscando: LOB="${lobNorm}", OM="${omNorm}"`);
        
        for (let i = 1; i < dataHC.length; i++) {
            const lobFila = dataHC[i][1]; // Columna B (LOB)
            const omFila = dataHC[i][6];  // Columna G (OM)
            
            if (!lobFila || !omFila) continue;
            
            const lobFilaNorm = normalizar(lobFila);
            const omFilaNorm = normalizar(omFila);
            
            if (lobFilaNorm === lobNorm) {
                console.log(`‚úÖ [BACKEND] Encontrada LOB en fila ${i+1}: OM="${omFila}"`);
                
                if (omFilaNorm === omNorm) {
                    console.log(`üéØ ‚úÖ [BACKEND] COINCIDE: OM ${nombreOM} s√≠ tiene esta LOB`);
                    return true;
                } else {
                    console.log(`üö´ ‚ùå [BACKEND] NO COINCIDE: LOB asignada a OM "${omFila}", no a "${nombreOM}"`);
                    return false;
                }
            }
        }
        
        console.log(`‚ö†Ô∏è [BACKEND] LOB "${lob}" no encontrada en H_C`);
        return false;
        
    } catch (error) {
        console.error('‚ùå [BACKEND] Error en verificarLOBPerteneceAOM:', error);
        return false;
    }
}

function verificarLOBPerteneceAOM(lob, nombreOM) {
    try {
        const ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        const hojaHC = ss.getSheetByName('H_C');
        if (!hojaHC) return false;
        
        const data = hojaHC.getDataRange().getValues();
        
        for (let i = 1; i < data.length; i++) {
            if (String(data[i][1]).trim() === lob.trim() && 
                String(data[i][6]).trim() === nombreOM.trim()) {
                return true;
            }
        }
        return false;
    } catch(e) {
        return false;
    }
}


// ========================================
// üî• NUEVA FUNCI√ìN: OBTENER LOBs POR ROL
// ========================================
function obtenerLobsPorRol(nombreUsuario, rolUsuario) {
    try {
        console.log(`üîç [BACKEND] Obteniendo LOBs para ${nombreUsuario} (${rolUsuario})`);
        
        let lobs = [];
        
        // üî• FILTRAR SEG√öN ROL
        if (rolUsuario === 'Reporting Analyst' || rolUsuario === 'Audit') {
            // Ver todas las LOBs
            lobs = obtenerTodasLasLobs();
            console.log(`‚úÖ ${rolUsuario}: Todas las LOBs (${lobs.length})`);
            
        } else if (rolUsuario === 'OM') {
            // üî• SOLO LOBs de este OM espec√≠fico
            lobs = obtenerLobsPorOM(nombreUsuario);
            console.log(`‚úÖ OM ${nombreUsuario}: LOBs asignadas (${lobs.length})`);
            
        } else if (rolUsuario === 'ACCM') {
            lobs = obtenerLobsPorACCM(nombreUsuario);
            console.log(`‚úÖ ACCM ${nombreUsuario}: LOBs asignadas (${lobs.length})`);
            
        } else if (rolUsuario === 'Supervisor') {
            lobs = obtenerLobsPorSupervisor(nombreUsuario);
            console.log(`‚úÖ Supervisor ${nombreUsuario}: LOBs asignadas (${lobs.length})`);
            
        } else {
            console.log(`‚ö†Ô∏è Rol no reconocido: ${rolUsuario}`);
        }
        
        // üî• VALIDACI√ìN EXTRA: Asegurar que el OM tenga acceso real a cada LOB
        if (rolUsuario === 'OM' && lobs.length > 0) {
            const lobsValidadas = [];
            
            lobs.forEach(lob => {
                if (verificarLOBPerteneceAOM(lob, nombreUsuario)) {
                    lobsValidadas.push(lob);
                } else {
                    console.log(`‚ö†Ô∏è LOB "${lob}" no pertenece a OM ${nombreUsuario} - filtrada`);
                }
            });
            
            console.log(`‚úÖ OM ${nombreUsuario}: ${lobsValidadas.length} LOBs v√°lidas de ${lobs.length} originales`);
            return lobsValidadas.sort();
        }
        
        return lobs.sort();
        
    } catch (error) {
        console.log('‚ùå Error en obtenerLobsPorRol:', error.toString());
        return [];
    }
}



// ========================================
// üî• NUEVA FUNCI√ìN: SIMULAR TODAS LAS LOBs DEL USUARIO
// ========================================
// ========================================
// üî• SIMULAR TODAS LAS LOBs DEL USUARIO
// ========================================
function simularTodasLasLOBsDelUsuario() {
    try {
        console.log('üöÄ Iniciando simulaci√≥n de todas las LOBs...');
        
        const usuario = obtenerDatosUsuarioActivo();
        if (!usuario) {
            return { success: false, error: 'Usuario no encontrado' };
        }
        
        console.log(`üë§ Usuario: ${usuario.nombre} (${usuario.rol})`);
        
        // Obtener todas las LOBs registradas del usuario
        const lobsRegistradas = obtenerLobsRegistradas();
        console.log(`üìã LOBs registradas encontradas: ${lobsRegistradas.length}`);
        
        if (lobsRegistradas.length === 0) {
            return { 
                success: false, 
                error: 'No se encontraron LOBs registradas para este usuario' 
            };
        }
        
        const lobsSimuladas = [];
        let totalGeneral = 0;
        let totalAgentesGeneral = 0;
        let totalBonoMaximo = 0;
        
        // Procesar cada LOB
        lobsRegistradas.forEach(lob => {
            console.log(`\nüìä Procesando LOB: ${lob}`);
            
            // Obtener meses registrados para esta LOB
            const meses = obtenerMesesRegistrados(lob, usuario);
            
            if (meses.length === 0) {
                console.log(`   ‚ö†Ô∏è No hay meses registrados para ${lob}`);
                return;
            }
            
            // Tomar el mes m√°s reciente
            const mesReciente = meses[meses.length - 1];
            console.log(`   üìÖ Usando mes m√°s reciente: ${mesReciente}`);
            
            // Obtener estructura registrada
            const estructura = obtenerEstructuraRegistrada(lob, mesReciente, usuario);
            
            if (!estructura.encontrado) {
                console.log(`   ‚ùå No se pudo obtener estructura para ${lob} - ${mesReciente}`);
                return;
            }
            
            const salario = parseFloat(estructura.salario) || 0;
            const porcentaje = parseFloat(estructura.porcentaje) || 0;
            const hc = parseInt(estructura.hc) || contarAgentesPorLob(lob);
            
            if (salario === 0 || porcentaje === 0) {
                console.log(`   ‚ö†Ô∏è Sin configuraci√≥n salarial para ${lob}`);
                return;
            }
            
            const bonoMaximo = (salario * porcentaje) / 100;
            
            // Calcular totales de Bonus y Additional
            let totalBonus = 0;
            let totalAdditional = 0;
            
            if (estructura.kpis.bonusStructure) {
                estructura.kpis.bonusStructure.forEach(kpi => {
                    const pct = parseFloat(kpi.porcentaje) || 0;
                    totalBonus += (bonoMaximo * pct) / 100;
                });
            }
            
            if (estructura.kpis.additionalIncentives) {
                estructura.kpis.additionalIncentives.forEach(kpi => {
                    const pct = parseFloat(kpi.porcentaje) || 0;
                    totalAdditional += (bonoMaximo * pct) / 100;
                });
            }
            
            const totalPorAgente = totalBonus + totalAdditional;
            const totalLOB = totalPorAgente * hc;
            
            lobsSimuladas.push({
                lob: lob,
                mes: mesReciente,
                hc: hc,
                bonoPorAgente: totalPorAgente,
                totalBonus: totalBonus * hc,
                totalAdditional: totalAdditional * hc,
                totalLOB: totalLOB
            });
            
            totalGeneral += totalLOB;
            totalAgentesGeneral += hc;
            totalBonoMaximo += (bonoMaximo * hc);
            
            console.log(`   ‚úÖ ${lob}: ${hc} agentes, Total: $${totalLOB.toFixed(2)}`);
        });
        
        console.log(`\n‚úÖ Simulaci√≥n completada:`);
        console.log(`   ‚Ä¢ LOBs simuladas: ${lobsSimuladas.length}`);
        console.log(`   ‚Ä¢ Total agentes: ${totalAgentesGeneral}`);
        console.log(`   ‚Ä¢ Total a pagar: $${totalGeneral.toFixed(2)}`);
        
        return {
            success: true,
            lobsSimuladas: lobsSimuladas,
            totalGeneral: totalGeneral,
            resumen: {
                totalAgentes: totalAgentesGeneral,
                bonoMaximoTotal: totalBonoMaximo,
                totalBonus: lobsSimuladas.reduce((sum, l) => sum + l.totalBonus, 0),
                totalAdditional: lobsSimuladas.reduce((sum, l) => sum + l.totalAdditional, 0)
            },
            usuario: {
                nombre: usuario.nombre,
                rol: usuario.rol
            }
        };
        
    } catch (error) {
        console.error('‚ùå Error en simularTodasLasLOBsDelUsuario:', error);
        console.error(error.stack);
        return { 
            success: false, 
            error: error.toString() 
        };
    }
}


// ========================================
// üî• SIMULACI√ìN MASIVA OPTIMIZADA
// ========================================
function simularTodasLOBsPorOM(nombreOM) {
    try {
        console.log(`üöÄ Iniciando simulaci√≥n MASIVA para OM: ${nombreOM}`);
        const ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        const hojaHC = ss.getSheetByName('H_C');
        if (!hojaHC) {
            return { success: false, error: 'No se encontr√≥ la hoja H_C' };
        }
        const dataHC = hojaHC.getDataRange().getValues();
        
        const normalizar = s => s ? s.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : "";
        const omNorm = normalizar(nombreOM);
        // üî• OBTENER TODAS LAS LOBs ASIGNADAS A ESTE OM (DEDUPLICADAS)
        const lobsSet = new Set();
        for (let i = 1; i < dataHC.length; i++) {
            const omFila = normalizar(String(dataHC[i][6] || '')); // Columna G
            if (omFila === omNorm) {
                const lob = String(dataHC[i][1] || '').trim(); // Columna B
                if (lob) lobsSet.add(lob);
            }
        }
        
        const lobsDelOM = Array.from(lobsSet);
        console.log(`üìã LOBs √öNICAS asignadas al OM ${nombreOM}: ${lobsDelOM.length}`);
        
        if (lobsDelOM.length === 0) {
            return { success: false, error: `No se encontraron LOBs asignadas al OM ${nombreOM}` };
        }
        
        const usuario = obtenerDatosUsuarioActivo();
        if (!usuario) {
            return { success: false, error: 'Usuario no encontrado' };
        }
        
        const usuarioNorm = normalizar(usuario.nombre);
        if (usuario.rol !== 'OM' || usuarioNorm !== omNorm) {
            return { success: false, error: `Solo el OM ${nombreOM} puede simular sus LOBs` };
        }
        // üî• NUEVA L√ìGICA: Usar Map para evitar duplicados por LOB
        const resultadosMap = new Map(); // Key: LOB, Value: datos m√°s recientes
        let totalAgentesGeneral = 0;
        let totalBonoMaximo = 0;
        // üî• PROCESAR CADA LOB (UNA SOLA VEZ)
        for (const lob of lobsDelOM) {
            console.log(`\nüìä Procesando LOB: ${lob}`);
            // üî• EVITAR DUPLICADOS: Si ya procesamos esta LOB, saltar
            if (resultadosMap.has(lob)) {
                console.log(`   ‚ö†Ô∏è LOB ${lob} ya procesada, omitiendo...`);
                continue;
            }
            try {
                // 1. Obtener meses registrados
                const meses = obtenerMesesRegistrados(lob, usuario);
                if (!meses || meses.length === 0) {
                    console.log(`   ‚ö†Ô∏è No hay meses registrados para ${lob}`);
                    continue;
                }
                // 2. Usar el mes m√°s reciente
                const mesReciente = meses[meses.length - 1];
                console.log(`   üìÖ Usando mes m√°s reciente: ${mesReciente}`);
                // 3. Obtener estructura registrada
                const estructura = obtenerEstructuraRegistrada(lob, mesReciente, usuario);
                if (!estructura || !estructura.encontrado) {
                    console.log(`   ‚ùå No se encontr√≥ estructura para ${lob} - ${mesReciente}`);
                    continue;
                }
                // 4. Obtener configuraci√≥n (salario y %)
                const config = obtenerConfiguracionPorMesYLob(mesReciente, lob);
                const salario = config.success ? parseFloat(config.configuracion.salarioBase) : 0;
                const porcentaje = config.success ? parseFloat(config.configuracion.porcentajeBono) : 0;
                if (!salario || !porcentaje) {
                    console.log(`   ‚ö†Ô∏è Sin configuraci√≥n salarial para ${lob}`);
                    continue;
                }
                // 5. Contar agentes
                const hc = contarAgentesPorLob(lob) || 0;
                if (hc === 0) {
                    console.log(`   ‚ö†Ô∏è No hay agentes en ${lob}`);
                    continue;
                }
                const bonoMaximo = (salario * porcentaje) / 100;
                // 6. Calcular totales de Bonus y Additional
                let totalBonus = 0;
                let totalAdditional = 0;
                if (estructura.kpis && estructura.kpis.bonusStructure) {
                    estructura.kpis.bonusStructure.forEach(kpi => {
                        const pct = parseFloat(kpi.porcentaje) || 0;
                        totalBonus += (bonoMaximo * pct) / 100;
                    });
                }
                if (estructura.kpis && estructura.kpis.additionalIncentives) {
                    estructura.kpis.additionalIncentives.forEach(kpi => {
                        const pct = parseFloat(kpi.porcentaje) || 0;
                        totalAdditional += (bonoMaximo * pct) / 100;
                    });
                }
                const totalPorAgente = totalBonus + totalAdditional;
                const totalLOB = totalPorAgente * hc;
                const eficiencia = bonoMaximo > 0 ? ((totalPorAgente / bonoMaximo) * 100) : 0;
                // 7. üî• GUARDAR EN MAP (una sola vez por LOB)
                resultadosMap.set(lob, {
                    lob: lob,
                    mes: mesReciente,
                    hc: hc,
                    salarioBase: salario,
                    porcentajeBono: porcentaje,
                    bonoMaximoPorAgente: bonoMaximo,
                    bonoPorAgente: totalPorAgente,
                    totalBonus: totalBonus * hc,
                    totalAdditional: totalAdditional * hc,
                    totalLOB: totalLOB,
                    eficiencia: eficiencia.toFixed(1) + '%'
                });
                totalAgentesGeneral += hc;
                totalBonoMaximo += (bonoMaximo * hc);
                console.log(`   ‚úÖ ${lob}: ${hc} agentes, Total: $${totalLOB.toFixed(2)}, Eficiencia: ${eficiencia.toFixed(1)}%`);
            } catch (errorLOB) {
                console.error(`   ‚ùå Error procesando ${lob}:`, errorLOB);
                continue;
            }
        }
        // üî• CONVERTIR MAP A ARRAY (sin duplicados)
        const resultados = Array.from(resultadosMap.values());
        const totalGeneral = resultados.reduce((sum, lob) => sum + lob.totalLOB, 0);
        console.log(`\n‚úÖ Simulaci√≥n MASIVA completada:`);
        console.log(`   ‚Ä¢ LOBs √öNICAS procesadas: ${resultados.length}/${lobsDelOM.length}`);
        console.log(`   ‚Ä¢ Total agentes: ${totalAgentesGeneral}`);
        console.log(`   ‚Ä¢ Inversi√≥n total: $${totalGeneral.toFixed(2)}`);
        return {
            success: true,
            om: nombreOM,
            totalLOBs: lobsDelOM.length,
            lobsProcesadas: resultados.length,
            resultados: resultados.sort((a, b) => b.totalLOB - a.totalLOB),
            resumen: {
                totalAgentes: totalAgentesGeneral,
                inversionTotal: totalGeneral,
                bonoMaximoTotal: totalBonoMaximo,
                promedioPorAgente: totalAgentesGeneral > 0 ? totalGeneral / totalAgentesGeneral : 0,
                promedioPorLOB: resultados.length > 0 ? totalGeneral / resultados.length : 0
            },
            fechaSimulacion: new Date().toISOString()
        };
    } catch (error) {
        console.error('‚ùå Error en simularTodasLOBsPorOM:', error);
        console.error(error.stack);
        return { success: false, error: error.toString() };
    }
}
function simularTodasLOBsPorOMConPVE(nombreOM, pveTotal, porcPVE) {
    try {
        const sim = simularTodasLOBsPorOM(nombreOM);
        if (!sim.success) return sim;
        const presupuestoGlobal = (pveTotal * porcPVE) / 100;
        // Enriquecer con PVE
        sim.resultados.forEach(r => {
            // Comparar con PVE Global
            r.pctDelPVEGlobal = presupuestoGlobal > 0 ? (r.totalLOB / presupuestoGlobal * 100) : 0;
            // Comparar con PVE Local (si existe)
            if (r.pvePresupuesto > 0) {
                r.diferenciaLocal = r.pvePresupuesto - r.totalLOB;
                r.statusLocal = r.totalLOB > r.pvePresupuesto ? 'Excede' : 'OK';
            } else {
                r.statusLocal = 'N/A';
            }
        });
        sim.pveConfig = { pveTotal, porcPVE, presupuestoGlobal };
        sim.estadoPresupuesto = {
            inversionTotal: sim.resumen.inversionTotal,
            diferenciaGlobal: presupuestoGlobal - sim.resumen.inversionTotal,
            statusGlobal: sim.resumen.inversionTotal > presupuestoGlobal ? 'Excede' : 'OK'
        };
        return sim;
    } catch (e) {
        return { success: false, error: e.toString() };
    }
}
// ============================================================
// üí∞ FUNCI√ìN CORREGIDA: SIMULAR CON PVE GENERAL
// ============================================================
function simularTodasLOBsPorOMConPVE(nombreOM, pveTotal, porcPVE) {
    try {
        console.log(`üöÄ Iniciando simulaci√≥n MASIVA con PVE para OM: ${nombreOM}`);
        console.log(`üí∞ PVE Total: ${pveTotal}, % PVE: ${porcPVE}%`);
        
        // üî• CALCULAR PRESUPUESTO DISPONIBLE
        const presupuestoDisponible = (pveTotal * porcPVE) / 100;
        
        // Primero obtener la simulaci√≥n b√°sica
        const simulacionBasica = simularTodasLOBsPorOM(nombreOM);
        
        if (!simulacionBasica.success) {
            return simulacionBasica;
        }
        
        // Agregar datos de PVE a los resultados
        const resultadosConPVE = simulacionBasica.resultados.map(lob => {
            const pctDelPVE = presupuestoDisponible > 0 
                ? (lob.totalLOB / presupuestoDisponible * 100)
                : 0;
            
            return {
                ...lob,
                pctDelPVE: parseFloat(pctDelPVE.toFixed(2))
            };
        });
        
        // üî• CALCULAR ESTADO DEL PRESUPUESTO
        const totalInversion = simulacionBasica.resumen.inversionTotal;
        const pctUsadoDelPVE = presupuestoDisponible > 0 
            ? (totalInversion / presupuestoDisponible * 100)
            : 0;
        
        let estadoPresupuesto = '‚úÖ DENTRO DEL PRESUPUESTO';
        let colorEstado = '#27ae60';
        
        if (pctUsadoDelPVE > 100) {
            estadoPresupuesto = '‚ùå EXCEDE EL PRESUPUESTO';
            colorEstado = '#e74c3c';
        } else if (pctUsadoDelPVE > 90) {
            estadoPresupuesto = '‚ö†Ô∏è CERCA DEL L√çMITE';
            colorEstado = '#f39c12';
        } else if (pctUsadoDelPVE < 70) {
            estadoPresupuesto = 'üìà POR DEBAJO (OPORTUNIDAD)';
            colorEstado = '#3498db';
        }
        
        console.log(`\nüí∞ An√°lisis PVE:`);
        console.log(`   ‚Ä¢ Presupuesto disponible: $${presupuestoDisponible.toFixed(2)}`);
        console.log(`   ‚Ä¢ Inversi√≥n total: $${totalInversion.toFixed(2)}`);
        console.log(`   ‚Ä¢ % usado del PVE: ${pctUsadoDelPVE.toFixed(1)}% - ${estadoPresupuesto}`);
        
        return {
            ...simulacionBasica,
            pveConfig: {
                pveTotal: pveTotal,
                porcPVE: porcPVE,
                presupuestoDisponible: presupuestoDisponible
            },
            estadoPresupuesto: {
                texto: estadoPresupuesto,
                color: colorEstado,
                pctUsado: parseFloat(pctUsadoDelPVE.toFixed(1)),
                inversionTotal: totalInversion,
                diferencia: presupuestoDisponible - totalInversion
            },
            resultados: resultadosConPVE.sort((a, b) => b.pctDelPVE - a.pctDelPVE)
        };
        
    } catch (error) {
        console.error('‚ùå Error en simularTodasLOBsPorOMConPVE:', error);
        return { success: false, error: error.toString() };
    }
}

function obtenerLobsPorRegion(region) {
    try {
        console.log('üåé Obteniendo LOBs para regi√≥n:', region);
        
        const ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        const hojaHC = ss.getSheetByName('H_C');
        
        if (!hojaHC) {
            console.error('‚ùå Hoja H_C no encontrada');
            return [];
        }
        
        const dataHC = hojaHC.getDataRange().getValues();
        
        const normalizar = s => s ? s.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : "";
        const regionNorm = normalizar(region);
        
        // 1. Obtener LOBs de la regi√≥n desde H_C
        const lobsEnRegion = new Set();
        
        for (let i = 1; i < dataHC.length; i++) {
            const regionFila = normalizar(String(dataHC[i][8] || '')); // Columna I
            const lobFila = String(dataHC[i][1] || '').trim(); // Columna B
            
            if (regionFila === regionNorm && lobFila) {
                lobsEnRegion.add(lobFila);
            }
        }
        
        console.log('üìã LOBs en H_C para ' + region + ': ' + lobsEnRegion.size);
        
        if (lobsEnRegion.size === 0) {
            return [];
        }
        
        // 2. Obtener LOBs con registros
        const hojaRegistro = ss.getSheetByName('Registro');
        const hojaRegistroPisos = ss.getSheetByName('Registro_pisos');
        const lobsConRegistro = new Set();
        
        [hojaRegistro, hojaRegistroPisos].forEach(function(hoja) {
            if (!hoja) return;
            const data = hoja.getDataRange().getValues();
            for (let i = 1; i < data.length; i++) {
                const lob = String(data[i][1] || '').trim();
                if (lob) lobsConRegistro.add(lob);
            }
        });
        
        // 3. Intersecci√≥n
        const resultado = [];
        lobsEnRegion.forEach(function(lob) {
            var tieneRegistro = false;
            lobsConRegistro.forEach(function(lr) {
                if (normalizar(lr) === normalizar(lob)) {
                    tieneRegistro = true;
                }
            });
            if (tieneRegistro) {
                resultado.push(lob);
            }
        });
        
        console.log('‚úÖ LOBs finales para ' + region + ': ' + resultado.length);
        return resultado.sort();
        
    } catch (error) {
        console.error('‚ùå Error en obtenerLobsPorRegion:', error);
        return [];
    }
}

/**
 * Simula todas las LOBs de una regi√≥n (sin PVE)
 */

function simularTodasLOBsPorRegion(region) {
    try {
        console.log('üìä Simulando LOBs para regi√≥n: ' + region);
        
        const lobs = obtenerLobsPorRegion(region);
        
        if (!lobs || lobs.length === 0) {
            return { 
                success: false, 
                error: 'No se encontraron LOBs con registros para la regi√≥n: ' + region 
            };
        }
        
        console.log('üìã LOBs a procesar: ' + lobs.length);
        
        const resultados = [];
        let totalAgentes = 0;
        let inversionTotal = 0;
        
        lobs.forEach(function(lob) {
            try {
                console.log('\nüîç Procesando LOB: ' + lob);
                
                // 1. Obtener √∫ltima estructura
                const estructura = obtenerUltimaEstructuraParaSimulacion(lob);
                
                if (!estructura) {
                    console.log('   ‚ö†Ô∏è Sin estructura para: ' + lob);
                    return;
                }
                
                // 2. Obtener HC
                const hc = contarAgentesPorLob(lob) || 0;
                if (hc === 0) {
                    console.log('   ‚ö†Ô∏è Sin agentes en: ' + lob);
                    return;
                }
                
                // 3. Obtener salario y porcentaje
                const salario = parseFloat(estructura.salario) || 0;
                const porcentaje = parseFloat(estructura.porcentaje) || 0;
                
                if (salario === 0 || porcentaje === 0) {
                    console.log('   ‚ö†Ô∏è Sin config salarial para: ' + lob);
                    return;
                }
                
                const bonoMaximo = (salario * porcentaje) / 100;
                
                // 4. Calcular totales
                let totalBonus = 0;
                let totalAdditional = 0;
                let totalDecreased = 0;
                let bonusKPIs = 0;
                let additionalKPIs = 0;
                let decreasedKPIs = 0;
                
                if (estructura.kpis) {
                    // Bonus
                    if (estructura.kpis.bonusStructure && estructura.kpis.bonusStructure.length > 0) {
                        estructura.kpis.bonusStructure.forEach(function(kpi) {
                            var pct = parseFloat(kpi.porcentaje) || 0;
                            totalBonus += (bonoMaximo * pct) / 100;
                            bonusKPIs++;
                        });
                    }
                    
                    // Additional
                    if (estructura.kpis.additionalIncentives && estructura.kpis.additionalIncentives.length > 0) {
                        estructura.kpis.additionalIncentives.forEach(function(kpi) {
                            var pct = parseFloat(kpi.porcentaje) || 0;
                            totalAdditional += (bonoMaximo * pct) / 100;
                            additionalKPIs++;
                        });
                    }
                    
                    // Decreased
                    if (estructura.kpis.decreasedKPIs && estructura.kpis.decreasedKPIs.length > 0) {
                        estructura.kpis.decreasedKPIs.forEach(function(kpi) {
                            var pct = parseFloat(kpi.porcentaje) || 0;
                            totalDecreased += (bonoMaximo * pct) / 100;
                            decreasedKPIs++;
                        });
                    }
                }
                
                const totalLOB = (totalBonus + totalAdditional) * hc;
                const eficiencia = bonoMaximo > 0 ? ((totalBonus + totalAdditional) / bonoMaximo * 100) : 0;
                
                totalAgentes += hc;
                inversionTotal += totalLOB;
                
                console.log('   ‚úÖ ' + lob + ': HC=' + hc + ', Total=' + totalLOB.toFixed(2));
                
                resultados.push({
                    lob: lob,
                    mes: estructura.mes,
                    hc: hc,
                    salarioBase: salario,
                    porcentajeBono: porcentaje,
                    bonoMaximo: bonoMaximo,
                    totalBonus: totalBonus * hc,
                    totalAdditional: totalAdditional * hc,
                    totalDecreased: totalDecreased * hc,
                    totalLOB: totalLOB,
                    eficiencia: eficiencia.toFixed(2),
                    bonusKPIs: bonusKPIs,
                    additionalKPIs: additionalKPIs,
                    decreasedKPIs: decreasedKPIs
                });
                
            } catch (err) {
                console.error('   ‚ùå Error procesando ' + lob + ':', err);
            }
        });
        
        if (resultados.length === 0) {
            return {
                success: false,
                error: 'No se pudieron procesar las LOBs. Verifica que tengan configuraci√≥n de salario y registros.'
            };
        }
        
        console.log('\n‚úÖ Simulaci√≥n completada:');
        console.log('   ‚Ä¢ LOBs procesadas: ' + resultados.length);
        console.log('   ‚Ä¢ Total agentes: ' + totalAgentes);
        console.log('   ‚Ä¢ Inversi√≥n total: $' + inversionTotal.toFixed(2));
        
        return {
            success: true,
            region: region,
            om: region,
            lobsProcesadas: resultados.length,
            resultados: resultados.sort(function(a, b) { return b.totalLOB - a.totalLOB; }),
            resumen: {
                totalAgentes: totalAgentes,
                inversionTotal: inversionTotal,
                promedioPorAgente: totalAgentes > 0 ? inversionTotal / totalAgentes : 0
            }
        };
        
    } catch (error) {
        console.error('‚ùå Error en simularTodasLOBsPorRegion:', error);
        return { success: false, error: error.toString() };
    }
}



/**
 * Simula todas las LOBs de una regi√≥n CON an√°lisis PVE
 */


function simularTodasLOBsPorRegionConPVE(region, pveTotal, porcPVE) {
    try {
        console.log('üìä Simulando con PVE - Regi√≥n: ' + region);
        console.log('   PVE Total: ' + pveTotal + ', %: ' + porcPVE);
        
        var resultado = simularTodasLOBsPorRegion(region);
        
        if (!resultado.success) return resultado;
        
        var presupuestoDisponible = (pveTotal * porcPVE) / 100;
        var inversionTotal = resultado.resumen.inversionTotal;
        var diferencia = presupuestoDisponible - inversionTotal;
        var pctUsado = presupuestoDisponible > 0 ? (inversionTotal / presupuestoDisponible * 100) : 0;
        
        // Agregar % del PVE a cada LOB
        resultado.resultados.forEach(function(lob) {
            lob.pctDelPVE = presupuestoDisponible > 0 ? 
                parseFloat((lob.totalLOB / presupuestoDisponible * 100).toFixed(2)) : 0;
        });
        
        resultado.pveConfig = {
            pveTotal: pveTotal,
            porcPVE: porcPVE,
            presupuestoDisponible: presupuestoDisponible
        };
        
        resultado.estadoPresupuesto = {
            inversionTotal: inversionTotal,
            presupuestoDisponible: presupuestoDisponible,
            diferencia: diferencia,
            pctUsado: parseFloat(pctUsado.toFixed(2)),
            texto: diferencia >= 0 ? 'DENTRO DEL PRESUPUESTO' : 'EXCEDE PRESUPUESTO',
            color: diferencia >= 0 ? '#27ae60' : '#e74c3c'
        };
        
        console.log('üí∞ Estado PVE: ' + resultado.estadoPresupuesto.texto);
        console.log('   Presupuesto: $' + presupuestoDisponible.toFixed(2));
        console.log('   Inversi√≥n: $' + inversionTotal.toFixed(2));
        console.log('   % Usado: ' + pctUsado.toFixed(2) + '%');
        
        return resultado;
        
    } catch (error) {
        console.error('‚ùå Error en simularTodasLOBsPorRegionConPVE:', error);
        return { success: false, error: error.toString() };
    }
}


function obtenerUltimaEstructura(lob) {
    try {
        const ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        const hojas = ['Registro', 'Registro_pisos'];
        
        let ultimaEstructura = null;
        let ultimoMesIdx = -1;
        
        const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                       'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        
        hojas.forEach(nombreHoja => {
            const hoja = ss.getSheetByName(nombreHoja);
            if (!hoja) return;
            
            const data = hoja.getDataRange().getValues();
            
            for (let i = 1; i < data.length; i++) {
                const lobFila = String(data[i][1] || '').trim();
                const mesFila = String(data[i][0] || '').trim();
                
                if (lobFila.toLowerCase() === lob.toLowerCase()) {
                    const mesIdx = meses.indexOf(mesFila);
                    if (mesIdx > ultimoMesIdx) {
                        ultimoMesIdx = mesIdx;
                        ultimaEstructura = {
                            mes: mesFila,
                            lob: lobFila,
                            salario: data[i][7] || 0, // Ajusta seg√∫n tu hoja
                            porcentaje: data[i][8] || 0,
                            kpis: extraerKPIsDeFilaRegistro(data[i], nombreHoja)
                        };
                    }
                }
            }
        });
        
        return ultimaEstructura;
        
    } catch (error) {
        console.error('Error en obtenerUltimaEstructura:', error);
        return null;
    }
}



function obtenerUltimaEstructuraParaSimulacion(lob) {
    try {
        var ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        var hojas = ['Registro', 'Registro_pisos'];
        
        var ultimaEstructura = null;
        var ultimoMesIdx = -1;
        
        var meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                     'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        
        var normalizar = function(s) { 
            return s ? s.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : ""; 
        };
        var lobNorm = normalizar(lob);
        
        hojas.forEach(function(nombreHoja) {
            var hoja = ss.getSheetByName(nombreHoja);
            if (!hoja) return;
            
            var data = hoja.getDataRange().getValues();
            
            for (var i = 1; i < data.length; i++) {
                var lobFila = normalizar(String(data[i][1] || ''));
                var mesFila = String(data[i][0] || '').trim();
                
                if (lobFila === lobNorm) {
                    var mesIdx = meses.indexOf(mesFila);
                    if (mesIdx > ultimoMesIdx) {
                        ultimoMesIdx = mesIdx;
                        
                        // Obtener salario desde Configuracion
                        var salario = 0;
                        var porcentaje = 0;
                        
                        try {
                            var config = obtenerSalarioPorLob(lob);
                            if (config && config.encontrado) {
                                salario = parseFloat(config.salario) || 0;
                                porcentaje = parseFloat(config.porcentaje) || 0;
                            }
                        } catch (e) {
                            console.log('‚ö†Ô∏è No se pudo obtener config para ' + lob);
                        }
                        
                        // Extraer KPIs
                        var kpis = {
                            keys: [],
                            bonusStructure: [],
                            additionalIncentives: [],
                            decreasedKPIs: []
                        };
                        
                        if (nombreHoja === 'Registro') {
                            // BONUS: K-V (columnas 10-21)
                            for (var col = 10; col <= 21; col += 3) {
                                var kpiNombre = String(data[i][col] || '').trim();
                                if (kpiNombre) {
                                    kpis.bonusStructure.push({
                                        nombre: kpiNombre,
                                        score: String(data[i][col + 1] || ''),
                                        porcentaje: String(data[i][col + 2] || '')
                                    });
                                }
                            }
                            
                            // ADDITIONAL: X-AF (columnas 23-31)
                            for (var col = 23; col <= 31; col += 3) {
                                var kpiNombre = String(data[i][col] || '').trim();
                                if (kpiNombre) {
                                    kpis.additionalIncentives.push({
                                        nombre: kpiNombre,
                                        score: String(data[i][col + 1] || ''),
                                        porcentaje: String(data[i][col + 2] || '')
                                    });
                                }
                            }
                            
                            // DECREASED: AH-AM (columnas 33-38)
                            for (var col = 33; col <= 38; col += 3) {
                                var kpiNombre = String(data[i][col] || '').trim();
                                if (kpiNombre) {
                                    kpis.decreasedKPIs.push({
                                        nombre: kpiNombre,
                                        score: String(data[i][col + 1] || ''),
                                        porcentaje: String(data[i][col + 2] || '')
                                    });
                                }
                            }
                            
                        } else if (nombreHoja === 'Registro_pisos') {
                            // BONUS: M-AY (columnas 12-50)
                            for (var col = 12; col <= 50; col += 3) {
                                var kpiNombre = String(data[i][col] || '').trim();
                                if (kpiNombre && kpiNombre !== 'Bonus Structure') {
                                    kpis.bonusStructure.push({
                                        nombre: kpiNombre,
                                        score: String(data[i][col + 1] || ''),
                                        porcentaje: String(data[i][col + 2] || '')
                                    });
                                }
                            }
                            
                            // ADDITIONAL: BA-BI (columnas 52-60)
                            for (var col = 52; col <= 60; col += 3) {
                                var kpiNombre = String(data[i][col] || '').trim();
                                if (kpiNombre && kpiNombre !== 'Additional Incentive') {
                                    kpis.additionalIncentives.push({
                                        nombre: kpiNombre,
                                        score: String(data[i][col + 1] || ''),
                                        porcentaje: String(data[i][col + 2] || '')
                                    });
                                }
                            }
                            
                            // DECREASED: BK-BV (columnas 62-73)
                            for (var col = 62; col <= 73; col += 3) {
                                var kpiNombre = String(data[i][col] || '').trim();
                                if (kpiNombre && kpiNombre !== 'Decreased') {
                                    kpis.decreasedKPIs.push({
                                        nombre: kpiNombre,
                                        score: String(data[i][col + 1] || ''),
                                        porcentaje: String(data[i][col + 2] || '')
                                    });
                                }
                            }
                        }
                        
                        ultimaEstructura = {
                            mes: mesFila,
                            lob: String(data[i][1] || '').trim(),
                            tipoHoja: nombreHoja,
                            salario: salario,
                            porcentaje: porcentaje,
                            kpis: kpis
                        };
                    }
                }
            }
        });
        
        return ultimaEstructura;
        
    } catch (error) {
        console.error('‚ùå Error en obtenerUltimaEstructuraParaSimulacion:', error);
        return null;
    }
}
// ============================================================
// üì• EXPORTAR SIMULACI√ìN A EXCEL
// ============================================================
function exportarSimulacionAExcel(datos) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const nombreHoja = 'Exportacion_Simulacion_' + new Date().toISOString().slice(0,10);
    
    // Crear nueva hoja o usar existente
    let hoja = ss.getSheetByName(nombreHoja);
    if (!hoja) {
      hoja = ss.insertSheet(nombreHoja);
    } else {
      hoja.clear();
    }
    
    // Escribir encabezados
    if (datos.encabezados && datos.encabezados.length > 0) {
      hoja.getRange(1, 1, 1, datos.encabezados.length).setValues([datos.encabezados]);
      hoja.getRange(1, 1, 1, datos.encabezados.length)
        .setBackground('#667eea')
        .setFontColor('white')
        .setFontWeight('bold');
    }
    
    // Escribir datos
    if (datos.filas && datos.filas.length > 0) {
      hoja.getRange(2, 1, datos.filas.length, datos.filas[0].length).setValues(datos.filas);
    }
    
    // Escribir resumen al final
    if (datos.resumen && datos.resumen.length > 0) {
      const filaResumen = datos.filas.length + 4;
      hoja.getRange(filaResumen, 1).setValue('üìä RESUMEN').setFontWeight('bold');
      datos.resumen.forEach((item, idx) => {
        hoja.getRange(filaResumen + 1 + idx, 1).setValue(item[0]);
        hoja.getRange(filaResumen + 1 + idx, 2).setValue(item[1]);
      });
    }
    
    // Autoajustar columnas
    hoja.autoResizeColumns(1, datos.encabezados.length);
    
    // Devolver URL del spreadsheet
    return ss.getUrl() + '#gid=' + hoja.getSheetId();
    
  } catch (error) {
    console.error('Error exportando a Excel:', error);
    return null;
  }
}




// ============================================================
// üìß ENVIAR REPORTE DE SIMULACI√ìN POR CORREO
// ============================================================
function enviarReporteSimulacionPorCorreo(datos) {
  try {
    const { destinatarios, asunto, mensaje, simulacion } = datos;
    
    if (!destinatarios || destinatarios.length === 0) {
      return { success: false, error: 'No hay destinatarios' };
    }
    
    // Construir cuerpo del correo en HTML
    let htmlBody = `
    <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; text-align: center; color: white;">
        <h1>üìä Reporte de Simulaci√≥n de Bonos</h1>
      </div>
      
      <div style="padding: 20px;">
        ${mensaje ? `<p style="color: #666; margin-bottom: 20px;">${mensaje}</p>` : ''}
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #2c3e50; margin-bottom: 10px;">üìã Resumen General</h3>
          <table style="width: 100%;">
            <tr><td><strong>Regi√≥n/OM:</strong></td><td>${simulacion.region}</td></tr>
            <tr><td><strong>LOBs Procesadas:</strong></td><td>${simulacion.lobsProcesadas}</td></tr>
            <tr><td><strong>Total Agentes:</strong></td><td>${simulacion.totalAgentes}</td></tr>
            <tr><td><strong>Inversi√≥n Total:</strong></td><td>$${Number(simulacion.inversionTotal).toLocaleString()}</td></tr>
          </table>
        </div>
        
        <h3 style="color: #2c3e50;">üìä Detalle por LOB</h3>
        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
          <thead>
            <tr style="background: #667eea; color: white;">
              <th style="padding: 10px; text-align: left;">LOB</th>
              <th style="padding: 10px; text-align: center;">HC</th>
              <th style="padding: 10px; text-align: right;">Total</th>
              <th style="padding: 10px; text-align: center;">Eficiencia</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    simulacion.resultados.forEach((r, i) => {
      const bgColor = i % 2 === 0 ? '#ffffff' : '#f8f9fa';
      htmlBody += `
        <tr style="background: ${bgColor};">
          <td style="padding: 8px; border-bottom: 1px solid #eee;">${r.lob}</td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid #eee;">${r.hc}</td>
          <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">$${Number(r.totalLOB).toLocaleString()}</td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid #eee;">${r.eficiencia}%</td>
        </tr>
      `;
    });
    
    htmlBody += `
          </tbody>
        </table>
        
        <div style="margin-top: 30px; padding: 15px; background: #e8f5e9; border-radius: 8px; text-align: center;">
          <p style="margin: 0; color: #27ae60;">
            ‚úÖ Reporte generado el ${new Date().toLocaleDateString()} a las ${new Date().toLocaleTimeString()}
          </p>
        </div>
      </div>
      
      <div style="background: #2c3e50; padding: 15px; text-align: center; color: white; font-size: 12px;">
        <p>Este correo fue enviado autom√°ticamente desde el Sistema de Simulaci√≥n de Bonos</p>
      </div>
    </div>
    `;
    
    // Enviar correo a todos los destinatarios
    destinatarios.forEach(email => {
      MailApp.sendEmail({
        to: email,
        subject: asunto,
        htmlBody: htmlBody
      });
    });
    
    console.log('Correo enviado a:', destinatarios.join(', '));
    return { success: true, enviados: destinatarios.length };
    
  } catch (error) {
    console.error('Error enviando correo:', error);
    return { success: false, error: error.message };
  }
}