// ========================================
// FUNCI√ìN BACKEND: GUARDAR APROBACIONES (COMPLETA)
// Busca autom√°ticamente las hojas y guarda en Audit + Historico_MAX
// ========================================
function guardarAprobaciones(aprobaciones) {
  try {
    console.log('üöÄ Iniciando guardarAprobaciones...');
    console.log(`üì• Total aprobaciones recibidas: ${aprobaciones.length}`);
    
    // ========================================
    // ‚≠ê BUSCAR HOJAS AUTOM√ÅTICAMENTE EN M√öLTIPLES ARCHIVOS
    // ========================================
    let ss = null;
    let hojaAudit = null;
    let hojaHC = null;
    let ssCDM = null;
    
    // 1. Intentar en archivo ACTIVO
    console.log('üîç Buscando hojas en archivo activo...');
    const ssActivo = SpreadsheetApp.getActiveSpreadsheet();
    hojaAudit = ssActivo.getSheetByName('Audit');
    hojaHC = ssActivo.getSheetByName('H_C');
    
    if (hojaAudit && hojaHC) {
      console.log('‚úÖ Audit y H_C encontradas en archivo ACTIVO');
      ss = ssActivo;
    } else {
      // 2. Intentar en archivo PRINCIPAL (1nzX...)
      console.log('üîç Buscando en archivo principal...');
      try {
        ss = SpreadsheetApp.openById('1nzXCGsp8emRdDXphPWU75Ms5c_GfXiC7_TMODBS2ed4');
        hojaAudit = ss.getSheetByName('Audit');
        hojaHC = ss.getSheetByName('H_C');
        
        if (hojaAudit && hojaHC) {
          console.log('‚úÖ Audit y H_C encontradas en archivo PRINCIPAL');
        }
      } catch (e) {
        console.log('‚ö†Ô∏è No se pudo acceder al archivo principal: ' + e.toString());
      }
    }
    
    // 3. Si no se encontraron, intentar en archivo CDM
    if (!hojaAudit || !hojaHC) {
      console.log('üîç Buscando en archivo CDM...');
      try {
        const ssCDMTemp = SpreadsheetApp.openById('1PtYuAb5C2kIoX8sE7dOvt1nVS-aLamZLOJQUSbTBBCw');
        hojaAudit = ssCDMTemp.getSheetByName('Audit');
        hojaHC = ssCDMTemp.getSheetByName('H_C');
        
        if (hojaAudit && hojaHC) {
          console.log('‚úÖ Audit y H_C encontradas en archivo CDM');
          ss = ssCDMTemp;
        }
      } catch (e) {
        console.log('‚ö†Ô∏è No se pudo acceder al archivo CDM: ' + e.toString());
      }
    }
    
    // 4. Validar que se encontraron las hojas
    if (!hojaAudit) {
      return { success: false, error: 'No se encontr√≥ la hoja "Audit" en ning√∫n archivo' };
    }
    
    if (!hojaHC) {
      return { success: false, error: 'No se encontr√≥ la hoja "H_C" en ning√∫n archivo' };
    }
    
    // 5. Abrir archivo CDM para Historico_MAX
    console.log('üîç Abriendo archivo CDM para Historico_MAX...');
    try {
      ssCDM = SpreadsheetApp.openById('1PtYuAb5C2kIoX8sE7dOvt1nVS-aLamZLOJQUSbTBBCw');
      console.log('‚úÖ Archivo CDM abierto correctamente');
    } catch (e) {
      console.log('‚ö†Ô∏è Error al abrir archivo CDM: ' + e.toString());
      ssCDM = ss; // Usar el mismo archivo si falla
    }

    console.log('üìã Guardando aprobaciones en Audit y Historico_MAX');
    
    // ========================================
    // ‚≠ê DEBUG: VER DATOS RECIBIDOS
    // ========================================
    aprobaciones.forEach((ap, index) => {
      console.log(`   ${index + 1}. BMS: ${ap.bmsId}, Mes: "${ap.mes}", Total: $${ap.total}`);
      if (ap.desglose) {
        console.log(`      Desglose - Keys: $${ap.desglose.keys}, Bonus: $${ap.desglose.bonusStructure}, Additional: $${ap.desglose.additionalIncentives}, Decreased: $${ap.desglose.decreasedKPIs}`);
      }
    });

    // ========================================
    // ‚≠ê CREAR HEADER EN AUDIT SI NO EXISTE
    // ========================================
    if (hojaAudit.getLastRow() === 0) {
      console.log('üìù Creando headers en Audit...');
      hojaAudit.appendRow([
        'BMS ID',              // A
        'Nombre Agente',       // B
        'LOB',                 // C
        'Role',                // D
        'Supervisor',          // E
        'ACCM',                // F
        'OM',                  // G
        'Director',            // H
        'Bono Aprobado',       // I
        'Fecha Aprobaci√≥n',    // J
        'Usuario Aprobador',   // K
        'Correo Aprobador',    // L
        'Fecha KPI',           // M
        'Mes CDM',             // N
        'Estado'               // O
      ]);
      
      const headerRange = hojaAudit.getRange(1, 1, 1, 15);
      headerRange.setBackground('#28a745');
      headerRange.setFontColor('#FFFFFF');
      headerRange.setFontWeight('bold');
      headerRange.setHorizontalAlignment('center');
      headerRange.setWrap(true);
      console.log('‚úÖ Headers creados en Audit');
    }

    // ========================================
    // ‚≠ê OBTENER DATOS DEL USUARIO APROBADOR
    // ========================================
    const usuario = Session.getActiveUser().getEmail();
    const nombreUsuario = obtenerNombreUsuario(usuario);
    const fechaAprobacion = new Date();

    // ========================================
    // ‚≠ê CARGAR TODOS LOS DATOS DE H_C EN MEMORIA
    // ========================================
    const dataHC = hojaHC.getDataRange().getValues();
    const datosHCMap = {};

    console.log('üìä Cargando datos de H_C...');

    for (let i = 1; i < dataHC.length; i++) {
      const bmsId = String(dataHC[i][0]).trim();
      
      if (bmsId) {
        datosHCMap[bmsId] = {
          lob: String(dataHC[i][1] || '').trim(),
          nombre: String(dataHC[i][2] || '').trim(),
          director: String(dataHC[i][3] || '').trim(),
          supervisor: String(dataHC[i][4] || '').trim(),
          accm: String(dataHC[i][5] || '').trim(),
          om: String(dataHC[i][6] || '').trim(),
          role: String(dataHC[i][7] || '').trim()
        };
      }
    }

    console.log(`üìä Total agentes cargados de H_C: ${Object.keys(datosHCMap).length}`);

    // ========================================
    // ‚≠ê AGRUPAR DATOS POR LOB Y MES PARA HISTORICO_MAX
    // ========================================
    const datosPorLobYMes = {};

    // ========================================
    // ‚≠ê INSERTAR CADA APROBACI√ìN EN AUDIT
    // ========================================
    let registrosGuardados = 0;
    let errores = [];

    aprobaciones.forEach(function(aprobacion) {
      const bmsId = String(aprobacion.bmsId).trim();
      const datosHC = datosHCMap[bmsId];
      
      if (!datosHC) {
        console.log(`‚ö†Ô∏è BMS ${bmsId} no encontrado en H_C`);
        errores.push(`BMS ${bmsId} no encontrado en H_C`);
        return;
      }

      // Validar LOB
      if (datosHC.lob !== aprobacion.lob) {
        console.log(`‚ö†Ô∏è BMS ${bmsId}: LOB no coincide. H_C: "${datosHC.lob}" vs Aprobaci√≥n: "${aprobacion.lob}"`);
      }

      // ‚≠ê USAR EL MES QUE VIENE DEL FRONTEND DIRECTAMENTE
      const nombreMes = aprobacion.mes || 'General';
      const numeroMes = obtenerNumeroMesDesdeNombre(aprobacion.mes);
      
      console.log(`üìÖ Para agente ${bmsId}:`);
      console.log(`   Mes desde frontend: "${aprobacion.mes}"`);
      console.log(`   Nombre Mes: "${nombreMes}"`);
      console.log(`   N√∫mero Mes: ${numeroMes}`);
      
      const claveLobMes = `${datosHC.lob}_${nombreMes}`;

      if (!datosPorLobYMes[claveLobMes]) {
        datosPorLobYMes[claveLobMes] = {
          lob: datosHC.lob,
          om: datosHC.om,
          mes: nombreMes,
          numeroMes: numeroMes,
          fechaRegistro: aprobacion.fecha,
          totalBonos: 0,
          agentesUnicos: new Set(),
          desglose: {
            keys: 0,
            bonusStructure: 0,
            additionalIncentives: 0,
            decreasedKPIs: 0
          }
        };
        
        console.log(`‚úÖ Nuevo registro creado para: ${claveLobMes}`);
      }

      // ========================================
      // GUARDAR EN AUDIT
      // ========================================
      const fila = [
        bmsId,
        datosHC.nombre,
        datosHC.lob,
        datosHC.role,
        datosHC.supervisor,
        datosHC.accm,
        datosHC.om,
        datosHC.director,
        aprobacion.total,
        fechaAprobacion,
        nombreUsuario,
        usuario,
        aprobacion.fecha,
        aprobacion.mes,
        'APROBADO'
      ];
      
      hojaAudit.appendRow(fila);
      registrosGuardados++;

      // ========================================
      // ‚≠ê ACUMULAR DATOS PARA HISTORICO_MAX CON DESGLOSE
      // ========================================
      datosPorLobYMes[claveLobMes].totalBonos += aprobacion.total;
      datosPorLobYMes[claveLobMes].agentesUnicos.add(bmsId);
      
      // ‚≠ê USAR DESGLOSE DEL FRONTEND SI EXISTE
      if (aprobacion.desglose) {
        datosPorLobYMes[claveLobMes].desglose.keys += aprobacion.desglose.keys || 0;
        datosPorLobYMes[claveLobMes].desglose.bonusStructure += aprobacion.desglose.bonusStructure || 0;
        datosPorLobYMes[claveLobMes].desglose.additionalIncentives += aprobacion.desglose.additionalIncentives || 0;
        datosPorLobYMes[claveLobMes].desglose.decreasedKPIs += aprobacion.desglose.decreasedKPIs || 0;
        
        console.log(`üí∞ Sumando desglose para ${claveLobMes}:`, aprobacion.desglose);
      } else {
        // Si no hay desglose, sumar todo a bonusStructure (fallback)
        datosPorLobYMes[claveLobMes].desglose.bonusStructure += aprobacion.total;
        console.log(`üí∞ Sin desglose, sumando $${aprobacion.total} a bonusStructure`);
      }
    });

    // ========================================
    // ‚≠ê DEBUG: VER DATOS AGRUPADOS PARA HISTORICO_MAX
    // ========================================
    console.log('üìä Datos agrupados para Historico_MAX:');
    Object.keys(datosPorLobYMes).forEach(clave => {
      const dato = datosPorLobYMes[clave];
      console.log(`   ${clave}:`);
      console.log(`      Total: $${dato.totalBonos}`);
      console.log(`      Agentes: ${dato.agentesUnicos.size}`);
      console.log(`      Desglose:`, dato.desglose);
    });

    // ========================================
    // ‚≠ê FORMATEAR DATOS EN AUDIT
    // ========================================
    const lastRow = hojaAudit.getLastRow();
    const startRow = lastRow - registrosGuardados + 1;

    if (registrosGuardados > 0) {
      const dataRange = hojaAudit.getRange(startRow, 1, registrosGuardados, 15);
      
      // Formato de fecha de aprobaci√≥n (columna J)
      hojaAudit.getRange(startRow, 10, registrosGuardados, 1).setNumberFormat('dd/mm/yyyy hh:mm:ss');
      
      // Formato de bono (columna I)
      hojaAudit.getRange(startRow, 9, registrosGuardados, 1).setNumberFormat('$#,##0.00');
      
      // Bordes
      dataRange.setBorder(true, true, true, true, true, true);
      
      // Alternar colores de filas
      for (let i = 0; i < registrosGuardados; i++) {
        const rowNumber = startRow + i;
        const bgColor = i % 2 === 0 ? '#f8f9fa' : '#ffffff';
        hojaAudit.getRange(rowNumber, 1, 1, 15).setBackground(bgColor);
      }
      
      // Resaltar estado APROBADO (columna O)
      hojaAudit.getRange(startRow, 15, registrosGuardados, 1)
        .setBackground('#d4edda')
        .setFontColor('#155724')
        .setFontWeight('bold')
        .setHorizontalAlignment('center');
    }

    console.log(`‚úÖ Se guardaron ${registrosGuardados} aprobaciones en Audit`);

    // ========================================
    // ‚≠ê GUARDAR EN HISTORICO_MAX
    // ========================================
    let resultadoHistorico = { success: false };
    
    if (Object.keys(datosPorLobYMes).length > 0) {
      console.log(`üìä Guardando en Historico_MAX: ${Object.keys(datosPorLobYMes).length} LOB-Mes combinaciones`);
      
      // Convertir Set a n√∫mero
      const datosParaHistorico = Object.values(datosPorLobYMes).map(dato => ({
        ...dato,
        agentes: dato.agentesUnicos.size,
        agentesUnicos: undefined // Eliminar el Set
      }));

      console.log('üöÄ Llamando a guardarEnHistoricoMax...');
      resultadoHistorico = guardarEnHistoricoMax(datosParaHistorico, ssCDM);
      console.log('üìã Resultado de guardarEnHistoricoMax:', resultadoHistorico);
      
      if (resultadoHistorico.success) {
        console.log('‚úÖ Datos guardados exitosamente en Historico_MAX');
      } else {
        console.log('‚ö†Ô∏è Error al guardar en Historico_MAX: ' + resultadoHistorico.error);
      }
    }

    // ========================================
    // ‚≠ê RESULTADO
    // ========================================
    if (errores.length > 0) {
      console.log(`‚ö†Ô∏è Errores encontrados: ${errores.length}`);
      errores.forEach(err => console.log(`   - ${err}`));
    }

    return {
      success: true,
      count: registrosGuardados,
      mensaje: `${registrosGuardados} agente(s) aprobado(s) exitosamente`,
      errores: errores.length > 0 ? errores : null,
      historicoGuardado: resultadoHistorico.success,
      historicoMensaje: resultadoHistorico.mensaje || resultadoHistorico.error
    };
    
  } catch (error) {
    console.log('‚ùå Error en guardarAprobaciones: ' + error.toString());
    console.log('Stack trace: ' + error.stack);
    return {
      success: false,
      error: error.toString()
    };
  }
}

// ========================================
// FUNCIONES AUXILIARES
// ========================================
function obtenerNumeroMesDesdeNombre(nombreMes) {
  if (!nombreMes) return 0;
  
  const mesesMap = {
    'enero': 1, 'febrero': 2, 'marzo': 3, 'abril': 4,
    'mayo': 5, 'junio': 6, 'julio': 7, 'agosto': 8,
    'septiembre': 9, 'octubre': 10, 'noviembre': 11, 'diciembre': 12
  };
  
  const nombreLower = nombreMes.toString().toLowerCase().trim();
  
  for (const mes in mesesMap) {
    if (nombreLower.includes(mes)) {
      return mesesMap[mes];
    }
  }
  
  return 0;
}

function obtenerNombreUsuario(email) {
  try {
    const nombre = email.split('@')[0];
    return nombre.charAt(0).toUpperCase() + nombre.slice(1).toLowerCase();
  } catch (e) {
    return 'Usuario';
  }
}

// ========================================
// ‚≠ê FUNCI√ìN AUXILIAR: GUARDAR EN HISTORICO_MAX
// ========================================


function guardarEnHistoricoMax(datosParaHistorico, ssCDM) {
  try {
    console.log('üíæ Iniciando guardado en Historico_MAX...');
    console.log('Datos a guardar:', JSON.stringify(datosParaHistorico));
    
    let hojaCache = ssCDM.getSheetByName('Historico_MAX');
    
    // Crear hoja si no existe
    if (!hojaCache) {
      console.log('üìù Creando hoja Historico_MAX...');
      hojaCache = ssCDM.insertSheet('Historico_MAX');
    } else {
      console.log('‚úÖ Hoja Historico_MAX encontrada');
    }
    
    // ‚≠ê LIMPIAR COLUMNAS EXTRA SI EXISTEN
    const ultimaColumna = hojaCache.getLastColumn();
    if (ultimaColumna > 19) {
      console.log(`üßπ Limpiando ${ultimaColumna - 19} columnas extra...`);
      hojaCache.deleteColumns(20, ultimaColumna - 19);
      console.log('‚úÖ Columnas extra eliminadas');
    }
    
    // Verificar headers
    const ultimaFila = hojaCache.getLastRow();
    console.log('üìä √öltima fila en Historico_MAX:', ultimaFila);
    
    const tieneHeaders = ultimaFila > 0;
    
    if (!tieneHeaders) {
      console.log('üìù Agregando headers a Historico_MAX...');
      const headers = [
        'Fecha Generaci√≥n',      // A
        'Fecha Registro',        // B
        'LOB',                   // C
        'OM',                    // D
        'Mes',                   // E
        'Numero Mes',            // F
        'Total Bonos',           // G
        'Total Agentes',         // H
        'Keys',                  // I
        'Bonus Structure',       // J
        'Additional Incentives', // K
        'Decreased KPIs',        // L
        '% Keys',                // M
        '% Bonus',               // N
        '% Additional',          // O
        '% Decreased',           // P
        'Usuario',               // Q
        'Correo Usuario',        // R
        'A√±o'                    // S
      ];
      
      // ‚≠ê CAMBIO 1: Usar setValues en lugar de appendRow para headers
      hojaCache.getRange(1, 1, 1, 19).setValues([headers]);
      
      const headerRange = hojaCache.getRange(1, 1, 1, 19);
      headerRange.setBackground('#8e44ad');
      headerRange.setFontColor('#FFFFFF');
      headerRange.setFontWeight('bold');
      headerRange.setHorizontalAlignment('center');
      
      console.log('‚úÖ Headers agregados a Historico_MAX');
    }
    
    // ========================================
    // PREPARAR DATOS PARA GUARDAR
    // ========================================
    const fechaGeneracion = new Date();
    const usuario = Session.getActiveUser().getEmail();
    const nombreUsuario = usuario.split('@')[0];
    const anio = fechaGeneracion.getFullYear();
    
    console.log('üîÑ Preparando datos para guardar...');
    
    let registrosGuardados = 0;
    let registrosActualizados = 0;
    
    // Obtener datos existentes para evitar duplicados
    const dataExistente = ultimaFila > 1 ? hojaCache.getRange(2, 1, ultimaFila - 1, 19).getValues() : [];
    const datosExistentesMap = {};
    const filasExistentes = {};
    
    console.log('üìã Datos existentes en Historico_MAX:', dataExistente.length);
    
    for (let i = 0; i < dataExistente.length; i++) {
      const lobFila = String(dataExistente[i][2] || '').trim();
      const mesFila = String(dataExistente[i][4] || '').trim();
      const clave = `${lobFila}_${mesFila}`;
      
      datosExistentesMap[clave] = true;
      filasExistentes[clave] = i + 2; // +2 porque la data empieza en fila 2 (fila 1 es header)
      
      console.log(`   Existente: ${clave} en fila ${i + 2}`);
    }
    
    // ========================================
    // GUARDAR CADA REGISTRO
    // ========================================
    datosParaHistorico.forEach((dato, index) => {
      console.log(`üìù Procesando registro ${index + 1}:`, dato);
      
      const totalBonos = dato.totalBonos || 0;
      const totalAgentes = dato.agentes || 0;
      
      // Calcular porcentajes
      const porcKeys = totalBonos > 0 ? ((dato.desglose.keys || 0) / totalBonos * 100) : 0;
      const porcBonus = totalBonos > 0 ? ((dato.desglose.bonusStructure || 0) / totalBonos * 100) : 0;
      const porcAdditional = totalBonos > 0 ? ((dato.desglose.additionalIncentives || 0) / totalBonos * 100) : 0;
      const porcDecreased = totalBonos > 0 ? ((dato.desglose.decreasedKPIs || 0) / totalBonos * 100) : 0;
      
      const fila = [
        fechaGeneracion,                    // A: Fecha Generaci√≥n
        dato.fechaRegistro || fechaGeneracion, // B: Fecha Registro
        dato.lob || 'Sin LOB',             // C: LOB
        dato.om || '-',                    // D: OM
        dato.mes || 'General',             // E: Mes
        dato.numeroMes || 0,               // F: Numero Mes
        totalBonos,                        // G: Total Bonos
        totalAgentes,                      // H: Total Agentes
        dato.desglose.keys || 0,           // I: Keys
        dato.desglose.bonusStructure || 0, // J: Bonus Structure
        dato.desglose.additionalIncentives || 0, // K: Additional Incentives
        dato.desglose.decreasedKPIs || 0,  // L: Decreased KPIs
        porcKeys,                          // M: % Keys
        porcBonus,                         // N: % Bonus
        porcAdditional,                    // O: % Additional
        porcDecreased,                     // P: % Decreased
        nombreUsuario,                     // Q: Usuario
        usuario,                           // R: Correo Usuario
        anio                               // S: A√±o
      ];
      
      const clave = `${dato.lob}_${dato.mes}`;
      console.log(`   Clave: ${clave}`);
      
      if (datosExistentesMap[clave]) {
        // ‚≠ê ACTUALIZAR REGISTRO EXISTENTE
        const filaExistente = filasExistentes[clave];
        console.log(`   ‚ö° Actualizando fila ${filaExistente}`);
        
        hojaCache.getRange(filaExistente, 1, 1, 19).setValues([fila]);
        registrosActualizados++;
        
        console.log(`   ‚úÖ Actualizado: ${dato.lob} - ${dato.mes}`);
      } else {
        // ‚≠ê CAMBIO 2: Usar setValues en lugar de appendRow para nuevos registros
        const nuevaFila = hojaCache.getLastRow() + 1;
        console.log(`   ‚ûï Nuevo registro en fila ${nuevaFila}...`);
        
        hojaCache.getRange(nuevaFila, 1, 1, 19).setValues([fila]);
        registrosGuardados++;
        
        console.log(`   ‚úÖ Guardado: ${dato.lob} - ${dato.mes}`);
      }
    });
    
    // ========================================
    // APLICAR FORMATO A NUEVOS REGISTROS
    // ========================================
    if (registrosGuardados > 0) {
      const nuevaUltimaFila = hojaCache.getLastRow();
      const primeraFilaNueva = nuevaUltimaFila - registrosGuardados + 1;
      
      console.log(`üé® Aplicando formato a nuevas filas: ${primeraFilaNueva} a ${nuevaUltimaFila}`);
      
      // Formato de fechas
      hojaCache.getRange(primeraFilaNueva, 1, registrosGuardados, 1)
        .setNumberFormat('dd/mm/yyyy hh:mm:ss');
      hojaCache.getRange(primeraFilaNueva, 2, registrosGuardados, 1)
        .setNumberFormat('dd/mm/yyyy');
      
      // Formato de moneda
      hojaCache.getRange(primeraFilaNueva, 7, registrosGuardados, 1)
        .setNumberFormat('$#,##0.00');
      hojaCache.getRange(primeraFilaNueva, 9, registrosGuardados, 4)
        .setNumberFormat('$#,##0.00');
      
      // Formato de n√∫meros
      hojaCache.getRange(primeraFilaNueva, 8, registrosGuardados, 1)
        .setNumberFormat('#,##0');
      hojaCache.getRange(primeraFilaNueva, 13, registrosGuardados, 4)
        .setNumberFormat('0.00"%"');
      
      // Bordes
      hojaCache.getRange(primeraFilaNueva, 1, registrosGuardados, 19)
        .setBorder(true, true, true, true, true, true, '#ddd', SpreadsheetApp.BorderStyle.SOLID);
      
      console.log('‚úÖ Formato aplicado a nuevos registros');
    }
    
    // ========================================
    // RESULTADO FINAL
    // ========================================
    console.log(`üìä RESUMEN Historico_MAX:`);
    console.log(`   ‚úÖ Nuevos: ${registrosGuardados}`);
    console.log(`   üîÑ Actualizados: ${registrosActualizados}`);
    console.log(`   üìà Total procesados: ${registrosGuardados + registrosActualizados}`);
    
    return {
      success: true,
      count: registrosGuardados + registrosActualizados,
      nuevos: registrosGuardados,
      actualizados: registrosActualizados,
      mensaje: `${registrosGuardados} nuevos, ${registrosActualizados} actualizados en Historico_MAX`
    };
    
  } catch (error) {
    console.error('‚ùå Error en guardarEnHistoricoMax:', error);
    console.error('Stack trace:', error.stack);
    
    return {
      success: false,
      error: error.toString()
    };
  }
}








// ========================================
// ‚≠ê FUNCI√ìN AUXILIAR: GUARDAR EN HISTORICO_MAX


// ========================================
// ========================================
// ‚≠ê FUNCI√ìN AUXILIAR: GUARDAR EN HISTORICO_MAX (CORREGIDA)
// ========================================
function guardarEnHistoricoMax(datosParaHistorico, ssCDM) {
  try {
    console.log('üíæ Iniciando guardado en Historico_MAX...');
    console.log('Datos a guardar:', JSON.stringify(datosParaHistorico));
    
    let hojaCache = ssCDM.getSheetByName('Historico_MAX');
    
    // Crear hoja si no existe
    if (!hojaCache) {
      console.log('üìù Creando hoja Historico_MAX...');
      hojaCache = ssCDM.insertSheet('Historico_MAX');
    } else {
      console.log('‚úÖ Hoja Historico_MAX encontrada');
    }
    
    // Verificar headers
    const ultimaFila = hojaCache.getLastRow();
    console.log('üìä √öltima fila en Historico_MAX:', ultimaFila);
    
    const tieneHeaders = ultimaFila > 0;
    
    if (!tieneHeaders) {
      console.log('üìù Agregando headers a Historico_MAX...');
      const headers = [
        'Fecha Generaci√≥n',      // A
        'Fecha Registro',        // B
        'LOB',                   // C
        'OM',                    // D
        'Mes',                   // E
        'Numero Mes',            // F
        'Total Bonos',           // G
        'Total Agentes',         // H
        'Keys',                  // I
        'Bonus Structure',       // J
        'Additional Incentives', // K
        'Decreased KPIs',        // L
        '% Keys',                // M
        '% Bonus',               // N
        '% Additional',          // O
        '% Decreased',           // P
        'Usuario',               // Q
        'Correo Usuario',        // R
        'A√±o'                    // S
      ];
      
      hojaCache.appendRow(headers);
      
      const headerRange = hojaCache.getRange(1, 1, 1, 19);
      headerRange.setBackground('#8e44ad');
      headerRange.setFontColor('#FFFFFF');
      headerRange.setFontWeight('bold');
      headerRange.setHorizontalAlignment('center');
      
      console.log('‚úÖ Headers agregados a Historico_MAX');
    }
    
    // ========================================
    // PREPARAR DATOS PARA GUARDAR
    // ========================================
    const fechaGeneracion = new Date();
    const usuario = Session.getActiveUser().getEmail();
    const nombreUsuario = usuario.split('@')[0];
    const anio = fechaGeneracion.getFullYear();
    
    console.log('üîÑ Preparando datos para guardar...');
    
    let registrosGuardados = 0;
    let registrosActualizados = 0;
    
    // Obtener datos existentes para evitar duplicados
    const dataExistente = ultimaFila > 1 ? hojaCache.getRange(2, 1, ultimaFila - 1, 19).getValues() : [];
    const datosExistentesMap = {};
    const filasExistentes = {};
    
    console.log('üìã Datos existentes en Historico_MAX:', dataExistente.length);
    
    for (let i = 0; i < dataExistente.length; i++) {
      const lobFila = String(dataExistente[i][2] || '').trim();
      const mesFila = String(dataExistente[i][4] || '').trim();
      const clave = `${lobFila}_${mesFila}`;
      
      datosExistentesMap[clave] = true;
      filasExistentes[clave] = i + 2; // +2 porque la data empieza en fila 2 (fila 1 es header)
      
      console.log(`   Existente: ${clave} en fila ${i + 2}`);
    }
    
    // ========================================
    // GUARDAR CADA REGISTRO
    // ========================================
    datosParaHistorico.forEach((dato, index) => {
      console.log(`üìù Procesando registro ${index + 1}:`, dato);
      
      const totalBonos = dato.totalBonos || 0;
      const totalAgentes = dato.agentes || 0;
      
      // Calcular porcentajes
      const porcKeys = totalBonos > 0 ? ((dato.desglose.keys || 0) / totalBonos * 100) : 0;
      const porcBonus = totalBonos > 0 ? ((dato.desglose.bonusStructure || 0) / totalBonos * 100) : 0;
      const porcAdditional = totalBonos > 0 ? ((dato.desglose.additionalIncentives || 0) / totalBonos * 100) : 0;
      const porcDecreased = totalBonos > 0 ? ((dato.desglose.decreasedKPIs || 0) / totalBonos * 100) : 0;
      
      const fila = [
        fechaGeneracion,                    // A: Fecha Generaci√≥n
        dato.fechaRegistro || fechaGeneracion, // B: Fecha Registro
        dato.lob || 'Sin LOB',             // C: LOB
        dato.om || '-',                    // D: OM
        dato.mes || 'General',             // E: Mes
        dato.numeroMes || 0,               // F: Numero Mes
        totalBonos,                        // G: Total Bonos
        totalAgentes,                      // H: Total Agentes
        dato.desglose.keys || 0,           // I: Keys
        dato.desglose.bonusStructure || 0, // J: Bonus Structure
        dato.desglose.additionalIncentives || 0, // K: Additional Incentives
        dato.desglose.decreasedKPIs || 0,  // L: Decreased KPIs
        porcKeys,                          // M: % Keys
        porcBonus,                         // N: % Bonus
        porcAdditional,                    // O: % Additional
        porcDecreased,                     // P: % Decreased
        nombreUsuario,                     // Q: Usuario
        usuario,                           // R: Correo Usuario
        anio                               // S: A√±o
      ];
      
      const clave = `${dato.lob}_${dato.mes}`;
      console.log(`   Clave: ${clave}`);
      
      if (datosExistentesMap[clave]) {
        // ‚≠ê ACTUALIZAR REGISTRO EXISTENTE
        const filaExistente = filasExistentes[clave];
        console.log(`   ‚ö° Actualizando fila ${filaExistente}`);
        
        hojaCache.getRange(filaExistente, 1, 1, 19).setValues([fila]);
        registrosActualizados++;
        
        console.log(`   ‚úÖ Actualizado: ${dato.lob} - ${dato.mes}`);
      } else {
        // ‚≠ê NUEVO REGISTRO
        console.log(`   ‚ûï Nuevo registro, agregando fila...`);
        
        hojaCache.appendRow(fila);
        registrosGuardados++;
        
        console.log(`   ‚úÖ Guardado: ${dato.lob} - ${dato.mes}`);
      }
    });
    
    // ========================================
    // APLICAR FORMATO A NUEVOS REGISTROS
    // ========================================
    if (registrosGuardados > 0) {
      const nuevaUltimaFila = hojaCache.getLastRow();
      const primeraFilaNueva = nuevaUltimaFila - registrosGuardados + 1;
      
      console.log(`üé® Aplicando formato a nuevas filas: ${primeraFilaNueva} a ${nuevaUltimaFila}`);
      
      // Formato de fechas
      hojaCache.getRange(primeraFilaNueva, 1, registrosGuardados, 1)
        .setNumberFormat('dd/mm/yyyy hh:mm:ss');
      hojaCache.getRange(primeraFilaNueva, 2, registrosGuardados, 1)
        .setNumberFormat('dd/mm/yyyy');
      
      // Formato de moneda
      hojaCache.getRange(primeraFilaNueva, 7, registrosGuardados, 1)
        .setNumberFormat('$#,##0.00');
      hojaCache.getRange(primeraFilaNueva, 9, registrosGuardados, 4)
        .setNumberFormat('$#,##0.00');
      
      // Formato de n√∫meros
      hojaCache.getRange(primeraFilaNueva, 8, registrosGuardados, 1)
        .setNumberFormat('#,##0');
      hojaCache.getRange(primeraFilaNueva, 13, registrosGuardados, 4)
        .setNumberFormat('0.00"%"');
      
      // Bordes
      hojaCache.getRange(primeraFilaNueva, 1, registrosGuardados, 19)
        .setBorder(true, true, true, true, true, true, '#ddd', SpreadsheetApp.BorderStyle.SOLID);
      
      console.log('‚úÖ Formato aplicado a nuevos registros');
    }
    
    // ========================================
    // RESULTADO FINAL
    // ========================================
    console.log(`üìä RESUMEN Historico_MAX:`);
    console.log(`   ‚úÖ Nuevos: ${registrosGuardados}`);
    console.log(`   üîÑ Actualizados: ${registrosActualizados}`);
    console.log(`   üìà Total procesados: ${registrosGuardados + registrosActualizados}`);
    
    return {
      success: true,
      count: registrosGuardados + registrosActualizados,
      nuevos: registrosGuardados,
      actualizados: registrosActualizados,
      mensaje: `${registrosGuardados} nuevos, ${registrosActualizados} actualizados en Historico_MAX`
    };
    
  } catch (error) {
    console.error('‚ùå Error en guardarEnHistoricoMax:', error);
    console.error('Stack trace:', error.stack);
    
    return {
      success: false,
      error: error.toString()
    };
  }
}

function diagnosticarHistoricoMax() {
  try {
    const ssCDM = SpreadsheetApp.openById('1PtYuAb5C2kIoX8sE7dOvt1nVS-aLamZLOJQUSbTBBCw');
    const hojaCache = ssCDM.getSheetByName('Historico_MAX');
    
    if (!hojaCache) {
      console.log('‚ùå No se encontr√≥ la hoja Historico_MAX');
      return { existe: false };
    }
    
    const ultimaFila = hojaCache.getLastRow();
    const data = hojaCache.getDataRange().getValues();
    
    console.log('üìä DIAGN√ìSTICO Historico_MAX:');
    console.log(`   üìè Filas totales: ${data.length}`);
    console.log(`   üìç √öltima fila: ${ultimaFila}`);
    console.log(`   üè∑Ô∏è  Headers: ${data[0] ? data[0].slice(0, 8) : 'No hay headers'}`);
    
    if (data.length > 1) {
      console.log('   üìã Primeros registros:');
      for (let i = 1; i < Math.min(4, data.length); i++) {
        console.log(`      Fila ${i + 1}: ${data[i].slice(0, 8)}`);
      }
    }
    
    return {
      existe: true,
      totalFilas: data.length,
      headers: data[0] || [],
      tieneDatos: data.length > 1
    };
    
  } catch (error) {
    console.error('‚ùå Error en diagn√≥stico:', error);
    return { existe: false, error: error.toString() };
  }
}

// ========================================
// FUNCI√ìN AUXILIAR: OBTENER N√öMERO DE MES
// ========================================
// ========================================
// FUNCI√ìN AUXILIAR: OBTENER N√öMERO DE MES (CORREGIDA)
// ========================================
function obtenerNumeroMesDeFecha(fecha) {
  if (!fecha) return 0;
  
  // ‚≠ê CORREGIDO: Enero = 1, Febrero = 2, etc.
  const mesesMap = {
    'enero': 1, 'febrero': 2, 'marzo': 3, 'abril': 4,
    'mayo': 5, 'junio': 6, 'julio': 7, 'agosto': 8,
    'septiembre': 9, 'octubre': 10, 'noviembre': 11, 'diciembre': 12
  };
  
  const fechaLower = fecha.toString().toLowerCase().trim();
  
  for (const mes in mesesMap) {
    if (fechaLower.includes(mes)) {
      return mesesMap[mes]; // ‚≠ê Ahora retorna el n√∫mero correcto
    }
  }
  
  // Si es una fecha tipo "2024-05-15"
  try {
    const fechaObj = new Date(fecha);
    if (!isNaN(fechaObj.getTime())) {
      return fechaObj.getMonth() + 1; // ‚≠ê getMonth() retorna 0-11, sumamos 1
    }
  } catch (e) {
    // Ignorar errores
  }
  
  return 0;
}



// ========================================
// ‚≠ê FUNCI√ìN BACKEND: LEER DESDE HISTORICO_MAX
// ========================================
function leerHistoricoDesdeCache(lob) {
  try {
    const ssCDM = SpreadsheetApp.openById('1PtYuAb5C2kIoX8sE7dOvt1nVS-aLamZLOJQUSbTBBCw');
    const hojaCache = ssCDM.getSheetByName('Historico_MAX');
    
    if (!hojaCache) {
      Logger.log('‚ùå No se encontr√≥ la hoja Historico_MAX');
      return [];
    }
    
    const data = hojaCache.getDataRange().getValues();
    
    if (data.length <= 1) {
      Logger.log('‚ÑπÔ∏è Historico_MAX est√° vac√≠o');
      return [];
    }
    
    Logger.log(`üìä Leyendo Historico_MAX para LOB: ${lob}`);
    
    const headers = data[0];
    const datosFiltrados = [];
    
    // Encontrar √≠ndices de columnas
    const lobIndex = headers.indexOf('LOB');
    const mesIndex = headers.indexOf('Mes');
    const numeroMesIndex = headers.indexOf('Numero Mes');
    const totalBonosIndex = headers.indexOf('Total Bonos');
    const totalAgentesIndex = headers.indexOf('Total Agentes');
    const keysIndex = headers.indexOf('Keys');
    const bonusStructureIndex = headers.indexOf('Bonus Structure');
    const additionalIncentivesIndex = headers.indexOf('Additional Incentives');
    const decreasedKPIsIndex = headers.indexOf('Decreased KPIs');
    
    // Validar que existen las columnas necesarias
    if (lobIndex === -1 || totalBonosIndex === -1) {
      Logger.log('‚ùå Estructura de Historico_MAX incorrecta');
      return [];
    }
    
    for (let i = 1; i < data.length; i++) {
      const fila = data[i];
      const lobFila = String(fila[lobIndex] || '').trim();
      
      // Filtrar por LOB
      if (lobFila === lob) {
        const datosMes = {
          mes: fila[mesIndex] || 'Mes Desconocido',
          numeroMes: fila[numeroMesIndex] || 0,
          total: Number(fila[totalBonosIndex]) || 0,
          agentes: Number(fila[totalAgentesIndex]) || 0,
          desglose: {
            keys: Number(fila[keysIndex]) || 0,
            bonusStructure: Number(fila[bonusStructureIndex]) || 0,
            additionalIncentives: Number(fila[additionalIncentivesIndex]) || 0,
            decreasedKPIs: Number(fila[decreasedKPIsIndex]) || 0
          }
        };
        
        // Solo incluir meses con datos v√°lidos
        if (datosMes.total > 0) {
          datosFiltrados.push(datosMes);
        }
      }
    }
    
    Logger.log(`‚úÖ Encontrados ${datosFiltrados.length} meses para LOB: ${lob}`);
    
    return datosFiltrados;
    
  } catch (error) {
    Logger.log('‚ùå Error en leerHistoricoDesdeCache: ' + error.toString());
    return [];
  }
}